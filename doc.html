<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Техническое задание и спецификация на разработку АСПП</title>
<!-- 2016-03-27 Вс. 13:22 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 87 -*- -->
<!-- org-toggle-inline-images -->

<script type="text/javascript" src="http://orgmode.org/org-info.js">
/**
 *
 * @source: http://orgmode.org/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in http://orgmode.org/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in http://orgmode.org/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "0");
org_html_manager.set("VIEW", "overview");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Техническое задание и спецификация на разработку АСПП</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Инструкция по работе с документом</a>
<ul>
<li><a href="#sec-1-1">1.1. Теги</a></li>
<li><a href="#sec-1-2">1.2. Правила оформления</a></li>
<li><a href="#sec-1-3">1.3. Подсветка inline todo elements</a></li>
<li><a href="#sec-1-4">1.4. Водки найду</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Назначение и цель создания системы</a>
<ul>
<li><a href="#sec-2-1">2.1. Функции АСПП</a></li>
<li><a href="#sec-2-2">2.2. Сферы применения АСПП</a></li>
<li><a href="#sec-2-3">2.3. Основные компоненты</a>
<ul>
<li><a href="#sec-2-3-1">2.3.1. Печатные платы контроллера</a></li>
<li><a href="#sec-2-3-2">2.3.2. Программное обеспечение контроллера</a></li>
<li><a href="#sec-2-3-3">2.3.3. Компьютеры управления</a></li>
<li><a href="#sec-2-3-4">2.3.4. Программное обеспечение сервера</a></li>
<li><a href="#sec-2-3-5">2.3.5. Клиентские программы</a></li>
</ul>
</li>
<li><a href="#sec-2-4">2.4. Гибкость и масштабируемость</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Этапы, сроки, задачи</a>
<ul>
<li><a href="#sec-3-1">3.1. <span class="todo nilTODO">TODO</span> Краткий список горящих задач&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="gmm">gmm</span></span></a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. <span class="done nilDONE">DONE</span> Запустить дисплеи на 2 и 4 строки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-2">3.1.2. <span class="done nilDONE">DONE</span> Запустить принтер через USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-3">3.1.3. <span class="done nilDONE">DONE</span> Запустить принтер через драйвер CUPS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-4">3.1.4. <span class="todo nilTODO">TODO</span> Написать драйвер собственный для принтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-5">3.1.5. <span class="todo nilTODO">TODO</span> Запустить принтер через RS232&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-6">3.1.6. <span class="todo nilTODO">TODO</span> Печать сгенерированного штрих-кода&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-7">3.1.7. <span class="todo nilTODO">TODO</span> Обмен данными Wiegand26&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-8">3.1.8. <span class="todo nilTODO">TODO</span> Считывание данных EM Marine&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-9">3.1.9. <span class="todo nilTODO">TODO</span> Запустить сканер штрихкодов через USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-10">3.1.10. <span class="todo nilTODO">TODO</span> Написать драйвер для сканера штрих-кодов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-11">3.1.11. <span class="todo nilTODO">TODO</span> Считывание штрих-кода сканером RS232&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-12">3.1.12. <span class="todo nilTODO">TODO</span> Утилита добавления/удаления тарифов в web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-1-13">3.1.13. <span class="todo nilTODO">TODO</span> Утилита добавления/удаления карт ЕМ в web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-1-14">3.1.14. <span class="todo nilTODO">TODO</span> Воспроизведение звука&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-1-15">3.1.15. <span class="todo nilTODO">TODO</span> Видимость sip-устройства в сети&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. <span class="todo nilTODO">TODO</span> Этапы и сроки</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. <span class="todo nilTODO">TODO</span> Пилотный функционал (до 1 марта 2016)</a></li>
<li><a href="#sec-3-2-2">3.2.2. <span class="todo nilTODO">TODO</span> Функционал второго этапа (с 1 марта 2016)</a></li>
<li><a href="#sec-3-2-3">3.2.3. <span class="todo nilWAIT">WAIT</span> Функционал третьего этапа (с 1 авгутса 2016)</a></li>
<li><a href="#sec-3-2-4">3.2.4. <span class="todo nilWAIT">WAIT</span> Дополнительные направления разработки</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3. Задачи общего характера</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. <span class="todo nilSTART">START</span> Описание алгоритмов взаимодействия постетителя и АСПП&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-3-3-2">3.3.2. <span class="todo nilWAIT">WAIT</span> Отладка и интеграционное тестирование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aav">aav</span></span></a></li>
<li><a href="#sec-3-3-3">3.3.3. <span class="todo nilWAIT">WAIT</span> Проверка элементов системы на макете прототипа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></a></li>
</ul>
</li>
<li><a href="#sec-3-4">3.4. Задачи hardware</a>
<ul>
<li><a href="#sec-3-4-1">3.4.1. <span class="done nilDONE">DONE</span> Выбор микрокомпьютера для контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></a></li>
<li><a href="#sec-3-4-2">3.4.2. <span class="done nilDONE">DONE</span> Покупка плат BeagleBone Black и Development Kit&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-3-4-3">3.4.3. <span class="done nilDONE">DONE</span> Подбор редких комплектующих для платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></a></li>
<li><a href="#sec-3-4-4">3.4.4. <span class="done nilDONE">DONE</span> Дерганье ногами на BBB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-4-5">3.4.5. <span class="done nilDONE">DONE</span> Подбор основной части комплектующих для платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></a></li>
<li><a href="#sec-3-4-6">3.4.6. <span class="done nilDONE">DONE</span> Поиск и заказ идущих долго комплектующих&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span>&#xa0;<span class="bda">bda</span></span></a></li>
<li><a href="#sec-3-4-7">3.4.7. <span class="done nilDONE">DONE</span> Трассировка базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></a></li>
<li><a href="#sec-3-4-8">3.4.8. <span class="done nilDONE">DONE</span> Трассировка платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></a></li>
<li><a href="#sec-3-4-9">3.4.9. <span class="todo nilTODO">TODO</span> Обеспечить возможность дергать ногами GPIO при отправке JSON-а&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-3-4-10">3.4.10. <span class="done nilDONE">DONE</span> Обеспечить возможность управлять дисплеем через JSON&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-3-4-11">3.4.11. <span class="todo nilTODO">TODO</span> RTC needed (battery etc.)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-3-4-12">3.4.12. <span class="todo nilWAIT">WAIT</span> Макетирование прототипа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
</ul>
</li>
<li><a href="#sec-3-5">3.5. Задачи software контроллер</a>
<ul>
<li><a href="#sec-3-5-1">3.5.1. <span class="todo nilTODO">TODO</span> Описать <code>happy-cases</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-3-5-2">3.5.2. <span class="todo nilTODO">TODO</span> Составление исполняемой спецификации, внесение описаний работы и кейсов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-3">3.5.3. <span class="done nilDONE">DONE</span> Выделить состояния контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-4">3.5.4. <span class="todo nilTODO">TODO</span> Список событий контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-3-5-5">3.5.5. <span class="todo nilSTART">START</span> Декларативное описание конечных автоматов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-6">3.5.6. <span class="done nilDONE">DONE</span> Написание генератора кода модели системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-7">3.5.7. <span class="todo nilSTART">START</span> Ручная верификация работы системы на модели&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-8">3.5.8. <span class="todo nilSTART">START</span> Расширение модели рабочим кодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-9">3.5.9. <span class="todo nilTODO">TODO</span> Автоматическая верификация работы системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-10">3.5.10. <span class="todo nilTODO">TODO</span> Тестирование рабочего кода на прототипе устройства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-3-5-11">3.5.11. <span class="todo nilTODO">TODO</span> Создание UI web-интерфейса для настройки контроллера</a></li>
</ul>
</li>
<li><a href="#sec-3-6">3.6. Задачи периферии контроллера</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1. <span class="todo nilTODO">TODO</span> Создание списка периферии и сведение документации по ней&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-3-7">3.7. <span class="todo nilTODO">TODO</span> Задачи сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a>
<ul>
<li><a href="#sec-3-7-1">3.7.1. <span class="todo nilWAIT">WAIT</span> Разработка структуры БД</a></li>
<li><a href="#sec-3-7-2">3.7.2. <span class="todo nilWAIT">WAIT</span> Разработка софтверной части для сервера</a></li>
<li><a href="#sec-3-7-3">3.7.3. <span class="todo nilWAIT">WAIT</span> Разработка интерфейса сервера</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Описание функционирования</a>
<ul>
<li><a href="#sec-4-1">4.1. <span class="done nilDONE">DONE</span> Общий принцип работы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-2">4.2. <span class="todo nilTODO">TODO</span> Парковочные места, тарифные зоны и сектора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. <span class="todo nilTODO">TODO</span> Тарифная зона&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-2-2">4.2.2. <span class="todo nilTODO">TODO</span> Сектор парковки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-2-3">4.2.3. <span class="todo nilTODO">TODO</span> Распределение паркомест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. <span class="done nilDONE">DONE</span> Виды проездных документов и информация на них&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-3-1">4.3.1. <span class="done nilDONE">DONE</span> Бумажный въездной билет со штрихкодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-3-2">4.3.2. <span class="done nilDONE">DONE</span> Бумажный выездной билет / кассовый чек со штрих-кодом</a></li>
<li><a href="#sec-4-3-3">4.3.3. <span class="todo nilTODO">TODO</span> RFID Em-Marine&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-3-4">4.3.4. <span class="todo nilWAIT">WAIT</span> RFID Mifare+&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-3-5">4.3.5. <span class="todo nilWAIT">WAIT</span> RFID DSRC&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-4">4.4. <span class="todo nilTODO">TODO</span> Кассовые и сервисные документы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a>
<ul>
<li><a href="#sec-4-4-1">4.4.1. <span class="todo nilTODO">TODO</span> Кассовый чек на покупку карты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-2">4.4.2. <span class="todo nilWAIT">WAIT</span> Х-отчёт&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-3">4.4.3. <span class="todo nilWAIT">WAIT</span> Z-отчёт&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-4">4.4.4. <span class="todo nilWAIT">WAIT</span> Инкассация&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-5">4.4.5. <span class="todo nilWAIT">WAIT</span> Изъятие средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-6">4.4.6. <span class="todo nilWAIT">WAIT</span> Внесение средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-7">4.4.7. <span class="todo nilWAIT">WAIT</span> Возврат&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-8">4.4.8. <span class="todo nilWAIT">WAIT</span> Ошибка платежа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-4-9">4.4.9. <span class="todo nilWAIT">WAIT</span> Сервисный билет&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-5">4.5. <span class="todo nilTODO">TODO</span> Логирование сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-6">4.6. <span class="todo nilTODO">TODO</span> Состояния стойки при проезде&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a>
<ul>
<li><a href="#sec-4-6-1">4.6.1. <span class="todo nilTODO">TODO</span> Состояние запуска (<code>poweron</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-4-6-2">4.6.2. <span class="todo nilTODO">TODO</span> Состояние тестирования (<code>selftest</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-4-6-3">4.6.3. <span class="done nilDONE">DONE</span> Состояние ожидания (<code>standby</code>)</a></li>
<li><a href="#sec-4-6-4">4.6.4. <span class="todo nilTODO">TODO</span> Подъезд машины к стойке (<code>finding</code>)</a></li>
<li><a href="#sec-4-6-5">4.6.5. <span class="todo nilTODO">TODO</span> Стойка в диалоговом режиме (<code>dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-6-6">4.6.6. <span class="todo nilTODO">TODO</span> Инициация процедуры проезда (<code>init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-6-7">4.6.7. <span class="todo nilTODO">TODO</span> Процедура проезда (<code>goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-6-8">4.6.8. <span class="todo nilTODO">TODO</span> Процедура завершения проезда (<code>fin</code>)</a></li>
<li><a href="#sec-4-6-9">4.6.9. <span class="todo nilTODO">TODO</span> Cостояние полной блокировки (<code>hardlock</code>)</a></li>
<li><a href="#sec-4-6-10">4.6.10. <span class="todo nilWAIT">WAIT</span> Процедура частичной блокировки (<code>softlock</code>)</a></li>
<li><a href="#sec-4-6-11">4.6.11. <span class="todo nilWAIT">WAIT</span> Процедура оплаты (<code>payment</code>)</a></li>
</ul>
</li>
<li><a href="#sec-4-7">4.7. <span class="todo nilTODO">TODO</span> Обработка сигналов с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-8">4.8. <span class="todo nilTODO">TODO</span> Отмена проезда по незавершённому алгоритму&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-9">4.9. <span class="todo nilTODO">TODO</span> Настройки администратора из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-9-1">4.9.1. <span class="todo nilTODO">TODO</span> Настройка торгового оборудования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-9-2">4.9.2. <span class="todo nilTODO">TODO</span> Настройки работы датчиков и реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-9-3">4.9.3. <span class="todo nilTODO">TODO</span> Системные настройки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-9-4">4.9.4. <span class="todo nilTODO">TODO</span> Настройки тарификации из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-9-5">4.9.5. <span class="todo nilTODO">TODO</span> Тестирование и диагностика из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a></li>
<li><a href="#sec-4-9-6">4.9.6. <span class="todo nilTODO">TODO</span> Режим тестирования опрашиваемого оборудования из UI контроллера</a></li>
</ul>
</li>
<li><a href="#sec-4-10">4.10. <span class="todo nilTODO">TODO</span> Некорректные действия посетителя&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></a>
<ul>
<li><a href="#sec-4-10-1">4.10.1. <span class="todo nilTODO">TODO</span> Машина посетителя уезжает не завершив процедуру проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-10-2">4.10.2. <span class="todo nilTODO">TODO</span> Повторное прикладывание/некорректный билет&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-10-3">4.10.3. <span class="todo nilTODO">TODO</span> Повторная оплата по въездному билету&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-11">4.11. <span class="todo nilTODO">TODO</span> Некорректные действия оператора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-12">4.12. <span class="todo nilTODO">TODO</span> Сообщения периферийных устройств контроллеру&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-4-13">4.13. <span class="todo nilTODO">TODO</span> Алгоритмы проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-13-1">4.13.1. Алгоритм простого въезда по чеку <code>barcode</code> <code>enter</code></a></li>
<li><a href="#sec-4-13-2">4.13.2. <span class="todo nilTODO">TODO</span> Алгоритм простого выезда по чеку <code>barcode</code> <code>leave</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-13-3">4.13.3. <span class="todo nilTODO">TODO</span> Алгоритм проезда по карте СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-14">4.14. <span class="todo nilWAIT">WAIT</span> Усложнения алгоритмов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-14-1">4.14.1. <span class="todo nilTODO">TODO</span> Проезд по шлюзу / рампе</a></li>
<li><a href="#sec-4-14-2">4.14.2. <span class="todo nilWAIT">WAIT</span> Фотофиксация въезда</a></li>
<li><a href="#sec-4-14-3">4.14.3. <span class="todo nilWAIT">WAIT</span> Звуковое сопровождение</a></li>
</ul>
</li>
<li><a href="#sec-4-15">4.15. <span class="todo nilTODO">TODO</span> Алгоритмы работы с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-15-1">4.15.1. <span class="todo nilTODO">TODO</span> Работа с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-15-2">4.15.2. <span class="todo nilTODO">TODO</span> Процедура оплаты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-15-3">4.15.3. <span class="todo nilTODO">TODO</span> Процедура инкассации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-15-4">4.15.4. <span class="todo nilTODO">TODO</span> Процедура закрытия смены&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-16">4.16. <span class="todo nilTODO">TODO</span> Роли пользователей системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-16-1">4.16.1. Суперадминистратор (root)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-16-2">4.16.2. Администратор (admin)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-16-3">4.16.3. <span class="todo nilTODO">TODO</span> Оператор (operator)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-16-4">4.16.4. Бухгалтер</a></li>
<li><a href="#sec-4-16-5">4.16.5. Посетитель парковки</a></li>
</ul>
</li>
<li><a href="#sec-4-17">4.17. <span class="todo nilTODO">TODO</span> Обработка ошибок в работе&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></a>
<ul>
<li><a href="#sec-4-17-1">4.17.1. <span class="todo nilTODO">TODO</span> Описать полный цикл работы системы с обработкой ошибок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-4-18">4.18. <span class="done nilDONE">DONE</span> Логирование сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-4-19">4.19. <span class="todo nilWAIT">WAIT</span> Парковочные места, тарифные зоны и сектора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-4-19-1">4.19.1. <span class="todo nilWAIT">WAIT</span> Распределение паркомест</a></li>
<li><a href="#sec-4-19-2">4.19.2. <span class="todo nilWAIT">WAIT</span> Тарифная зона</a></li>
<li><a href="#sec-4-19-3">4.19.3. <span class="todo nilWAIT">WAIT</span> Сектор парковки</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Контроллер</a>
<ul>
<li><a href="#sec-5-1">5.1. Требования к контроллеру&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="noa">noa</span></span></a>
<ul>
<li><a href="#sec-5-1-1">5.1.1. <span class="todo nilTODO">TODO</span> Требования к функционалу контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-1-2">5.1.2. <span class="todo nilTODO">TODO</span> Требования к аппаратной части контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-1-3">5.1.3. <span class="todo nilTODO">TODO</span> Требования к платам расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-1-4">5.1.4. <span class="todo nilTODO">TODO</span> Требования по подключению внешних периферийных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-1-5">5.1.5. <span class="todo nilTODO">TODO</span> Требования к программной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-1-6">5.1.6. <span class="done nilDONE">DONE</span> Оценка максимального количества подключений устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-1-7">5.1.7. <span class="todo nilWAIT">WAIT</span> Требования к гибкой реализации подключения периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-1-8">5.1.8. Требования к автономной работе контроллера</a></li>
</ul>
</li>
<li><a href="#sec-5-2">5.2. Аппаратная часть контроллера</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1. <span class="todo nilTODO">TODO</span> Данные по потреблению периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-2-2">5.2.2. <span class="done nilDONE">DONE</span> Принципиальная схема базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="bda">bda</span></span></a></li>
<li><a href="#sec-5-2-3">5.2.3. <span class="todo nilTODO">TODO</span> Схемотехника базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-4">5.2.4. <span class="todo nilWAIT">WAIT</span> Принципиальная схема управляющей платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-5">5.2.5. <span class="todo nilWAIT">WAIT</span> Схемотехника управляющей платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span>&#xa0;<span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-2-6">5.2.6. <span class="done nilDONE">DONE</span> Принципиальная схема кроссировочной платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></a></li>
<li><a href="#sec-5-2-7">5.2.7. <span class="todo nilTODO">TODO</span> Схемотехника кроссировочной платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-8">5.2.8. <span class="todo nilTODO">TODO</span> Принципальные схемы плат расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-9">5.2.9. <span class="todo nilTODO">TODO</span> Схемотехника плат расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-10">5.2.10. <span class="todo nilTODO">TODO</span> Спецификация плат для производства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span>&#xa0;<span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-2-11">5.2.11. <span class="todo nilTODO">TODO</span> Соединение плат контроллера, форм-фактор&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="ske">ske</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3. Подключаемые периферийные устройства</a>
<ul>
<li><a href="#sec-5-3-1">5.3.1. <span class="todo nilTODO">TODO</span> Периферийные устройства (обмен данными)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-3-2">5.3.2. <span class="todo nilTODO">TODO</span> Периферийные устройства (обмен сигналами)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-3-3">5.3.3. <span class="todo nilTODO">TODO</span> Стандартные комплекты периферийных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-5-3-4">5.3.4. <span class="todo nilTODO">TODO</span> Аудио оборудование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-4">5.4. <span class="todo nilTODO">TODO</span> Архитектура программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aav">aav</span>&#xa0;<span class="gmm">gmm</span>&#xa0;<span class="bvl">bvl</span></span></a>
<ul>
<li><a href="#sec-5-4-1">5.4.1. Высокоуровневая архитектура</a></li>
<li><a href="#sec-5-4-2">5.4.2. Взаимодействие уровней</a></li>
<li><a href="#sec-5-4-3">5.4.3. FFI</a></li>
<li><a href="#sec-5-4-4">5.4.4. Архитектура бизнес-логики</a></li>
<li><a href="#sec-5-4-5">5.4.5. Архитектура классов нижнего уровня</a></li>
<li><a href="#sec-5-4-6">5.4.6. Нотификация при изменении настроек</a></li>
<li><a href="#sec-5-4-7">5.4.7. Драйвера уровня ядра</a></li>
<li><a href="#sec-5-4-8">5.4.8. Требования к функционалу <code>HardwarePresentationLayer</code></a></li>
<li><a href="#sec-5-4-9">5.4.9. Требования к реализации <code>HardwarePresentationLayer</code></a></li>
<li><a href="#sec-5-4-10">5.4.10. Работа с дисплеями и другими конкретными устройствами</a></li>
</ul>
</li>
<li><a href="#sec-5-5">5.5. <span class="todo nilTODO">TODO</span> Алгоритм запуска программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-6">5.6. <span class="todo nilTODO">TODO</span> Рабочая среда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a>
<ul>
<li><a href="#sec-5-6-1">5.6.1. <span class="done nilDONE">DONE</span> Операционная система&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-2">5.6.2. <span class="done nilDONE">DONE</span> Инициализация операционной системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-3">5.6.3. <span class="todo nilSTART">START</span> Конфигурация SSH сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-4">5.6.4. <span class="done nilDONE">DONE</span> Установка и запуск nginx&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-5">5.6.5. <span class="todo nilSTART">START</span> Установка и запуск PostgreSQL&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-6-6">5.6.6. <span class="done nilDONE">DONE</span> Установка и запуск Boost&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-7">5.6.7. <span class="done nilDONE">DONE</span> Установка и запуск git-core&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-5-6-8">5.6.8. Установка Closure Common Lisp на bbb</a></li>
<li><a href="#sec-5-6-9">5.6.9. Установка org-mode</a></li>
<li><a href="#sec-5-6-10">5.6.10. Установка Slime</a></li>
<li><a href="#sec-5-6-11">5.6.11. Установка Quicklisp</a></li>
<li><a href="#sec-5-6-12">5.6.12. <span class="todo nilSTART">START</span> Установка и запуск SMTP-сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-5-6-13">5.6.13. <span class="todo nilSTART">START</span> Установка и запуск FTP-сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-5-6-14">5.6.14. <span class="todo nilSTART">START</span> Конфигурация iptables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-15">5.6.15. <span class="todo nilTODO">TODO</span> Конфигурация супервизора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-16">5.6.16. <span class="todo nilSTART">START</span> Конфигурация средства бэкапирования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-6-17">5.6.17. <span class="todo nilTODO">TODO</span> Установка и конфигурация отдельных периферийных средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-7">5.7. Подготовка среды разработки ПО контроллера</a>
<ul>
<li><a href="#sec-5-7-1">5.7.1. Сборка ядра Linux в нашей частной конфигурации 3.8.13-bone47</a></li>
<li><a href="#sec-5-7-2">5.7.2. Установка cmake</a></li>
<li><a href="#sec-5-7-3">5.7.3. Установка Boost</a></li>
<li><a href="#sec-5-7-4">5.7.4. Установка cppunit</a></li>
<li><a href="#sec-5-7-5">5.7.5. Установка rapidjson</a></li>
<li><a href="#sec-5-7-6">5.7.6. Единая конфигурация Eclipse&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-8">5.8. <span class="todo nilTODO">TODO</span> Работа с библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a>
<ul>
<li><a href="#sec-5-8-1">5.8.1. <span class="todo nilTODO">TODO</span> Работа со статическими библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-8-2">5.8.2. <span class="todo nilWAIT">WAIT</span> Работа динамическими с библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-9">5.9. <span class="todo nilWAIT">WAIT</span> Драйвера перифериных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-10">5.10. <span class="todo nilTODO">TODO</span> Протоколы периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-11">5.11. <span class="todo nilTODO">TODO</span> Описание блока настроек портов подключения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></a></li>
<li><a href="#sec-5-12">5.12. <span class="todo nilTODO">TODO</span> Резервирование системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-13">5.13. <span class="todo nilTODO">TODO</span> Web-интерфейс для настройки контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-5-14">5.14. Настройка и развертывание ПО контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a>
<ul>
<li><a href="#sec-5-14-1">5.14.1. <span class="done nilDONE">DONE</span> Подключение к BBB по ssh&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-14-2">5.14.2. <span class="done nilDONE">DONE</span> Бэкап при подготовке к работам&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-14-3">5.14.3. <span class="todo nilTODO">TODO</span> Развертывание рабочей среды из архива&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
<li><a href="#sec-5-14-4">5.14.4. <span class="done nilDONE">DONE</span> Компиляция и запуск HelloWorld&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-15">5.15. <span class="todo nilWAIT">WAIT</span> Оптимизация решения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></a>
<ul>
<li><a href="#sec-5-15-1">5.15.1. <span class="todo nilWAIT">WAIT</span> Оптимизация аппаратной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></a></li>
<li><a href="#sec-5-15-2">5.15.2. <span class="todo nilWAIT">WAIT</span> Оптимизация программной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></a></li>
</ul>
</li>
<li><a href="#sec-5-16">5.16. HOWTO Подключение подтяжек pull-up для GPIO</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Серверная часть&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-6-1">6.1. <span class="todo nilTODO">TODO</span> Общие положения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-2">6.2. <span class="todo nilTODO">TODO</span> Основной функционал сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-6-3">6.3. <span class="todo nilWAIT">WAIT</span> База данных&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-6-4">6.4. <span class="todo nilTODO">TODO</span> Web-интерфейс сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-6-5">6.5. <span class="todo nilWAIT">WAIT</span> Агреггирующий сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
<li><a href="#sec-6-6">6.6. <span class="todo nilTODO">TODO</span> Дополнительные аппаратно-програмные модули&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-6-6-1">6.6.1. <span class="todo nilTODO">TODO</span> Модуль платной парковки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-2">6.6.2. <span class="todo nilTODO">TODO</span> Модуль СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-3">6.6.3. <span class="todo nilWAIT">WAIT</span> Модуль для работы с абонементами&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-4">6.6.4. <span class="todo nilWAIT">WAIT</span> Модуль для работы по дебетовым картам&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-5">6.6.5. <span class="todo nilWAIT">WAIT</span> Модуль акцептирования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-6">6.6.6. <span class="todo nilWAIT">WAIT</span> Модуль арендаторов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-7">6.6.7. <span class="todo nilTODO">TODO</span> Модуль кассира&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-8">6.6.8. <span class="todo nilWAIT">WAIT</span> Модуль бухгалтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-9">6.6.9. <span class="todo nilWAIT">WAIT</span> Модуль фотофиксации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-10">6.6.10. <span class="todo nilWAIT">WAIT</span> Модуль распознания номеров&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-6-11">6.6.11. <span class="todo nilTODO">TODO</span> Модуль дуплексной IP связи&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="bvl">bvl</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
</ul>
</li>
<li><a href="#sec-6-7">6.7. <span class="todo nilWAIT">WAIT</span> Интеграция со сторонними решениями&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a>
<ul>
<li><a href="#sec-6-7-1">6.7.1. <span class="todo nilWAIT">WAIT</span> Выгрузка данных в 1С&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-7-2">6.7.2. <span class="todo nilWAIT">WAIT</span> Интеграция с 1С&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-7-3">6.7.3. <span class="todo nilWAIT">WAIT</span> Интеграция со сторонним биллингом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-7-4">6.7.4. <span class="todo nilWAIT">WAIT</span> Интеграция с NOW!&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-7-5">6.7.5. <span class="todo nilWAIT">WAIT</span> Интеграция с SOLVO&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-6-7-6">6.7.6. <span class="todo nilWAIT">WAIT</span> API для создания библиотек&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-7">7. Использование алгоритмов шифрования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></a>
<ul>
<li><a href="#sec-7-1">7.1. Программная лицензионная защита комплекса&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></a></li>
</ul>
</li>
<li><a href="#sec-8">8. Глоссарий</a>
<ul>
<li><a href="#sec-8-1">8.1. Датчик</a>
<ul>
<li><a href="#sec-8-1-1">8.1.1. Датчик присутствия автомобиля</a></li>
<li><a href="#sec-8-1-2">8.1.2. Датчик безопасности</a></li>
<li><a href="#sec-8-1-3">8.1.3. Датчик контроля состояния стрелы шлагбаума</a></li>
</ul>
</li>
<li><a href="#sec-8-2">8.2. Сигнал</a></li>
<li><a href="#sec-8-3">8.3. Событие</a></li>
<li><a href="#sec-8-4">8.4. Сообщение</a></li>
<li><a href="#sec-8-5">8.5. Состояние</a></li>
<li><a href="#sec-8-6">8.6. Процедура</a></li>
<li><a href="#sec-8-7">8.7. <span class="todo nilTODO">TODO</span> Стойка&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-8">8.8. Периферийные устройства</a>
<ul>
<li><a href="#sec-8-8-1">8.8.1. Внутренние</a></li>
<li><a href="#sec-8-8-2">8.8.2. Внешние</a></li>
<li><a href="#sec-8-8-3">8.8.3. Торговые</a></li>
<li><a href="#sec-8-8-4">8.8.4. Опрашиваемые</a></li>
<li><a href="#sec-8-8-5">8.8.5. Критичные</a></li>
</ul>
</li>
<li><a href="#sec-8-9">8.9. Касса</a></li>
<li><a href="#sec-8-10">8.10. Проездной документ</a></li>
<li><a href="#sec-8-11">8.11. Контроллер</a></li>
<li><a href="#sec-8-12">8.12. Системы навигациии</a></li>
<li><a href="#sec-8-13">8.13. <span class="todo nilTODO">TODO</span> Сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-14">8.14. Время</a></li>
<li><a href="#sec-8-15">8.15. Группы</a></li>
<li><a href="#sec-8-16">8.16. Парковка</a></li>
<li><a href="#sec-8-17">8.17. <span class="todo nilTODO">TODO</span> Посетитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-18">8.18. <span class="todo nilTODO">TODO</span> Деление парковкочных мест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-19">8.19. <span class="todo nilTODO">TODO</span> Тариф&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-20">8.20. <span class="todo nilTODO">TODO</span> Роли&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-21">8.21. <span class="todo nilTODO">TODO</span> Внешний носитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-22">8.22. <span class="todo nilTODO">TODO</span> УДПА&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-23">8.23. <span class="todo nilTODO">TODO</span> Процесс&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-24">8.24. <span class="todo nilTODO">TODO</span> Рампа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-25">8.25. <span class="todo nilTODO">TODO</span> Шлюз&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-26">8.26. <span class="todo nilTODO">TODO</span> Реверсивный проезд&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></a></li>
<li><a href="#sec-8-27">8.27. <span class="done nilDONE">DONE</span> Глоссарий архитектуры&#xa0;&#xa0;&#xa0;<span class="tag"><span class="man">man</span></span></a></li>
</ul>
</li>
<li><a href="#sec-9">9. Данные по первому поколению системы</a>
<ul>
<li><a href="#sec-9-1">9.1. <span class="done nilDONE">DONE</span> Старая версия сервера</a></li>
</ul>
</li>
<li><a href="#sec-10">10. Сущности</a>
<ul>
<li><a href="#sec-10-1">10.1. Функции для кодогенерации сущностей</a></li>
<li><a href="#sec-10-2">10.2. <span class="done nilDONE">DONE</span> События</a></li>
<li><a href="#sec-10-3">10.3. <span class="done nilDONE">DONE</span> Роли (role)</a></li>
<li><a href="#sec-10-4">10.4. <span class="done nilDONE">DONE</span> Пользователи (user)</a></li>
<li><a href="#sec-10-5">10.5. <span class="done nilDONE">DONE</span> Группы (group, user2group)</a></li>
<li><a href="#sec-10-6">10.6. <span class="done nilDONE">DONE</span> Сообщения (msg)</a></li>
<li><a href="#sec-10-7">10.7. <span class="done nilDONE">DONE</span> Задачи (task)</a></li>
<li><a href="#sec-10-8">10.8. <span class="done nilDONE">DONE</span> Очереди (que, quelt)</a></li>
</ul>
</li>
<li><a href="#sec-11">11. Тесты</a></li>
<li><a href="#sec-12">12. Модули</a>
<ul>
<li><a href="#sec-12-1">12.1. Cущности, автоматы и их тесты</a></li>
<li><a href="#sec-12-2">12.2. Авторизация</a></li>
<li><a href="#sec-12-3">12.3. Очереди</a></li>
<li><a href="#sec-12-4">12.4. Демонстрация</a></li>
</ul>
</li>
<li><a href="#sec-13">13. Сборка</a>
<ul>
<li><a href="#sec-13-1">13.1. Утилиты</a></li>
<li><a href="#sec-13-2">13.2. Глобальные определения</a></li>
<li><a href="#sec-13-3">13.3. Страницы</a>
<ul>
<li><a href="#sec-13-3-1">13.3.1. Главная страница</a></li>
</ul>
</li>
<li><a href="#sec-13-4">13.4. Каркас проекта</a></li>
<li><a href="#sec-13-5">13.5. Пакеты</a></li>
<li><a href="#sec-13-6">13.6. Подготовка к старту</a></li>
<li><a href="#sec-13-7">13.7. Блок логина в шапке на каждой странице</a></li>
<li><a href="#sec-13-8">13.8. Точка входа</a></li>
<li><a href="#sec-13-9">13.9. Copyright</a></li>
</ul>
</li>
<li><a href="#sec-14">14. Оптимизация аппаратной части решения</a></li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="/css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Инструкция по работе с документом</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Теги</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Итак, каждом заголовку можно поставить теги. Это делается с помощью комбинации
<code>C-c C-q</code>, которая вызывает функцию <code>(org-set-tags-command)</code>
</p>

<p>
Теги пишутся в правой колонке, которой управляет переменная org-tags-column, у
меня, по умолчанию, она равна 77.
</p>

<p>
Если ввести <code>C-u C-c C-q</code> все теги в документе будут выровнены (по возможности) по
этой колонке.
</p>

<p>
Теги автоматически перестраиваются после изменения порядка столбцов, двигания
разделов и присвоения меток TODO, START и других. Кроме того, теги не нарушают поиск
ссылок на разделы, в отличии от наших вставок TODO:bvl в раздел, после чего
все ссылки на этот раздел "ломаются".
</p>

<p>
Можно ставить несколько тегов на один раздел например так: :pyub:bvl:
</p>

<p>
Чтобы быстро найти все разделы с каким либо тегом нужно нажать <code>C-c / m</code> или, еще
проще - <code>C-c \</code>, что вызывает функцию <code>(org-match-sparse-tree)</code>, которая прямо в
текущем файле подсветит вам разделы, которые имеют этот тег.
</p>

<p>
Однако иногда удобнее получить список всех этих разделов и дальше ходить по нему. Для
этого существует мега-полезная комбинация <code>C-c a &lt; m</code>, которая из текущего буфера (или
даже из его выделенной области) сформирует список разделов, имеющих теги, которые вы
укажете и выведет в отдельный буфер, который покажет вам. Этот буфер можно будет
обновлять прямо в нем, нажимая <code>C-u r</code> о чем собственно и будет написано у него
наверху. И внутри этого буфера можно будет бродить по всем интересующим разделам,
который будут открываться в вашем исходном буфере.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Правила оформления</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Всегда, если вы написали какой-то кусок текста или отвечаете за данную задачу, или
поставили кому-то задачу куском текста, ставьте тег в заголовок раздела. Это в
последствии упрощает поиск человека, отвественного за задачу, который может дать
развёрнутый комментарий к ней.
</p>

<p>
Именные:
</p>
<p>
:pyub - Пирогов Юрий (Санти)
</p>
<p>
:unrimah -&gt; :bvl - Богданов Владимир (Унримах)
</p>
<p>
:rigidus -&gt; :gmm - Глухов Михаил (Ригидус)
</p>
<p>
:ranma -&gt; :aav - Алешкин Алексей (Ранма)
</p>
<p>
:noa - Нилов Олег
</p>
<p>
:bda - Булашевич Дмитрий (Корвиноль)
</p>
<p>
:ske - Степанов Кирилл (Эльтар)
</p>
<p>
:all - всем
</p>
<p>
:noname - не определено
</p>
<p>
:man - информация, не важная для данного документа в целом и для конечной
документации, но важная для кого-то в плане понимания или прихода к решению
</p>

<p>
В одном разделе может быть несколько ответственных.
</p>

<p>
[TODO:pyub] Прошерстить
</p>

<p>
Описание состояний, в которых может находиться раздел:
TODO  - задача поставлена и ждёт исполнения
START - задача исполняется, но еще не закончена
DONE  - задача завершена и об этом написано
WAIT  - задача описана, но на данный момент не активна
</p>

<p>
ничего не сделано
</p>

<p>
Общаясь в документе не забывайте выставлять
COMMENT: - временный комментарий дан одним из учатников проекта
</p>

<p>
Если вы написали какой-то текст в разделе, где вы помечены как ответственный автор и
хотите, чтобы кто-то другой прочёл этот текст и верифицировал, используйте
VRFY: - задача человеку проверить, прочитать, по факту прочтения оставляются коммент,
правки и т.п., а тег убирается
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Подсветка inline todo elements</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Для того чтобы удобно работать с подсветкой инлайновых (вне заголовков) TODO и VRFY
добавьте в ваш ~/.emacs.d/init.el следующие строчки:
</p>

<div class="org-src-container">

<pre class="src src-elisp"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">ORG-MODE TODO|VRFY font-lock-faces</span>
(font-lock-add-keywords 'org-mode
                        '((<span style="color: #00cd00;">"</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">(</span><span style="color: #00cd00;">\\[TODO:[a-z]\\{3,\\}\\]</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">)</span><span style="color: #00cd00;">"</span> . 'font-lock-warning-face)
                          (<span style="color: #00cd00;">"</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">(</span><span style="color: #00cd00;">\\[COMMENT:[a-z]\\{3,\\}\\]</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">)</span><span style="color: #00cd00;">"</span> . 'font-lock-keyword-face)
                          (<span style="color: #00cd00;">"</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">(</span><span style="color: #00cd00;">\\[VRFY:[a-z]\\{3,\\}\\]</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">)</span><span style="color: #00cd00;">"</span> . 'font-lock-function-name-face)
                          ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Водки найду</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Когда необходимо получить сводную информацию по своим TODO и VRFY элементам, можно
воспользоваться функцией <code>what-can-i-do</code>, изменив (при необходимости) идентификатор
в <code>pattern</code> и добавив ее в свой <code>init.el</code>.
</p>

<p>
В этом коде (последняя строчка) эта функция биндится на комбинацию клавишь
<code>C-c m</code>. Вы можете повесить ее на другую комбинацию клавишь.
</p>

<div class="org-src-container">

<pre class="src src-elisp">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">what-can-i-do</span> (arg)
  (interactive <span style="color: #00cd00;">"sName: "</span>)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((pattern (format <span style="color: #00cd00;">"</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">(</span><span style="color: #00cd00;">\\[</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">(</span><span style="color: #00cd00;">TODO</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">|</span><span style="color: #00cd00;">VRFY</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">)</span><span style="color: #00cd00;">:%s\\]</span><span style="color: #00cd00; font-weight: bold;">\\</span><span style="color: #00cd00; font-weight: bold;">)</span><span style="color: #00cd00;">"</span> arg)) <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">"\\(\\[TODO:.\\{3,\\}\\]\\)"</span>
        (curbuff (current-buffer))
        (newbuff (generate-new-buffer <span style="color: #00cd00;">"*what-can-i-do*"</span>)))
    (<span style="color: #00cdcd; font-weight: bold;">save-excursion</span>
      (goto-char (point-min))
      (<span style="color: #00cdcd; font-weight: bold;">let</span> ((cnt 0))
        (<span style="color: #00cdcd; font-weight: bold;">with-output-to-temp-buffer</span> newbuff
          (<span style="color: #00cdcd; font-weight: bold;">while</span> (re-search-forward pattern nil t)
            (incf cnt)
            (<span style="color: #00cdcd; font-weight: bold;">let</span> ((buff  curbuff)
                  (point (point))
                  (line  (line-number-at-pos))
                  (contents (thing-at-point 'line)))
              (<span style="color: #00cdcd; font-weight: bold;">with-current-buffer</span> newbuff
                (insert-text-button (format <span style="color: #00cd00;">"%d:"</span> line)
                                    'buff buff
                                    'point point
                                    'action (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                                              (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((pos   (posn-point (event-end x)))
                                                     (buff  (get-text-property pos 'buff))
                                                     (point (get-text-property pos 'point)))
                                                (<span style="color: #00cdcd; font-weight: bold;">with-current-buffer</span> buff
                                                  (goto-char point))
                                                (switch-to-buffer buff))))
                (princ contents))))
          (goto-char (point-max))
          (princ (format <span style="color: #00cd00;">"\nDone. %s finded."</span> cnt))
          )))))

(global-set-key (kbd <span style="color: #00cd00;">"C-c m"</span>) 'what-can-i-do)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Назначение и цель создания системы</h2>
<div class="outline-text-2" id="text-2">
<p>
Целью проводимых работ является создание спецификации, разработка, отладка и
доведение до серийного производства аппаратно-программного комплекса
<code>Автоматизированной Системы Платной Парковки</code> (АСПП) - решения, предназанченного для
оснащения парковок и дорожной инфраструктуры.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Функции АСПП</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Основной функцией разрабатываемой системы явяется автоматизация следующих процессов:
</p>
<ul class="org-ul">
<li>контроль доступа посетителей к парковочному пространству;
</li>
<li>монетизация этой услуги;
</li>
<li>сбор статистических данных;
</li>
<li>управление навигацией по территории парковки.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Сферы применения АСПП</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Разрабатываемая система может применяться в следующих сферах:
</p>
<ul class="org-ul">
<li>плоскостные платные парковки;
</li>
<li>многоэтажные платные парковки с навигацией;
</li>
<li>парковки и территории, требующие автомобильной СКУД;
</li>
<li>уличные паркоматы;
</li>
<li>терминалы контрольных пунктов платных дорог;
</li>
<li>системы распределения траффика автомобилей на транспортных терминалах.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Основные компоненты</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Объекты разработки:
</p>
<ul class="org-ul">
<li><code>Контроллер</code> - комплексное аппаратно-программное решение, состоящее из:
<ul class="org-ul">
<li>нескольких физически разделяемых <code>печатных плат</code>
</li>
<li><code>программного обеспечения</code> для них.
</li>
</ul>
</li>
<li><code>Серверное ПО</code> - ПО, агреггирующее данные с контроллеров и управляющее парковкой в
целом.
</li>
</ul>

<p>
<code>Контроллер</code> устанавливается непосредственно в проездные стойки и кассовые терминалы
и управляет всем периферийным оборудованием - как встроенным (приём и выдача билетов
и денег), так и внешним (открытие и закрытие шлагбаума, светофоры, датчики).
</p>

<p>
<code>Серверное ПО</code> устанавливается на обычный персональный или серверный компьютер в
защищённом месте, соединяется с контроллерами и другими узлами АСПП с помощью
Ethernet (они могут находиться в разных подсетях и находится далеко друг от друга) и
отвечает за сбор данных о событиях и ошибках со всех подключённых в сеть устройств
АСПП. Через серверное ПО конфигурируются все настройки работы оборудования и
бизнес-логики (управление правами доступа, тарифами и.т.п), программных моделй АСПП
и осуществляется управление шлагбаумами и системой навигации.
</p>
</div>

<div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> Печатные платы контроллера</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
<code>Управляющая плата</code> - печатная плата, представляющая из себя одноплатный
микрокомпьютер на базе микропроцессора архитектуры ARM Cortex-А7/A8/A9.
</p>

<p>
Допускается:
</p>
<ul class="org-ul">
<li>использование готовых решений одноплатных микрокомпьютеров
</li>
<li>варианты микропроцессоров с аналогичными характеристиками
</li>
<li>рассмотрение вариантов микропроцессоров отечественной разработки
</li>
</ul>

<p>
<code>Базовая плата</code> - печатная плата, реализующая базовый необходимый функционал связи
управляющей платы с периферийными устройствами стойки и другими элементами
автоматической парковки. К ней подключается управляющая плата и, при необходимости,
платы расширения и кроссировочная плата.
</p>

<p>
<code>Плата расширения</code> - печатная плата, реализующая дополнительный любой специфический
функционал связи с периферийными устройствами и другим оборудованием автоматической
парковки, а также интеграции с любыми другими системами. Возможна разработка нескольких
плат расширений с различным функционалом.
</p>

<p>
<code>Кроссировочная плата</code> - печатная плата, подключаемая к базовой плате с помощью
широкополосного шлейфа и предназначенная для простого подключения к контроллеру
внешних периферийных устройств с помощью унифицированного разъёма 8P8C (RJ-45).
</p>
</div>
</div>

<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> Программное обеспечение контроллера</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
<code>Программное обеспечение контроллера</code> - операционная система на базе ядра Linux и
развёрнутое на ней сервисное программное обеспечение, оснащённое web-интерфейсом
для настройки и конфигурирования, отвечающее за работу периферийных устройств,
логику работы контроллера и интерфейс для посетителей парковки.
</p>

<p>
<code>Пользовательский web-интерфейс контроллера</code> - web-интерфейс для конфигурирования и
настройки работы контроллера администратором, инженером пуско-наладки или
разработчиком.
</p>

<p>
<code>Клиентский интерфейс стойки</code> - управляемый контроллером интерфейс, обеспечивающий
диалог пароковчной стойки и клиента парковки. Различен для разных стоек и
реализаций, может быть как полностью аппаратным, так и программным, выводимым на
сенсорный дисплей.
</p>
</div>
</div>

<div id="outline-container-sec-2-3-3" class="outline-4">
<h4 id="sec-2-3-3"><span class="section-number-4">2.3.3</span> Компьютеры управления</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
<code>Центральный сервер</code> - это компьютер на архитектуре x86-x64 на котором развёрнута
программа управления парковкой и хранится база данных со всеми настройками системы
и пользователей, а также история событий.
</p>

<p>
<code>Автоматизированная ручная касса</code> - это компьютер к которому подключено
периферийное торговое оборудование, и с помощью которого оператор-кассир парковки
получает доступ к интерфейсу оплаты услуг.
</p>
</div>
</div>

<div id="outline-container-sec-2-3-4" class="outline-4">
<h4 id="sec-2-3-4"><span class="section-number-4">2.3.4</span> Программное обеспечение сервера</h4>
<div class="outline-text-4" id="text-2-3-4">
<p>
<code>Серверное ПО</code> - это программа управления парковкой, через которую осуществляется
настройка всех основных модулей системы и управление парковочной
системой. Серверное ПО имеет ядро, СУБД, web-интерфейс и, как и все компоненты
комплекса, работает с <a href="#sec-7-1">программной лицензионной защитой комплекса</a>.
</p>

<p>
<code>Пользовательский интерфейс сервера</code> - web-интерфейс модуля сервера, к которому
получают доступ операторы, администраторы, бухгалтеры и арендаторы системы. С
помощью него осуществляется управление и конфигурация АСПП и её отдельных модулей.
</p>
</div>
</div>

<div id="outline-container-sec-2-3-5" class="outline-4">
<h4 id="sec-2-3-5"><span class="section-number-4">2.3.5</span> Клиентские программы</h4>
<div class="outline-text-4" id="text-2-3-5">
<p>
<code>Клиентская программа</code> - отдельно устанавливаемое на ПК (рабочую станцию)
программное обеспечение, настраиваемое на взаимодействие с сервером, которое
использует конечный пользователь системы.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Гибкость и масштабируемость</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Юрий: По существу в данном разделе у нас постановка задачи в формате
"хочется чтобы было вот так", а не её решение и обоснование почему это можно, а это
нельзя. Чтобы потом не было вопросов "а где об этом говорилось?". По факту я
развернул идею и расписал что к чему и для чего.
</p>

<p>
Создавая систему необходимо заложить масштабируемость решения и широкий спектр
применения как управляющей платы контроллера, так и контроллера в целом в других
проектах.
</p>

<p>
Основная задача концепции гибкости и мастштабируемости - разработать систему так,
чтобы максимальное число задач решалось в рамках одной ветки версий программного
обеспечения и для уникальных задач не приходилось бы создавать уникальные ветки, а
была бы возможность решать их подключая и отключая модули, как программные
(библиотеки), так и аппаратные (платы расширения).
</p>

<p>
Модули программного обеспечения должны сохранять обратную совместимость друг с
другом (сервер с версиями ПО контроллера). ПО контроллера новой версии должно
сохранять возможность работы с оборудованием, работающим в предыдущих версиях.
</p>

<p>
Все печатные платы должны иметь унифицированные разъёмы подключений для различных
типов устройств и дополнительных плат с описанной в документации спецификацией. При
этом на эти разъёмы должен быть выведен весь заложенный функционал, даже тот,
который мы не используем в непосредственно текущем решении. Платы расширения должны
решать максимальный спектр задач, не требуя при этом вмешательства в схемотехнику и
конструкцию управляющей и базовой плат.
</p>

<p>
Например, в определённый момент возникнет необходимость увеличить количество реле
или COM-портов на контроллере. Данный вопрос должен в большинстве случаев решаться
платами расширения, но в единичных случаях может потребоваться переразводка базовой
платы. В случае возникновения таких аппаратных решений на них должно штатно работать
старое ПО (при этом новый функционал будет не доступен для ПО), а на старых
контроллерах работать новое ПО (при этом ПО будет определять отсутсвие аппаратных
возможностей).
</p>

<p>
   Система должна иметь возможжность интеграции сторонними системами СКУД,
   пожаротушения, оповещения, видеонаблюдения и распознания номеров а/м, а также со
   сторонними системами биллинга и оплаты. Часть этих задач может решаться в на
   аппаратном уровне (резервирование реле и сенсоров, специальные платы расширения,
   RS-485), часть исключительно на программном уровне, что требует создания
   полноценного API.
г
   На базе решения, кроме нескольки вариантов АСПП для плоскостных парковок,
   различающихся по целевому ценовому сегменту, планируется разработать паркоматы и
   систему автоматизации оплаты и проезда для платных дорог, работающие с другим
   периферийным оборудованием и другой бизнес-логикой (программными
   модулями).
</p>

<p>
Ещё одной задачей масштабирования является сведение несколько парковок в
кластер. Локальные парковочные сервера должны по Ethernet соединяться с едиынм
агреггирующим сервером (соединение - "звезда"), что позволит сделать их управляемыми
из единого центра.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Этапы, сроки, задачи</h2>
<div class="outline-text-2" id="text-3">
<p>
Список текущих задач. По факту завершения задачи обязательно закрывать её в статус DONE,
писать сопроводительную записку и переносить весь подраздел задачи с описанием в
соотвествующий данной задаче раздел документации.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> <span class="todo TODO">TODO</span> Краткий список горящих задач&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> <span class="done DONE">DONE</span> Запустить дисплеи на 2 и 4 строки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> <span class="done DONE">DONE</span> Запустить принтер через USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3"><span class="section-number-4">3.1.3</span> <span class="done DONE">DONE</span> Запустить принтер через драйвер CUPS&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-4" class="outline-4">
<h4 id="sec-3-1-4"><span class="section-number-4">3.1.4</span> <span class="todo TODO">TODO</span> Написать драйвер собственный для принтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-5" class="outline-4">
<h4 id="sec-3-1-5"><span class="section-number-4">3.1.5</span> <span class="todo TODO">TODO</span> Запустить принтер через RS232&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-6" class="outline-4">
<h4 id="sec-3-1-6"><span class="section-number-4">3.1.6</span> <span class="todo TODO">TODO</span> Печать сгенерированного штрих-кода&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-7" class="outline-4">
<h4 id="sec-3-1-7"><span class="section-number-4">3.1.7</span> <span class="todo TODO">TODO</span> Обмен данными Wiegand26&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-8" class="outline-4">
<h4 id="sec-3-1-8"><span class="section-number-4">3.1.8</span> <span class="todo TODO">TODO</span> Считывание данных EM Marine&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-9" class="outline-4">
<h4 id="sec-3-1-9"><span class="section-number-4">3.1.9</span> <span class="todo TODO">TODO</span> Запустить сканер штрихкодов через USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-10" class="outline-4">
<h4 id="sec-3-1-10"><span class="section-number-4">3.1.10</span> <span class="todo TODO">TODO</span> Написать драйвер для сканера штрих-кодов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-11" class="outline-4">
<h4 id="sec-3-1-11"><span class="section-number-4">3.1.11</span> <span class="todo TODO">TODO</span> Считывание штрих-кода сканером RS232&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-12" class="outline-4">
<h4 id="sec-3-1-12"><span class="section-number-4">3.1.12</span> <span class="todo TODO">TODO</span> Утилита добавления/удаления тарифов в web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-3-1-12">
<p>
[COMMENT:gmm] Мне надо больше данных о том как это сделать
</p>
</div>
</div>

<div id="outline-container-sec-3-1-13" class="outline-4">
<h4 id="sec-3-1-13"><span class="section-number-4">3.1.13</span> <span class="todo TODO">TODO</span> Утилита добавления/удаления карт ЕМ в web&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-3-1-13">
<p>
[COMMENT:gmm] Мне надо больше данных о том как это сделать
</p>
</div>
</div>

<div id="outline-container-sec-3-1-14" class="outline-4">
<h4 id="sec-3-1-14"><span class="section-number-4">3.1.14</span> <span class="todo TODO">TODO</span> Воспроизведение звука&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-1-15" class="outline-4">
<h4 id="sec-3-1-15"><span class="section-number-4">3.1.15</span> <span class="todo TODO">TODO</span> Видимость sip-устройства в сети&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> <span class="todo TODO">TODO</span> Этапы и сроки</h3>
<div class="outline-text-3" id="text-3-2">
</div><div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> <span class="todo TODO">TODO</span> Пилотный функционал (до 1 марта 2016)</h4>
<div class="outline-text-4" id="text-3-2-1">
</div><ol class="org-ol"><li><a id="sec-3-2-1-1"></a>Рабочий вьезд/выезд по билетам и картам СКУД<br  /><div class="outline-text-5" id="text-3-2-1-1">
<p>
[VRFY:gmm] Проверить достаточны ли описания, запросить если нет.
</p>

<p>
В рамках пилотного проекта нам необходимо реализовать следующий комплект
оборудования стойки:
<i>Въезная / выездная стойка с выдачей бумажного билета, СКУД и IP-связью</i>
</p>

<p>
Должно функционировать следующее периферийное оборудование:
Дисплей символьный 2 строки
Термопринтер Custom VKP80 II
ККМ ИСКАР ПРИМ-21К на базе принтера Custom VKP80 II
Широкополосный сканер штрихкодов Honywell IS3480 QuantumE
Считыватель RFID Matrix EH
Вввод / вывод воспроизведения аудио
</p>

<p>
Должны быть произведены:
4 единицы прототипов базовых плат
4 единицы плат управления
</p>

<p>
Для стойки должны работать следующие базовые алгоритмы работы парковки:
<a href="#sec-4-13-1">Алгоритм простого въезда по чеку <code>barcode</code> <code>enter</code></a>
<a href="#sec-4-13-2">Алгоритм простого выезда по чеку <code>barcode</code> <code>leave</code></a>
<i>Алгоритм проезда по карте СКУД</i>
</p>

<p>
Для реализации процедуры оплаты должен быть реализован:
Алгоритм оплаты с помощью кассы на базе ПК
</p>

<p>
Для стоек въезда и выезда должен быть реализован базовый UI
[TODO:pyub] Битая  <i>Настройки администратора из web-интерфейса контроллера</i>
</p>
</div>
</li>

<li><a id="sec-3-2-1-2"></a><span class="todo TODO">TODO</span> Базовый интерфейс сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-3-2-1-2">
<p>
В рамках пилотного проекта должен быть базовый UI сервера: <i>Web-интерфейс сервера</i>
Необходимо сделать возможность удалённого управления шлагбаумами для оператора,
просмотра логов событий и конфигурирования стоек для адмиинистратора, модуль СКУД,
модуль настройки и рассылки тарифов на стойки и модуль кассира для приёма оплаты за
услуги парковки.
</p>
</div>
</li>

<li><a id="sec-3-2-1-3"></a><span class="todo TODO">TODO</span> Система СКУД Em-Marine&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-3-2-1-3">
<p>
Необходимо реализовать работу карты СКУД стандарта EM-Marine в составе:
</p>
<ul class="org-ul">
<li>функционирующего <i>алгоритма проезда по картам СКУД</i>;
</li>
<li>реализованногов UI сервера <i>модуля СКУД</i> для внесения карт доступа в систему и
управления ими.
</li>
</ul>
</div>
</li>

<li><a id="sec-3-2-1-4"></a><span class="todo TODO">TODO</span> Ручная касса на базе ПК<br  /><div class="outline-text-5" id="text-3-2-1-4">
<p>
Необходимо реализовать <a href="#sec-6-6-7">Модуль кассира</a> для возможности приёма оплаты за услуги
парковки. Кассир, с помощью UI на своём персональном компьютере, должен считывать
информацию со штрих-кода билета (сканером, подключённым к ПК по USB),
самостоятельно принимать оплату, после чего система должны печатать кассовый
чек (на фискальном регистраторе, подключённом к ПК по USB или COM RS-232).
</p>

<p>
В качестве сканера предлагается использовать любой <code>ручной сканер Honeywell/Metrologic Eclipse</code>
</p>

<p>
В качестве фискального регистратора использвать  <code>Штрих-Light-ФР-К (100)</code> или
<code>Искра ПРИМ-08ТК</code>.
</p>

<p>
Для считывания карт EM-Marine используется настольный считыватель <code>IronLogic Z-2 USB</code>.
</p>
</div>
</li>

<li><a id="sec-3-2-1-5"></a><span class="todo TODO">TODO</span> Логирование на сервере&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-3-2-1-5">
<p>
Описано в <a href="#sec-4-5">Логирование сообщений</a>
</p>
</div>
</li>

<li><a id="sec-3-2-1-6"></a><span class="todo TODO">TODO</span> Аудиосвязь стоек и сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li></ol>
</div>
<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> <span class="todo TODO">TODO</span> Функционал второго этапа (с 1 марта 2016)</h4>
<div class="outline-text-4" id="text-3-2-2">
</div><ol class="org-ol"><li><a id="sec-3-2-2-1"></a>Автоматизированная касса купюры + монеты (до 1-15 апреля 2016)<br  /></li>
<li><a id="sec-3-2-2-2"></a>Собственная разводка платы упралвения (до 1 мая 2016)<br  /></li>
<li><a id="sec-3-2-2-3"></a>Работа кассы с банк-терминалами (до 1 июня 2016)<br  /></li>
<li><a id="sec-3-2-2-4"></a>Работа с видеокамерами по событиям (до 1 июня 2016)<br  /></li>
<li><a id="sec-3-2-2-5"></a>Автоматизация продажи абонементов и дебетовых карт на кассе (до 1 июля 2016)<br  /></li>
<li><a id="sec-3-2-2-6"></a>Гибкие системы тарификации (до 1 июля 2016)<br  /></li>
<li><a id="sec-3-2-2-7"></a>Распределение машин по местам на парковке (до 1 июля 2016)<br  /></li></ol>
</div>
<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> <span class="todo WAIT">WAIT</span> Функционал третьего этапа (с 1 авгутса 2016)</h4>
<div class="outline-text-4" id="text-3-2-3">
</div><ol class="org-ol"><li><a id="sec-3-2-3-1"></a>Гибкая реализация подключения периферийных устройств<br  /><div class="outline-text-5" id="text-3-2-3-1">
<p>
см. <a href="#sec-5-1-7">Требования к гибкой реализации подключения периферии</a>
</p>
</div>
</li>

<li><a id="sec-3-2-3-2"></a>Интеграции с API<br  /><div class="outline-text-5" id="text-3-2-3-2">
<p>
SOLVO
NOW!Innowation
</p>
</div>
</li>

<li><a id="sec-3-2-3-3"></a>Распознавание номеров<br  /></li>
<li><a id="sec-3-2-3-4"></a>Шлюзы и распределители<br  /></li>
<li><a id="sec-3-2-3-5"></a>Реализация DSRC<br  /></li></ol>
</div>
<div id="outline-container-sec-3-2-4" class="outline-4">
<h4 id="sec-3-2-4"><span class="section-number-4">3.2.4</span> <span class="todo WAIT">WAIT</span> Дополнительные направления разработки</h4>
<div class="outline-text-4" id="text-3-2-4">
</div><ol class="org-ol"><li><a id="sec-3-2-4-1"></a>Аггрегирующий сервер<br  /></li>
<li><a id="sec-3-2-4-2"></a>Паркомат<br  /></li>
<li><a id="sec-3-2-4-3"></a>Билинг паркомата<br  /></li>
<li><a id="sec-3-2-4-4"></a>Премиум сегмент<br  /><div class="outline-text-5" id="text-3-2-4-4">
<ul class="org-ul">
<li>ресайклеры
</li>
<li>реализация парковки на Mifare+
</li>
<li>сенсорные дисплеи
</li>
</ul>
</div>
</li>
<li><a id="sec-3-2-4-5"></a>Работа с УДПА<br  /></li>
<li><a id="sec-3-2-4-6"></a>Интеграция с системой навигации<br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Задачи общего характера</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> <span class="todo START">START</span> Описание алгоритмов взаимодействия постетителя и АСПП&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> <span class="todo WAIT">WAIT</span> Отладка и интеграционное тестирование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aav">aav</span></span></h4>
</div>
<div id="outline-container-sec-3-3-3" class="outline-4">
<h4 id="sec-3-3-3"><span class="section-number-4">3.3.3</span> <span class="todo WAIT">WAIT</span> Проверка элементов системы на макете прототипа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></h4>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Задачи hardware</h3>
<div class="outline-text-3" id="text-3-4">
</div><div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> <span class="done DONE">DONE</span> Выбор микрокомпьютера для контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
Для прототипирования выбран микрокомпьютер: <code>EMBEST BeagleBone Black Rev C</code>
Информация о микрокомпьютере:  <a href="http://beagleboard.org/support/bone101">http://beagleboard.org/support/bone101</a>
</p>

<p>
Данный микрокомпьюетр использует микропоцессор <code>ARM TI AM3358</code> с архитектурой
ARM hard float. Информация о микропроцессоре: <a href="http://www.ti.com/product/AM3359">http://www.ti.com/product/AM3359</a>
</p>

<p>
Основной проблемой при использовании непосредственно данного решения является
требование разработчика к лицензированию <code>Creative Commons</code> с условиями
<code>Attribution-ShareAlike</code> (CC BY-SA). Эта лицензия позволяет другим редактировать,
поправлять и брать за основу произведение даже в коммерческих целях до тех пор
пока они указывают ваше авторство и лицензируют свои новые творения на идентичных
условиях. Эта лицензия часто сравнивается с «копилефтными» свободными и «open
source»-лицензиями на программное обеспечение. Все новые произведения основанные на
ваших будут распространяться по той же лицензии, так любые производные произведения
будут также разрешать коммерческое использование.
</p>

<p>
Прочесть об условиях лицензии можно здесь:
<a href="https://ru.wikipedia.org/wiki/%D0%9B%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D0%B8_%D0%B8_%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B_Creative_Commons">https://ru.wikipedia.org/wiki/%D0%9B%D0%B8%D1%86%D0%B5%D0%BD%D0%B7%D0%B8%D0%B8_%D0%B8_%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B_Creative_Commons</a>
<a href="http://creativecommons.ru/licenses">http://creativecommons.ru/licenses</a>
</p>

<p>
В качестве варианта рассматривается использование функционального аналога BBB -
де-факто промышленной копии BBB <code>Mentorel uSomIQ AM335x</code> с платой <code>uSomIQ BoneCape</code>
не попадающей под условия лицензии CC BY-SA.
</p>

<p>
Прочесть о нём:
<a href="http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/">http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/</a>
<a href="http://www.mentorel.ru/product/usomiq-bonecape/">http://www.mentorel.ru/product/usomiq-bonecape/</a>
</p>

<p>
В дальнейшем предполагается собственное проектирование и разводка управляющей платы
на базе процессора <code>ARM TI AM335x</code>, оптимизированное и адаптирования под требования
к контроллеру АСПП.
</p>

<p>
Все существующие требования по оптимищации собраны в разделе:
<a href="#sec-14">Оптимизация аппаратной части решения</a>
</p>
</div>
</div>

<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> <span class="done DONE">DONE</span> Покупка плат BeagleBone Black и Development Kit&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-3-4-3" class="outline-4">
<h4 id="sec-3-4-3"><span class="section-number-4">3.4.3</span> <span class="done DONE">DONE</span> Подбор редких комплектующих для платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
Сформирован список: <a href="https://octopart.com/bom-lookup/g1agjT7N/75pqkJDrUqGv7qrq">https://octopart.com/bom-lookup/g1agjT7N/75pqkJDrUqGv7qrq</a>
</p>
</div>
</div>
<div id="outline-container-sec-3-4-4" class="outline-4">
<h4 id="sec-3-4-4"><span class="section-number-4">3.4.4</span> <span class="done DONE">DONE</span> Дерганье ногами на BBB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
<a href="http://hertaville.com/introduction-to-accessing-the-raspberry-pis-gpio-in-c.html">http://hertaville.com/introduction-to-accessing-the-raspberry-pis-gpio-in-c.html</a>
</p>
</div>
</div>

<div id="outline-container-sec-3-4-5" class="outline-4">
<h4 id="sec-3-4-5"><span class="section-number-4">3.4.5</span> <span class="done DONE">DONE</span> Подбор основной части комплектующих для платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span></span></h4>
</div>
<div id="outline-container-sec-3-4-6" class="outline-4">
<h4 id="sec-3-4-6"><span class="section-number-4">3.4.6</span> <span class="done DONE">DONE</span> Поиск и заказ идущих долго комплектующих&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span>&#xa0;<span class="bda">bda</span></span></h4>
<div class="outline-text-4" id="text-3-4-6">
<p>
Необходимо по спискам из задач подбора комплектующих найти поставщиков в России
через данный ресурс: <a href="http://passport.efind.ru/org/">http://passport.efind.ru/org/</a>
Далее, сделать заказ по списку.
</p>
</div>
</div>

<div id="outline-container-sec-3-4-7" class="outline-4">
<h4 id="sec-3-4-7"><span class="section-number-4">3.4.7</span> <span class="done DONE">DONE</span> Трассировка базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></h4>
</div>
<div id="outline-container-sec-3-4-8" class="outline-4">
<h4 id="sec-3-4-8"><span class="section-number-4">3.4.8</span> <span class="done DONE">DONE</span> Трассировка платы расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></h4>
</div>
<div id="outline-container-sec-3-4-9" class="outline-4">
<h4 id="sec-3-4-9"><span class="section-number-4">3.4.9</span> <span class="todo TODO">TODO</span> Обеспечить возможность дергать ногами GPIO при отправке JSON-а&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
</div>
<div id="outline-container-sec-3-4-10" class="outline-4">
<h4 id="sec-3-4-10"><span class="section-number-4">3.4.10</span> <span class="done DONE">DONE</span> Обеспечить возможность управлять дисплеем через JSON&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
</div>
<div id="outline-container-sec-3-4-11" class="outline-4">
<h4 id="sec-3-4-11"><span class="section-number-4">3.4.11</span> <span class="todo TODO">TODO</span> RTC needed (battery etc.)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
<div id="outline-container-sec-3-4-12" class="outline-4">
<h4 id="sec-3-4-12"><span class="section-number-4">3.4.12</span> <span class="todo WAIT">WAIT</span> Макетирование прототипа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Задачи software контроллер</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Описание конечно-автоматной работы системы и ее верификации.
</p>
</div>

<div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> <span class="todo TODO">TODO</span> Описать <code>happy-cases</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-3-5-1">
</div><ol class="org-ol"><li><a id="sec-3-5-1-1"></a><span class="todo START">START</span> На алгоритмы проезда<br  /></li>
<li><a id="sec-3-5-1-2"></a><span class="todo TODO">TODO</span> На алгоритмы оплаты<br  /></li>
<li><a id="sec-3-5-1-3"></a><span class="todo TODO">TODO</span> Совмещенные алгоритмы<br  /></li></ol>
</div>
<div id="outline-container-sec-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> <span class="todo TODO">TODO</span> Составление исполняемой спецификации, внесение описаний работы и кейсов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-3" class="outline-4">
<h4 id="sec-3-5-3"><span class="section-number-4">3.5.3</span> <span class="done DONE">DONE</span> Выделить состояния контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-4" class="outline-4">
<h4 id="sec-3-5-4"><span class="section-number-4">3.5.4</span> <span class="todo TODO">TODO</span> Список событий контроллера (стоек)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-3-5-5" class="outline-4">
<h4 id="sec-3-5-5"><span class="section-number-4">3.5.5</span> <span class="todo START">START</span> Декларативное описание конечных автоматов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-6" class="outline-4">
<h4 id="sec-3-5-6"><span class="section-number-4">3.5.6</span> <span class="done DONE">DONE</span> Написание генератора кода модели системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-7" class="outline-4">
<h4 id="sec-3-5-7"><span class="section-number-4">3.5.7</span> <span class="todo START">START</span> Ручная верификация работы системы на модели&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-8" class="outline-4">
<h4 id="sec-3-5-8"><span class="section-number-4">3.5.8</span> <span class="todo START">START</span> Расширение модели рабочим кодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-9" class="outline-4">
<h4 id="sec-3-5-9"><span class="section-number-4">3.5.9</span> <span class="todo TODO">TODO</span> Автоматическая верификация работы системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-10" class="outline-4">
<h4 id="sec-3-5-10"><span class="section-number-4">3.5.10</span> <span class="todo TODO">TODO</span> Тестирование рабочего кода на прототипе устройства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
</div>
<div id="outline-container-sec-3-5-11" class="outline-4">
<h4 id="sec-3-5-11"><span class="section-number-4">3.5.11</span> <span class="todo TODO">TODO</span> Создание UI web-интерфейса для настройки контроллера</h4>
</div>
</div>
<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Задачи периферии контроллера</h3>
<div class="outline-text-3" id="text-3-6">
</div><div id="outline-container-sec-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> <span class="todo TODO">TODO</span> Создание списка периферии и сведение документации по ней&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
</div>
<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7"><span class="section-number-3">3.7</span> <span class="todo TODO">TODO</span> Задачи сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-3-7">
</div><div id="outline-container-sec-3-7-1" class="outline-4">
<h4 id="sec-3-7-1"><span class="section-number-4">3.7.1</span> <span class="todo WAIT">WAIT</span> Разработка структуры БД</h4>
</div>
<div id="outline-container-sec-3-7-2" class="outline-4">
<h4 id="sec-3-7-2"><span class="section-number-4">3.7.2</span> <span class="todo WAIT">WAIT</span> Разработка софтверной части для сервера</h4>
</div>
<div id="outline-container-sec-3-7-3" class="outline-4">
<h4 id="sec-3-7-3"><span class="section-number-4">3.7.3</span> <span class="todo WAIT">WAIT</span> Разработка интерфейса сервера</h4>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Описание функционирования</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> Общий принцип работы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-1">
<p>
Посетителль на автомобиле въезжает в зону действия <a href="#sec-8-1-1">датчика присутствия автомобиля</a>,
нажимает на кнопку и получает въездной документ, которым может являться либо
<a href="#sec-4-3-1">бумажный въездной билет со штрихкодом</a>, либо пластиковую карту <a href="#sec-4-3-4">RFID Mifare+</a>.
</p>

<p>
Одноразовый въездной документ ему выдаётся термопринтером в случае бумажных билетов
или диспенсером карт совмещённым со считывателем RFID в случае карт Mifare+.
</p>

<p>
После того как пользователь забирает документ, открывается шлагбаум. Взятие документа
пользователем мы ослеживаем общаясь с выдающим его устройством, если это возможно.
</p>

<p>
Для постоянных посетителей парковки и арендаторов предусмотрены карты многоразового
использования - это RFID Em-Marine, Mifare+ или SDRC. Таки пропуска просто
прикладываются к сканеру на стойке (или сканируются на расстоянии) и система
определяет - возможен въезд посетителя на парковку или нет. Если возможен -
открывает шлагбаум.
</p>

<p>
Во время проезда машины под стрелой шлагбаума его закрытие невозможно - наличие
автомобиля фиксируется фотоэлементом на линии стрелы и датчиком за ней. Фотоэлемент
отключаем настройкой "<i>включить проверку фотоэлемента безопасности</i>".
</p>

<p>
По факту проезда шлагбаум закрывается. После въезда начинается допустимое бесплатное
время нахождения на парковке.
</p>

<p>
Также имеется возможность попасть на парковку по бесконтактным картам доступа
<a href="#sec-4-3-3">RFID Em-Marine</a>, которые заранее программируются и выдаются клиентам (система СКУД для
постоянных клиентов и владельцев).
</p>

<p>
Далее посетитель парковки должен произвести оплату парковочного времени. Это возможно
сделать тремя осовными способами:
</p>
<ul class="org-ul">
<li>оплатить на автоматической кассе
</li>
<li>оплатить на ручной кассе (ПК на котором оператор в программе принимает оплату)
</li>
<li>акцептировать билет у одного из арендаторов (сбросить время или перевести его на
счёт арендатора)
</li>
</ul>
<p>
В рамках пилотного проекта мы делаем только оплату на ручной кассе, где кассир
сообщает системе о проведенной оплате через броузер.
</p>

<p>
В любом случае информация с билета считывается с помощью сканера штрих кодов (для
карт Mifare будет использоваться считыватель-программатор), либо на ПК вводом
буквенно-цифрового кода с билета. При считывании посетителю сообщается сумма оплаты,
которую он должен внести. По факту приёма оплаты печатается кассовый чек, он же
выездной билет, а въездной билет аннулируется. Кроме оплаты билет может быть
акцептирован арендатором с помощью специальной карты или акцептирован на ПК.
</p>

<p>
 Стоимость парковки может варьироваться в зависимости от времени пребывания на ней,
тарифной сетки (разные тарифы в разное время суток и дни недели) и <i>тарифных зон</i> (на
одной парковке может быть несколько секторов, в каждом из которых парковка
оплачивается по разному, между ними стоят проездные стойки).
</p>

<p>
После оплаты устанавливается допустимое время нахождения на парковке до выезда. Если
посетитель находится больше времени, чем было установлено администратором парковки,
ему необходимо снова оплачивать время. Бесплатное время настраивается со всеми
тарифами в <i>web-интерфейсе контроллера</i> или сервера.
</p>

<p>
На выезде посетитель парковки при попадании автомобиля в зону действия датчика
присутствия подносит свой билет к сканеру штрих кодов и, если допустимое время
нахождения на парковке не истекло, ему позволяется покинуть парковку (в случае
Mifare карт карта вставляется в приемник и он её заглатывает). Также выхеать можно
по EM Marine карте.
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <span class="todo TODO">TODO</span> Парковочные места, тарифные зоны и сектора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> <span class="todo TODO">TODO</span> Тарифная зона&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Необходимо реализовать гибкую систему тарифов, при этом постаравшись
максимально сохранить автномность системы в случае падения связи с
сервером.
</p>

<p>
Основные единые настройки бесплатного времени:
</p>
<ul class="org-ul">
<li>бесплатное время после въезда (мин)
</li>
<li>бесплатное время на выезд после оплаты (мин)
</li>
</ul>

<p>
Эти характеристики должны быть индивидуальны для разных секторов парковки. Т.е.,
например, в секторе открытого паркинга одни тарифы, а в секторе закрытого -
другие. Между секторами стоит проездная стойка со сканером штрих кодов (для Mifare
парковки это сделать проще в автономном режиме). При поднесении она переносит на
сервере и всех соседних стойках билет в другой сектор. При этом если машина отстояла
t1 времени в одном секторе, а потом поехала в другой, то данные по оплате
суммируется, а бесплатное время во втором секторе не считается.
</p>

<p>
Основые вещи:
</p>
<ul class="org-ul">
<li>Со скольки до скольки работает парковка (осуществляется впуск и выпуск)
Допустимо по картам СКУД пускать например круглосуточно, а по чекам - только днем
</li>
<li>Бесплатное время - время, которое машина может стоять на парковке до требования
оплаты. В течении его она может выехать бесплатно.
</li>
<li>Время на выезд - время за которое машина может покинуть парковку после оплаты
водителем в кассе. Если не успел - время на выезд не учитывается.
</li>
<li>Штраф - сумма, которая взимается с человека, если он потерял вьездной документ.
</li>
<li>Стоимость часов исходя из того, что имеются следующие основыне тарифные характеристики:
<ul class="org-ul">
<li>стоимость 1го..2го..23го..24го.. часа после истечения бесплатного времени
</li>
</ul>
</li>
<li>коэффициент стоймости в зависимости от времени суток (с 20:00 до 22:00 k=2, с 9:00 до 18:00 k=0,5)
</li>
<li>коэффицикнт стоймости в зависимости от дня недели (пн, вт, ср, чт, пт k2=1, сб,вс k2=2)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> <span class="todo TODO">TODO</span> Сектор парковки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
Секторальность - например есть крытая и открытая система парковки, между ними
стойка. Если пользователь на ночь хочет на закрытую парковку - там другой тариф,
все это надо считать, суммируя. В пилотном проекте не делаем, но учитывать нужно
при программировании системы тарифов.
</p>
</div>
</div>

<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> <span class="todo TODO">TODO</span> Распределение паркомест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
[TODO:pyub] Здесь должен быть алгоритм распределения машин на конкретные паркоместа
на въезде на парковку по ТЗ аналогичному ЛенСпецСМУ.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> <span class="done DONE">DONE</span> Виды проездных документов и информация на них&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-3">
<p>
АСПП может работать с различными типами проездных документов - одноразовыми
бумажными билетами (печать на термобумаге) и многоразовыми RFID-метками (как
правило - пластиковыми картами) различных стандартов.
</p>
</div>

<div id="outline-container-sec-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> <span class="done DONE">DONE</span> Бумажный въездной билет со штрихкодом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
[VRFY:noa:aav:bvl] Всё это было обсуждено на большом субботнем совещании и
дополнительно с Олегом. Прошу проверить и задать вопросы, если что-то не понятно.
</p>

<p>
Въездной билет печатается при въезде посетителя на парковку на термочувствительной
бумаге. Посетитель забирает его и хранить в течении всего времени пребывания на
парковке. Этот документ является одноразовым, т.е. по нему человек только один раз
выехать или оплатить услуги парковки.
</p>

<p>
Для печати билетов использоваться рулоны бумаги шириной 57 мм или 80 мм, в
зависисмости от термопринтера. На бумагу шириной 44 мм мы не рассчитываем.  Таким
образом, вся информация, размещаяемая на билете, должна умещатться в столбец
шириной 54 мм. Возможно сделать масштабируемость размера шрифта текста в
зависимости от настроек бумаги, выставленных программно, но это в перспективе.
</p>

<p>
На въездном билете всегда печатается следующая информация:
</p>
<ul class="org-ul">
<li>данные о въезеде открытым читаемым текстом
</li>
<li>данные о въезде зашифрованные в машинночитаемый штрихкод
</li>
</ul>

<p>
При наличии соответсвующей настройки также может печататься:
</p>
<ul class="org-ul">
<li>блок вносимой через UI настройки текстовой информации
</li>
<li>монохромное графическое изображение, загружаемое через UI настройки
</li>
</ul>

<p>
Открытым текстом должны быть напечатаны:
</p>
<ul class="org-ul">
<li>уникальный номер (ID) билета в системе
</li>
<li>дата и время въезда
</li>
<li>массогабаритные характеристики ТС посетителя (например: легковой или грузовой)
</li>
<li>номер стойки через которую был совершен въезд
</li>
<li>номер сектора к которому относится въездная стойка
</li>
<li>номер назначенного посетителю места из вирутального диапазона мест
</li>
</ul>

<p>
Опционально <code>номер места</code> должен печататься крупно (возможно - изображением) для
систем, подразумевающих направление машин на номерные места или интеграцию с
системами контроля мест и навигации. Формат вывода управляется флаагом в настройках
печати билета. Если алгоритм направления машин на номерные места активирован,
должно также печататься название / <code>номер сектора назначения</code> (например, этаж
2). Эта опция управляется флагом в <code>настройках секторов и мест парковки</code>.
</p>

<p>
Опционально - <code>время работы сектора парковки</code> автоматически забираемое из
настроек. Опция управляется флагом в <code>настройках печати билета</code>.
</p>

<p>
Опционально - автоматически генерируемые <code>данные о тарифе в текущей зоне</code>. Опция
управляется флаагом в <code>настройках печати билета</code>.
</p>

<p>
Опционально, при наличии модуля распознания государственных знаков (номеров)
транспортных средств, на чеке печатается номер автомобиля, определённый на въезде.
</p>

<p>
Пример текста на билете:
<code>=======================</code>
ДОБРО ПОЖАЛОВАТЬ!
<code>=======================</code>
ID 000000001
Въезд: 12:00 01.01.2016
Тип т/с: легковой
Гос. знак: А0000АА 78RUS
Стойка 1, сектор 1
<code>=======================</code>
проследуйте на место
МЕСТО 0201
в секторе 2
<code>=======================</code>
Выезд 1 работает:
с 09:00 до 22:00
Выезд 2 работает:
круглосуточно
В тарифной зоне 1:
20 минут - бесплатно
1 час - 100 руб.
более 3 часов - 50 руб.
В тарифной зоне 2:
1 час - 100 руб.
после 22:00 - 200 руб.
<code>=======================</code>
Телефон для справок:
8(812)000-00-00
</p>

<p>
<code>Штрихкод</code> должен быть зашифрован, чтобы избежать попыток подстановки данных со
стороны посетителя. Также на каждой парковке должен использоваться уникальный ключ
шифрования, выставляемый в системе, во избежании использования одних и тех же
билетов на разных парковках.
</p>

<p>
В штрикоде зашифрована следующая информация:
</p>
<ul class="org-ul">
<li>номер стойки через которую был совершен въезд
</li>
<li>номер сектора к которому относится въездная стойка
</li>
<li>номер места из вирутального диапазона мест, приписанных к сектору
</li>
<li>дата и время вьезда
</li>
<li>массогабаритные характеристики ТС посетителя (например: 0 = легковой, 1 = средний, 2 = грузовик)
</li>
</ul>

<p>
[COMMENT:pyub] Общая оценка используемых бит данных:
</p>
<ul class="org-ul">
<li>№ стойки - 8 байт, 2 символа
</li>
<li>№ сектора - 8 байт, 2 символа
</li>
<li>№ места - 16 байт, 4 символа
</li>
<li>дата, время - 32 байта, unix-time
</li>
<li>тип ТС - 2 байта, 1 символ
</li>
</ul>

<p>
Переоценка:
</p>
<ul class="org-ul">
<li># стойки:    7 бит  (0 - 127)
</li>
<li># сектора:   6 бит  (0 - 63)
</li>
<li># места:    16 бит  (0 - 65535)
</li>
<li>Дата/время: 32 бита (до 19.01.2038)
</li>
<li>тип ТС:      3 бита (0 - 7)
</li>
</ul>
<p>
ИТОГО         64 бита = 8 байт
</p>

<p>
Шифрование проводим над получившейся группой 8 байт, на выходе получаем столько же
байт, передаем на нижний уровень.
</p>

<p>
На нижнем уровне:
Представляем это как массив битов длиной 64, разбиваем на группы по 6 (11 групп),
каждую группу методом "+0х30" переводим в соответствие символам 0х30-0х6F ASCII.
Из строки этих символов генерируем штрих-код по стандарту <code>Code 128-C</code>.
</p>

<p>
При считывании штрихкода операции проводятся в обратном порядке, на верхний
уровень отдаются 8 байт без расшифровки.
</p>

<p>
Предлагаемые стандарты шифрования штрихкода:
<code>Code 128</code> или <code>EAN-128</code>
</p>

<p>
Шифрование и дешифрование данных осуществляется на уровне бизнес-логики. Ключ
шифрования для каждой парковки уникальный, предполагается, что он может быть зашит
в файл лицензии, подробнее о котором можно прочесть в разделе:
<a href="#sec-7-1">Программная лицензионная защита комплекса</a>
</p>

<p>
Нижний уровень системы получает от бизнес-логики уже зашифрованные данные и
архивирует их, после чего получившийся архив преобразует в
штрихкод. Предполагается, что буквенно-цифровое представление штрихкода - это и
есть уникальный ID билета в системе, которым мы оперируем. После въезда автомобиля
он рассылается всем стойкам и серверу и далее, в процессе движения посетителя по
парковке, мы персонализируем его действия с оборудованием именно по ID его билета.
</p>

<p>
Возможно сопоставление уникального ID билета некому виртуальному четрёхзачному или
шестизначному номеру билета (из сквозного списка 1 - 9999) на сервере системы для
интеграции со сторонними системами.
</p>

<p>
Документация по принтер находится тут:
<a href="file://asp/devices/barcode_thermal_printer">devices/barcode<sub>thermal</sub><sub>printer</sub></a>
</p>
</div>
</div>

<div id="outline-container-sec-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> <span class="done DONE">DONE</span> Бумажный выездной билет / кассовый чек со штрих-кодом</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Выездной билет печатается автоматической кассой или кассой на базе ПК после оплаты
посетителем услуг парковки и является как правило одновременно кассовым чеком -
документом, прошедшим через дополнительный модуль принтера, поставленный на учёт в
налоговой и имеющйи ЭКЛЗ, и несущим на себе фискальный признак. Нефискльный чек по
факту опалты может печататься в случаях, если оборудование эксплуатируется ИП или
вне пределов РФ, где другие законы. Тогда мы ставим в кассу не фискальный
регистратор, а обычный принтер и печатаем выездные чеки на нём.
</p>

<p>
В России на кассовых чеках печатается признак фискального режима - буквы Ф, ФП или
ПФП. Также для верификации кассовых чеков используется КПК - криптографический
проверочный код, он печатается в конце кассового чека и позволяет проверить
кассовый чек на подлинность.
</p>

<p>
Также выездной билет / кассовый чек печатается при оплате штрафа за утерю въездного
билета по установленному тарифу.
</p>

<p>
Для печати выездного билета / кассового чека используется такая же бумага, как и
для печати въездного билета.
</p>

<p>
На въездном билете всегда печатается следующая информация:
</p>
<ul class="org-ul">
<li>данные о том, за какие услуги и сколько заплатил человек открытым читаемым текстом
</li>
<li>данные, которые необходимо печатать на кассовом чеке по закону РФ
</li>
<li>данные о факте и времени оплаты зашифрованные в машинночитаемый штрихкод
</li>
</ul>

<p>
При наличии соответсвующей настройки также может печататься:
</p>
<ul class="org-ul">
<li>блок вносимой через UI настройки текстовой информации
</li>
<li>монохромное графическое изображение, загружаемое через UI настройки
</li>
</ul>

<p>
Открытым текстом должны быть напечатаны:
</p>
<ul class="org-ul">
<li>уникальный номер (ID) билета в системе
</li>
<li>дата и время въезда на парковку / оплата штрафа
</li>
<li>номер кассы на которой была совершена оплата
</li>
<li>время на выезд с парковки после оплаты
</li>
</ul>

<p>
Открытым текстом должны быть напечатаны кассовые данные (они же передаются в ФР и
записываются на ЭКЛЗ). Формат этих данных определяется законодательством РФ и
протоколом обмена данными с конкретной моделью фискального регистратора. В них
должны быть:
</p>
<ul class="org-ul">
<li>организационно-правовая форма и наименование продавца
</li>
<li>ИНН продавца
</li>
<li>фактический адрес размещения ККМ
</li>
<li>номер ККМ в налоговых органах
</li>
<li>СПНД - сквозной порядковый номер документа в памяти ККМ
</li>
<li>номер кассовой смены
</li>
<li>информация о кассире
</li>
<li>дата и время операции по оплате услуг
</li>
<li>перечень товаров и услуг, купленных покупателем
</li>
<li>итоговая сумма
</li>
<li>скидки и бонусы
</li>
<li>фискальный признак
</li>
<li>криптографический проверочный код
</li>
<li>тип оплаты (наличные / карта)
</li>
</ul>

<p>
[TODO:pyub:gmm] Разобраться что там вообще должно быть и как.
</p>

<p>
Под фискальной и польщовательской информацией должен печататься штрихкод по
которому посетитель сможет выехать, зашифрованный аналогично штрихкоду на въездном билете.
</p>

<p>
В штрикоде зашифрована следующая информация:
</p>
<ul class="org-ul">
<li>номер кассы через которую была совершена оплата
</li>
<li>дата и время оплаты
</li>
</ul>

<p>
Предлагаемые стандарты шифрования штрихкода:
<code>Code 128</code> или <code>EAN-128</code>
</p>
</div>
</div>

<div id="outline-container-sec-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> <span class="todo TODO">TODO</span> RFID Em-Marine&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
Форм-фактор карты: 86х54 мм
Тип карты: Em-Marine 125 кГц
</p>

<p>
Также возможно использование любых Em-Marine совместимых меток, брелков, и т.п., но
не в варианте работы с картоглотателями.
</p>

<p>
devices/wiegand<sub>26</sub> - описание протокола
devices/rfid<sub>matrix</sub><sub>eh</sub> - документация по считывателю Em-Marine Iron Logic Matrix EH
devices/rfid<sub>matrix</sub><sub>v</sub> - документация по считывателю Em-Marine Iron Logic Matrix V
</p>
</div>
</div>

<div id="outline-container-sec-4-3-4" class="outline-4">
<h4 id="sec-4-3-4"><span class="section-number-4">4.3.4</span> <span class="todo WAIT">WAIT</span> RFID Mifare+&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
Форм-фактор карты:
Тип карты:
</p>

<p>
devices/wiegand<sub>26</sub> - описание протокола
<a href="file://asp/devices/rfid_matrix_mf">devices/rfid<sub>matrix</sub><sub>mf</sub></a> - описание устрйоств на Mifare+
<a href="file://asp/devices/rfid_card_issuince">devices/rfid<sub>card</sub><sub>issuince</sub></a>- описание устройства для выдачи карт
<a href="file://asp/devices/rfid_card_collector">devices/rfid<sub>card</sub><sub>collector</sub></a>- описание устройства для приёма карт
<a href="file://asp/devices/rfid_card_recycler">devices/rfid<sub>card</sub><sub>recycler</sub></a> - описание устройства для выдачи и приёма карт
</p>
</div>
</div>

<div id="outline-container-sec-4-3-5" class="outline-4">
<h4 id="sec-4-3-5"><span class="section-number-4">4.3.5</span> <span class="todo WAIT">WAIT</span> RFID DSRC&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> <span class="todo TODO">TODO</span> Кассовые и сервисные документы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-4-4">
<p>
[TODO:gmm] Разобраться со стандартными операциями с ККМ, внести описание получаемых
документов и производимых операций сюда.
</p>

<p>
Кассовыми документами являются все чеки, связаннные с кассово-бухгалтерским порядком
и финансовой системой парковки. Они необходимы для работы персонала с финансами и
для подтверждения постетителю факта оказания услуг.
</p>

<p>
В случае работы кассы с фискальным регистратором, все они фиксируются в фискальном
модуле и на ЭКЛЗ устройства. В случае работы с принтером - мы просто выводим на чек
информацию в установленном порядке.
</p>
</div>

<div id="outline-container-sec-4-4-1" class="outline-4">
<h4 id="sec-4-4-1"><span class="section-number-4">4.4.1</span> <span class="todo TODO">TODO</span> Кассовый чек на покупку карты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
Кассовый чек, печатаемый при покупке посетителем абонементной или дебетовой карты
де-факто не является проездным документом и не несёт на себе штрихкода, в остальном
же он абсолютно идентичен выездному кассовому чеку.
</p>

<p>
[COMMENT:pyub] Пишу здесь, чтобы не забыть. Если мы хотим продавать карты и при
этом брать за них залоговую стоимость сверху оплаты услуг, а потом автоматизировать
возврат этих карт - надо подумать над собственно механизмом возврата клиенту
денежных средств с точки зрения а) законодательства б) работы с фискальным
регистратором.
</p>
</div>
</div>

<div id="outline-container-sec-4-4-2" class="outline-4">
<h4 id="sec-4-4-2"><span class="section-number-4">4.4.2</span> <span class="todo WAIT">WAIT</span> Х-отчёт&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-3" class="outline-4">
<h4 id="sec-4-4-3"><span class="section-number-4">4.4.3</span> <span class="todo WAIT">WAIT</span> Z-отчёт&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-4" class="outline-4">
<h4 id="sec-4-4-4"><span class="section-number-4">4.4.4</span> <span class="todo WAIT">WAIT</span> Инкассация&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-5" class="outline-4">
<h4 id="sec-4-4-5"><span class="section-number-4">4.4.5</span> <span class="todo WAIT">WAIT</span> Изъятие средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-6" class="outline-4">
<h4 id="sec-4-4-6"><span class="section-number-4">4.4.6</span> <span class="todo WAIT">WAIT</span> Внесение средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-7" class="outline-4">
<h4 id="sec-4-4-7"><span class="section-number-4">4.4.7</span> <span class="todo WAIT">WAIT</span> Возврат&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-8" class="outline-4">
<h4 id="sec-4-4-8"><span class="section-number-4">4.4.8</span> <span class="todo WAIT">WAIT</span> Ошибка платежа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-4-4-9" class="outline-4">
<h4 id="sec-4-4-9"><span class="section-number-4">4.4.9</span> <span class="todo WAIT">WAIT</span> Сервисный билет&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> <span class="todo TODO">TODO</span> Логирование сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-5">
<p>
Контроллеры взаимодействуют между собой и сервером через отправку и получение
<i>сообщений</i>.
</p>

<p>
Все сообщения должны писаться в лог-файл. Основное место хранения лога работы
системы - сервер. Каждый контроллер ведёт свою отдельную историю, храня в своей
памяти сообщения за время t (или определённое кол-во сообщений), дублируя эти данные
на агрегирующий сервер, где они собираются в единый лог. В случае отсутствия связи
контроллер перестаёт удалять сервисные сообщения из своего лога, собирая "хвост"
вплоть до появления связи. Если место для сообщений заканчивается, а связь не
появилась - возможно удаление некритичных сообщений и запись на их место критичных.
</p>

<p>
Необходимо обеспечить постоянную запись истории работы системы:
</p>
<ul class="org-ul">
<li>проходящих штатно событий (например, события выезда, события выезд, произошедшей оплаты);
</li>
<li>кодов известных ошибок в работе контроллера и основного ПО;
</li>
<li>кодов известных ошибок в работе периферийного оборудования (обработка кодов ошибок из протоколов взаимодействия самих устройств);
</li>
<li>кодов известных ошибок возникающих при нарушении связи между контроллерами и / или сервером;
</li>
<li>сообщений о неизвестных ошибках.
</li>
</ul>

<p>
Контроллер держит в своей постоянной памяти на SD-карте единовременно лог событий не
превышающий установленное в <i>настройках логирования событий</i> количество записей. В нём
же управляется объем информации лога (по объёму или по глубине времени хранения
бэкапа) хранимой на SD-карте.
</p>

<p>
В случае выхода из строя SD карты стойка уходит автоматически обрабатывает это
событие и в <a href="#sec-4-6-9">cостояние полной блокировки (<code>hardlock</code>)</a>.
</p>

<p>
При этом он постоянно отправляет сообщения об ошибках на агрегирующий сервер, где
они систематизируются в доступном для оператора или администратора виде и хранятся
долгосрочно. Если связь нарушена, контроллер сохраняет сообщения сверх
установленного количеств записей вплоть до заполнения памяти.
</p>
</div>
</div>

<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> <span class="todo TODO">TODO</span> Состояния стойки при проезде&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-4-6">
<p>
definition: <a href="#sec-8-7">Стойка</a>
</p>

<p>
[TODO:gmm] Проверить и актуализировать с учетом новых данных.
</p>

<p>
Независимо от используемого комплекта периферийного оборудования контроллера при
въезде он может находится в следующих состояниях:
</p>

<table id="checkpoint_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Состояния конечного автомата стойки</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">selftest-to-lock</td>
<td class="left">selftest</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">selftest-to-standby</td>
<td class="left">selftest</td>
<td class="left">standby</td>
</tr>

<tr>
<td class="left">standby-to-lock</td>
<td class="left">standby</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">standby-to-finding</td>
<td class="left">standby</td>
<td class="left">finding</td>
</tr>

<tr>
<td class="left">finding-to-lock</td>
<td class="left">finding</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">finding-to-dialog</td>
<td class="left">finding</td>
<td class="left">dialog</td>
</tr>

<tr>
<td class="left">dialog-to-lock</td>
<td class="left">dialog</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">dialog-to-init</td>
<td class="left">dialog</td>
<td class="left">init</td>
</tr>

<tr>
<td class="left">init-to-lock</td>
<td class="left">init</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">init-to-goon</td>
<td class="left">init</td>
<td class="left">goon</td>
</tr>

<tr>
<td class="left">goon-to-lock</td>
<td class="left">goon</td>
<td class="left">lock</td>
</tr>

<tr>
<td class="left">goon-to-fin</td>
<td class="left">goon</td>
<td class="left">fin</td>
</tr>
</tbody>
</table>

<p>
[TODO:pyub] не описано состояние fin. Оно тождественно standby?
</p>

<p>
Теперь мы можем полностью описать поведение стойки как конечный автомат:
</p>


<div class="figure">
<p><img src="img/in-state.png" alt="in-state.png" />
</p>
</div>
</div>

<div id="outline-container-sec-4-6-1" class="outline-4">
<h4 id="sec-4-6-1"><span class="section-number-4">4.6.1</span> <span class="todo TODO">TODO</span> Состояние запуска (<code>poweron</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-4-6-1">
<p>
<code>poweron</code> - состояние старта бизнес-логики.
</p>

<p>
В это состояние мы выходим по итогам запуска системы:
<a href="#sec-5-5">Алгоритм запуска программного обеспечения</a>
</p>

<p>
В данном состоянии проводится первичная проверка настроек бизнес-логики (то что мы
описываем на уровне <code>SettingsLayer</code>) и далее ожидается событие <code>devices-ready</code> или
<code>devices-error</code>, создаваемые по сумме итога инициализации устройств на нижнем уровне.
</p>

<p>
При событии <code>devices-ready</code> с нижнего уровня запрашивается список существующих
устройств и сравнивается со списком из <code>SettingsLayer</code> для проверки соответсвия
реально существующих (инициализированных) устройств списку настроенных в системе
устройств. В случае несоответствия списков переходим в состояние <code>hardlock</code>.
</p>

<p>
Находясь в состоянии <code>poweron</code> от нижнего уровня системы получаются отчёты о
состоянии конкретных устройств. Система на уровне бизнес-логики определяет
дальнешиее алгоритмы работы с ними, согласуя в том числе работу комплектов
зависимых друг от друга устройств.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-2" class="outline-4">
<h4 id="sec-4-6-2"><span class="section-number-4">4.6.2</span> <span class="todo TODO">TODO</span> Состояние тестирования (<code>selftest</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-4-6-2">
<p>
Стойка находится в состоянии <code>selftest</code> до тех пор пока состояние всех устрйоство
после инициализации не будет определено (готово, ошибка и т.п.)
</p>

<p>
В данном состоянии осуществляется тестирование всего периферийного оборудования по
кругу. Вход в это состояние возможен из любого другого состояния при получении
сообщения о сбое от нижнего уровня или команды разблокировки из UI (с кнопки
разблокировки на стойке или через web-интерфейс контроллера или через web-интерфейс
сервера).
</p>

<p>
Бизнес-логике по устройствам интересно следующее:
</p>
<ul class="org-ul">
<li>существует ли физически устройство
</li>
<li>существует ли в текущей конфигурации (чтобы узнать это запрашивать нижний уровень необязательно - PostgreSQL)
</li>
<li>включено или выключено в UI (тоже)
</li>
<li>работает ли оно нормально или с ошибками?
</li>
</ul>

<p>
[WAIT:aav] Выявить ошибки, которые нижний уровень может самостоятельно решить
(например: отказ сканера - перезагрузка помогает)
</p>

<p>
[COMMENT:aav] До пилотника я не могу взять на себя такие решения. Может в процессе
что-то вылезет, буду иметь в виду.
</p>

<p>
[TODO:pyub] [TODO:bvl] Расставить устройства по приоритету, в каком порядке
разрабатывать json.
</p>

<p>
[COMMENT:aav] Не только json, но и реальные устройства по порядку.
</p>

<p>
[COMMENT:aav] На нижнем уровне будет проводиться не все тестирование. Только наличие устройства,
если это возможно, и его инициализация.
</p>

<p>
[COMMENT:aav] Если в обработке json-документа на нижнем уровне будут возникать
какие-то ошибки, они будут посылаться json-м в сообщения в простом текстовом
формате.
</p>

<p>
Находясь в состоянии <code>selftest</code> от ниженго уровня системы получаются отчёты о
состоянии конкретных устройств. Система на уровне бизнес-логики определяет
дальнейшие алгоритмы работы с ними, согласуя в том числе работу комплектов
зависимых друг от друга устройств.
</p>

<p>
[TODO:noa] Поставить ссылку на зависимости комплектов устройств.
</p>

<p>
Проходя через состояние <code>selftest</code> система сама пытается устранить неполадки.
</p>

<p>
[VRFY:aav] Согласовывать будем на ходу.
</p>

<p>
В этот момент можно диагностировать отказы перед началом работы.
</p>

<p>
При обнаружении критичного отказа стойка классифицирует отказ и немедленно
переходит в состояние <code>hardlock</code> или <code>softlock</code>, отсылая об этом сообщение на
сервер.
</p>

<p>
[COMMENT:pyub] В пилотнике мы всегда уходим в <code>hardlock</code>. Классификация видов
отказов и их разделение на <code>hard</code> и <code>soft</code> будем делать в перспективе.
</p>

<p>
[TODO:aav] Создать классификацию видов отказов.
</p>

<p>
Если тестирование оборудования прошло успешно, мы переходим к состоянию <code>standby</code>
или, в зависимости от <i>установленных настроек датчиков и реле</i>, в другие состояния.
</p>

<p>
Точки входа в состояние:
</p>
<ul class="org-ul">
<li>включение стойки, т.е. на контроллер подано питание
</li>
<li>оборудование стойки не может полноценно обслуживать посетителя
<ul class="org-ul">
<li>отсутствие ответа <a href="#sec-8-8-4">опрашиваемого оборудования</a>
</li>
<li>сигнал об ошибке от опрашиваемого оборудования
</li>
</ul>
</li>
<li><code>root</code> принудительно перевел из UI [TODO:pyub] описать опцию в описании UI
контроллера, важно - невозможность перевода в процессе исполнения задачи /
автомата или перехода между состояниями
</li>
</ul>

<p>
В состоянии <code>selftest</code> должны функционировать (в порядке запуска):
</p>
<ul class="org-ul">
<li>подсистема логировнаия
</li>
<li>обмен сообщениями с сервером
</li>
<li>SSH
</li>
<li>UI web-интерфейс контроллера
</li>
<li>подсистема <i>тестирования и диагностики из web-интерфейса контроллера</i> [TODO:pyub]
описать далее запускаются все остальные модули и периферийное оборудованние,
которое необходимо тестировать.
</li>
</ul>

<p>
Стойка может быть выключена, но присутствовать в системе. Выключенная стойка не
получает и не реагирует ни на какие внешние воздействия. Управляющий сервер должен
иметь возможность отслеживать стойку в этом состоянии и включать/выключать ее при
необходимости.
</p>

<p>
В случае, если диагностирован некритичный отказ, информация о нем записывается в
конфигурацию, и об отказе информируется сервер.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-3" class="outline-4">
<h4 id="sec-4-6-3"><span class="section-number-4">4.6.3</span> <span class="done DONE">DONE</span> Состояние ожидания (<code>standby</code>)</h4>
<div class="outline-text-4" id="text-4-6-3">
<p>
Режим работы в котором датчик стойки не видит автомобиля и не идёт никакой другой
процесс. В нём стойка реагирует на действия пользователя только сервисными
ифнормационными сообщениями, выводя на дисплей либо сообщение о том, что нет
автомобиля, либо сервисное сообщение о статусе карты/чека. Вся периферия неактивна.
</p>

<p>
Различие в алгоритмах режима ожидания главным образом заключается в том, что к стойкам
может быть подключен разный набор датчиков, соответственно условие перехода в
следующее состояние зависит от конкретного набора.
</p>

<p>
Также в зависимости от настроек пользователя по разному работает взаимодействие с
пользователем: если нет машины - стойка не реагирует на нажатия кнопок на ней, или
занимается продажей карточек и.т.п.
</p>

<p>
<i>Состояние ожидания (простой вьезд по чеку)</i> - для сценария вьезда с бумажными
билетами
</p>

<p>
В этом состянии стойка может обнаружить критичный отказ, в этом случае она
немедленно переходит в состояние <code>hardlock</code>, информируя об этом сервер
</p>

<p>
В случае если обнаруживается неисправность устройства - решаем эту проблему,
переходя в <code>lock</code>. О проблеме узнаем из сообщения, которое посылает нижний уровень.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-4" class="outline-4">
<h4 id="sec-4-6-4"><span class="section-number-4">4.6.4</span> <span class="todo TODO">TODO</span> Подъезд машины к стойке (<code>finding</code>)</h4>
<div class="outline-text-4" id="text-4-6-4">
<p>
Процесс управления сложной процедурой подъезда машины к стойке (через шлюз из двух
шлагбаумов, по рампе) и/или определения датчиком (петлей индуктивности,
фотоэлементом, датчиком магнитного поля) габаритов/массы автотранспортного
средства, а также контроля подъезда к стойке.
</p>

<p>
<a href="#sec-4-13-1-4">Подьезд машины к стойке (<code>barcode-enter-finding</code>)</a> для сценария вьезда с бумажными билетами
</p>

<p>
[TODO:pyub] - Критичный отказ возможен? Какие условия его возникновения? Как
обрабатываем такую ситуацию, если управляем машиной?
</p>

<p>
В этом состянии стойка может обнаружить критичный отказ, в этом случае она
немедленно переходит в состояние <code>hardlock</code>, информируя об этом сервер
</p>
</div>
</div>

<div id="outline-container-sec-4-6-5" class="outline-4">
<h4 id="sec-4-6-5"><span class="section-number-4">4.6.5</span> <span class="todo TODO">TODO</span> Стойка в диалоговом режиме (<code>dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-6-5">
<p>
После срабатывания датчика присутствия стойка начинает диалог с посетителем, выводя
на дисплей сообщения <code>display-dialog</code> о необходимости совершения действий, ошибок и
т.п. В этом режиме посетитель может совершить действия, которые в конечном счёте
может привести к большому списку различных ответов системы, запуска процедур и
изменений состояний.
</p>

<p>
[TODO:pyub] - дописать и перечислить все возможные действия, которые может
совершить пользователь, описать протокол взаимодействия для каждого из них
(поведение стойки в ответ на действия пользователя, варианты действий пользователя
в каждом узле протокола, и.т.п)
</p>

<p>
[COMMENT:pyub] действия и реакция на них расписаны в описаниях для конкретных типов
стоек и конкретных типов оборудования.
</p>

<p>
На этом этапе осуществляется арбитраж в случае использования реверсивного проезда
(один шлагбаум на две стойки с разных сторон) или использования двух стоек для
левого и правого руля.
</p>

<p>
После срабатывания датчика присутствия стойка начинает диалог с посетителем, выводя
на дисплей сообщения о необходимости совершения действий, ошибок и т.п. Стойка
может сопровождать эти действия проигрыванием аудиозаписей для клиента.
</p>

<p>
После прикладывания пользователем въездного документа, либо оплатного документа,
либо карты СКУД, стойка совершает проверку возможности выезда, статуса оплаты и так
далее. На этом этапе осуществляется арбитраж в случае использования реверсивного
проезда (один шлагбаум на две стойки с разных сторон) или использования двух стоек
для левого и правого руля. Также на этом этапе выезд может быть совмещён с оплатой,
как на автоматическом кассовом терминале.
</p>

<p>
Разрешение для посетителя на пребывание на парковке в течение определенного
промежутка времени после оплаты задается арендатором. При этом клиентская программа
арендатора шлет информацию на центральный сервер, а центральный сервер сохраняет
информацию и транслирует ее контроллеру. Контроллер сохраняет полученную информацию
в памяти. При выезде автомобиля контроллер проверяет, истек срок пребывания на
парковке или нет, и разрешает или запрещает выезд. Время выезда передается на
центральный сервер.
</p>

<p>
Есть диалоговый режим, который при неплаченном проезде приводит к процедуре
оплаты. [TODO:pyub] - Описать и дать ссылку.
</p>

<p>
[TODO:pyub] - Критичный отказ возможен? Какие условия его возникновения? Как
обрабатываем такую ситуацию?
</p>
</div>

<ol class="org-ol"><li><a id="sec-4-6-5-1"></a>Дисплей <code>display-dialog</code><br  /><ol class="org-ol"><li><a id="sec-4-6-5-1-1"></a><code>display-gialog-enter</code><br  /><ol class="org-ol"><li><a id="sec-4-6-5-1-1-1"></a>Дисплей <code>4lines</code><br  /><ol class="org-ol"><li><a id="sec-4-6-5-1-1-1-1"></a>barcode<br  /></li>
<li><a id="sec-4-6-5-1-1-1-2"></a>EM<br  /></li></ol>
</li></ol>
</li></ol>
</li></ol>
</div>
<div id="outline-container-sec-4-6-6" class="outline-4">
<h4 id="sec-4-6-6"><span class="section-number-4">4.6.6</span> <span class="todo TODO">TODO</span> Инициация процедуры проезда (<code>init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-6-6">
<p>
После того, как посетителю разрешён въезд (из презентера устройства забран чек или
карта, или успешно проверен статус карты СКУД) контроллер инициирует процесс
открытия шлагбаума, замыкая соответсвующие реле и принимая сигналы с концевиков
шлагбаума (или давая выставленный в миллисекундах импульс, если концевиков нет).
</p>

<p>
[TODO:pyub] - Мне нужны описания сообщений, получаемых контроллером от устройств,
которые приводят к выходу из состояния <code>init</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>

<p>
[COMMENT:bvl] А пройдя состояние <code>fin</code> мы умираем, или возвращаемся в standby?
Может быть, ответ очевиден, но он не описан.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-7" class="outline-4">
<h4 id="sec-4-6-7"><span class="section-number-4">4.6.7</span> <span class="todo TODO">TODO</span> Процедура проезда (<code>goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-6-7">
<p>
После открытия шлагбаума контроллер контролирует проезд машины под стрелой,
принимая сообщения с датчика безопасности (фотоэлемент на линии стрелы) и датчика
завершения проезда (петля индуктивности за стрелой, фотоэлемент, датчик МП). В эту
же процедуру может входит контроль проезда по рампе или через шлюз, находящийся за
стойкой.
</p>

<p>
[TODO:pyub] - Необходимо описать различия по рампе/шлюзу/реверсивному движению
(алгоритм движения, включаемые устройства, ожидание подтверждения проезда от
датчиков и.т.п.)
</p>

<p>
[TODO:pyub] [TODO:aav] [TODO:bvl] - Мне нужны описания сообщений, получаемых
контроллером от устройств, которые приводят к выходу из состояния <code>goon</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>
</div>
</div>

<div id="outline-container-sec-4-6-8" class="outline-4">
<h4 id="sec-4-6-8"><span class="section-number-4">4.6.8</span> <span class="todo TODO">TODO</span> Процедура завершения проезда (<code>fin</code>)</h4>
<div class="outline-text-4" id="text-4-6-8">
<p>
Процесс закрытия шлагбаума после проезда машины, отправки итоговых данных о
совершённом проезде на сервер и возвращения стойки в режим ожидания.
</p>

<p>
[TODO:pyub] - Надо описать различия по отправляемым на сервер данным от периферии и
настроек тарифных зон.
</p>

<p>
[TODO:pyub] [TODO:aav] [TODO:bvl] - Мне нужны описания сообщений, получаемых
контроллером от устройств, которые приводят к выходу из состояния <code>fin</code>.
</p>

<p>
[TODO:pyub] - Что с критичным отказом в этом состянии? Условия возникновения, как
обрабатываем?
</p>
</div>
</div>

<div id="outline-container-sec-4-6-9" class="outline-4">
<h4 id="sec-4-6-9"><span class="section-number-4">4.6.9</span> <span class="todo TODO">TODO</span> Cостояние полной блокировки (<code>hardlock</code>)</h4>
<div class="outline-text-4" id="text-4-6-9">
<p>
При возникновении критичного отказа стойка может перевести себя в данное состояние,
заблокировав всё своё периферийное оборудование и завершив все процессы
взаимодействия с периферийным оборудованием для возможности работы с этими
библиотеками и модулями.
</p>

<p>
В этом случае, в зависимости от алгоритма (например <code>barcode</code>) она выполняет
урезанный протокол взаимодействия, и не занимается своей основной задачей -
пропускать машины, а вместо этого, например, только продает билеты, или даже
информирует посетителя о сбое работы.
</p>

<p>
[VRFY:pyub] - В случае, если отказ некритичный, и стойка может управлять проездом
машин, то она не переходит в состояние <code>hardlock</code>, вместо этого модифицируется
алгоритм . К примеру, если отказал термопринтер, стойка может успешно пропускать
постоянных клиентов по картам, для этого мы просто меняем текущий алгоритм ее
работы, на что то вроде "проезд только по картам" - и это критичным отказом не
считается. Следовательно то что описано ниже - про частичную блокировку - нужно
вынести в другое место - полагаю в алгоритмы работы. При этом там, где мы описываем
различные отказы описать, при каком отказе один алгоритм текущей работы стойки
может поменяться на другой.
</p>

<p>
[TODO:pyub] - Раз стойка может быть выключена, то вероятно сервер может выключить
ее, отправив ей сообщение. Нужно описать в каких состояниях возможно выключение (мы
же не хотим вырубить стойку при проезде машины так, чтобы на нее рухнул шлагбаум?)
Полагаю, что во всех остальных состояниях стойка запоминает, что необходимо
выключиться, выполняет протокол до первого состояния где выключение возможно и
выключается. В этом случае я должен предусмотреть корректную реакцию на события во
всех этих состяниях.
</p>

<p>
Состояние, в которое переходит стойка в случае некорректной работы критичного для
работы системы опрашиваемого <i>периферийного устройства</i>. Для стоек, на которых нет
торгового оборудования (т.е.работы с деньгами) блокировка должна быть
частичной. Например, если заканчивается бумага в термопринтере, выводится сообщение
о том, что "Печать билета невозможна, обратитесь к персоналу парковки", но при этом
въезд по пластиковым билетам (картам) для постоянных клиентов по прежнему возможен.
</p>

<p>
В случае возникновения ситуации блокировки стойка регулярно отправляет на сервер
сервисное сообщение о том, что она работает в нештатном режиме и требуется
произвести замену бумаги или ремонт устройства.
</p>
</div>
</div>

<div id="outline-container-sec-4-6-10" class="outline-4">
<h4 id="sec-4-6-10"><span class="section-number-4">4.6.10</span> <span class="todo WAIT">WAIT</span> Процедура частичной блокировки (<code>softlock</code>)</h4>
</div>
<div id="outline-container-sec-4-6-11" class="outline-4">
<h4 id="sec-4-6-11"><span class="section-number-4">4.6.11</span> <span class="todo WAIT">WAIT</span> Процедура оплаты (<code>payment</code>)</h4>
<div class="outline-text-4" id="text-4-6-11">
<p>
В пилотном проекте мы пострараемся избежать реализации этого.
</p>

<p>
Это состояние может быть активировано и после <code>dialog</code> и после <code>standby</code>. Может
быть касса, совмещенная с выездом, на ней есть и торговое
оборудование. Пользователь может прийти пешком из <code>standby</code> и оплатить или
подьехать - тогда входом может быть любое состояние и выходом может быть <code>standby</code>
или <code>init</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> <span class="todo TODO">TODO</span> Обработка сигналов с датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-7">
<p>
Принцип функционирования простых <code>датчиков</code>: в самом датчике замыкается реле, с
него на контроллер парковочной системы идёт ток 5/12/24 в (в зависимости от
устройства датчика). пока ток идёт на <code>сенсорный ввод</code> контроллера, системное
значение сенсора <code>sx</code> = <code>1</code> (где x - номер датчика).  когда тока нет на сенсоре -
<code>sx</code> = <code>0</code>.
</p>

<p>
Например: для <code>датчика присутствия</code> наличие сигнала (<code>1</code>) значит, что автомобиль
находится в зоне действия контура датчика. если <code>0</code>, то автомобиля нет.
</p>

<p>
Для <code>датчика безопасности</code> отсутствие сигнала (<code>0</code>) означает, что на на линии
стрелы шлагбаума находится объект (луч разомкнут). если <code>1</code>, то линия свободна.
</p>

<p>
Для <code>датчика контроля стрелы шлагбаума</code> - определение того, что стрела находится
в определённном положении:
</p>
<ul class="org-ul">
<li>есть сигнал с <code>концевика открытия</code> (<code>1</code>) - стрела поднята
</li>
<li>есть сигнал с <code>концевика закрытия</code> (<code>1</code>) - стрела опущена
</li>
<li>нет сигнала с обоих концевиков (<code>0</code>) - стрела в промежуточном состоянии
</li>
<li>есть сигнал с обоих концевиков (<code>1</code>) - ошибка
</li>
</ul>

<p>
В случае отказа сенсорного устройства администратор снимает соотвествующий
устройству флаг <i>настройках администратора в web-интерфейсе контроллера</i> и проверка сигнала на
данном сенсоре отключается. если датчик отключён, все проверки, связанные с ним, не
выполняются.
</p>

<p>
[COMMENT:gmm] Полагаю, такие вещи можно делать и автоматически, не привлекая
администратора. в алгоритмах работы, в каждом состоянии нужно описать что мы
делаем, получив отказ какого-то датчика.
</p>

<p>
[COMMENT:pyub] Не получится у нас нет никакого фидбека с этих устройств
</p>

<p>
Неисправность в работе простых датчиков никак не диагоностируется.  если датчик или
линия связи неисправны - вместо изменения сигнала ничего ни происходит.
</p>

<p>
[COMMENT:gmm] Однако в ряде случаев мы можем диагностировать неисправность, если
датчик сообщает нам что-то такое, чего не может быть в этом состоянии. например,
если в <code>standby</code> шлагбаум не закрыт и не открыт. или к примеру в <code>selftest</code> (сразу
после включения стойки), при закрытом шлагбауме фотоэлемент сообщает о присутствии
машины под ним.
</p>

<p>
[COMMENT:pyub] В некоторых случаях ошибка на сервер - если, например, машина
подьехала не с той стороны шлагбаума. иногда надо делать <code>lock</code>.
</p>

<p>
[TODO:pyub] Перечислить случаи и закрыть дискуссию. пока работаем по happy-case
</p>

<p>
Если на петле б нет автомобиля - шлагбаум закрывается по выставлемому оператором
<code>таймауту закрытия шлагбаума</code>, отсчитываемому после получения сигнала о проезде с
датчика безопасности (фотоэлемент).
</p>

<p>
Если фотоэлемент и петля б не функционируют одновременно - шлагбаум закрывается только
по выставляемому оператором  таймауту закрытия шлагбаума, отсчитываемому после прихода
сигнала об открытии шлагбаума.
</p>

<p>
Если отсуствуют или не работают <code>датчики статуса стрелы шлагбаума</code> (концевики
открытия/закрытия) - то при открытие шлагбаума напряжение на него подаётся в
соответствии с настроенным <code>временим импульса открытия шлагбаума</code>, а при закрытии в
соответствии с настроенным <code>временим импульса закрытия шлагбаума</code>. Статус концевиков
при этом не учитывается.
</p>

<p>
Тонкая настройка датчиков оператором через <i>ui администратора контроллера</i> описана в
разделе <i>настройки работы датчиков и реле</i>
</p>
</div>
</div>

<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> <span class="todo TODO">TODO</span> Отмена проезда по незавершённому алгоритму&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-8">
<p>
Если алгоритм въезда не завершён до конца, не важно на каком этапе это произошло,
то полученный билет аннулируется через время t.
</p>

<p>
[COMMENT:bvl] - почему не сразу? Почему не так:
</p>
<ul class="org-ul">
<li>Выдали билет - внесли в номер (билета) в базу
</li>
<li>Проезд завершен успешно - поставили на билете в базе "галочку"
</li>
<li>Действителен на выезд билет с "галочкой" (в дополнение к остальным правилам)
</li>
<li>Билеты без "галочки" чистятся из системы при выдаче следующего, либо в конце смены.
</li>
</ul>

<p>
[VRFY:pyub] Важно описать все такие инварианты (прерывание алгортима
вьезда/выезда) в каждом из алгоритмов.
</p>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> <span class="todo TODO">TODO</span> Настройки администратора из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-9">
</div><div id="outline-container-sec-4-9-1" class="outline-4">
<h4 id="sec-4-9-1"><span class="section-number-4">4.9.1</span> <span class="todo TODO">TODO</span> Настройка торгового оборудования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-9-1">
</div><ol class="org-ol"><li><a id="sec-4-9-1-1"></a><span class="todo TODO">TODO</span> Включить печать билетов термопринтером&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-9-1-1">
<p>
[TODO:pyub] Внести момент относительно информирования клиента о невозможности
въехать по билету при неисправности принтера
</p>

<p>
Если в комплекте оборудования <code>въездной стойки</code> есть <code>термопринтер</code> и в память
контроллера установлена библиотека для работы с ним, внутри системы взводится
флаг <code>printer-exist</code> и в настройках в web-интерфейсе самого контроллера становится
доступен флаг включения или отключения работы термопринтера.
</p>

<p>
При изменении значения этого флага сервер посылает стойке соответствующие
сообщения и стойка включает или выключает термопринтер в своих настройках.
</p>

<p>
[TODO:gmm] Описать это в разделе web-интерфейса и обработчике сообщений
контроллером. Проверить все варианты в случаях, когда термопринтер
есть/нет/сломан/починен.
</p>

<p>
<code>printer-on</code> - принтер включен и возможен въезд по бумажным билетам (флаг установлен)
<code>printer-off</code> - принтер отключен и въезд по бумажным билетам невозможен (флаг снят)
</p>

<p>
В случае наличия включённого термопринтера во всех состояниях стойки на дисплее
отображается сообщения, связанные с печатью и обработкой билета.
</p>

<p>
[TODO:gmm] Описать проверку в виде кода.
</p>

<p>
[VRFY:pyub] [COMMENT:gmm] - чтобы описать это в коде я должен знать сообщения
стойки для всех состояний всех алгоритмов если принтер включен, если принтер
выключен и если он сломан.
</p>

<p>
Обработка ошибок в работе термопринтера:
<i>обработка ошибок в работе термопринтера на въезде (<code>printer-problem</code>)</i>
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-9-2" class="outline-4">
<h4 id="sec-4-9-2"><span class="section-number-4">4.9.2</span> <span class="todo TODO">TODO</span> Настройки работы датчиков и реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-9-2">
</div><ol class="org-ol"><li><a id="sec-4-9-2-1"></a><span class="todo TODO">TODO</span> Включить проверку датчика магнитной петли A&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-1">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса машины по <code>датчику присутствия автомобиля а</code>.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-a</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-a</code> присвоен сенсорный ввод <code>s1</code>.
</p>

<p>
Состояние <code>detector-a</code> = <code>0</code> (не замкнуто реле, нет машины).
Состояние <code>detector-a</code> = <code>1</code> (замкнуто реле, машина на петле).
</p>

<p>
Если администратор отключает датчик присутствия автомобиля (снимает флаг), то
возникает событие <code>detector-a-disabled</code>.
</p>

<p>
Для алгоритма простого въезда по чекам в состоянии <code>standby</code>:
<i>настройка: выключена проверка датчика присутствия автомобиля а</i>
</p>

<p>
[VRFY:pyub] не могу перейти по этой ссылке
</p>
</div>
</li>

<li><a id="sec-4-9-2-2"></a><span class="todo TODO">TODO</span> включить проверку датчика магнитной петли б&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-2">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса машины по <code>датчику присутствия автомобиля б</code>.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-b</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-b</code> присвоен сенсорный ввод <code>s2</code>.
</p>

<p>
Состояние <code>detector-b</code> = <code>0</code> (не замкнуто реле, нет машины).
Состояние <code>detector-b</code> = <code>1</code> (замкнуто реле, машина на петле).
</p>

<p>
Еесли администратор отключает датчик присутствия автомобиля (снимает флаг), то
возникает событие <code>detector-b-disabled</code>.
</p>
</div>
</li>

<li><a id="sec-4-9-2-3"></a><span class="todo TODO">TODO</span> включить проверку фотоэлемента безопасности&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-3">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика безопасности</code>, отвечающего за остановку закрытия стрелы
шлагбаума при наличии на линии фотоэлементов объекта.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-safety</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-safety</code> присвоен сенсорный ввод <code>s7</code>.
</p>

<p>
Состояние <code>detector-safety = =1</code> (не замкнуто реле, на линии
фотоэлементов нет объекта).
Состояние <code>detector-safety = =0</code> (замкнуто реле, на линии
фотоэлементов есть объект).
</p>

<p>
Если администратор отключает датчик безопасносоти (снимает флаг), то
возникает событие <code>detector-safety</code> -  <code>disabled</code>.
</p>

<p>
Если датчик безопасности отключён - в процедуре закрытия шлагбаума не
формируется событие <code>gate-stop</code> при наличии объекта на линии фотоэлемента в
процессе закрытия, и при начал процедуры закрытия не проверяются состояние <code>detector-safety</code>.
</p>
</div>
</li>

<li><a id="sec-4-9-2-4"></a><span class="todo TODO">TODO</span> включить работу с концевиком открытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-4">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика статуса стрелы шлагбаума</code> - <code>концевика открытия</code>,
отвечающего за контроль статуса стрелы шлагбаума и остановку движения стрелы по
факту её открытия.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-gate-open</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-gate-open</code> присвоен сенсорный ввод <code>s5</code>.
</p>

<p>
Состояние <code>detector-gate-open</code> = <code>1</code> (замкнуто реле, стрела шлагбаума открыта)
приводит к событию <code>gate-open</code>.
Состояние <code>detector-gate-open</code> = <code>0</code> (не замкнуто реле, стрела шлагбаума не открыта).
</p>

<p>
Если администратор отключает датчик концевика открытия (снимает флаг), то
возникает событие <code>detector-gate-open-disabled</code>.
</p>

<p>
Если проверка концевика открытия отключена, то открытие шлагбаума и остановка
движения стрелы происходят по параметру <code>импульс открытия шлагбаума</code>.
</p>

<p>
См. <i>настройка импульса открытия шлагбаума</i>
</p>
</div>
</li>

<li><a id="sec-4-9-2-5"></a><span class="todo TODO">TODO</span> включить работу с концевиком закрытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-5">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
проверки статуса <code>датчика статуса стрелы шлагбаума</code> - <code>концевика закрытия</code>,
отвечающего за контроль статуса стрелы шлагбаума и остановку движения стрелы по
факту её закрытия.
</p>

<p>
В настройках по умолчанию проверка включена (<code>detector-gate-close</code> - <code>enabled</code>).
В настройках по умолчанию <code>detector-gate-close</code> присвоен сенсорный ввод <code>s6</code>.
</p>

<p>
Состояние <code>detector-gate-close</code> = <code>1</code> (замкнуто реле, стрела шлагбаума открыта)
приводит к событию <code>gate-close</code>.
Состояние <code>detector-gate-close</code> = <code>0</code> (не замкнуто реле, стрела шлагбаума не
открыта).
</p>

<p>
Если администратор отключает датчик концевика закрытия (снимает флаг), то
возникает событие <code>detector-gate-close-disabled</code>.
</p>

<p>
Если проверка концевика закрытия отключена, то открытие шлагбаума и остановка
движения стрелы происходят по параметру <code>импульс закрытия шлагбаума</code>.
</p>

<p>
См. <i>настройка импульса закрытия шлагбаума</i>
</p>
</div>
</li>

<li><a id="sec-4-9-2-6"></a><span class="todo TODO">TODO</span> Настройка импульса открытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-6">
<p>
[TODO:gmm] описать проверку в виде кода.
</p>

<p>
в настройках в <code>web-интерфейсе</code> контроллера есть поле настройки <code>импульса открытия
     шлагбаума</code> (<code>impulse-gate-open</code>) в котором можно в милисекундах выставить время, в
течении которого с реле открытия шлагбаума (<code>relay-gate-open</code>) подаётся
напряжение, т.е. стрела поднимается. когда реле размыкается - стрела
останавливается и происходит событие <code>gate-open</code>.
</p>

<p>
Поле <code>impulse-gate-open</code> активно для ввода значения только если актвино событие
<code>detector-gate-open-disabled</code>, т.е <i>выключена работа с концевиком открытия шлагбаума</i>.
</p>

<p>
В настройках по умолчанию <code>impulse-gate-open</code> = 3000 ms.
</p>
</div>
</li>

<li><a id="sec-4-9-2-7"></a><span class="todo TODO">TODO</span> Настройка импульса закрытия шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-9-2-7">
<p>
[TODO:gmm] Описать проверку в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть поле настройки <code>импульса
     закрытия шлагбаума</code> (<code>impulse-gate-close</code>) в котором можно в милисекундах
выставить время, в течении которого с реле закрытия шлагбаума
(<code>relay-gate-close</code>) подаётся напряжение, т.е. стрела опускается. Когда реле
размыкается - стрела останавливается и происходит событие <code>gate-close</code>.
</p>

<p>
Поле <code>impulse-gate-close</code> активно для ввода значения только если актвино событие
<code>detector-gate-close-disabled</code>, т.е <i>выключена работа с концевиком закрытия шлагбаума</i>.
</p>

<p>
В настройках по умолчанию <code>impulse-gate-close</code> = 3000 ms.
</p>
</div>
</li>

<li><a id="sec-4-9-2-8"></a><span class="todo START">START</span> Включение контроля работы шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-9-2-8">
<p>
[VRFY:pyub]
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
<code>безопасного режима</code> работы шлагбаума <code>control-gate</code>, который управляет работой
реле <code>relay-gate-stop</code>.
</p>

<p>
В настройках по умолчанию безопасный режим включен  (<code>control-gate</code> -
<code>enabled</code>)
</p>

<p>
Безопасный режим выключен  (<code>control-gate</code> - <code>enabled</code>) работа шлагбаума разрешается только при подаче на него
исполняемого сигнала (например, открытия или закрытия). Разрешение действует до совершения событий <code>gate-open</code>,
<code>gate-close</code> или <code>gate-stop</code>. [TODO:noa] Описать работу фотоэлементов.
</p>

<p>
Безопасный режим выключен  (<code>control-gate</code> - <code>disable</code>), что разрешает работу шлагбаума с помощью реле <code>relay-gate-stop</code> активирую его
постоянно, до момента получения события <code>gate-stop</code> размыкая размыкает его.
Разрешение действует до совершения события <code>gate-stop</code>. [TODO:noa] Описать работу фотоэлементов.
</p>

<p>
Пример:
Если во время процедуры закрытия нам необходимо остановить шлагбаум по
срабатыванию фотоэлемента безопансости [TODO:noa], мы меняем статус <code>relay-gate-stop</code>
(зависит от настройки <i>Реле "стоп" нормально замкнуто</i>).
</p>
</div>
</li>

<li><a id="sec-4-9-2-9"></a><span class="todo START">START</span> Реле "стоп" нормально замкнуто&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-9-2-9">
<p>
[VRFY:pyub]
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть двухпозиционый переключатель
(radiobutton) - настройка "Тип работы реле стоп" (нормально замкнутое - NC
/нормально разомкнутое - NO), которая, определяет формат выводимых данных
<code>relay-gate-stop</code>.
</p>

<p>
По умолчанию включено состояние "нормально замкнутое - NC".
</p>

<p>
"Нормально замкнутое - NC" это состояние при котором <code>relay-gate-stop</code> присвоенно
<code>0</code>, при активации меняется на <code>0</code>.  "Нормально разамкнутое - NO" это состояние
при котором <code>relay-gate-stop</code> присвоенно <code>1</code>, при активации меняется на <code>1</code>.
</p>

<p>
Пример: для подачи разрешения работы шлагбауму при открытии, контроллер при
установленной насторйке "NC", замыкает реле - замыкая цепь системы безопасности
шлагбаума.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-9-3" class="outline-4">
<h4 id="sec-4-9-3"><span class="section-number-4">4.9.3</span> <span class="todo TODO">TODO</span> Системные настройки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-9-3">
</div><ol class="org-ol"><li><a id="sec-4-9-3-1"></a><span class="todo TODO">TODO</span> Настройка логирования событий&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-9-3-1">
<p>
В этом разделе можно установить объём хранимого системой лога событий, ограничив
его либо по количеству записей, либо по объёму занимаемого пространства на
SD-карте.
</p>

<p>
Вторая настройка логирования - отправка сообщений на сервер. Если в настройках
стойки установлен IP адрес сервера, то он автоматически добавляется и сюда. Флаг
включает / отключает логирование.
</p>

<p>
[WAIT] Третья настройка логирования - сохранение лога в виде текстовых файлов в
стороннее сетевое хранлище. В адресную строку можно вбить адрес сетевой шары, а в
дополнительные поля логин и пароль к ней. в неё (шару) стойка будет писать
текстовые файлы, создавая каждый час новый файл. Именем файла является дата и
время начала записи.
</p>

<p>
По умолчанию объём лога ограничен [TODO:gmm] Надо определить как оптимальнее
с точки зрения доступа к данным и т.п.
</p>

<p>
По умолчанию отправка на сервер включена.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-9-4" class="outline-4">
<h4 id="sec-4-9-4"><span class="section-number-4">4.9.4</span> <span class="todo TODO">TODO</span> Настройки тарификации из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-9-4">
</div><ol class="org-ol"><li><a id="sec-4-9-4-0-1"></a><span class="todo TODO">TODO</span> Включить обновление данных о тарифах с сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-6" id="text-4-9-4-0-1">
<p>
[TODO:gmm] Описать в виде кода.
</p>

<p>
В настройках в <code>web-интерфейсе</code> контроллера есть флаг включения или отключения
автоматического получения, применения и <code>обновления данных о тарифах с сервера</code>.
</p>

<p>
В настройках по умолчанию обновление включено (<code>tariff-autoload</code> -
<code>enabled</code>). При такой настройке стойка автоматически забирает данные о времени
и режиме работы парковки, тарифных зонах и остальных настройках раздела с
сервера. Поля настроек защищены от редактирования и в них отображаются данные,
полученные с сервера системы.
</p>

<p>
Если в настройках обновление отключено (<code>tariff-autoload</code> -
<code>disabled</code>), поля становятся доступны для редактирования и стойка оперирует выставлеными в них
значениями вместо рассылаемых централизовано с сервера.
</p>
</div>
</li>

<li><a id="sec-4-9-4-0-2"></a><span class="todo TODO">TODO</span> Время работы стойки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-4-9-4-0-2">
<p>
Данная настройка определяет время работы стойки. В установленный период стойка
работает штатно, вне его переходит в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
[TODO:pyub] Описать специфику блокировки по времени работы. Кроме того, мы обычно
переходим в <code>lock</code> в случае возникновения каких-то проблем, может быть лучше
просто выключать стойку или придумать для таких "режимных" выключений свое
состояние, где стойка будет не реагировать ни на что, только сообщая, что "Вы что
не видите, что у нас обед?"
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Наследуется от глобальной настройки <code>время работы парковки</code> или настройки <code>время
      работы сектора</code> к которому относится стойка в <code>web-интерфейсе сервера</code>.
</p>

<p>
[TODO:pyub] - Нужно дать ссылку на эти настройки
</p>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59",
т.е. стойка функционирует круглосуточно.
</p>

<p>
[COMMENT:gmm] - Лучше просто пусть там будет ноль, а то мы можем забыть это
специально обработать и стойка будет перезагружаться в полночь, и не дай бог там
в это время будет вьезжать машина..
</p>
</div>
</li>

<li><a id="sec-4-9-4-0-3"></a><span class="todo TODO">TODO</span> Время работы стойки для разовых посетителей&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-4-9-4-0-3">
<p>
[TODO:pyub] - Надо дать ссылки на те настройки которые уже есть и те настройки
которые еще не описаны, но на них ссылается содержимое этого раздела
</p>

<p>
Данная настройка определяет время работы стойки для разовых посетителей,
использующих одноразовые проездные документы (в зависимости от комплекта
оборудования - чеки или карты Mifare+).
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Имеет приоритет над настройкой <i>время работы стойки</i>.
</p>

<p>
Наследуется от глобальных настроек в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда для разовых посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда для разовых посетителей</code> - для выездов и выездов
совмещённых с оплатами
</li>
<li><code>время работы оплаты для разовых посетителей</code> - для кассовых терминалов
</li>
</ul>

<p>
Или от глобальных настроек секторов в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда в сектор для разовых посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда из сектора для разовых посетителей</code> - для выездов и
выездов совмещённых с оплатами
</li>
</ul>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59".
</p>
</div>
</li>

<li><a id="sec-4-9-4-0-4"></a><span class="todo TODO">TODO</span> Время работы для постоянных посетителей&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-6" id="text-4-9-4-0-4">
<p>
[TODO:pyub] - Надо дать ссылки на те настройки которые уже есть и те настройки
которые еще не описаны, но на них ссылается содержимое этого раздела
</p>

<p>
Данная настройка определяет время работы стойки для постоянных посетителей,
использующих <i>карты СКУД</i>, <i>абонементские карты</i> или <i>дебетовые карты</i> (в зависимости
от комплекта оборудования - карт EM-Marine или Mifare+).
</p>

<p>
[VRFY:pyub] Не могу перейти по этим ссылкам
</p>

<p>
Формат настройки - поля для ввода времени в 24-х часовом формате "с HH:MM" "до HH:MM".
</p>

<p>
Имеет приоритет над настройкой <i>время работы стойки</i>.
</p>

<p>
Наследуется от глобальных настроек в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда для постоянных посетителей</code> - для въездов и въездов
совмещённых с оплатами
</li>
<li><code>время работы выезда для постоянных посетителей</code> - для выездов и выездов
совмещённых с оплатами
</li>
<li><code>время работы оплаты для постоянных посетителей</code> - для кассовых терминалов,
оплата дебетовых или абонементских карт, автоматическая продажа карточек при
наличии
</li>
</ul>

<p>
Или от глобальных настроек секторов в <code>web-интерфейсе сервера</code>:
</p>
<ul class="org-ul">
<li><code>время работы въезда в сектор для постоянных посетителей</code> - для въездов и въездов совмещённых с оплатами
</li>
<li><code>время работы выезда из сектора для постоянных посетителей</code> - для выездов и выездов совмещённых с оплатами
</li>
</ul>

<p>
Настройка по умолчанию при выключенном наследовании "с 00:00" до "23:59".
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-9-5" class="outline-4">
<h4 id="sec-4-9-5"><span class="section-number-4">4.9.5</span> <span class="todo TODO">TODO</span> Тестирование и диагностика из web-интерфейса контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-4-9-5">
<p>
[TODO:noa] Подробно описать функционал работы системы аналогичной Parking Test
применимо к нашей системе.
</p>

<p>
В web-интерфейсе должна быть закладка диагностики. На этой странице отображаются
данные по всем сенсорным вводам, реле и подключениям перферийных устройств.
В формате:
</p>
<ul class="org-ul">
<li>SX (где X - номер сенсора) - есть / нет сигнал отображается разным цветом.
</li>
<li>BX (где Х - номер кнопки) - есть / нет сигнал  отображается разным цветом.
</li>
<li>RX (где Х - номер реле) - есть / нет замыкание  отображается разным цветом.
</li>
<li>PORTX - TYPE - MODEL, где
<ul class="org-ul">
<li>PORT- тип порта по которому подключенно устройство,
</li>
<li>X - номер порта,
</li>
<li>TYPE - тип устройства,
</li>
<li>MODEL - модель устройства,
</li>
<li>STATUS - статус устройства отображается разными цветами:
<ul class="org-ul">
<li>зеленый -функционирует
</li>
<li>желтый - были не сброшенные ошибки за прошедшие сутки
</li>
<li>красный присутствуют ошибки на данный момент
</li>
<li>черный с устройством нет связи но в конфигурации оно есть.
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
Должна быть кнопка тестирования которая при нажатии проводит тестировние устройства
и возвращает список ошибок или "ошибок нет". Так же должен быть список ошибок
возникавших за период с момента последнего сброса ошибок. Кнопка сброса списка
ошибок по каждому устройству за прошедший период.
</p>

<p>
Должно отображаться текущее время на контроллере, время последней
связи/синхронизации с сервером. Данные отображаемые на дисплее стойки.
</p>

<p>
Должно присутствовать окно с логом замыкания/сигналами за время сессии
теститрования (сессия начинается при подключении к контроллеру через web
интерфейс). Данные лога должны содержать время срабатывания, название и
длительность сигнала для события его окончания.
</p>

<p>
Также там должен быть реализован функционал тестирования оборудования, а для
суперадминистратора имитации финансовых операций (для простого админа запрещаем,
т.к. это всё связано с фискальником и балансом и потом могут быть проблемы).
</p>
</div>
</div>

<div id="outline-container-sec-4-9-6" class="outline-4">
<h4 id="sec-4-9-6"><span class="section-number-4">4.9.6</span> <span class="todo TODO">TODO</span> Режим тестирования опрашиваемого оборудования из UI контроллера</h4>
<div class="outline-text-4" id="text-4-9-6">
<p>
<code>root</code> или <code>admin</code> должен иметь возможность принудительно перевести стойку в
<a href="#sec-4-6-2">состояние тестирования (<code>selftest</code>)</a>. Для этого необходимо предусмотреть на странице
тестирования и лога в web-интерфейсе кнопку <code>Разблокировка</code> - <code>button-selftest</code>.
</p>

<p>
Функционал кнопки по сути дублирует аппаратную кнопку <code>button-unlock</code>
</p>

<p>
Это необходимо для инициации опроса всех периферийных устройств без
перезагрузки контроллера
при их зависании или по факту решения технической проблемы и необходимости ручного
выхода из состояний <code>hardlock</code> и <code>softlock</code>.
</p>

<p>
невозможность перевода в процессе исполнения задачи/автомата или перехода между
состояниями
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> <span class="todo TODO">TODO</span> Некорректные действия посетителя&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></h3>
<div class="outline-text-3" id="text-4-10">
<p>
[COMMENT:pyub] Пока я хочу собрать все подобные ситуациии здесь. Они будуту меня в
голове вспылвать по ходу описания состояний, кейсов и оборудования. Если у вас при
написании текста / анализе моего текста, будет всплывать понимание того, что "вот
тут может что-то пойти не так из-за действий пользователя" - пишите прямо там, где
возник вопрос.
</p>
</div>

<div id="outline-container-sec-4-10-1" class="outline-4">
<h4 id="sec-4-10-1"><span class="section-number-4">4.10.1</span> <span class="todo TODO">TODO</span> Машина посетителя уезжает не завершив процедуру проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-10-1">
<p>
Все действия посетителя аннулируются. Стойка возвращается в исходное состояние
 <code>finging</code>.
</p>
</div>
</div>

<div id="outline-container-sec-4-10-2" class="outline-4">
<h4 id="sec-4-10-2"><span class="section-number-4">4.10.2</span> <span class="todo TODO">TODO</span> Повторное прикладывание/некорректный билет&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-10-2">
<p>
Посетитель пытается приложить билет от другой парковки, или самостоятельно
сформированный билет.
</p>
</div>
</div>

<div id="outline-container-sec-4-10-3" class="outline-4">
<h4 id="sec-4-10-3"><span class="section-number-4">4.10.3</span> <span class="todo TODO">TODO</span> Повторная оплата по въездному билету&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-10-3">
<p>
[TODO:gmm] Прочти, пойми о чём речь. Если понял - подумай как обработать.
</p>

<p>
Кейс актуален только для билетов со штрих-кодом.
</p>

<p>
Посетитель парковки подносит к сканеру кассы въездной билет, оплачивает время, получает
выездной чек. У него есть определённое время на выезд по нему.
</p>

<p>
Тем не менее посетитель не выезжает с парковки за установленное время на выезд,
следовательно ему нужно оплатить ещё какое-то время. Чтобы сделать это он должен
поднести к сканеру кассы штрих-код выездного чека. Тогда система посчитает то
время, которое он отсоял сверх оплаченного и по факту оплаты выдаст ему ещё один
выездной чек.
</p>

<p>
По факту же человек скорее всего повторно поднесёт к сканеру кассы уже оплаченный
въездной билет и система посчитает ему сумму к оплате от первоначального времени
въезда.
</p>

<p>
Задача: сделать так, чтобы система корректно обрабатывала ситуацию. Т.е., что бы
человек не поднёс к сканеру - изначальный въездной билет или уже оплаченный, но
просроченный выездной чек - любая касса на парковке (общающаяся с другими по
Ethernet) знала о том, что человеку нужно оплатить только просроченное время.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> <span class="todo TODO">TODO</span> Некорректные действия оператора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> <span class="todo TODO">TODO</span> Сообщения периферийных устройств контроллеру&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="bvl">bvl</span></span></h3>
<div class="outline-text-3" id="text-4-12">
</div><ol class="org-ol"><li><a id="sec-4-12-0-1"></a><span class="todo TODO">TODO</span> Обработка ошибок в работе термопринтера на въезде (<code>printer-problem</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="bvl">bvl</span>&#xa0;<span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-12-0-1">
<p>
[TODO:bvl] Добавить перечень возможных отказов и ошибок принтера VKP-80.
[TODO:gmm] [TODO:bvl] Согласовать списки ошибок конкретных устройств и абстрактных
устройств.
</p>

<p>
[COMMENT:bvl] Набросал, коды ошибок допилю как найду.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">индикация</th>
<th scope="col" class="right">число миганий</th>
<th scope="col" class="left">описание</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">зеленый</td>
<td class="right">1</td>
<td class="left">Прием данных (не ошибка)</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="left">Ошибка приема (parity, frame error, overrun error)</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="left">Команда не распознана</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Истекло время на прием команды</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">оранжевый</td>
<td class="right">2</td>
<td class="left">Перегрев печатающей термоголовки</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="left">Закончилась бумага</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Замятие бумаги</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">5</td>
<td class="left">Неверное напряжение блока питания</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">6</td>
<td class="left">Открыта крышка</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">красный</td>
<td class="right">3</td>
<td class="left">Ошибка RAM</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">4</td>
<td class="left">Ошибка EEPROM</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="right">5</td>
<td class="left">Ошибка автообрезчика</td>
</tr>
</tbody>
</table>

<p>
[TODO:gmm] Написать код обработки.
</p>

<p>
Термопринтер имеет собственный набор датчиков и перечень возможных возникающих
проблем и состояний о которых сообщениями сообщает контоллеру по RS-232.
</p>

<p>
Получение контроллером сообщения о проблеме должно всегда приводить к отправке стойкой
<code>сообщений на сервер</code>, в некоторых ситуациях блокировке работы принтера (<code>printer-error</code>)
или полному переводу стойки в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
Только сообщение на сервер:
</p>
<ul class="org-ul">
<li>есть сигнал с оптодатчика контроля кол-ва бумаги о том, что бобина почти пуста.
</li>
</ul>

<p>
К <code>printer-off</code> приводит:
</p>
<ul class="org-ul">
<li>замятие бумаги;
</li>
<li>оптодатчикидатчики контроля презентера долго заняты;
</li>
<li>билет отправлен в сброс;
</li>
<li>кончилась бумага.
</li>
</ul>

<p>
Если на стойке включена(ы) библиотека(и) работы с картами СКУД (<code>emmarine-on</code>) или
транспондерами DSRC (<code>transponder-on</code>) то отключется только принтер (<code>printer-off</code>)
и возможен проезд по картам или транспондеру.
</p>

<p>
Если на стойке не включена ни одна из данных библиотек
(<code>emmarine-off</code> и/или <code>transponder-off</code>) - вместе с отключением принтера
стойка должна перейти в <i>состояние блокировки (<code>lock</code>)</i>.
</p>

<p>
На дисплей в любом состоянии выводится следующая информация:
1 строка: <code>сообщение текущего состояния стойки</code>
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка: Принтер неисправен
4 строка: работа только по картам.
</p>
</div>
</li>

<li><a id="sec-4-12-0-2"></a><span class="todo TODO">TODO</span> Повторное прикладывание использованного билета&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-4-12-0-3"></a><span class="todo START">START</span> Машина оказывается на датчике магнитной петли Б&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-4-12-0-4"></a><span class="todo TODO">TODO</span> Нажата кнопка "Печать билета"&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-4-12-0-5"></a><span class="todo TODO">TODO</span> Нажата кнопка "Вызов оператора"&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li></ol>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13"><span class="section-number-3">4.13</span> <span class="todo TODO">TODO</span> Алгоритмы проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-13">
<p>
[TODO:pyub] - Необходимо описать основные отказы и их обработку
</p>
</div>

<div id="outline-container-sec-4-13-1" class="outline-4">
<h4 id="sec-4-13-1"><span class="section-number-4">4.13.1</span> Алгоритм простого въезда по чеку <code>barcode</code> <code>enter</code></h4>
<div class="outline-text-4" id="text-4-13-1">
<p>
Объявляем его как <code>barcode-enter</code>. В дальнейшем диспетчеризация поведения будет
происходить в зависимости как от алгоритма проезда, так и от текущего состояния
стойки. Однако чтобы давать уникальные ссылки на подразделы ниже мы включаем
идентификатор алгоритма в название раздела.
</p>

<p>
Простой алгоритм для парковки, работающей по чекам со стандартным комплектом
датчиков (петли А,Б и фотоэлементы). В алгоритме введены светофор и счётчик мест
(светодиодное табло).
</p>
</div>

<ol class="org-ol"><li><a id="sec-4-13-1-1"></a>Состояние выключенной стойки (<code>barcode</code> <code>enter</code> <code>selftest</code>)<br  /><div class="outline-text-5" id="text-4-13-1-1">
<p>
Здесь мы просто создадим модельную стойку в этом состоянии - этот код будет частью
теста на модели
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="test_make_checkpoint">(make-checkpoint <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"1"</span> <span style="color: #0000ee; font-weight: bold;">:state</span> <span style="color: #00cd00;">":SELFTEST"</span>)
</pre>
</div>
</div>
</li>

<li><a id="sec-4-13-1-2"></a><span class="todo TODO">TODO</span> Состояние инициализации (<code>barcode</code> <code>enter</code> <code>poweron</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-2">
<p>
Что нужно сделать при инициализации
</p>
<ul class="org-ul">
<li>Сообщить серверу о себе
</li>
<li>Включить логгинг
</li>
<li>Прочитать конфигурацию
</li>
<li>Опросить устройства
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="checkpoint_trans_functions">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">power-on</span> ()
  <span style="color: #00cd00;">"selftest -&gt; poweron"</span>)
</pre>
</div>
</div>
</li>

<li><a id="sec-4-13-1-3"></a><span class="todo TODO">TODO</span> Состояние ожидания (<code>barcode-enter-standby</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="aav">aav</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-13-1-3">
<p>
[TODO:gmm] Изменить исполняемую спецификацию в соответствии с моими изменениями.
</p>

<p>
См. <i>Состояние ожидания (<code>standby</code>)</i>
</p>

<p>
Когда стойка находится в состоянии ожидания на дисплей выводится следующая
информация:
1 строка: Стойка въезда
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка: информация клиента
4 строка: информация клиента
</p>

<p>
В данном состоянии замкнуто реле <code>Светофор сигнал 1</code> (<code>реле R4</code>) отвечающее за
зелёный сигнал светофора.
</p>

<p>
При нажатии на кнопку "Печать билета" (<code>кнопка B1</code>) на дисплей выводится информация:
1 строка: нет автомобиля.
</p>

<p>
Т.е. если машины нет на датчике А, то клиент не может сделать никаких действий -
при нажатии на кнопку печати билета или приложении пластиковой карты стойка
сообщает ему: "нет автомобиля"
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> push-button (<span style="color: #0000ee; font-weight: bold;">:standby</span> button)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector button)))
    (send-message (display controller) <span style="color: #00cd00;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100; &#1085;&#1077; &#1086;&#1073;&#1085;&#1072;&#1088;&#1091;&#1078;&#1077;&#1085;"</span>)))
</pre>
</div>

<p>
При нажатии на <code>кнопку B2</code> "Вызов оператора" переходим к обработке процедуры <code>вызов по IP связи</code>.
</p>

<p>
При нажатии на <code>кнопку B3</code> "Разблокировка" - ничего не происходит (нет отказа).
Данная кнопка необходима при отказах:
</p>
<ul class="org-ul">
<li>при сбое принтера см. <i>Обработка ошибок в работе термопринтера</i>
</li>
</ul>

<p>
При нажатии на <code>кнопку B4</code> "Запрос выезда" переходим к процедуре <code>внешний запрос выезда</code>.
</p>

<p>
Когда машина подъезжает к стойке, срабатывает <code>датчик присутствия автомобиля А</code> перед
стойкой (сигнал на <code>сенсорый ввод S1</code>) и контроллер получает сигнал о том,
что машина перед стойкой. Контроллер переключается в состояние <code>finding</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-presence (<span style="color: #0000ee; font-weight: bold;">:standby</span> detector)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector detector)))
    (trans controller <span style="color: #0000ee; font-weight: bold;">:standby</span> <span style="color: #0000ee; font-weight: bold;">:finding</span>)))
</pre>
</div>
</div>

<ol class="org-ol"><li><a id="sec-4-13-1-3-1"></a>Влияние настроек на состояние<br  /><div class="outline-text-6" id="text-4-13-1-3-1">
<p>
<i>Включить проверку датчика магнитной петли А</i>
</p>

<p>
Стойка автоматически автоматически переходит в <code>dialog</code>;
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> detector-a-disabled (<span style="color: #0000ee; font-weight: bold;">:standby</span> detector)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-detector button)))
    (trans controller <span style="color: #0000ee; font-weight: bold;">:standby</span> <span style="color: #0000ee; font-weight: bold;">:dialog</span>)))
</pre>
</div>
</div>
</li></ol>
</li>

<li><a id="sec-4-13-1-4"></a><span class="todo TODO">TODO</span> Подьезд машины к стойке (<code>barcode-enter-finding</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-4">
<p>
[TODO:gmm] Изменить исполянемую спецификацию в соответствии с моими изменениями.
</p>

<p>
<i>Подъезд машины к стойке (<code>finding</code>)</i>
</p>

<p>
В данном случае имеем простой подъезд автомобиля.
</p>

<p>
При переключении в состояние <code>finding</code> происходят следующие действия:
</p>
<ul class="org-ul">
<li>размыкается <code>светофор сигнал 1</code> (<code>реле R4</code>), отвечающее за зелёный сигнал на светофоре
</li>
<li>замыкается <code>светофор сигнал 2</code> (<code>реле R5</code>), отвечающее за красный сигнал на светофоре
</li>
<li>на сервер отправляет <code>сообщение</code> "Машина у стойки въезда".
</li>
</ul>

<p>
Т.к. мы не можем проверить исполнение данных действий, автоматически переходим в
состояние <code>dialog</code> по факту отправки сигналов и сообщений.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> red-trafic-light (<span style="color: #0000ee; font-weight: bold;">:standby</span> <span style="color: #0000ee; font-weight: bold;">:finding</span> controller)
  (send-signal (trafic-light controller) <span style="color: #0000ee; font-weight: bold;">:red</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-action</span> send-to-server-car-is-present (<span style="color: #0000ee; font-weight: bold;">:standby</span> <span style="color: #0000ee; font-weight: bold;">:finding</span> controller)
  (send-message (parent-server controller) <span style="color: #0000ee; font-weight: bold;">:car-is-present</span>))
</pre>
</div>
</div>
</li>

<li><a id="sec-4-13-1-5"></a><span class="todo TODO">TODO</span> Диалоговый режим (<code>barcode-enter-dialog</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-5">
<p>
См. <i>Стойка в диалоговом режиме (<code>dialog</code>)</i>
</p>

<p>
При переходе в состояние <code>dialog</code> контроллер переводит периферийные устройства в
режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>включается подсветка кнопки печати билета (<code>кнопка B1</code>) замыкая реле подсветки (<code>реле R10</code>);
</li>
</ul>

<p>
Когда стойка находится в состоянии диалога на дисплей выводится следующая
информация:
1 строка: Нажмите кнопку для печати билета
2 строка: DD.MM.YYYY HH:MM (текущая дата и время)
3 строка (опция): информация клиента
4 строка (опция): инофрмация клиента
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> print-ticket-button-light-on (<span style="color: #0000ee; font-weight: bold;">:finding</span> <span style="color: #0000ee; font-weight: bold;">:dialog</span> controller)
  (send-signal (print-ticket-button controller) <span style="color: #0000ee; font-weight: bold;">:on</span>))

(<span style="color: #00cdcd; font-weight: bold;">define-action</span> show-display-press-button-and-get-ticket (<span style="color: #0000ee; font-weight: bold;">:finding</span> <span style="color: #0000ee; font-weight: bold;">:dialog</span> controller)
  (send-message (display controller) <span style="color: #00cd00;">"&#1053;&#1072;&#1078;&#1084;&#1080;&#1090;&#1077; &#1082;&#1085;&#1086;&#1087;&#1082;&#1091; &#1080; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1077; &#1073;&#1080;&#1083;&#1077;&#1090;"</span>))
</pre>
</div>

<p>
Когда машина находится на магнитной петеле и стойка находится в состоянии
<code>finding</code>, но пользователем ещё не соверщены действия, инициирующие переход в состояние машина покидает зону действия датчика и стойка возвращается в
состояние <code>standby</code>
</p>

<p>
Клиент нажимает кнопку печати билета, сигнал с кнопки приходит на сенсорный вход
контроллера.
</p>

<p>
Контроллер получает сигнал и отправляет на принтер команду "напечатать билет с
необходимой информацией" (штрих-код, зашифрованный в соответствии с
предустановленным кодом; текущее время; номер терминала въезда; номер тарифной
зоны; предустановленную доп. информацию).
</p>

<p>
Пользователю на экран выводится предложение подождать.
</p>

<p>
[TODO:gmm] - Тут нужен таймер с watch-догом. И для пользователя и для
принтера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> ticket-printing (<span style="color: #0000ee; font-weight: bold;">:dialog</span> print-button)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((controller (get-controller-by-print-button print-button)))
    (send-message (display controller) <span style="color: #00cd00;">"&#1056;&#1072;&#1089;&#1087;&#1077;&#1095;&#1072;&#1090;&#1099;&#1074;&#1072;&#1077;&#1090;&#1089;&#1103; &#1073;&#1080;&#1083;&#1077;&#1090;... &#1055;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072; &#1087;&#1086;&#1076;&#1086;&#1078;&#1076;&#1080;&#1090;&#1077;.."</span>)
    (send-command (printer contriller)
                  <span style="color: #0000ee; font-weight: bold;">:print-ticket</span>
                  barcode
                  current-time
                  (terminal-number controller)
                  (tariff-zone controller)
                  additional-data)))
</pre>
</div>

<p>
Принтер печатает билет, его сенсоры контролируют состояние печати (возможно
замятие, окончание бумаги и т.п.).
</p>

<p>
[TODO:pyub] - Необходимо все возможные ситуации рассмотреть, вместе с их
последствиями, т.е. что делаем в каждом из случаев.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ticket_printing_emergency">(<span style="color: #00cdcd; font-weight: bold;">define-emergency-event</span> paper-jam (<span style="color: #0000ee; font-weight: bold;">:dialog</span> printer)
  (TODO))

(<span style="color: #00cdcd; font-weight: bold;">define-emergency-event</span> paper-over (<span style="color: #0000ee; font-weight: bold;">:dialog</span> printer)
  (TODO))
</pre>
</div>

<p>
Если печать завершена успешно - билет находится в презентере и контроллер должен
сам вызывать событие <code>printing-completed-successfully</code>
</p>

<p>
В обработчике этого события Контроллер блокирует периферию, защищая систему от
повторного получения въездного документа. На дисплей выводится сообщение
"Забирите билет".
</p>

<p>
В этом же обработчике устанавливается Watchdog timer на несколько секунд, который
вызовет событие <code>get-ticket-watchdog-timer-over</code> если клиент не заберет билет в
течении этого времени.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> printing-completed-successfully (<span style="color: #0000ee; font-weight: bold;">:dialog</span> controller ticket)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1042;&#1099;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; &#1087;&#1086;&#1076;&#1089;&#1074;&#1077;&#1090;&#1082;&#1091; &#1082;&#1085;&#1086;&#1087;&#1082;&#1080;</span>
  (send-signal (print-ticket-button controller) <span style="color: #0000ee; font-weight: bold;">:off</span>)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1042;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1101;&#1082;&#1088;&#1072;&#1085;</span>
  (send-message (display controller) <span style="color: #00cd00;">"&#1047;&#1072;&#1073;&#1077;&#1088;&#1080;&#1090;&#1077; &#1073;&#1080;&#1083;&#1077;&#1090;"</span>)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1090;&#1072;&#1081;&#1084;&#1077;&#1088;</span>
  (set-watchdog 5 #'get-ticket-watchdog-timer-over ticket))
</pre>
</div>

<p>
Если билет не забран из презентера клиентом более t секунд - принтер сообщает об
этом контроллеру, контроллер отбивает ошибку на сервер и анулирует билет.
</p>

<p>
Это еще не все, я правильно понимаю, что надо перевести стойку в режим <code>finding</code>?
Да.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> get-ticket-watchdog-timer-over (<span style="color: #0000ee; font-weight: bold;">:dialog</span> controller ticket)
  (reset-watchdog get-ticket-watchdog-timer-over)
  (send-message (parent-server controller) <span style="color: #0000ee; font-weight: bold;">:get-ticket-watchdog-timer-over</span>)
  (ticket-cancel ticket))
</pre>
</div>

<p>
Если клиент забирает билет из презентера, принтер сообщает об этом контроллеру,
вызывая событие <code>get-printed-ticket-successfully</code>. Контроллер сообщает на сервер
о том, что билет напечатан и прикладывает сам билет, а затем переходит в
следующее состояние.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> get-printed-ticket-successfully (<span style="color: #0000ee; font-weight: bold;">:dialog</span> controller ticket)
  (reset-watchdog get-ticket-watchdog-timer-over)
  (send-message (parent-server controller) <span style="color: #0000ee; font-weight: bold;">:get-ticket-watchdog-timer-over</span> ticket)
  (trans controller <span style="color: #0000ee; font-weight: bold;">:dialog</span> <span style="color: #0000ee; font-weight: bold;">:init</span>))
</pre>
</div>

<p>
[TODO:pyub] - Необходимо знать, что происходит, когда сервер получает все эти
сообщения от контроллера. Сервер может считать места и.т.п.
</p>
</div>
</li>

<li><a id="sec-4-13-1-6"></a><span class="todo TODO">TODO</span> Инициация проезда (<code>barcode-enter-init</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-6">
<p>
При переходе в состояние <code>init</code> контроллер замыкает реле, отвечающее за открытие
шлагбаума за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала
"открыт", либо по длине импульса из настроек контроллера)
</p>

<p>
Как разделять эти два инварианта? Галочкой в настройках
</p>

<p>
Контроллер сообщает серверу "Открытие шлагбаума стойки №"
</p>

<p>
Если у нас нет концевика, то ставим watchdog на открытие шлагбаума
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="output_actions">(<span style="color: #00cdcd; font-weight: bold;">define-action</span> barrier-open (<span style="color: #0000ee; font-weight: bold;">:dialog</span> <span style="color: #0000ee; font-weight: bold;">:init</span> controller)
  (send-signal (barrier controller) <span style="color: #0000ee; font-weight: bold;">:open</span>)
  (send-message (parent-server controller) <span style="color: #0000ee; font-weight: bold;">:barrier-open</span> controller)
  (<span style="color: #00cdcd; font-weight: bold;">if</span> barrier-limit-switch-not-present
      (set-watchdog 5 #'barrier-open-confirm)))
</pre>
</div>
</div>
</li>

<li><a id="sec-4-13-1-7"></a><span class="todo TODO">TODO</span> Процедура проезда (<code>barcode-enter-goon</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-7">
<p>
Когда стрела шлагбаума открывается, в шлагбауме срабатывает концевик открытия -
сигнал с него приходит на сенсор "открытие" контроллера. Если концевика нет, то мы
генерируем его срабатывание по таймеру, запущенному в <code>barrier-open</code>
</p>

<p>
Контроллер фиксирует факт того, что шлагбаум в открытом положении и совершает
следующие действия:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>сообщает серверу "Шлагбаум стойки № открыт"
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> barrier-open-confirm (<span style="color: #0000ee; font-weight: bold;">:goon</span> controller)
  (send-signal (trafic-light controller) <span style="color: #0000ee; font-weight: bold;">:green</span>)
  (send-message (parent-server controller) <span style="color: #0000ee; font-weight: bold;">:barrier-open-confirm</span> controller))
</pre>
</div>

<p>
Когда машина пересекает линию фотоэлемента безопасности (стрелы шлагбаума) с
фотоэлемента приходит сигнал на сенсор. Контроллер, имея сигнал с ф/э безопасности
на сенсор, переходит в режим "автомобиль в воротах" - пока проезд не освобождён стрела шлагбаума
не должна закрыться.
</p>

<p>
Правильно ли я понимаю, что мы в этот момент должны включить красный сигнал
светофора? Да, с момента пересечения стрелы. Так же арбитраж на другую сторону.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-in-gate (<span style="color: #0000ee; font-weight: bold;">:goon</span> controller)
   (trans controller <span style="color: #0000ee; font-weight: bold;">:goon</span> <span style="color: #0000ee; font-weight: bold;">:ingate</span>))
</pre>
</div>

<p>
Машина проезжает шлагбаум, с сенсорного устройства за его стрелой (контроллер
петли индуктивности, фотоэлемент, датчик МП) на контроллер отправляется
сигнал. Контроллер получает подтверждение завершения проезда и начинает
соответствующую процедуру.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">(<span style="color: #00cdcd; font-weight: bold;">define-event</span> car-out-of-gate (<span style="color: #0000ee; font-weight: bold;">:ingate</span> controller)
   (trans controller <span style="color: #0000ee; font-weight: bold;">:ingate</span> <span style="color: #0000ee; font-weight: bold;">:fin</span>))
</pre>
</div>
</div>
</li>

<li><a id="sec-4-13-1-8"></a><span class="todo TODO">TODO</span> Процедура завершения проезда (<code>barcode-enter-fin</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-4-13-1-8">
<p>
Мы считаем, что машина покинула ворота (место проезда) тогда, когда:
</p>
<ul class="org-ul">
<li>фотоэлемент не регистрирует машину под шлагбаумом
</li>
<li>от сенсора за шлагбаумом пришел сигнал, что машина за шлагбаумом
</li>
</ul>

<p>
Все это вместе вызовет событие <code>car-out-of-gate</code>. Получив это событие, мы перейдем
в состояние <code>fin</code> и контроллер сделает следующие действия:
</p>

<ul class="org-ul">
<li>размыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за закрытие шлагбаума за стойкой (реле замкнуто либо
до прихода на сенсорный ввод сигнала "закрыт" с концевика, либо по длине
импульса из настроек контроллера)
</li>
<li>сообщает серверу "проезд по билету № успешно завершен", а также об изменении
количества мест в секторе и данные по билету
</li>
<li>отправляет на табло счётчика мест по RS-485 сообщение "-1 место"
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_events">TODO
</pre>
</div>

<p>
Получив сигнал с концевика закрытия на сенсор контроллер:
</p>
<ul class="org-ul">
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>возвращает стойку в режим ожидания <code>standby</code>.
</li>
</ul>
</div>
</li>

<li><a id="sec-4-13-1-9"></a><span class="todo TODO">TODO</span> Cостояние блокировки (<code>barcode-enter-lock</code>)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-4-13-1-9">
<p>
Состояние, в которое переходит стойка в случае некорректной работы критичного для
функционирования системы (или подсистемы) опрашиваемого <i>периферийного устройства</i>.
</p>

<p>
[TODO:pyub] - Не могу перейти по этой ссылке.
</p>

<p>
Для стоек, на которых нет торгового оборудования (т.е.работы с деньгами)
блокировка должна быть частичной. Например, если заканчивается бумага в
термопринтере, выводится сообщение о том, что "Печать билета невозможна,
обратитесь к персоналу парковки", но при этом въезд по пластиковым билетам
(картам) для постоянных клиентов по врежнему возможен.  В случае возникновения
ситуации блокировки стойка регулярно отправляеет на сервер сервисное сообщение о
том, что она работает в нештатном режиме и требуется произвести змену бумаги /
ремонт устрйоства.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-4-13-2" class="outline-4">
<h4 id="sec-4-13-2"><span class="section-number-4">4.13.2</span> <span class="todo TODO">TODO</span> Алгоритм простого выезда по чеку <code>barcode</code> <code>leave</code>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-13-2">
<p>
[TODO:pyub] - Надо описать по нормальному, так же как выше описан вьезд.
</p>

<p>
Простейший алгоритм для парковки, работающей по чекам с стандартным комплектом
датчиков и контроля проезда. В алгоритм введены светофор и счётчик мест
(светодиодное табло).
</p>

<ol class="org-ol">
<li><code>Подъезд машины</code>
</li>
</ol>
<p>
1.1. Машина подъезжает к стойке, с сенсорного устройства у стойки (контроллер петли
индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.2. Контроллер получает сигнал о том, что у стойки находится машина и из режима
ожидания переховодит стойку в активный режим.  1.3. Замыкается реле, отвечающее за
красный сигнал на светофоре.  1.4. На сервер отправляет инфосообщение "Машина у
стойки выезда".
</p>
<ol class="org-ol">
<li><code>Активный режим (диалог с пользователем)</code>
</li>
</ol>
<p>
2.1. Контроллер переводит периферийные устройства в режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>активируется широкополосный сканер штрих-кода;
</li>
<li>на дисплей выдаётся информационное сообщение "Поднесите билет".
</li>
</ul>
<p>
2.2. Клиент подносит билет штрих-кодом к сканеру, данные по RS232 или USB передаются на контроллер.
2.3. Контроллер  расшифровывает с помощью ключа шифрования (аналогичный стоит на въезде и кассах) штрих-код, получая из него информацию об оставшемся бесплатном времени (со времени въезда или времени оплаты). Он решает, исходя из заложенных в себя тарифов и параметров времени, разрешёен въезд или требуется оплата времени. см. "ПРОВЕРКА РАЗРЕШЕНИЯ ВЫЕЗДА"
2.4. Исходя из результатов проверки контроллер выводит на дислпей сообщение "Выезд разрешён" или "Выезд запрещён, оплатите $$$ руб".
2.5. Если выезд запрещён, контроллер блокирет периферию до
     окончания процедуры завершения проезда (<code>fin</code>), защищая систему от повторного прикладывания чека.
2.6. Контроллер сообщает на сервер "Выезд по билету №".
</p>
<ol class="org-ol">
<li><code>Инициация проезда</code>
</li>
</ol>
<p>
3.1. Контроллер получает положительный ответ от внутренних и внешних механизмов проверки оплаты билета и инициирует процедуру проезда.
3.2. Контроллер  замыкает реле, отвечающее за открытие шлагбаума  за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала "открыт", либо по длине импульса из настроек контроллера)
3.3. Контроллер сообщает серверу "Открытие шлагбаума стойки №"
</p>
<ol class="org-ol">
<li><code>Процедура проезда</code>
</li>
</ol>
<p>
4.1. Когда стрела шлагбаума открывается, в шлагбауме срабатывает концевик открытия - сигнал с него приходит на сенсор "открытие" контроллера
4.2. Контроллер фиксирует факт того, что шлагбаум в открытом положении совершаются следующие действия:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>сообщает серверу "Шлагбаум стойки № открыт"
</li>
</ul>
<p>
4.3. Когда машина пересекает линию фотоэлемента безопасности (стрелы шлагбаума) с ф/э приходит сигнал на сэнсор.
4.4. Контроллер, имея сигнал с ф/э безопасности на сенсор, переходит в режим "стоп" - пока сенсор не освобождён стрела шлагбаума не должна закрыться.
4.5. Машина проезжает шлагбаум,  с сенсорного устройства за его стрелой (контроллер петли индуктивности, фотоэлемент, датчик МП) на контроллер отправляется сигнал.
4.6. Контроллер получает подтверждение завершения проезда и начинает соответсвующую процедуру.
</p>
<ol class="org-ol">
<li><code>Процедура завершения проезда</code>
</li>
</ol>
<p>
5.1. Получив подтверждение окончания проезда - нет сигнала на сенсор безопасности проезда и на сенсор петли за шлагбаумом - контроллер инициирует следующеи действия:
</p>
<ul class="org-ul">
<li>размыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за закрытие шлагбаума за стойкой (реле замкнуто либо до прихода на сенсорный ввод сигнала "закрыт" с концевика, либо по длине импульса из настроек контроллера)
</li>
<li>сообщает серверу "выезд по билету № успешно завершен", а также об изменении количества мест в секторе и данные по билету
</li>
<li>отправляет на табло счётчика мест по RS-485 сообщение "+1 место"
</li>
</ul>
<p>
5.2. Получив сигнал с концевика закрытия на сенсор контроллер:
</p>
<ul class="org-ul">
<li>размыкает реле, отвечающее за красный свет на светофоре;
</li>
<li>замыкает реле, отвечающее за зелёный свет на светофоре;
</li>
<li>возвращает стойку в режим ожидания;
</li>
<li>сообщает на сервер о закрытии шлагбаума.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-13-3" class="outline-4">
<h4 id="sec-4-13-3"><span class="section-number-4">4.13.3</span> <span class="todo TODO">TODO</span> Алгоритм проезда по карте СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-13-3">
<p>
[TODO:pyub] - Надо описать по нормальному, так же как выше описан вьезд.
</p>

<p>
Карты СКУД формата Em-Marine могут использоваться параллельно с билетами или картами
Mifare (основным въездным документом). Они вносятся в базу данных администратором
парковки и имеют ряд опций и статусов о которых подробнее будет написано в описании
модуля СКУД. Если пользователь вместо нажатия кнопки выдачи въездного документа
прикладывает карту СКУД и она проходит успешно проверки - это действие является
инициирующим проезд.
</p>

<p>
2.1. Контроллер переводит периферийные устройства в режим обслуживания клиента:
</p>
<ul class="org-ul">
<li>включается подсветка кнопки печати билета;
</li>
<li>на дисплей выдаётся информационное сообщение "Нажмите кнопку и получите билет ИЛИ ПРИЛОЖИТЕ КАРТУ".
</li>
</ul>
<p>
2.2. Клиент прикладывает карту к считывателю карт. Сигнал со считывателя Em-Marine приходит на интерфейс Wiegand 26.
2.3. Контроллер получает сигнал о том, что приложена карат имеющая номер NNNNNNNN.
2.4. Контроллер отправляет запрос на проверку статуса карты на сервер. Сервер обрабатывает запрос и возвращает контроллеру информацию о статусе карты:
</p>
<ul class="org-ul">
<li>"есть в БД" / "нет в БД" ;
</li>
<li>"на парковке" / "вне парковки";
</li>
<li>"заблокирована" / "активна";
</li>
<li>"есть места для данной группы" / "нет мест для данной группы".
</li>
</ul>
<p>
2.5. Контроллер получает ответ от сервера и на его основании решает - пускать ли владельца карты на парковку или нет.
2.6. Если сигнала связи с сервером нет, то контроллер проверяет
свою БД и опрашивает другие контроллеры, которые видит в
сети. Решение принимается на базе самой новой из доступных записей
о статусе карты. Тут у нас была мысль поддерживать такую же логику
работы, которой руководствуется гит при слиянии коммитов. [TODO:pyub] <code>продумать поведение при обрыве связи</code>
2.8. Если въезд разрешён, контроллер инициирует процедуру проезда.
2.9. На сервер отправляет инфосообщение "Приложена карта NNNNNNNN, выезд разрешен".
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-14" class="outline-3">
<h3 id="sec-4-14"><span class="section-number-3">4.14</span> <span class="todo WAIT">WAIT</span> Усложнения алгоритмов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-14">
<p>
[TODO:pyub] - Надо это все преобразовать и описать в разделе "Описание
функциональности" - "Состояния стойки при проезде" - в соответствующих разделах где
применяются эти усложнения
</p>
</div>

<div id="outline-container-sec-4-14-1" class="outline-4">
<h4 id="sec-4-14-1"><span class="section-number-4">4.14.1</span> <span class="todo TODO">TODO</span> Проезд по шлюзу / рампе</h4>
<div class="outline-text-4" id="text-4-14-1">
<p>
Изменения касаются процедуры подъезда, всё начинается не с датчика присутствия у
стойки, а с датчика в начале "шлюза" из двух шлагбаумов - одного в начале участка
подъезда к стойке по рампе, второго - за стойкой. В данном решении присутсвуют три
датчика присутвия - на начале шлюза, у стойки и за стрелой, а также фотоэлемент на
линии стрелы.
</p>

<p>
1.1. Машина начинает заезд на рампу, с сенсорного устройства в начале рампы (контроллер петли индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.2. Контроллер получает сигнал о том, что начат проезд рампы и переходит в режим ожидания освобождения сенсора.
1.3. Машина начинает подъём по рампе,  сигнал с сенсорного устройства прекращается (оно остаётся позади машины).
1.4. Контроллер фиксирует прекращение сигнала и блокирует рампу:
</p>
<ul class="org-ul">
<li>замыкает реле, отвечающее за закрытие шлагбаума №1, находящегося в начале рампы;
</li>
<li>замыкает реле, отвечающее за красный свет на светофоре в начале рампы;
</li>
<li>отправляет на сервер инфосообщение "Рампа занята".
</li>
</ul>
<p>
1.5. Машина подъезжает к стойке,  с сенсорного устройства у стойки (контроллер петли индуктивность, фотоэлемент и т.п.) на контроллер отправляется сигнал.
1.6. Контроллер получает сигнал о том, что у стойки находится машина и инициирует процедуру инициации проезда.
1.7. На сервер отправляет инфосообщение "Машина у стойки въезда".
5.3. Контроллер открывает шлагбаум в начале рампы, зажигает зелёный свет на светофоре в начале рампы.
5.4. На сервер отправляется сообщение "Рампа свободна".
</p>
</div>
</div>

<div id="outline-container-sec-4-14-2" class="outline-4">
<h4 id="sec-4-14-2"><span class="section-number-4">4.14.2</span> <span class="todo WAIT">WAIT</span> Фотофиксация въезда</h4>
<div class="outline-text-4" id="text-4-14-2">
<p>
В пилотнике не надо
</p>

<p>
Опциональное действие, которое может совершаться параллельно с любым действием
контроллера (выбирается в настрйоках контроллера). В процессе фотофиксации камера
(или камеры), IP которой указан в настройках контролера, получает запрос на
фотографирование, после чего возвращает контроллеру фото, которое сохраняетя им на
SD носитель.
</p>
</div>
</div>

<div id="outline-container-sec-4-14-3" class="outline-4">
<h4 id="sec-4-14-3"><span class="section-number-4">4.14.3</span> <span class="todo WAIT">WAIT</span> Звуковое сопровождение</h4>
<div class="outline-text-4" id="text-4-14-3">
<p>
В пилотном проекте не реализуем, но - задел на будущее
</p>

<p>
Опциональное действие, которое может совершаться параллельно с выводом сообщений на
дисплей, дублируя их аудиозаписями, лежащими на SD носители. Данные аудиофайлы
должны загружаться и сопоставляться с текстовыми сообщениями через интерфейс
настройки контроллера.
</p>

<p>
В пилотнике не надо
</p>

<p>
Опциональное действие, которое может соврешаться параллельно с
выводом сообщений на дисплей, дублируя их аудиозаписями, лежащими
на SD носители. Данные аудиофайлы должны загружаться и
сопоставляться с текстовыми сообщениями через интерфейс настройки
контроллера.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-15" class="outline-3">
<h3 id="sec-4-15"><span class="section-number-3">4.15</span> <span class="todo TODO">TODO</span> Алгоритмы работы с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-15">
</div><div id="outline-container-sec-4-15-1" class="outline-4">
<h4 id="sec-4-15-1"><span class="section-number-4">4.15.1</span> <span class="todo TODO">TODO</span> Работа с автоматической кассой&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-15-1">
<p>
АЛГОРИТМЫ СКОПИРОВАНЫ ИЗ ПАСПОРТА КАССЫ, В ПРОЦЕССЕ ДОРАБОТКИ
</p>
</div>
</div>

<div id="outline-container-sec-4-15-2" class="outline-4">
<h4 id="sec-4-15-2"><span class="section-number-4">4.15.2</span> <span class="todo TODO">TODO</span> Процедура оплаты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-15-2">
<p>
Это последовательность действий посетителя и оператора парковки
при проведении оплаты через автоматическую кассу.
</p>

<ol class="org-ol">
<li>Посетитель находится у кассы.
</li>
</ol>
<p>
1.1. Подносит неоплаченный въездной билет или просроченный выездной чек к сканеру штрих-кода.
1.2. Если посетитель потерял въездной билет или выездной чек, то он должен нажать кнопку "Оплата за утерю билета" (точная формулировка может отличаться).
</p>
<ol class="org-ol">
<li>На дисплее выводится информация о необходимых операциях.
</li>
</ol>
<p>
2.1. В случае, если бесплатное или ранее оплаченное время ещё не истекло, на дисплей будет выведена информация об оставшемся времени нахождения на парковке.
2.2. Если посетитель пробыл на парковке больше установленного бесплатного времени и не провёл оплату на другой кассе или производит оплату за утерю билета, система рассчитает сумму, требуемую к оплате, исходя из установленных для стойки тарифов, выведет на дисплей информацию о необходимости и размере платежа и активирует платёжное оборудование.
</p>
<ol class="org-ol">
<li>Посетитель оплачивает услуги АПС наличными через купюроприемник (банкноты номиналом 50, 100, 500, 1000 и 5000 руб.; мод. К, БК, КМ, БКМ), монетоприёмник (монеты номиналом 1, 2, 5 и 10 руб., мод. М, КМ, БМ, БКМ) или банковской карточкой (мод. Б, БК, БМ, БКМ).
</li>
</ol>
<p>
3.1. Если оплата производится купюрами или монетами, и при внесении платежа была совершена ошибка, возможно вернуть деньги нажав кнопку "Возврат денег".
3.2. Если оплата производится монетами, и при внесении платежа монету заклинило в монетоприёмнике, необходимо нажать на кнопку "Сброс монеты" под прорезью для монет.
3.3. Если оплата производится с помощью банковской карты, то для активации POS-терминала необходимо нажать кнопку "Оплата картой".
</p>
<ol class="org-ol">
<li>После оплаты касса выдаёт выездной чек и, в случае, если посетитель оплатил наличными и сумма вносимых средств превысила требуемую, сдачу. При этом на мониторе отображается оставшееся время, в соответствии с установленными тарифами, в течение которого посетитель должен покинуть парковку.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-4-15-3" class="outline-4">
<h4 id="sec-4-15-3"><span class="section-number-4">4.15.3</span> <span class="todo TODO">TODO</span> Процедура инкассации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-15-3">
<ol class="org-ol">
<li>Запросить "Х-отчет" и забрать чек. п. 3 и п. 4 только для модификаций с купюрами (К, БК, КМ, БКМ)
</li>
<li>Изъять банкнотную наличность.
</li>
</ol>
<p>
3.1. Снять бокс купюроприёмника
3.2. Изъять купюры из бокса или взять пустой бокс купюроприёмника
3.3. Установить пустой бокс купюроприемника на место.
</p>
<ol class="org-ol">
<li>Восполнить банкнотную наличность для сдачи.
</li>
</ol>
<p>
4.1. Снять кассеты диспенсера с купюрами сдачи и кассету "Отказ".
4.2. Заполнить кассеты купюрами или взять предварительно заполненные сдачей новые кассеты. Изъять неликвидные купюры из кассеты "Отказ".
4.3. Установить кассеты на место.
</p>
<ol class="org-ol">
<li>Провести инкассацию и закрыть смену.
</li>
</ol>
<p>
5.1. Нажать кнопку "Инкассация" и забрать чек с данными об инкассации. п. 6 и п. 7 только для модификаций с монетами (М, КМ, БМ, БКМ)
</p>
<ol class="org-ol">
<li>Изъять полученные монеты из специального металлического ящика.
</li>
<li>После нажатия "Инкассации" выполнить перезагрузку сдачи в хопперы.
</li>
</ol>
<p>
7.1. Хопперы автоматически поочерёдно осуществят сброс всех не
     выданных в качестве сдачи монет в окно выдачи сдачи или в
     предварительно размещённую под желобами для монет ёмкость.
7.2. Загрузите в хопперы сдачу в соответствии с установленным по умолчанию количеством сдачи. п. 8 только для модификаций с банковскими картами (Б, БК, БМ, БКМ)
</p>
<ol class="org-ol">
<li>После нажатия "Инкассации" POS-терминал обменивается данными с банком, после чего в чек инкассации включается отчёт об эквайринговых операциях.
</li>
<li>Если на дисплее отображается надпись "Заблокировано", необходимо нажать кнопку "Разблокировка", после чего будет напечатан тестовый чек и выведена надпись "Поднесите штрих-код или карту".
</li>
<li>Закрыть дверь кассы.
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-4-15-4" class="outline-4">
<h4 id="sec-4-15-4"><span class="section-number-4">4.15.4</span> <span class="todo TODO">TODO</span> Процедура закрытия смены&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-15-4">
<p>
Почитать про кассовый регламент, что такое Z-отчет
</p>

<ol class="org-ol">
<li>Запросить "Z-отчет", закрыть фискальную смену и забрать чек. Сверить суммы прибыли с чеками инкассаций и фактической прибылью.
</li>
<li>Новая смена открывается автоматически при следующей оплате.
</li>
<li>Если на дисплее отображается надпись "Заблокировано", необходимо нажать кнопку "Разблокировка", после чего будет напечатан тестовый чек и выведена надпись "Поднесите штрих-код или карту".
</li>
<li>Закрыть кассу.
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-4-16" class="outline-3">
<h3 id="sec-4-16"><span class="section-number-3">4.16</span> <span class="todo TODO">TODO</span> Роли пользователей системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-16">
<p>
Описание ролей пользователей системы в рамках общего принципа функционирования.
</p>
</div>

<div id="outline-container-sec-4-16-1" class="outline-4">
<h4 id="sec-4-16-1"><span class="section-number-4">4.16.1</span> Суперадминистратор (root)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-16-1">
<p>
<code>Суперадминистратор</code> (<code>root</code>) - это сертифицированный обученный специалист
производителя или подрядчика, который может осуществлять первичное конфигурирование
и отладку контроллеров и установку дополнительных модулей на сервер. У него есть
доступ ко всем функциям остальных пользователей системы и описанные ниже
дополнительные возможности.
</p>

<p>
В <i>web-интерфейсе настройки контроллера</i> <code>root</code> может:
</p>
<ul class="org-ul">
<li>устанавливать библиотеки периферийного оборудования
</li>
<li>устанавливать библиотеки, связанные с доп. функциями парковки
</li>
<li>разрешать/запрещать/конфигурировать удалённый доступ к контроллеру через SSH
</li>
<li>иметь доступ к SSH консоли из web-интерфейса
</li>
<li>производить обновление ПО, работать с удалёнными репозиториями обновлений и
библиотек
</li>
<li>производить диагностику, отладку и имитациою операций с финансовыми устройствами
подробнее: <i>Тестирование и диагностика из web-интерфейса контроллера</i>
</li>
</ul>

<p>
На <i>web-интерфейсе сервера</i> <code>root</code> может:
</p>
<ul class="org-ul">
<li>конфигурировать интерфейсы остальных групп пользователей
</li>
<li>устанавливать библиотеки и модули, связанные с доп. функциями работы парковки
(по факту их продажи клиенту)
</li>
<li>разрешать / запрещать / конфигурировать удалённый доступ к серверу через SSH
</li>
<li>иметь доступ к SSH консоли сервера из web-инетрфейса
</li>
<li>ПО, работать с удалёнными репозиториями обновлений и библиотек
</li>
<li>осуществлять связь серверов друг с другом, настраивать каскады серверов,
связывать их с системой биллинга
</li>
<li>конфигурировать части системы, связанные с интеграцией с другими системами
</li>
</ul>

<p>
Доступ root должен быть ограничен паролем и, в идеале, ещё чем-то. Ключевым
файлом, SSH сертификатом и т.п.
</p>
</div>
</div>

<div id="outline-container-sec-4-16-2" class="outline-4">
<h4 id="sec-4-16-2"><span class="section-number-4">4.16.2</span> Администратор (admin)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-16-2">
<p>
<code>Администратор</code> cистемы - это сотрудник клиента, владеющего парковочной системой,
отвечающий за настройку и функционирование систмы и производяший конечную настройку
системы непосредственно по факте эксплуатации решения.
</p>

<p>
В <i>web-интерфейсе настройки контроллера</i> <code>администратор</code> может:
</p>
<ul class="org-ul">
<li>отслеживание логов событий контроллера
</li>
<li>конфигурирование настроек LAN контроллера
</li>
<li>производить <i>настройки администратора из web-интерфейса контроллера</i>,
конфгурировать работу установленного и подключённого периферийного оборудования
</li>
<li>производить диагностику, отладку и имитацию работы сенсоров, реле и периферийного
оборудования кроме торгового оборудования (<i>тестирование и диагностика из web-интерфейса контроллера</i>)
</li>
<li>подключать или отключать стойки от общения, обмена данными и тарифами с видимыми им серверами
</li>
<li>управлять временем, информацией, выводимой на дисплей стоек и печатаемой на чеках
</li>
</ul>

<p>
Доступ администратора к настройкам оборудования определяется установленными
пользователем <code>root</code> библиотеками.
</p>

<p>
Весь функционал web-интерфейса контроллера должен быть также доступен через общий
web-интерфейс сервера (выбор стойки -&gt; настройка)
</p>

<p>
На <i>web-интерфейсе сервера</i> <code>администратор</code> может:
</p>
<ul class="org-ul">
<li>отслеживать все логи о работе парковки в целом, создавать выгрузки и отчёты
истории событий
</li>
<li>получать информацию о настрйоках и состоянии всех стоек, терминалов и касс, находящихся в
локальной сети и подключенных к серверу
</li>
<li>изменять IP-адреса, ключей шифрования, номера подключённых стоек
</li>
<li>управлять пользователями, создавая и удаляя их, разнося по созданным <code>root</code>
      группам доступа к страницам интерфейса
</li>
<li>управлять секторами парковки и тарифными зонами, временем работы парковки,
тарифными сетками
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-16-3" class="outline-4">
<h4 id="sec-4-16-3"><span class="section-number-4">4.16.3</span> <span class="todo TODO">TODO</span> Оператор (operator)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-16-3">
<p>
<code>Оператор</code> - это человек из обслуживающего персонала парковки, который
отвечает за некую определённую сферу функционирования системы и следит за ней в
процессе эксплуатации.
</p>

<p>
Имеет доступ к системе только через <i>web-интерфейс сервера</i> или через отдельную утилиту.
</p>

<p>
Можно выделить несколько основных функций операторов (они могут быть совмещены или разделены).
</p>
</div>

<ol class="org-ol"><li><a id="sec-4-16-3-1"></a>Парковщик (parker)<br  /><div class="outline-text-5" id="text-4-16-3-1">
<p>
Парковщик должен иметь следующие возможности:
</p>
<ul class="org-ul">
<li>открытие и закрытие шлагбаумов, подключённых к стойкам, находящимся в локальной сети.
</li>
<li>управление количеством свободных мест на парковке.
</li>
<li>мониторинг информации, приходящей со стоек (лога) в режиме реального времени.
</li>
</ul>
</div>
</li>

<li><a id="sec-4-16-3-2"></a>Кассир (casher)<br  /></li>
<li><a id="sec-4-16-3-3"></a>СКУД<br  /></li></ol>
</div>
<div id="outline-container-sec-4-16-4" class="outline-4">
<h4 id="sec-4-16-4"><span class="section-number-4">4.16.4</span> Бухгалтер</h4>
<div class="outline-text-4" id="text-4-16-4">
<p>
<code>Бухглатер</code> - это человек из обслуживающего персонала парковки, отвечающий за
работу финансовой системы, установку тарифов, проведение инкассаций, соблюдение и
выполнение кассового порядка и т.д. Иногда роль совмещена с ролью
<code>оператора-кассира</code>.
</p>

<p>
Имеет доступ к системе только через <i>web-интерфейс сервера</i> или через отдельную
утилиту.
</p>
</div>
</div>

<div id="outline-container-sec-4-16-5" class="outline-4">
<h4 id="sec-4-16-5"><span class="section-number-4">4.16.5</span> Посетитель парковки</h4>
<div class="outline-text-4" id="text-4-16-5">
<p>
<code>Посетитель</code> - это клиент парковки, который оставляет своё транспортное средство на
её территории. Он взаимодействует с системой с помощью интерфейсов стоек и касс,
либо через персонал парковки.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-17" class="outline-3">
<h3 id="sec-4-17"><span class="section-number-3">4.17</span> <span class="todo TODO">TODO</span> Обработка ошибок в работе&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></h3>
<div class="outline-text-3" id="text-4-17">
</div><div id="outline-container-sec-4-17-1" class="outline-4">
<h4 id="sec-4-17-1"><span class="section-number-4">4.17.1</span> <span class="todo TODO">TODO</span> Описать полный цикл работы системы с обработкой ошибок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-4-17-1">
</div><ol class="org-ol"><li><a id="sec-4-17-1-1"></a><span class="todo TODO">TODO</span> На алгоритмы проезда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-4-17-1-2"></a><span class="todo TODO">TODO</span> На алгоритмы оплаты&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /></li>
<li><a id="sec-4-17-1-3"></a><span class="todo TODO">TODO</span> Совмещенные алгоритмы<br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-4-18" class="outline-3">
<h3 id="sec-4-18"><span class="section-number-3">4.18</span> <span class="done DONE">DONE</span> Логирование сообщений&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-18">
<p>
Контроллеры взаимодействуют между собой и сервером через отправку и получение
<i>сообщений</i>.
</p>

<p>
Все сообщения должны писаться в лог-файл. Основное место хранения лога работы
системы - сервер. Каждый контроллер ведёт свою отдельную историю, храня в своей
памяти сообщения за время t (или определённое кол-во сообщений), дублируя эти данные
на агрегирующий сервер, где они собираются в единый лог. В случае отсутствия связи
контроллер перестаёт удалять сервисные сообщения из своего лога, собирая "хвост"
вплоть до появления связи. Если место для сообщений заканчивается, а связь не
появилась - возможно удаление некритичных сообщений и запись на их место критичных.
</p>

<p>
Необходимо обеспечить постоянную запись истории работы системы:
</p>
<ul class="org-ul">
<li>проходящих штатно событий (например, события выезда, события выезд, произошедшей оплаты);
</li>
<li>кодов известных ошибок в работе контроллера и основного ПО;
</li>
<li>кодов известных ошибок в работе периферийного оборудования (обработка кодов ошибок из протоколов взаимодействия самих устройств);
</li>
<li>кодов известных ошибок возникающих при нарушении связи между контроллерами и / или сервером;
</li>
<li>сообщений о неизвестных ошибках.
</li>
</ul>

<p>
Контроллер держит в своей постоянной памяти на SD-карте единовременно лог событий не
превышающий установленное в <i>настройках логирования событий</i> количество записей. В нём
же управляется объем информации хранимой на SD-карте.
</p>

<p>
[TODO:pyub] Необходимо продумать, что мы делаем при отказе SD.
</p>

<p>
При этом он постоянно отправляет сообщения об ошибках на агрегирующий сервер, где
они систематизируются в доступном для оператора или администратора виде и хранятся
долгосрочно. Если связь нарушена, контроллер сохраняет сообщения сверх
установленного количеств записей вплоть до заполнения памяти.
</p>
</div>
</div>

<div id="outline-container-sec-4-19" class="outline-3">
<h3 id="sec-4-19"><span class="section-number-3">4.19</span> <span class="todo WAIT">WAIT</span> Парковочные места, тарифные зоны и сектора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-4-19">
</div><div id="outline-container-sec-4-19-1" class="outline-4">
<h4 id="sec-4-19-1"><span class="section-number-4">4.19.1</span> <span class="todo WAIT">WAIT</span> Распределение паркомест</h4>
</div>
<div id="outline-container-sec-4-19-2" class="outline-4">
<h4 id="sec-4-19-2"><span class="section-number-4">4.19.2</span> <span class="todo WAIT">WAIT</span> Тарифная зона</h4>
<div class="outline-text-4" id="text-4-19-2">
<p>
Необходимо реализовать гибкую систему тарифов, при этом постаравшись
максимально сохранить автономность системы в случае падения связи с
сервером.
</p>

<p>
Основные единые настройки бесплатного времени:
</p>
<ul class="org-ul">
<li>бесплатное время после въезда (мин)
</li>
<li>бесплатное время на выезд после оплаты (мин)
</li>
</ul>

<p>
Эти характеристики должны быть индивидуальны для разных секторов парковки. Т.е.,
например, в секторе открытого паркинга одни тарифы, а в секторе закрытого -
другие. Между секторами стоит проездная стойка со сканером штрих кодов (для Mifare
парковки это сделать проще в автономном режиме). При поднесении она переносит на
сервере и всех соседних стойках билет в другой сектор. При этом если машина отстояла
t1 времени в одном секторе, а потом поехала в другой, то данные по оплате
суммируется, а бесплатное время во втором секторе не считается.
</p>

<p>
Основые вещи:
</p>
<ul class="org-ul">
<li>Со скольки до скольки работает парковка (осуществляется впуск и выпуск)
Допустимо по картам СКУД пускать например круглосуточно, а по чекам - только днем
</li>
<li>Бесплатное время - время, которое машина может стоять на парковке до требования
оплаты. В течении его она может выехать бесплатно.
</li>
<li>Время на выезд - время за которое машина может покинуть парковку после оплаты
водителем в кассе. Если не успел - время на выезд не учитывается.
</li>
<li>Штраф - сумма, которая взимается с человека, если он потерял вьездной документ.
</li>
<li>Стоимость часов исходя из того, что имеются следующие основыне тарифные характеристики:
<ul class="org-ul">
<li>стоимость 1го..2го..23го..24го.. часа после истечения бесплатного времени
</li>
</ul>
</li>
<li>коэффициент стоймости в зависимости от времени суток (с 20:00 до 22:00 k=2, с 9:00 до 18:00 k=0,5)
</li>
<li>коэффицикнт стоймости в зависимости от дня недели (пн, вт, ср, чт, пт k2=1, сб,вс k2=2)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-19-3" class="outline-4">
<h4 id="sec-4-19-3"><span class="section-number-4">4.19.3</span> <span class="todo WAIT">WAIT</span> Сектор парковки</h4>
<div class="outline-text-4" id="text-4-19-3">
<p>
Секторальность - например есть крытая и открытая система парковки, между ними
стойка. Если пользователь на ночь хочет на закрытую парковку - там другой тариф,
все это надо считать, суммируя. В пилотном проекте не делаем, но учитывать нужно
при программировании системы тарифов.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Контроллер</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Требования к контроллеру&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="noa">noa</span></span></h3>
<div class="outline-text-3" id="text-5-1">
<p>
Устройства можно разделить на те, с которыми идёт обмен данными и обмен только
сигналами.
</p>

<p>
Также можно разделить на встраиваемые и внешние.
</p>

<p>
[TODO:pyub] Расписать всю теоретическую и вводную часть про периферию.
</p>

<p>
Отдельно аудио-оборудование.
</p>
</div>

<div id="outline-container-sec-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"><span class="section-number-4">5.1.1</span> <span class="todo TODO">TODO</span> Требования к функционалу контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
[VRFY:noa] Я наверное что-то забыл. Можно дополнить.
</p>

<p>
Разрабтывая аппаратную и программную часть контроллера необходимо реализовать
описанный ниже функицонал.
</p>

<ol class="org-ol">
<li>Реализовать вводы / выводы контроллера и подключение к нему переченя
периферийного оборудования, описанного в разделах:
<ul class="org-ul">
<li><a href="#sec-5-3-1-3">Периферийные устройства контроллера и протоколы связи</a>
</li>
<li><i>Выводы на аудио оборудование</i>
</li>
<li><i>Выводы на сухой контакт реле</i>
</li>
</ul>
</li>

<li>В базовой комплектации плата контроллера должна обеспечивать работу въездной и
выездной стоек в базовой комплектации. Кассы и более сложные решения должны быть
реализованы платами расширения. Платырасширения должны обеспечивать
одновременную работу максимального комплекта оборудования.
</li>

<li><p>
Реализовать простое подключение:
</p>
<ul class="org-ul">
<li>Периферийного оборудования, размещённого внутри стойки при
</li>
</ul>
<p>
сборке оборудования
</p>
<ul class="org-ul">
<li>Внешнего периферийного оборудования при монтаже систем на
</li>
</ul>
<p>
месте эксплуатации
</p>
<ul class="org-ul">
<li>контроллера к локальной сети по RJ-45 (возможна дополнительная связь по
RS-485)
</li>
</ul>
</li>

<li>Настройка бизнес-логики системы и работы всего периферийного оборудования должна
быть реализована из браузера по IP-адресу контроллера. Переконфигурация может
проводиться удалённо, частично автоматизированно при измении внешних условий и
отказах. Описание в разделе: <a href="#sec-5-13">Web-интерфейс для настройки контроллера</a>
</li>

<li><a href="#sec-4-5">Логирование сообщений</a> о всех происходящих ошибках и действиях на сервер и на
самом контроллере.
</li>

<li>Должна быть реализована голосовая связь посетителя и оператора парковки
голосом. Для этого каждый контроллер должен распознаваться в локальной сети как
SIP-устройство.
</li>

<li>Осуществление <a href="#sec-4-14-3">звукового сопровождения</a> действий пользователя - проигрывание
аудиозаписей по определенным событиям.
</li>

<li>Контроллер должен уметь взаимодействовать с IP-камерами, совершая <i>фотофиксацию</i>
по событиям и фотосьемку по временном интервале, настраиваемые через UI
контроллера.
</li>

<li>Необходима проработкарешения с распознаванием номеров транспортных средств на
сделанных фотографиях.
</li>

<li><i>Автономная работа</i> контроллера при отсутствии связи с сервером
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-1-2" class="outline-4">
<h4 id="sec-5-1-2"><span class="section-number-4">5.1.2</span> <span class="todo TODO">TODO</span> Требования к аппаратной части контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
[VRFY:pyub:noa] Ниже черновик раздела. Мне он нужен чтобы вынести его в ТЗ.
</p>

<p>
Условия эксплуатации.
t от 0 до 55
влажность до 95
</p>

<p>
[TODO:ske]
Испытания будут проводиться при условиях:
t=? влажность
</p>

<p>
Входящее напряжение: DC 12/24 В
Сила тока: ?? А [todo:bda] Какая сила тока?
[TODO:pyub] Внести из письма. Там есть док.
</p>

<p>
Форм-фактор базовой и управляющей плат в сборе [TODO:pyub] Сравнимо с текущим контроллером
</p>

<p>
К базовой плате должны подключаться от 1 до 3 плат расширения, унифицированных по
разъёму подключения и форм-фактору, но имеющих разный функционал - дополнительные
комплекты вводов / выводов на периферийные устройства.
</p>

<p>
К базовой плате должна подключаться плата кроссировки, позволяющая быстро
подключать к стойке находящиеся на расстоянии от стойки периферийные устройства с
помощью RJ-45.
</p>

<p>
К базовой плате должны подключаться символьные и графические дисплеи. Следует
проработать работу с дисплеями на 2 и 4 строки, графическими монохромными дисплеями
низкого разрешения и полноцевтными RGB дисплеями, в том числе сенсорными.
</p>

<p>
К базовой пате должны подключаться динамик (монозвук) и микрофон, работающие без
каких-либо дополнительных усилителей.
</p>
</div>
</div>

<div id="outline-container-sec-5-1-3" class="outline-4">
<h4 id="sec-5-1-3"><span class="section-number-4">5.1.3</span> <span class="todo TODO">TODO</span> Требования к платам расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-1-3">
<p>
[TODO:noa:pyub] Расписать зачем, что и как.
</p>
</div>
</div>

<div id="outline-container-sec-5-1-4" class="outline-4">
<h4 id="sec-5-1-4"><span class="section-number-4">5.1.4</span> <span class="todo TODO">TODO</span> Требования по подключению внешних периферийных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-1-4">
<p>
[VRFY:noa] Это сделано из старого ТЗ. Нужно причесать под текущие реалии.
</p>

<p>
Плата выполняет агрегирующую роль внешних периферийных устройств и кроссировки
линий согласно потребностям системы АСПП. Предназначена для быстрого подклчения
системы на месте после монтажа.
</p>

<p>
Плата выполнена единым устройством, на текстолитовом основании и содержит все
необходимые элементы для функционирования. Соединяется с базовой платой
широкополосным шлейфом.
</p>

<p>
На плате имеется два внешних ввода питания 24В и 12В с которых осуществляется
питание внешних устройств.  Ввод питания для внешних устройств (подключаемых к плате
по RJ45) осуществляется через развязку на базе трех пинов, если джампер установлен
на 1-2 то выводится питание со внешнего ввода №1 - 24В, если в положение 2-3 то
выводится питание со внешнего ввода №2 – ХХВ (данная схема применяется на всех
устройствах со внешним питанием).
</p>

<p>
Разводка путей путей обозначена в разделе [TODO:pyub] Таблица кроссировки
Кросс линии выходят на разъемы RJ45.
</p>

<p>
[TODO:noa:bvl:ske] Так. У нас есть развязка на оптроны рядом с сенсорными
выводамми. А что с кросс-платой? Они от сенсоров возвращаются через всю нашу базовую
плату к кроссировочному разъёму или вы дублируете их на кроссировочной?
</p>

<p>
[COMMENT:pyub] Если дублируете, но моё мнение - с базовой платы их надо убрать нахер.
</p>

<p>
На всех сенсорных выводах, идущих через плату, должны стоять оптическике реле для
развязки по питанию с внешними исполнительными устройствами.  Рекомендованно
использовать el817 c406.
</p>

<p>
Кроссировка сенсорных выводов осуществляется по следующей схеме:
сенсорный ввод &gt; оптореле &gt; контакты порта RJ45
</p>

<p>
Габаритные размеры кроссировочной платы должны быть от 270х100х15 мм до 300х150х50
мм.  Вводы питания располагаются с левой или правой стороны платы (в зависимости от
разводки разъёмов питания на базовой плате). Ввод широкополосного шлейфа должен
быть расположен в верхней части платы, возможно использования углового
разъёма. Выводы RG45 расположены в нижней части платы, возможно использование
фронтального или углового гнезда.
</p>

<p>
Плата должна иметь крепёжные отверстия на углах.
</p>
</div>
</div>

<div id="outline-container-sec-5-1-5" class="outline-4">
<h4 id="sec-5-1-5"><span class="section-number-4">5.1.5</span> <span class="todo TODO">TODO</span> Требования к программной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-1-5">
<p>
[COMMENT:pyub] Стойкое ощущение, что в данном разделе что-то было до этого мёрджа.
</p>
</div>
</div>

<div id="outline-container-sec-5-1-6" class="outline-4">
<h4 id="sec-5-1-6"><span class="section-number-4">5.1.6</span> <span class="done DONE">DONE</span> Оценка максимального количества подключений устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-1-6">
<p>
Максимальная комплектация, оплата совмещённая с выездной стойкой в вариантах на
чеках и картах.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая  модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Фискальный регистратор / Термопринтер</td>
<td class="left">Искра ПРИМ-21К03 / Custom VKP80II</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Сканер штрихкодов широкополосный / Приёмник карт Mifare+</td>
<td class="left">Honywell IS3480 QuantumE / не выбирали</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт  Mifare+</td>
<td class="left">не выбран</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Считыватель карт Em-Marine / Mifare</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI / I2C</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET cmpt.RS232</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk cmpt.RS232</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбран</td>
<td class="left">USB / Ethernet</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Вввод RS-485</td>
<td class="left">не выбран</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Вывод RS-485</td>
<td class="left">не выбран</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">GSM промышленный</td>
<td class="left">не выбран</td>
<td class="left">GPRS RS-232</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Интерфейсы</th>
<th scope="col" class="left">Подключаемое оборудование</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Основные GPIO (o)</td>
<td class="left">Шлагбаум (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Светофор (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Доп. реле (3) ???</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Основные GPIO (i)</td>
<td class="left">Токовые петли (3)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Конц. шлагбаума (2)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Фотоэл. безоп. (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Датчик грузового (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Основные GPIO (i/o)</td>
<td class="left">Арбитраж (1)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">I2C GPIO</td>
<td class="left">Универсальные кнопки (8)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">I2C + 1 GPIO@I2C</td>
<td class="left">Малый дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">RGB</td>
<td class="left">Большой дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">I2C-GPIO-Wiegand26</td>
<td class="left">Считыватель карт MF/EH</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">I2C-RS232 not isolated</td>
<td class="left">Принтер/Фиск. регистратор</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">+1  RS232 not isolated</td>
<td class="left">сканер ШК/приемник MF</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">I2C-RS485 isolated</td>
<td class="left">Табло своб. мест</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">+1  RS485 isolated</td>
<td class="left">not used in base</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">I2C+I2S</td>
<td class="left">Аудио</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Интерфейсы</th>
<th scope="col" class="left">Подключяемое  оборудование</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">I2C-RS232</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт Mifare+</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">I2C-RS232</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">I2C-RS232-ccTALK</td>
<td class="left">Хоппер</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Интерфейсы</th>
<th scope="col" class="left">Подключяемое  оборудование</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">I2C-RS232-ID003/ccNET</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">I2C-RS232</td>
<td class="left">Диспенсер купюр</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">I2C-RS232</td>
<td class="left">Industrial Cell Network Modem (GSM)</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">USB</td>
<td class="left">POS банковский терминал</td>
<td class="left">Есть вопрос, подключать ли прямо в ВВВ,</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">или городить отдельный хаб на extBoard</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">можно это оставить на переразводку</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-5-1-7" class="outline-4">
<h4 id="sec-5-1-7"><span class="section-number-4">5.1.7</span> <span class="todo WAIT">WAIT</span> Требования к гибкой реализации подключения периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-5-1-7">
<p>
[TODO:bvl] Проверь, пожалуйста, всё ли я описал как мы проговорили.
</p>

<p>
[COMMENT:pyub] Данная задача будет решаться после выхода в релиз всего базового
функционала АСПП, работающего со статическими библиотеками нижнего
уровня. Описание добавлено с целью фиксации того, что обсуждалось на совещаниях и
понимания всеми цели использования динамических библиотек в перспективе. Для
описания использован кейс с заменой фискального регистратора в текущей реализациии
системы и перспективной реализации.
</p>

<p>
Гибкая реализация нужна потому что:
</p>
<ul class="org-ul">
<li>любое периферийное устройство должно легко заменяться и настраиваться через
web-интерфейс контроллера техническим персоналом парковки;
</li>
<li>технический персонал парковки не должен иметь возможности поставить и включить
оборудование, которое не входит в комлпект поставки, но теоретически
поддерживается нашим комплексом АСПП;
</li>
<li>разработчики / поставщики должны иметь возможность отправить техническому
персоналу парковки, не имеющей выхода в сеть, файл библиотеки, подключив который
персонал получит новый функционал;
</li>
<li>держать полный список конкретных устройств во всех версиях ПО нижнего уровня
ннецелесообразно - мы можем получить в конечном счёте очень много лишних
сущностей;
</li>
<li>когда одновременно будет производиться разработка и тестирование нескольких
устройств, то проще подключать и тестировать их с одноим stable ядром, нежели
обновлять ПО нижнего уровня из-за каждого из них и контролировать версии;
</li>
<li>необходимо создание API, которое даст возможность сторонним разработчикам
периферийного оборудования делать библиотеки самим, которые мы будем
только тестировать, сертифицировать и разрешать к работе.
</li>
</ul>

<p>
Вместо одной модели устройства, обменивающегося данными с контроллером (например,
фискальный регистратора) необходимо поставить другую модель на другой COM-порт
(предположим, порт к которому был подключён фискальный регистратор ранее сгорел
вместе со старым фискальным регистратором). При этом поддержки модели не
предусмотрено в текущей версией ПО контроллера.
</p>

<p>
Технический специалист совершает следующие действия:
</p>
<ul class="org-ul">
<li>Обесточивает стойку.
</li>
<li>Отоединияет старый фискальный регистратор от COM1, присоеденить новый фискальный
регистратор к COM2.
</li>
<li>Запускает стойку.
</li>
<li>Заходит в web-интерфейс контроллера с правами <code>admin</code> или <code>root</code>.
</li>
<li><p>
Далее он должен загрузить в систему часть ПО, отвечающую за работу нового
устройства. Тут будут различия.
</p>

<p>
В решении со статическими библиотеками нам потребуется обновить прошивку
контроллера в которую будет входить:
</p>
<ul class="org-ul">
<li>обновление приложений нижнего уровня, включающие в себя библиотеки, связанные с
новым типом конкретного устройства (драйвера?)
</li>
<li>обновление бизнес-логики верхнего уровня, если таковое требуется для работы
нового типа устройства;
</li>
<li>обвновление списка настроек, включающее в себя и новый тип устройства.
</li>
</ul>
<p>
[TODO:bvl] Здесь нужна ссылка на процедуру обновления ядра в текущей реализации.
</p>

<p>
При этом с обновлением будет загружен весь список поддерживаемых системой на
момент выхода версии устройств.
</p>

<p>
В решении отдельными динамическими библиотеками обновление ядра нижнего уровня и
бизнес-логики верхнего уровня может потребоваться только в том случае, если у нас
появится новый тип или подтип абстрактного устройства, т.е. со стороны ядра
нижнего уровня и бизнес-логики верхнего уровня появятся принципиально отличающиеся
от уже существующих алгоритмы работы устройств и новые таблицы сообщений и команд
абстрактынх устройств. При такой реализации для функционирования нового
конкретного устройства уже существующего абстрактного типа нам потребуется
только подгрузить библиотеки в которые будет входить:
</p>

<ul class="org-ul">
<li>драйвера устройства;
</li>
<li>таблица сопоставления команд конкретного устрйоства с нашими командами
абстрактного устройства;
</li>
<li>стандартные настройки и информация об устройстве для системы;
</li>
<li>сертификат авторства, разрешающий подключение библиотеки.
</li>
</ul>
<p>
И обновление ядра, и работа с библиотеками в перспективе должны быть реализованы в
специальном окне web-интерфейса, где отображена информация о верссии ядра, версиях
установленных библиотек и присутсвовать окна для ввода пути загружаемого с ПК
пользователя файла бибилотеки или обновления ядра.
</p>
</li>
</ul>
<ul class="org-ul">
<li><p>
После того, как произведено обновленние / загрузка библиотеки в том же
web-интерфейсе контроллера с конкретного COM-порта (COM1 в нашем случа)
удаляется запись о неиспользуемом устройстве <code>COM1</code> = <code>0</code>, а другому COM-порту
приписывается конкретное устройство из списка <code>COM2</code> = <code>KKM-PRIM21K</code>.
</p>

<p>
В случае если пользователь пытается подключить второе устрйоство типа фискальный
регистратор не удалив первое - программа сообщает ему об ошибке.
</p>

<p>
[TODO:noa] В разделе зависимостей оборудования надо также учесть неозможность
одновременного подключения некоторых типов устройств. Например, двух фискальных
регистраторов или диспенсера и ресайклера карт. Хотя тут всё зависит ещё и от
настроек бизнес-логики.
</p>

<p>
[TODO:pyub] Необходимо описать внешний вид данного окна web-интерфейса в
соответствующем разделе.
</p>
</li>

<li>После применения настроек стойка перезагружается (или проходит <code>selftest</code>?) Далее
новое устройство готово к работе.
</li>

<li>В случае работы с динамическими библиотеками должна быть возможность удаления
неиспользуемых библиотек через то же окно web-интерфейса, где осуществляется их
загрузка.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-1-8" class="outline-4">
<h4 id="sec-5-1-8"><span class="section-number-4">5.1.8</span> Требования к автономной работе контроллера</h4>
<div class="outline-text-4" id="text-5-1-8">
<p>
Часть функций система должна выполнять, когда устройства (контроллер и сервер)
работают в автономном режиме (например при обрыве связи по Ethernet).
</p>

<p>
Изначально закладывается одноранговая структура автоматического взаимодействия
сервера и контроллера. Т.е. сервер и все контроллеры в сети постоянно обмениваются
функциональными сервисными сообщениями, синхронизируя свои данные о происходящем на
парковке. Сервер является аггрегатором функциональных и информационных сообщений
(истории лога), а также имеет приоритет настройки и управления элементами системы
(например тарифы установленные на сервере приоритетны для контроллеров, если на них
не выставлена обратная настройка) во всех случаях, кроме связанных с безопасностью
(например, если с сервера пришёл сигнал "закрыть шлагбаум", а стойка считает, что
датчик безопасности закрытия стрелы шлагбаума занят - шлагбаум не закрывается).
</p>

<p>
Таким образом возможны три сценария сбоя:
</p>
<ul class="org-ul">
<li>одна или несколько стоек теряют связь с одной или несколькими стойками и сервером (две автономные группы)
</li>
<li>все стойки теряют свзяь с сервером (две автономные группы)
</li>
<li>несколько групп, состоящих из одной или нескольких стоек, теряют связь друг сдругом и / или сервером (более двух автономных групп).
</li>
</ul>

<p>
Работа контроллера в случае обрыва связи с сервером осуществляется следующим
образом. Билет считывается сканером штрих кодов. Время и код билета сохраняются в
памяти контроллера. Решение об открытии ворот принимается охранником (на билете
напечатано время въезда). При восстановлении связи архив информации о билетах
передается на центральный сервер.
</p>

<p>
Когда и если контроллер остаётся без связи со всей остальной системой он должен
максимально полноценно выполнять заложенные в него функции автоматизации:
</p>
<ul class="org-ul">
<li>Для въезда, выезда, проезда и совмещённых с оплатой решений:
<ul class="org-ul">
<li>открывать и закрывать шлагбаум, контролировать состояние шлг.
</li>
<li>управлять сигнальными устройствами (светофорами, счётчиками мест)
</li>
<li>контролировать состояние датчиков присутсвия и безопасности
</li>
</ul>
</li>
<li>Для въездов
<ul class="org-ul">
<li>для штрих-кода: шифровать в код информацию о въезде / для Mifare: записывать информацию о въезде на карту
</li>
</ul>
</li>
<li>Для выездов, касс, проездных стоек:
<ul class="org-ul">
<li>выдавать выездной документ разовым посетителям
</li>
<li>иметь инфомацию о тарифах (исходя из сложной системы тарификации)
</li>
<li>считывать информацию с въездного документа и обрабатывать её
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Аппаратная часть контроллера</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> <span class="todo TODO">TODO</span> Данные по потреблению периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
[TODO:bvl] [TODO:pyub] [TODO:noa] Составить список того, что необходимо для
просчёта. Посчитать. От этого зависит выбор предохранителя.
</p>

<p>
[TODO:bvl] Узнать у Кирилла как можно сделать защиту по нулю при занулении на
землю, перепутанных фазе и нуле на БП и скачке напряжения с БП. Рассмотреть кейс,
подумать как это можно решить кроме как установкой фильтра на вводе.
</p>

<p>
Посчитать данные и внести в таблицу сигнальные уровни (12 В, 5 В, 3.3 В)
</p>

<p>
Чтобы осмысленно строить защиту от статики, неправильного монтажа, наводок по земле
и т.п. надо понимать что из себя представляет периферия с электрической точки
зрения.
</p>

<p>
Для наглядности представления информации неплохо бы её занести в соответствующие
таблицы.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> <span class="done DONE">DONE</span> Принципиальная схема базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="bda">bda</span></span></h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
[TODO:bvl] Поставить ссылку на каталог + описать какой файл схемы есть что. Задача
не закрыта. Также выложить инфу о том, как найти отброшенный вариант базовой платы
с кроссировкой. Номер коммита или тег. При этом не забыть указать о том, что в той
версии не всё гладко и кроссировка была изменена при выносе на отдельную плату.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> <span class="todo TODO">TODO</span> Схемотехника базовой платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-3">
<p>
[TODO:ske] Сделать, залить, выложить ссылку.
[TODO:bvl] Проконтролировать.
</p>

<p>
[COMMENT:pyub] При осмотре релизного варианта платы в 3d и проекте Altium выявлены
следующие недостатки и вопросы:
</p>
<ul class="org-ul">
<li>Разъём канала связи Wiegand 26 предлагается сделать на клеммнике с тремя
разъёмами, оставив центральный пустым.
</li>
<li>Разъёмы RS-485 host, RS-485 client, Wiegand 26 (три трёхрядных клеммника)
необходимо разместить рядом друг с другом.
</li>
<li>Рядом с ними надо разместить двухконтактный клеммник дял питания 12/24 В, которое
можно подать с него как на шину Wiegand, так и в параллельно на линии RS-485.
</li>
<li>Клемму арбитража необходимо разметсить на удалении от питания Wiegand. В целом
подключение питания считывателя в клемму арбиратажа или арбитража в клемму
питания считывателя ни к каким последствиям не приведёт - и там, и там гоняем
12В, но лучше это сделать.
</li>
<li>Зачем сделан DIP-переключатель около чипа EEPROM? Правильно ли я понимаю, что
шестиконтактный разъём выше него для подключения программатора EEPRON
</li>
<li>Если мы будем втыкать платы расширения прямо в гнёзда без шлейфа - не будут ли
они мешать друг другу из-за напаянных компонентов? Может сделать разъёмы
инвертированными, чтобы платы расширения при такой установке смотрели друг на
друга "дном"?
</li>
<li>Правильно ли я понимаю, что символьные и монохромный дисплеи использует не полную
гребёнку вывода на дисплей, а только центральный сегмент?
</li>
<li>На плате есть развязка сенсоров оптонами. Я правильно понимаю, что на разъём
кроссировочнйо платы мы забираем уже развзяаный сигнал и на кроссировочной плате
развязки нет?
</li>
<li>На развязках сенсоров обязательно нужна маркировка - какой переключатель с каким
сенсором связан! Видимо на клеммники будем клеить наклейки с номерами.
</li>
<li>"Снизу" и "сверху" от гнёзд крепления плат расширения есть много свободного
пространства. Можно ли его использовать, переместив туда какую-то низкопрофильную
мелочь?
</li>
</ul>

<p>
[COMMENT:ske] [TODO:ske] Почему 2 сенсора (7 и 8) заведины на микросхему опроса клавиатуры, а не
на ту же микросхему, что и остальные сенсоры. Не связано ли это с тем, что когда мы
убирали лишние сенсоры мы их убрали не оттуда?
</p>

<p>
СО стороны базовой платы для подключения дисплея мы используем один сорокапиновый IDC40
для всех типов дисплеев. Можем ли мы прогрммно менять назначения ног для разных типов
дисплеев?
</p>
</div>
</div>

<div id="outline-container-sec-5-2-4" class="outline-4">
<h4 id="sec-5-2-4"><span class="section-number-4">5.2.4</span> <span class="todo WAIT">WAIT</span> Принципиальная схема управляющей платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
[TODO:pyub:noa:bvl] Составить ТЗ на переразводку платы, опираясь на раздел по
оптимизации.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-5" class="outline-4">
<h4 id="sec-5-2-5"><span class="section-number-4">5.2.5</span> <span class="todo WAIT">WAIT</span> Схемотехника управляющей платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span>&#xa0;<span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-2-5">
<p>
На данный момент отложено - используем BBB.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-6" class="outline-4">
<h4 id="sec-5-2-6"><span class="section-number-4">5.2.6</span> <span class="done DONE">DONE</span> Принципиальная схема кроссировочной платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span></h4>
<div class="outline-text-4" id="text-5-2-6">
<p>
[TODO:bvl] Ссылка на документы. Не забыть указать как найти отброшенный вариант
базовой платы с кроссировкой. Номер коммита или тег.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-2-6-1"></a><span class="done DONE">DONE</span> Кроссировка RJ45 для подключения внешних устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span></span><br  /><div class="outline-text-5" id="text-5-2-6-1">
<p>
[TODO:noa:bvl] Проверить изменения, обсуждённые с Олегом при выносе на
отдельную плату.
</p>

<p>
В паралель к текущим вводам выводм контроллера на плате должны быть установленны
следующие разъемы RJ45. С возможностью размыкать джамперами или переключать питание
на второй ввод питания на контроллер части линий.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">№</th>
<th scope="col" class="left">Функция</th>
<th scope="col" class="right">Разъем</th>
<th scope="col" class="right">Пин</th>
<th scope="col" class="left">Вывод</th>
<th scope="col" class="left">Цвет по B</th>
<th scope="col" class="left">Дополнительно</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Открыть шлагбаум</td>
<td class="right">1</td>
<td class="right">1</td>
<td class="left">R1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Закрыть шлагбаум</td>
<td class="right">1</td>
<td class="right">2</td>
<td class="left">R2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Остановить шлагбаум</td>
<td class="right">1</td>
<td class="right">3</td>
<td class="left">R3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий от открыть шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R1.2</td>
<td class="left">&#xa0;</td>
<td class="left">размыкается джампером 1 от R3.2</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Общий от закрыть шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R2.2</td>
<td class="left">&#xa0;</td>
<td class="left">размыкается джампером 2 от R3.2</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий от остановить шлагбаум</td>
<td class="right">1</td>
<td class="right">4</td>
<td class="left">R3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Шлагбаум открыт</td>
<td class="right">1</td>
<td class="right">5</td>
<td class="left">S4.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Шлагбаум закрыт</td>
<td class="right">1</td>
<td class="right">6</td>
<td class="left">S5.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Общий от шлагбаум открыт</td>
<td class="right">1</td>
<td class="right">7</td>
<td class="left">S4.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Общий от шлагбаум закрыт</td>
<td class="right">1</td>
<td class="right">8</td>
<td class="left">S5.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Красный Светофор U+</td>
<td class="right">2</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 3</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">2</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Красный Светофор GND</td>
<td class="right">2</td>
<td class="right">3</td>
<td class="left">R4.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 4</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">4</td>
<td class="left">R4.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Зеленый Светофор U+</td>
<td class="right">2</td>
<td class="right">5</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 5</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">6</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Зеленый Светофор GND</td>
<td class="right">2</td>
<td class="right">7</td>
<td class="left">R5.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 6</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">2</td>
<td class="right">8</td>
<td class="left">R5.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Дополнительный Светофор U+</td>
<td class="right">3</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 7</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">2</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дополнительный Светофор GND</td>
<td class="right">3</td>
<td class="right">3</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 8</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">4</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Дополнительное реле</td>
<td class="right">3</td>
<td class="right">5</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">6</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Дополнительное реле общий</td>
<td class="right">3</td>
<td class="right">7</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="right">3</td>
<td class="right">8</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание RS485 U+</td>
<td class="right">4</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 9</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание RS485 Gnd</td>
<td class="right">4</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается Джампером 10</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Host RS485 A</td>
<td class="right">4</td>
<td class="right">3</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Host RS485 B</td>
<td class="right">4</td>
<td class="right">4</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Host RS485 Gnd</td>
<td class="right">4</td>
<td class="right">5</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Client RS485 A</td>
<td class="right">4</td>
<td class="right">6</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Client RS485 B</td>
<td class="right">4</td>
<td class="right">7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Client RS485 Gnd</td>
<td class="right">4</td>
<td class="right">8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание устройства U+</td>
<td class="right">5</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 11</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питания Устройства Gnd</td>
<td class="right">5</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 12</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Датчик присутствия автомобиля A</td>
<td class="right">5</td>
<td class="right">3</td>
<td class="left">S1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Датчик присутствия автомобиля Б</td>
<td class="right">5</td>
<td class="right">4</td>
<td class="left">S2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Общий датчика присутствия А</td>
<td class="right">5</td>
<td class="right">5</td>
<td class="left">S1.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика присутствия Б</td>
<td class="right">5</td>
<td class="right">6</td>
<td class="left">S2.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Резервный датчик</td>
<td class="right">5</td>
<td class="right">7</td>
<td class="left">S8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий резервного датчика</td>
<td class="right">5</td>
<td class="right">8</td>
<td class="left">S8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Вызов оператора</td>
<td class="right">6</td>
<td class="right">1</td>
<td class="left">B1.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Отмена/Предыдыдущее меню</td>
<td class="right">6</td>
<td class="right">2</td>
<td class="left">B2.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Подтверждение/Выбор меню</td>
<td class="right">6</td>
<td class="right">3</td>
<td class="left">B3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Навигация вверх/Предыдущий пункт</td>
<td class="right">6</td>
<td class="right">4</td>
<td class="left">B4.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Навигация вниз/Следующий пункт</td>
<td class="right">6</td>
<td class="right">5</td>
<td class="left">B5.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Оплата штрафа/Конфиг контроллера</td>
<td class="right">6</td>
<td class="right">6</td>
<td class="left">B6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Печать чека/Тестовая печать</td>
<td class="right">6</td>
<td class="right">7</td>
<td class="left">B7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий кнопок лицевой панели</td>
<td class="right">6</td>
<td class="right">8</td>
<td class="left">B1-7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Сервисный режим NO/NC</td>
<td class="right">7</td>
<td class="right">1</td>
<td class="left">B9.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Х-отчет/Z-отчет</td>
<td class="right">7</td>
<td class="right">2</td>
<td class="left">B10.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Разблокировка(Hardware)/Копия Z-отчета</td>
<td class="right">7</td>
<td class="right">3</td>
<td class="left">B11.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Аварийное открытие проезда(Удержание)/Инкассация</td>
<td class="right">7</td>
<td class="right">4</td>
<td class="left">B12.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Запрос проезда(разрешение по процедуре)/изъятие-внесение</td>
<td class="right">7</td>
<td class="right">5</td>
<td class="left">B13.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Сигнализация А/Сигнализация А(техническая зона)</td>
<td class="right">7</td>
<td class="right">6</td>
<td class="left">B14.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Сигнализация Б/Сигнализация Б(финансовая зона)</td>
<td class="right">7</td>
<td class="right">7</td>
<td class="left">B15.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий внутренних кнопок</td>
<td class="right">7</td>
<td class="right">8</td>
<td class="left">B9-15.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">8</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 13</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">8</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 14</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Фотоэлемент безопстности</td>
<td class="right">8</td>
<td class="right">3</td>
<td class="left">S6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий фотоэлемента безопастности</td>
<td class="right">8</td>
<td class="right">4</td>
<td class="left">S6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Датчик грузового транспорта</td>
<td class="right">8</td>
<td class="right">5</td>
<td class="left">S7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика грузового транспорта</td>
<td class="right">8</td>
<td class="right">6</td>
<td class="left">S7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Арбитраж шина</td>
<td class="right">8</td>
<td class="right">7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Размыкается джампером 15</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Арбитраж обвязка</td>
<td class="right">8</td>
<td class="right">8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">9</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 13</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Питание фотоэлемента безопасности</td>
<td class="right">9</td>
<td class="right">2</td>
<td class="left">GND1/GND2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 14</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Фотоэлемент безопстности</td>
<td class="right">9</td>
<td class="right">3</td>
<td class="left">S6.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий фотоэлемента безопастности</td>
<td class="right">9</td>
<td class="right">4</td>
<td class="left">S6.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Датчик грузового транспорта</td>
<td class="right">9</td>
<td class="right">5</td>
<td class="left">S7.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика грузового транспорта</td>
<td class="right">9</td>
<td class="right">6</td>
<td class="left">S7.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Датчик завершения проезда рампы</td>
<td class="right">9</td>
<td class="right">7</td>
<td class="left">S3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Общий датчика завершения проезда рампы</td>
<td class="right">9</td>
<td class="right">8</td>
<td class="left">S3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Дополнительный светофор U+</td>
<td class="right">10</td>
<td class="right">1</td>
<td class="left">U1/U2</td>
<td class="left">&#xa0;</td>
<td class="left">выбирается джампером 7</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дополнительный светофор GND</td>
<td class="right">10</td>
<td class="right">2</td>
<td class="left">R6.2</td>
<td class="left">&#xa0;</td>
<td class="left">GND1/GND2 джампером 8</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">Дополнительное реле</td>
<td class="right">10</td>
<td class="right">3</td>
<td class="left">R8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Общий дополнительного реле</td>
<td class="right">10</td>
<td class="right">4</td>
<td class="left">R8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дтчик завершения проезда рампы</td>
<td class="right">10</td>
<td class="right">5</td>
<td class="left">S3.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Общий датчика завершения проезда рампы</td>
<td class="right">10</td>
<td class="right">6</td>
<td class="left">S3.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Резервный датчик</td>
<td class="right">10</td>
<td class="right">7</td>
<td class="left">S8.1</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Общий резервного датчика</td>
<td class="right">10</td>
<td class="right">8</td>
<td class="left">S8.2</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-2-7" class="outline-4">
<h4 id="sec-5-2-7"><span class="section-number-4">5.2.7</span> <span class="todo TODO">TODO</span> Схемотехника кроссировочной платы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span></h4>
</div>
<div id="outline-container-sec-5-2-8" class="outline-4">
<h4 id="sec-5-2-8"><span class="section-number-4">5.2.8</span> <span class="todo TODO">TODO</span> Принципальные схемы плат расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-8">
</div><ol class="org-ol"><li><a id="sec-5-2-8-1"></a><span class="todo TODO">TODO</span> Принципиальная схема платы расширения UART&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /></li>
<li><a id="sec-5-2-8-2"></a><span class="todo WAIT">WAIT</span> Принципиальная схема платы расширения USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /></li>
<li><a id="sec-5-2-8-3"></a><span class="todo WAIT">WAIT</span> Принципиальная схема расширения UART+USB&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /></li>
<li><a id="sec-5-2-8-4"></a><span class="todo TODO">TODO</span> Принципиальная схема расширения сенсоров и реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /></li>
<li><a id="sec-5-2-8-5"></a><span class="todo WAIT">WAIT</span> Принципиальная схема платы GSM-модема&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-5" id="text-5-2-8-5">
<p>
На данный момент отложено - используем готовые промышленные модемы.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-2-9" class="outline-4">
<h4 id="sec-5-2-9"><span class="section-number-4">5.2.9</span> <span class="todo TODO">TODO</span> Схемотехника плат расширения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-9">
</div><ol class="org-ol"><li><a id="sec-5-2-9-1"></a><span class="todo TODO">TODO</span> Схемотехника платы расширения UART&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span><br  /></li>
<li><a id="sec-5-2-9-2"></a><span class="todo WAIT">WAIT</span> Схемотехника платы расширения USB<br  /></li>
<li><a id="sec-5-2-9-3"></a><span class="todo WAIT">WAIT</span> Схемотехника платы расширения UART+USB<br  /></li>
<li><a id="sec-5-2-9-4"></a><span class="todo TODO">TODO</span> Схемотехника платы расширения сенсоров и реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="ske">ske</span></span><br  /></li>
<li><a id="sec-5-2-9-5"></a><span class="todo WAIT">WAIT</span> Схемотехника платы GSM-модема<br  /></li></ol>
</div>
<div id="outline-container-sec-5-2-10" class="outline-4">
<h4 id="sec-5-2-10"><span class="section-number-4">5.2.10</span> <span class="todo TODO">TODO</span> Спецификация плат для производства&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="noa">noa</span>&#xa0;<span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-10">
<p>
[TODO:bvl] Согласовать с Кириллом, залить сюда и свести в отдельный документ. +
ссылки на то, что может быть интересно Олегу и Юре. Если это было - перенести сюда.
Требования на все платы желательно унифицировать.
</p>

<p>
[TODO:bvl] [TODO:noa] Здесь должны быть перечни закупаемых компонентов на все типы плат.
</p>

<p>
[TODO:noa] Сверить с нашими ТУ производства оборудования.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-11" class="outline-4">
<h4 id="sec-5-2-11"><span class="section-number-4">5.2.11</span> <span class="todo TODO">TODO</span> Соединение плат контроллера, форм-фактор&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-2-11">
<p>
[TODO:bvl] Описать как части контроллера соединяются друг с другом с точки зрения
монтажа и геометрии.
</p>

<p>
Описать типы используемых разъёмов и шлейфов, стандартиировать длины шлейфов,
указать ключи, если есть. Описать текстом специфику монтажа плат.
</p>

<p>
Сюда же форм-фактор плат и всякие габариты.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Подключаемые периферийные устройства</h3>
<div class="outline-text-3" id="text-5-3">
</div><div id="outline-container-sec-5-3-1" class="outline-4">
<h4 id="sec-5-3-1"><span class="section-number-4">5.3.1</span> <span class="todo TODO">TODO</span> Периферийные устройства (обмен данными)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
[TODO:pyub] [TODO:bvl] Собрать здесь ссылки (на пдфки) на протоколы обмена для
каждого конкретного устройства.
</p>

<p>
В данном разделе речь идёт только об устройствах с которыми мы обмениваемся
сообщениями (данными), а не сигналами по сухому контакту и сенсорам. По большей
части это торговое оборудование и сложные датчики (например, УДПА).
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-3-1-1"></a><span class="todo TODO">TODO</span> Абстрактные типы устройств (обмен данными)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span><br  /><div class="outline-text-5" id="text-5-3-1-1">
<p>
[TODO:aav] [TODO:bvl] Подумать как это назвать. Это то, как устройства выглядят,
разделяются на типы (сканер) и подтипы (линейный, широкополосный, двухмерный сканер
штрихкодов). Бизнес-логике подтип в базе не особо важен, но в частных случаех также
может понадобиться (пример: парковка на обычных штрих-кодах, но есть функция
промо-акций по QR-кодам =&gt; при считывании QR бизнес-логика должна уметь принимать
сообщение в нетипичной для парковки с билетами на штрих-кодах форме).
</p>

<p>
Мы должны уметь работать с разными типами и подтипами дисплеев, при этом с точки
зрения бизнес-логики разница будет только при наличии / отсутствии сенсорной
системы ввода, а с точки зрения нижнего уровня можно разделить дисплеи на три типа.
</p>

<p>
В этих разделах будет текстовое описание абстрактных типов и их специфики. В
конечном счёт мы должны держать здесь таблицы функций, параметров и ошибок для
абстрактных устройств.
</p>

<p>
Есть вероятность, что мы слишком раздробили, либо что-то не учли.
</p>

<p>
Здесь же имеет смысл словами описывать собственно алгоритмы работы устройства
"внутри себя", с точки зрения пользователя и взаимодействия с нашей системой.
</p>

<p>
[COMMENT:aav] Это описано в разных разделах, нужно здесть просто сделать краткую
выжимку.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-3-1-1-1"></a><span class="todo TODO">TODO</span> Дисплей символьный<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-1-1"></a><span class="todo WAIT">WAIT</span> Символьный - 2 строки<br  /></li>
<li><a id="sec-5-3-1-1-1-2"></a><span class="todo TODO">TODO</span> Символьный - 4 строки<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-2"></a><span class="todo WAIT">WAIT</span> Дисплей графический&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span><br  /><div class="outline-text-6" id="text-5-3-1-1-2">
<p>
[COMMENT:pyub] Согласовать как будем работать с этими дисплеями.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-3-1-1-2-1"></a><span class="todo WAIT">WAIT</span> Монохромный графический<br  /></li>
<li><a id="sec-5-3-1-1-2-2"></a><span class="todo WAIT">WAIT</span> RGB диагональ 7' LCD<br  /></li>
<li><a id="sec-5-3-1-1-2-3"></a><span class="todo WAIT">WAIT</span> Монитор настольный<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-3"></a><span class="todo WAIT">WAIT</span> Дисплей цветной сенсорный<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-3-1"></a><span class="todo WAIT">WAIT</span> RGB 7' LCD сенсорный<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-4"></a><span class="todo WAIT">WAIT</span> Клавиатура<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-4-1"></a>USB клавиатура<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-5"></a><span class="todo TODO">TODO</span> Термопринтер<br  /><div class="outline-text-6" id="text-5-3-1-1-5">
<p>
На данный момент мы предполагаем использование только VKP-80. Разделить на
подтипы мы не можем потому что у нас нет выборки различных опций и специфики
функиционирования устройств.
</p>

<p>
Принтеры могут различаться по настройкам нижнего уровня, например, скорости
общения, по ширине используемой термобумаги, конфигурированию датчиков и ножа
автообрезчика, по наличию/отсутсвию контроля презентера.
</p>

<p>
Разрабатывая VKP-80 нужно оглядывться на фискальный регистратор ПРИМ21К, т.к. в
его основе этот же принтер.
</p>
</div>
</li>

<li><a id="sec-5-3-1-1-6"></a><span class="todo TODO">TODO</span> Фискальный регистратор<br  /><div class="outline-text-6" id="text-5-3-1-1-6">
<p>
[TODO:bvl] Разобраться с документацией по фискальному регистратору.
</p>

<p>
На сайте производитля лежат драйвера: <a href="http://www.iskra-kkm.ru/support/lib.php">http://www.iskra-kkm.ru/support/lib.php</a>
Они могут нам помочь при разработке принтера и фискального регистратор.
</p>

<p>
Можно предположить, что фискальный регистратором является частным случаем
термопринтера. В основе фискального регистратора всегда есть термопринтер. На
данный момент мы используем регистратор ПРИМ-21К в основе которого лежит принтер
VKP-80, такой же как и на въездной стойке.
</p>
</div>
</li>

<li><a id="sec-5-3-1-1-7"></a><span class="todo TODO">TODO</span> Сканер штрихкода<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-7-1"></a><span class="todo WAIT">WAIT</span> Линейный сканер<br  /></li>
<li><a id="sec-5-3-1-1-7-2"></a><span class="todo TODO">TODO</span> Широкополосный сканер<br  /></li>
<li><a id="sec-5-3-1-1-7-3"></a><span class="todo WAIT">WAIT</span> Двухменый сканер<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-8"></a><span class="todo WAIT">WAIT</span> Приёмник купюр<br  /><div class="outline-text-6" id="text-5-3-1-1-8">
<p>
На данный момент hазделить на подтипы мы не можем потому что у нас нет выборки
различных опций и специфики функиционирования устройств.
</p>

<p>
Вероятно будет зависеть от особенностей разных нациоальных валют, возможно по
другим критериям.
</p>
</div>
</li>

<li><a id="sec-5-3-1-1-9"></a><span class="todo WAIT">WAIT</span> Диспенсер купюр<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-9-1"></a><span class="todo WAIT">WAIT</span> Диспенсер на 1 номинал<br  /></li>
<li><a id="sec-5-3-1-1-9-2"></a><span class="todo WAIT">WAIT</span> Диспенсер на 2 номинала<br  /></li>
<li><a id="sec-5-3-1-1-9-3"></a><span class="todo WAIT">WAIT</span> Диспенсер на 4 номинала<br  /></li></ol>
</li>
<li><a id="sec-5-3-1-1-10"></a><span class="todo WAIT">WAIT</span> Приёмник монет<br  /><div class="outline-text-6" id="text-5-3-1-1-10">
<p>
На данный момент hазделить на подтипы мы не можем потому что у нас нет выборки
различных опций и специфики функиционирования устройств.
</p>
</div>
</li>

<li><a id="sec-5-3-1-1-11"></a><span class="todo WAIT">WAIT</span> Хоппер<br  /><div class="outline-text-6" id="text-5-3-1-1-11">
<p>
<code>Хоппер</code> - это диспенсер монет.
</p>

<p>
На данный момент hазделить на подтипы мы не можем потому что у нас нет выборки
различных опций и специфики функиционирования устройств.
</p>
</div>
</li>

<li><a id="sec-5-3-1-1-12"></a><span class="todo WAIT">WAIT</span> Ресайклер купюр<br  /></li>
<li><a id="sec-5-3-1-1-13"></a><span class="todo WAIT">WAIT</span> Ресайклер монет<br  /></li>
<li><a id="sec-5-3-1-1-14"></a><span class="todo TODO">TODO</span> Считыватель RFID<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-14-1"></a><span class="todo TODO">TODO</span> Считыватель Em-Marine<br  /></li>
<li><a id="sec-5-3-1-1-14-2"></a><span class="todo WAIT">WAIT</span> Считыватель Mifare<br  /></li>
<li><a id="sec-5-3-1-1-14-3"></a><span class="todo WAIT">WAIT</span> Считыватель DSRC<br  /><div class="outline-text-7" id="text-5-3-1-1-14-3">
<p>
Считыватель DSRC - это транспондер с ЗСД.
</p>

<p>
Статья, описывающая систему: <a href="http://habrahabr.ru/post/240047/">http://habrahabr.ru/post/240047/</a>
</p>

<p>
Даташит на пример устройства лежит в devices/DSRC.
</p>

<p>
<code>DSRC</code> (Dedicated Short Range Communication) - беспроводная связь на короткое
расстояние. Частота несущей в диапазоне 5.8 ГГц. Линии связи DSRC находят
применение, главным образом, в системах электронного платежа, так как для этой
технологии были завершены стандарты на уровне Европейского Союза (CEN/TC278 и
ETSI). Линия связи DSRC состоит из двух основных частей, а именно: из блока <code>OBU</code>
(On-Board Unit - устройство в транспортном средстве) и блока <code>RSE</code> (Road Side
Equipment - устройство на дороге), которые обмениваются данными.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-3-1-1-15"></a><span class="todo WAIT">WAIT</span> Приёмник карт<br  /></li>
<li><a id="sec-5-3-1-1-16"></a><span class="todo WAIT">WAIT</span> Диспенсер карт<br  /><ol class="org-ol"><li><a id="sec-5-3-1-1-16-1"></a><span class="todo WAIT">WAIT</span> Простой диспенсер<br  /></li>
<li><a id="sec-5-3-1-1-16-2"></a><span class="todo WAIT">WAIT</span> Диспенсер с автозаглатыванием карт<br  /><div class="outline-text-7" id="text-5-3-1-1-16-2">
<p>
[COMMENT:pyub] Вспомнил про такую фичу, как заглатывание карты по таймауту, если
её не забрали (карточки в банкоматах). Уверен, что такое умеют не все
диспенсеры, но это крутая фича для премиум сегмента.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-3-1-1-17"></a><span class="todo WAIT">WAIT</span> Ресайклер карт<br  /></li>
<li><a id="sec-5-3-1-1-18"></a><span class="todo TODO">TODO</span> Терминал банковских карт<br  /><div class="outline-text-6" id="text-5-3-1-1-18">
<p>
Каждое конкретное решение осуществляется по заданной спецификации банка
(первично) + спецификации производителя устройства (вторично).
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-3-1-2"></a><span class="todo TODO">TODO</span> Зависимости абстрактных периферийных устройств (обмен данными)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="noa">noa</span>&#xa0;<span class="gmm">gmm</span></span><br  /><div class="outline-text-5" id="text-5-3-1-2">
<p>
[TODO:noa] [TODO:pyub] - Расписать зависимости <code>абстрактных устройств</code>, указывая
причины почему одна периферия не может работать без другой. Уровень бизнес-логики
использует эти данные.
</p>

<p>
[TODO:gmm] - Построить граф зависимостей, проверить наличие циклов в нем.
</p>

<p>
[COMMENT:noa] Зависимость одного устройства от другого определить очень сложно,
предлагаю сделать табличку функция -&gt; зависящее оборудование -&gt; что делаем. Вопрос
как нам сформировать список функций.
</p>

<p>
[COMMENT:gmm] Думаю, можно сделать так: У нас есть алгоритмы проезда (например,
проезд по штрихкоду). Мы могли бы в его описании на каждом шаге выделять
используемые устройства, например так:
</p>
<pre class="example">
При переключении в состояние =finding= происходят следующие действия:
- размыкается =светофор сигнал 1= (=реле R4=), отвечающее за зелёный сигнал на светофоре
- замыкается =светофор сигнал 2= (=реле R5=), отвечающее за красный сигнал на светофоре
- на сервер отправляет =сообщение= "Машина у стойки въезда".
</pre>
<p>
Кое-где так уже сделано. А потом внизу формировать эту табличку. Таким образом у
нас будет табличка близко к описанию работы и все будет проще проверить. А мне
будет проще там же написать код, который обрабатывает действия при отказе. Потом
все это можно будет автоматически собрать в сценарии обработки ошибок из всех
разделов, так будет проще чем прыгать по тексту туда-сюда.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Название функции</th>
<th scope="col" class="left">Функция</th>
<th scope="col" class="left">устройства</th>
<th scope="col" class="left">Действия при отказе</th>
<th scope="col" class="left">Критичность/возможность замены</th>
<th scope="col" class="left">Дополнительные изменения</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><code>Въезд по билету</code></td>
<td class="left">Въезд на парковку по билету со штрих кодом</td>
<td class="left">Принтер</td>
<td class="left">Отключаем возможность въезда по билету</td>
<td class="left">Важно</td>
<td class="left">Убирам в приветстнных текстах слово "билет" и все производные выражения</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Дисплей монохромный</td>
<td class="left">Отключаем диалоговые режимы въезда</td>
<td class="left">Не важно /цветной дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Дисплей цветной</td>
<td class="left">Отключаем диалоговые режимы въезда</td>
<td class="left">Не важно /монохромый дисплей</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left"><code>Выезд по билету</code></td>
<td class="left">Выезд с парковки по билетам со штрихкодом</td>
<td class="left">Сканер штрих кода</td>
<td class="left">Отключаем выезд по билетам</td>
<td class="left">Важно</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Дисплей монохромный</td>
<td class="left">Отключаем диалоговые режимы вызда</td>
<td class="left">Не важно /цветной дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Дисплей цветной</td>
<td class="left">Отключаем диалоговые режимы выезда</td>
<td class="left">Не важно /монохромый дисплей</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">Связь с сетью</td>
<td class="left">Отключаем выезда по акцептированию</td>
<td class="left">не важно</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
[COMMENT:noa] И так далее в дальнешем эту таблицу можно перевести в раздел обработки ощибок. Нужен
ли нам вобще граф зависимости устройств?
</p>

<p>
[COMMENT:pyub] Необходимо верифицировать данный список со списком из
раздела <a href="#sec-5-3-1-1">Абстрактные типы устройств (обмен данными)</a>.
Зависимости могут возникать как между типами, так и между подтипами.
</p>

<p>
[COMMENT:noa] Вводим ли мы сюда не опрашиваемые систесой устройства? Аргумент "ЗА" в настройках
можно будет отключать устройства и корректно обрабатывать их отсутствие ПРИМЕР:
Доопустим на объекте не нужен скуд/или считыватель неисправен мы делаем
"Считыватель - false" или физически не ставим этот считыватель/снимаем его при
этом стойка не предлагает поднести карту и ее невозможно будет вывести в режим
работы с картой, тем самым убираем хвост возможных багов.
</p>

<p>
[COMMENT:noa] Аргумент "ПРОТИВ" это дофига работы как и для постановщиков так и
для прогеров, что снижает скорость разработки. А мы и так отстаем от графика
</p>

<p>
[COMMENT:noa] Да "надо потом будет сделать" равнозначно "против" потому как эта
TODO провисит там до первого пришествия, а потом нужно будет перепахивать
архитектуру как мне кажется.
</p>

<p>
[COMMENT:gmm] Хм, а я так думал, что такая логика у нас и будет&#x2026; Мы же должны
корректно обрабатывать любые отказы, разве нет? Отсутствие устройства (или его
отключение в настройках) - вполне себе с точки зрения логики эквивалентно его
отказу.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-3-1-2-1"></a>Дисплей монохромный<br  /><div class="outline-text-6" id="text-5-3-1-2-1">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Клавиатура
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-2"></a>Дисплей цветной<br  /><div class="outline-text-6" id="text-5-3-1-2-2">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Клавиатура/сенсор дисплея
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-3"></a>Сенсор дисплея<br  /><div class="outline-text-6" id="text-5-3-1-2-3">
<p>
Диалоговые режимы работы
</p>

<p>
необходимые устройства:
-Цветной дисплей
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-4"></a>Клавиатура<br  /><div class="outline-text-6" id="text-5-3-1-2-4">
<p>
Диалоговый режим работы
</p>

<p>
необходимые устройства:
-дисплей сенсорный/монохромный
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-5"></a>Термопринтеры<br  /><div class="outline-text-6" id="text-5-3-1-2-5">
<p>
Въезд по билетам
Безналичный расчет
</p>

<p>
необходимые устройства:
</p>
</div>
</li>

<li><a id="sec-5-3-1-2-6"></a>Фискальный регистратор<br  /><div class="outline-text-6" id="text-5-3-1-2-6">
<p>
Оплата наличными
Безналичный расчет
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-7"></a>Сканеры штриховых кодов<br  /><div class="outline-text-6" id="text-5-3-1-2-7">
<p>
Оплата билетов
Выезд по карам
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-8"></a>Приёмники купюр<br  /><div class="outline-text-6" id="text-5-3-1-2-8">
<p>
Прием купюр
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-9"></a>Диспнесеры купюр<br  /><div class="outline-text-6" id="text-5-3-1-2-9">
<p>
Выдача купюр
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-10"></a>Приёмник монет<br  /><div class="outline-text-6" id="text-5-3-1-2-10">
<p>
Прием монет
</p>

<p>
необходимые устройства:
-прием монет
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-11"></a>Хоппер (диспенсер монет)<br  /><div class="outline-text-6" id="text-5-3-1-2-11">
<p>
Выдча монет
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-12"></a>Ресайклер купюр<br  /><div class="outline-text-6" id="text-5-3-1-2-12">
<p>
Прием бумажной наличности
Выдача бумжной наличности
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-13"></a>Ресайклер монет<br  /><div class="outline-text-6" id="text-5-3-1-2-13">
<p>
Прием монет
Выдача монет
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-14"></a>Считыватели карт EM-Marine, Mifare<br  /><div class="outline-text-6" id="text-5-3-1-2-14">
<p>
Работа с картами
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-15"></a>Приёмник карт<br  /><div class="outline-text-6" id="text-5-3-1-2-15">
<p>
Приме карт
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-16"></a>Диспенсер карт<br  /><div class="outline-text-6" id="text-5-3-1-2-16">
<p>
Выдача карт
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-17"></a>Ресайклер карт<br  /><div class="outline-text-6" id="text-5-3-1-2-17">
<p>
Прием карт
Выдача карт
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-18"></a>Терминал банковских карт<br  /><div class="outline-text-6" id="text-5-3-1-2-18">
<p>
Безналичный расчет
</p>

<p>
необходимые устройства:
-термопринтер/фискальный регистратор
</p>
</div>
</li>
<li><a id="sec-5-3-1-2-19"></a>Транспондер DSRC<br  /><div class="outline-text-6" id="text-5-3-1-2-19">
<p>
Работа с радиоме
</p>
</div>
</li></ol>
</li>
<li><a id="sec-5-3-1-3"></a><span class="todo TODO">TODO</span> Периферийные устройства контроллера и протоколы связи<br  /><div class="outline-text-5" id="text-5-3-1-3">
<p>
Документация по всему периферийному оборудованию лежит тут: <a href="file://home/pyub/repo/asp/devices">devices</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Периферийное оборудовани</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
<th scope="col" class="left">Необходимое питание (мА)</th>
<th scope="col" class="left">Изоляция (Y/N)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Термопринтер</td>
<td class="left">Custom VKP80II</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Фискальный регистратор</td>
<td class="left">Искра ПРИМ-21К 03</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Сканер штрихкодов широкополосный</td>
<td class="left">Honywell IS3480 QuantumE</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Сканер штрихкода / QR-кода</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Диспенсер карт Mifare+</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Картоприёмник Mifare+</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Mifare + Matrix II MF-I</td>
<td class="left">Wiegand 26</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">Купюроприемник</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">ICT L77F</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Монетоприемник</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">ICT ND 300 KM</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk / Hopper</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">15</td>
<td class="left">Ресайклер монет</td>
<td class="left">не выбрана</td>
<td class="left">RS-232</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">16</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбрана</td>
<td class="left">RS-232 / USB / Ethernet</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">17</td>
<td class="left">Табло счётчика мест / инфотабло</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">18</td>
<td class="left">Ультразвуковой датчик наличия машины</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">19</td>
<td class="left">Магнитный датчик наличия машины</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-1-4"></a><span class="todo TODO">TODO</span> Стандарт подключения периферии к контроллеру&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-5" id="text-5-3-1-4">
<p>
[TODO:bvl] Необходима таблица к какому порту по умолчанию что подключается и с
какими настройками. По умолчанию.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-3-2" class="outline-4">
<h4 id="sec-5-3-2"><span class="section-number-4">5.3.2</span> <span class="todo TODO">TODO</span> Периферийные устройства (обмен сигналами)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
В данном разделе речь идёт только об устройствах с которыми мы обмениваемся
сигналами (реле + сенсор) и описаны алгоритмы функционирования таких
устройств и их взаимодействия с группами датчиков и реле контроллера.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-3-2-1"></a><span class="todo TODO">TODO</span> Описание возможности перенастройки<br  /><div class="outline-text-5" id="text-5-3-2-1">
<p>
[COMMENT:pyub] Не очень понимаю где это должно быть и о чём вообще речь.
</p>

<p>
Раздел в апппаратной части: <a href="#sec-5-11">Описание блока настроек портов подключения</a>
</p>
</div>
</li>

<li><a id="sec-5-3-2-2"></a><span class="done DONE">DONE</span> Стандартное назначение подключения датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-5" id="text-5-3-2-2">
<p>
[TODO:bvl] Вписать в таблицы в этих трех разделах конкретные названия пинов в виде
PX.XX и соответствующие им GPIO<sub>XX</sub>.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Сенсорный ввод</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Ввод</th>
<th scope="col" class="left">Домен</th>
<th scope="col" class="left">Типичный</th>
<th scope="col" class="left">max U при</th>
</tr>

<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип / описание назначения</th>
<th scope="col" class="left">Название в системе</th>
<th scope="col" class="left">по умолч.</th>
<th scope="col" class="left">развязки</th>
<th scope="col" class="left">ур. сигнала</th>
<th scope="col" class="left">ошибке монтажа</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">32</td>
<td class="left">Датчик присутсвия автомобиля А</td>
<td class="left"><code>detector-a</code></td>
<td class="left">S1</td>
<td class="left">присутствие</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">33</td>
<td class="left">Датчик присутсвия автомобиля Б</td>
<td class="left"><code>detector-b</code></td>
<td class="left">S2</td>
<td class="left">присутствие</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">34</td>
<td class="left">Датчик завершения проезда рампы</td>
<td class="left"><code>detector-c</code></td>
<td class="left">S3</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">35</td>
<td class="left">Концевки открытия шлагбаума</td>
<td class="left"><code>detector-gate-open</code></td>
<td class="left">S4</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">36</td>
<td class="left">Концевик закрытия шлагбаума</td>
<td class="left"><code>detector-gate-close</code></td>
<td class="left">S5</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">37</td>
<td class="left">Фотоэлемент безопасности</td>
<td class="left"><code>detector-safety</code></td>
<td class="left">S6</td>
<td class="left">шлагбаум</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">38</td>
<td class="left">Датчик грузового транспорта</td>
<td class="left"><code>detector-truck</code></td>
<td class="left">S7</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">39</td>
<td class="left">Резерв</td>
<td class="left">-</td>
<td class="left">S8</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-2-3"></a><span class="done DONE">DONE</span> Стандартное назначение подключения реле&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-5" id="text-5-3-2-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Выходы - сухой контакт</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип / описание назанчения</th>
<th scope="col" class="left">Название в системе</th>
<th scope="col" class="left">Реле по умолчанию</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">22</td>
<td class="left">Шлагбаум открытие (вверх)</td>
<td class="left"><code>relay-gate-open</code></td>
<td class="left">R1</td>
</tr>

<tr>
<td class="right">23</td>
<td class="left">Шлагбаум закрытие (внизз)</td>
<td class="left"><code>relay-gate-close</code></td>
<td class="left">R2</td>
</tr>

<tr>
<td class="right">24</td>
<td class="left">Шлагбаум стоп</td>
<td class="left"><code>relay-gate-stop</code></td>
<td class="left">R3</td>
</tr>

<tr>
<td class="right">25</td>
<td class="left">Светофор сигнал 1</td>
<td class="left"><code>relay-sign-1</code></td>
<td class="left">R4</td>
</tr>

<tr>
<td class="right">26</td>
<td class="left">Светофор сигнал 2</td>
<td class="left"><code>relay-sign-2</code></td>
<td class="left">R5</td>
</tr>

<tr>
<td class="right">27</td>
<td class="left">Светофор сигнал 3</td>
<td class="left"><code>relay-sign-3</code></td>
<td class="left">R6</td>
</tr>

<tr>
<td class="right">28</td>
<td class="left">Подсветка кнопки</td>
<td class="left"><code>relay-backlight</code></td>
<td class="left">R7</td>
</tr>

<tr>
<td class="right">29</td>
<td class="left">Доп. реле управления смежными устр.</td>
<td class="left">-</td>
<td class="left">R8</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-2-4"></a><span class="done DONE">DONE</span> Стандартное назначение подключения кнопок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><ol class="org-ol"><li><a id="sec-5-3-2-4-1"></a>Функции<br  /><div class="outline-text-6" id="text-5-3-2-4-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Функции</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">40</td>
<td class="left">Сигнализация А (техническая зона)</td>
</tr>

<tr>
<td class="right">41</td>
<td class="left">Сигнализация В (финансовая зона)</td>
</tr>

<tr>
<td class="right">42</td>
<td class="left">Вызов оператора</td>
</tr>

<tr>
<td class="right">43</td>
<td class="left">ОТМЕНА</td>
</tr>

<tr>
<td class="right">44</td>
<td class="left">ПОДТВЕРЖДЕНИЕ</td>
</tr>

<tr>
<td class="right">45</td>
<td class="left">Навигация Вверх</td>
</tr>

<tr>
<td class="right">46</td>
<td class="left">Навигация Вниз</td>
</tr>

<tr>
<td class="right">47</td>
<td class="left">Оплата ШТРАФА</td>
</tr>

<tr>
<td class="right">48</td>
<td class="left">X-отчет</td>
</tr>

<tr>
<td class="right">49</td>
<td class="left">Z-отчет</td>
</tr>

<tr>
<td class="right">50</td>
<td class="left">Копия Z-отчета</td>
</tr>

<tr>
<td class="right">51</td>
<td class="left">Печать чека (въезд)</td>
</tr>

<tr>
<td class="right">52</td>
<td class="left">Инкассация</td>
</tr>

<tr>
<td class="right">53</td>
<td class="left">Изъятие/внесение (?)</td>
</tr>

<tr>
<td class="right">54</td>
<td class="left">Разблокировка (hardware)</td>
</tr>

<tr>
<td class="right">55</td>
<td class="left">Тестовая печать</td>
</tr>

<tr>
<td class="right">56</td>
<td class="left">Сервисный режим (удержание, кнопка с фиксацией)</td>
</tr>

<tr>
<td class="right">57</td>
<td class="left">Запрос проезда (разрешение)</td>
</tr>

<tr>
<td class="right">58</td>
<td class="left">Открытие проезда (удержание)</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="left">Конфиг контроллера (?)</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-2-4-2"></a>Внешние кнопки<br  /><div class="outline-text-6" id="text-5-3-2-4-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
</tr>

<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Осн. режим</th>
<th scope="col" class="left">В сервисном режиме</th>
<th scope="col" class="left">Name</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">Вызов оператора</td>
<td class="left">&#xa0;</td>
<td class="left">B1</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">ОТМЕНА</td>
<td class="left">Предыдущее меню</td>
<td class="left">B2</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">ПОДТВЕРЖДЕНИЕ</td>
<td class="left">Выбор меню</td>
<td class="left">B3</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Навигация Вверх</td>
<td class="left">Предыдущий пункт</td>
<td class="left">B4</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Навигация Вниз</td>
<td class="left">Следующий пункт</td>
<td class="left">B5</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Оплата ШТРАФА</td>
<td class="left">Конфиг контроллера</td>
<td class="left">B6</td>
<td class="left">IP/тип/статус сязи с сервером/состояние на экран</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Печать чека (въезд)</td>
<td class="left">Тестовая печать</td>
<td class="left">B7</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Резерв</td>
<td class="left">Резерв</td>
<td class="left">B8</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-2-4-3"></a>Внутренние кнопки<br  /><div class="outline-text-6" id="text-5-3-2-4-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Осн. режим</th>
<th scope="col" class="left">В сервисном режиме</th>
<th scope="col" class="left">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">Основной режим (Разомкнута конопка с фиксацией)</td>
<td class="left">Сервесный режим (замкнута кнопка с фиксацией)</td>
<td class="left">B9</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">X-отчет</td>
<td class="left">Z-отчет</td>
<td class="left">B10</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Разблокировка (hardware)</td>
<td class="left">Копия Z-отчета</td>
<td class="left">B11</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Аварийное открытие проезда (удержание)</td>
<td class="left">Инкассация</td>
<td class="left">B12</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Запрос проезда (разрешение по процедуре)</td>
<td class="left">Изъятие/внесение (?)</td>
<td class="left">B13</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Сигнализация А (техническая зона)</td>
<td class="left">Сигнализация А (техническая зона)</td>
<td class="left">B14</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Сигнализация В (финансовая зона)</td>
<td class="left">Сигнализация В (финансовая зона)</td>
<td class="left">B15</td>
</tr>

<tr>
<td class="left">&#xa0;</td>
<td class="left">Резерв</td>
<td class="left">Резерв</td>
<td class="left">B16</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</li>

<li><a id="sec-5-3-2-5"></a><span class="todo TODO">TODO</span> Алгоритмы работы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-5-3-2-5">
<p>
[TODO:pyub] Здесь должны быть все алгоритмы работы, которые оказались в
настройках. Речь идет о вложенных автоматах, которые работают всегда одинакого и
выбираются в зависимости от настроек. Нужно перенести сюда.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-3-3" class="outline-4">
<h4 id="sec-5-3-3"><span class="section-number-4">5.3.3</span> <span class="todo TODO">TODO</span> Стандартные комплекты периферийных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-3-3">
</div><ol class="org-ol"><li><a id="sec-5-3-3-1"></a><span class="done DONE">DONE</span> Въездная / выездная стойка с выдачей бумажного билета, СКУД и IP-связью (пилот)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-5-3-3-1">
<p>
[TODO:bvl] Привести таблицу в понятный тебе вид.
</p>

<p>
Функционирование оборудования из данного списка должно быть реализовано в пилотном
проекте.
</p>

<p>
Также подключены светофор и табло со счётчиком мест.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
<th scope="col" class="left">Важность для работы сиситемы и функционал</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Термопринтер / Сканер штрих-кода</td>
<td class="left">Custom VKP80II / Honywell IS3480 QuantumE</td>
<td class="left">RS-232</td>
<td class="left">Опрашиваемое и критичное - при выходе из строя или определённых сигналов с датчиков блокировка проезда по чекам</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Считыватель карт Em-Marine</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
<td class="left">Опциональное</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long / МЭЛТ</td>
<td class="left">[TODO:bvl] Чё?!</td>
<td class="left">Опциональное</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Таблое свеетодиодное, счетчик мест (опц)</td>
<td class="left">не выбрана</td>
<td class="left">RS-485 IN</td>
<td class="left">Опциональное</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="left">Вывод на динамик</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">&#xa0;</td>
<td class="left">Опциональное</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Вывод на микрофон</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">&#xa0;</td>
<td class="left">Опциональное</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">7</td>
<td class="left">Шлагбаум вверх</td>
<td class="left">R1</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, стрела поднимается</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Шлагбаум вниз</td>
<td class="left">R2</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, стрела опускается</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Шлагбаум стоп</td>
<td class="left">R3</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле подаётся напряжение на плату управления шлагбаума, движение стрелы принудительно останавливается</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Светофор сигнал 1</td>
<td class="left">R4</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле ток идёт на группу диодов светофора зелёного цвета</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">Светофор сигнал 2</td>
<td class="left">R5</td>
<td class="left">&#xa0;</td>
<td class="left">По замыканию реле ток идёт на группу диодов светофора красного цвета</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">12</td>
<td class="left">Датчик присутсвия автомобиля А</td>
<td class="left">S1</td>
<td class="left">&#xa0;</td>
<td class="left">В случае отсутсвия сигнала - система не работает корректно, отключаемо оператором</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Датчик присутсвия автомобиля Б</td>
<td class="left">S2</td>
<td class="left">&#xa0;</td>
<td class="left">В случае отсутсвия сигнала - система не работает корректно, отключаемо оператором</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">Концевки открытия шлагбаума</td>
<td class="left">S5</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что шлг. открыт</td>
</tr>

<tr>
<td class="right">15</td>
<td class="left">Концевик закрытия шлагбаума</td>
<td class="left">S6</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что шлг. закрыт</td>
</tr>

<tr>
<td class="right">16</td>
<td class="left">Фотоэлемент безопасности</td>
<td class="left">S7</td>
<td class="left">&#xa0;</td>
<td class="left">Если есть сигнал - система думает, что на линии ф/э ннчего нет, если нет - сигнал на реле шлагбаум стоп</td>
</tr>

<tr>
<td class="right">17</td>
<td class="left">Кнопка 1 - Печать билета</td>
<td class="left">B1</td>
<td class="left">&#xa0;</td>
<td class="left">Отправка команды на принтер на печать билета и срабатывание арбитража, если надо</td>
</tr>

<tr>
<td class="right">18</td>
<td class="left">Кнопка 2 - Вызов оператора (IP-связь)</td>
<td class="left">B2</td>
<td class="left">&#xa0;</td>
<td class="left">Вызов по IP-связи на установленный в настройках стойки терминал связи</td>
</tr>

<tr>
<td class="right">19</td>
<td class="left">Кнопка 3 - Разблокировка</td>
<td class="left">B3</td>
<td class="left">&#xa0;</td>
<td class="left">Вывод стойки из состояния блокировки, в которое она может войти в случе неиспрвности критичного устрйоства</td>
</tr>

<tr>
<td class="right">20</td>
<td class="left">Кнопка 4 - Завпрос открытия шлг.</td>
<td class="left">B4</td>
<td class="left">&#xa0;</td>
<td class="left">Отправка команды на открытие шлагбаума (опционально в настройках - либо всегда, либо только при наличии машины, либо только в состоянии блокировки)</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="sec-5-3-3-2"></a><span class="todo WAIT">WAIT</span> Максимальная комплектация, оплата совмещённая с выездной стойкой в вариантах на чеках и картах&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span><br  /><div class="outline-text-5" id="text-5-3-3-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Тип устройства</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Интерфейс подключения</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">Фискальный регистратор / Термопринтер</td>
<td class="left">Искра ПРИМ-21К 03 / Custom VKP80II</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Сканер штрихкодов широкополосный / Приёмник карт Mifare+</td>
<td class="left">Honywell IS3480 QuantumE / не выбирали</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">Диспенсер карт Mifare+ / Ресайклер карт Mifare+</td>
<td class="left">&#xa0;</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">Считыватель карт Em-Marine / Mifare</td>
<td class="left">Iron Logic Matrix V / Matrix II EH</td>
<td class="left">Wiegand 26</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">Дисплей монохромный символьный 16*4</td>
<td class="left">Winstar / Long</td>
<td class="left">6800 / SPI / I2C</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">Дисплей цветной графический TFT-LCD</td>
<td class="left">Winstar / Long</td>
<td class="left">RGB / MCU</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">Купюроприемник / Ресайклер купюр</td>
<td class="left">CashCode SM (MSM)</td>
<td class="left">ID003 / CCNET cmpt.RS232</td>
</tr>

<tr>
<td class="right">8</td>
<td class="left">Монетоприемник / Ресайклер монет</td>
<td class="left">ICT UCA2</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">9</td>
<td class="left">Диспенсер купюр</td>
<td class="left">Puloon LCDM-1000/2000/4000</td>
<td class="left">RS-232</td>
</tr>

<tr>
<td class="right">10</td>
<td class="left">Хоппер</td>
<td class="left">ICT Leonid Mini Hopper</td>
<td class="left">ccTalk cmpt.RS232</td>
</tr>

<tr>
<td class="right">11</td>
<td class="left">POS банк-терминал</td>
<td class="left">не выбрана</td>
<td class="left">USB / Ethernet</td>
</tr>

<tr>
<td class="right">12</td>
<td class="left">Вввод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">13</td>
<td class="left">Вывод RS-485</td>
<td class="left">не выбрана</td>
<td class="left">RS-485</td>
</tr>

<tr>
<td class="right">14</td>
<td class="left">GSM промышленный</td>
<td class="left">не выбрана</td>
<td class="left">GPRS RS-232</td>
</tr>
</tbody>
</table>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-3-4" class="outline-4">
<h4 id="sec-5-3-4"><span class="section-number-4">5.3.4</span> <span class="todo TODO">TODO</span> Аудио оборудование&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-5-3-4">
<p>
[TODO:bvl] Выбор драйвера. Настройка ОС. Выбор SIP-клиента.
</p>

<p>
Делаем в пилотнике. Поднимаем Asterisk на серевре и коннеектим к нему
лёгкий SIP-клиент.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Аудио-оборудование</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">Предлагаемая модель</th>
<th scope="col" class="left">Тип устройства</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">20</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">Вывод на динамик</td>
</tr>

<tr>
<td class="right">21</td>
<td class="left">Jack 3,5 мм TS</td>
<td class="left">Вывод на микрофон</td>
</tr>
</tbody>
</table>

<p>
[COMMENT:pyub] Программную часть пока не расписывали. Серверная вот здесь:
<a href="#sec-6-6-11">Модуль дуплексной IP связи</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> <span class="todo TODO">TODO</span> Архитектура программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="aav">aav</span>&#xa0;<span class="gmm">gmm</span>&#xa0;<span class="bvl">bvl</span></span></h3>
<div class="outline-text-3" id="text-5-4">
</div><div id="outline-container-sec-5-4-1" class="outline-4">
<h4 id="sec-5-4-1"><span class="section-number-4">5.4.1</span> Высокоуровневая архитектура</h4>
<div class="outline-text-4" id="text-5-4-1">
<p>
Архитектурно то, что выполняется на контроллере можно разделить на <code>бизнес-логику</code>
и <code>нижний уровень</code>. Первая занимается проводом машин через стойки и всеми
сопутствующими процессами. Второй отвечает за взаимодействие с устройствами.
</p>

<p>
Еще у нас есть база данных PostgreSQL, в которой хранится конфигурационная
информация. Доступ к ней осуществляют оба уровня, свободно и равноправно.
</p>

<p>
Также в базе данных содержится актуальная рабочая информация (билеты за смену и их
статус)
</p>

<p>
Бизнес-логика пишется на lisp <code>gmm</code>, нижний уровень - на c++ <code>aav</code> и <code>bvl</code>
Проектированием структуры БД занимается <code>gmm</code>, он же создает триггеры, уведомляющие
об изменениях настроек.
</p>

<p>
Между собой <code>бизнес-логика</code> и <code>нижний уровень</code> взаимодействуют, посылая json другу
через http. Делают они это не напрямую, а через nginx, в конфигурации которого
прописаны виртуальные хосты. Эти хосты указывают на endpoint-ы <code>нижнего уровня</code> и
бизнес-логики. Это сделано чтобы развязать <code>бизнес-логику</code> и <code>нижний уровень</code> и
иметь возможность отлаживать и тестировать их по отдельности (в том числе с помощью
тестовых заглушек на виртуальных хостах)
</p>

<p>
Весь обмен сообщениями между <code>бизнес-логикой</code> и <code>нижним уровнем</code> полностью
асинхронный, сообщение может прийти в любое время и должно быть поставлено в
очередь обработки.
</p>

<p>
Весь обмен сообщениями между <code>бизнес-логикой</code> и <code>нижним уровнем</code> полностью
<code>stateless</code>, при необходимости синхронизации состояний требуется протаскивать
идентификатор состояния внутри json-посылок.
</p>

<p>
Бизнес-логика работает с командами "абстрактных устройств" (например дисплеем),
отправляя команды вида "отобразить на дисплей такую-то строку" через nginx. Нижний
уровень преобразует это в набор команд конкретного установленного устройства
(которых может быть много разных видов с разными наборами команд).
</p>

<p>
В случае возникновения событий от устройств <code>нижний уровень</code> обрабатывает эти
события и формирует сообщения для уровня бизнес-логики, передавая их json-ом
через nginx (в перспективе через FFI).
</p>
</div>
</div>

<div id="outline-container-sec-5-4-2" class="outline-4">
<h4 id="sec-5-4-2"><span class="section-number-4">5.4.2</span> Взаимодействие уровней</h4>
<div class="outline-text-4" id="text-5-4-2">
<p>
Взаимодействие между бизнес-логикой и нижним уровнем происходит так (далее на
примере):
</p>
<ul class="org-ul">
<li><p>
Бизнес-логике нужно открыть шлагбаум. Она делает GET или POST-запрос на
localhost:8080/Shlagbaum указывая в заголовке "Host: HardwareLayer". В POST-е
может лежать json с дополнительными параметрами. Например:
</p>
<pre class="example">
{
  id : 12345,
  device : "shlagbaum",
  command : "open",
  isdone : "confirm_please"
}
</pre>
</li>
<li>Запрос принимает nginx и пробрасывает на endpoint где его обработает веб-сервер
нижнего уровная, разберет JSON, сориентируется что за шлагбаум стоит на стойке и выработает
последовательность дерганий за GPIO, чтобы открыть шлагбаум так, чтобы тот
например прекратил открываться по достижении концевика. А если шлагбаум концевика
не имеет, то просто держит высокий уровень на нужной ногу GPIO нужное кол-во
секунд. Для этого (уточнить модель шлагбаума) он невозбранно пользуется
подключением к PostgreSql.
</li>
<li><p>
После того как действие завершено, обработчик на нижем уровне посылает сообщение
бизнес логике, делая POST-запрос на localhost:8080/confirm, указывая в заголовке
"Host: BusinesLogicLayer"
</p>
<pre class="example">
{
  id : 12345,
  device : "shlagbaum",
  confirm : "true"
}
</pre>
</li>
<li><p>
Запрос принимает nginx и пробрасывает на эндпойнт, где его обработает лисповый
сервер, закроет себе таску и поставит галочку, что на этот раз шлагбаум
не заело. После чего он может отправить сообщение, что машина номер такой-то
проехала на аггрегирующий сервер - точно таким-же образом.
</p>

<p>
Описание JSON документов обмена между нижним уровнем и бизнес-логикой.
</p>

<p>
Документ от бизнес-логики для нижнего уровня
</p>

<pre class="example">
{
  txid : &lt;int&gt;, номер транзакции
  device : &lt;string&gt;, имя абстрактного устройства, как в БД, уникальное
  command : &lt;string&gt;, команда для устройства
  parameters : &lt;struct&gt;, параметры команды, индивидуальные для каждой команды
  isdone : &lt;bool&gt;, запрос подтверждения исполнения команды
}
</pre>

<p>
Документы от нижнего уровня для бизнес-логики
</p>

<p>
Подтверждение исполнения команды для isdone: true
</p>
<pre class="example">
{
  txid : &lt;int&gt;, номер транзакции
  device : &lt;string&gt;, имя устройства
  command : &lt;string&gt;, команда, которая подтверждается
  confirm : &lt;bool&gt;, подтверждение исполнения или неисполнения команды
  status : &lt;string&gt;, состояние устройства: "init", "ready", "busy",  "error"
  state : &lt;struct&gt;, структура текущих параметров абстрактного устройства
}
</pre>

<p>
Изменение параметров или состояния устройства, которое произошло независимо от действий бизнес-логики.
</p>
<pre class="example">
{
  eventid : &lt;int&gt;, номер события
  device : &lt;string&gt;
  status : &lt;string&gt;, состояние устройства: "init", "ready", "busy", "error"
  state: &lt;type&gt;, изменившийся параметр абстрактного устройства, если изменилось несколько параметров,
                 то надо передать столько событий, сколько параметров изменилось.
}
</pre>

<p>
Расшифровка ошибок устройства. Делается отдельных запросом, так как должна быть возможность восстановления
списка ошибок в любой момент по запросу.
</p>

<pre class="example">
{
  txid : &lt;int&gt;, номер транзакции
  device : &lt;string&gt;, имя устройства
  status : &lt;string&gt;,
  errors : &lt;struct&gt;
}
</pre>

<p>
В каждом запросе есть обязательные поля:
</p>

<p>
txid | eventid - номер транзакции инициированной бизнес-логикой или нижним уровнем соответственно
</p>

<p>
    device - имя абстрактного устройства, отражающее его функционал в системе. Это имя уникально в рамках
одного въезда/выезда. Список этих имен должен быть зафиксирован для всего комплекса.
</p>
</li>
</ul>

<p>
Имя абстрактного устройства состоит из двух частей:
</p>
<ul class="org-ul">
<li>абстрактное название устройства, которое фиксировано для всех устройств одного
назначения, например любой шлагбаум = "shlagbaum" или любой датчик = "sensor" или
любой дисплей = "display".
</li>
<li>описании функции, которое делает устройство уникальным среди остальных таких же
устройств
</li>
</ul>

<p>
Примеры:
GOOD shlagbaum<sub>in</sub> - шлагбаум на въезд
GOOD sensor<sub>carpresent</sub> - датчик наличия машины
GOOD display - если устройство одно, то его функцию можно не описывать, просто дисплей
GOOD printer - тоже самое
GOOD shlagbaum - шлагбаум может быть всего один
BAD  sensor - датчиков, у нас всегда больше одного, поэтому так делать не надо.
</p>

<p>
После приема, но до начала обрабоки команды, json-документ должен проверятся на ошибки,
в случае неполного документа нужно отправлять ответ вида:
</p>
<pre class="example">
{
    json-error : &lt;текст с описанием ошибки англ&gt;
}
</pre>
</div>
</div>

<div id="outline-container-sec-5-4-3" class="outline-4">
<h4 id="sec-5-4-3"><span class="section-number-4">5.4.3</span> FFI</h4>
<div class="outline-text-4" id="text-5-4-3">
<p>
[VRFY:aav] [VRFY:bvl] Прочитай для общего развития
</p>

<p>
Из-за акцента лиспа на динамическом выделении памяти и "сборке мусора" реализации
лиспа используют непохожие на сишные представления объектов. Несоответствие
представлений создает сложности, когда лисп-программа должна разделять объекты с
другими программами, которые ожидают C-структуры. Есть три подхода к такой
коммуникации:
</p>
<ul class="org-ul">
<li>Бремя коммуникции может взять на себя внешняя программа (и ее программист), это
потребует знаний и использования представлений, используемых внутри
лисп-имплементации. Это может потребовать значительного количества "клея" на
стороне С и этот код имеет тенденцию быть чувствительно зависимым от внутренних
особенностей лисп-системы.
</li>
<li>Лисп система может автоматически конвертировать объекты назад и вперед между
лисповыми и внешними представлениями. Это удобно, но замедляет перевод, когда
большие и сложные структуры данных должны быть использованы совместно. Этот подход
опирается на FFI и используется автоматически, когда совместно используются простые типы,
например <code>integer</code> или <code>string</code>.
</li>
<li>Лисп-программа может напрямую манипулировать внешними объектами через расширения
лисп-языка.
</li>
</ul>

<p>
SBCL в основном использует автоматическую конверсию объектов и подход прямого
манипулирования. Пакет SB-ALIEN обеспечивает возможность автоматического
преобразования отдельных скалярных типов и непосредственную манипуляцию сложными
типами во внешнем представлении. Кроме того, нижний уровень System Area Pointers
(SAPs) может быть использован там, где необходимо обеспечить прямой доступ к
внешней нетипизированной памяти.
</p>

<p>
Любые внешние объекты, которые не могут быть автоматически конвертированы в
лисп-значения представляются как объекты типа <code>alien-value</code>. Так как лисп является
динамически типизируемым языком, даже внешние объекты должны иметь тип времени
выполнения. Эта информация о типе обеспечивается инкапсуляцией сырого указателя на
внешние данные внутри <code>alien-value</code> объекта.
</p>

<p>
Типы языка и операции над внешними объектами намеренно аналогичны типам и операциям
в языке С.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-3-1"></a>Определение внешних типов<br  /><div class="outline-text-5" id="text-5-4-3-1">
<p>
Alien types имеют язык описания, основанный на вложенных списковых
структурах. Например, тип С:
</p>

<div class="org-src-container">

<pre class="src src-cpp"><span style="color: #00cdcd; font-weight: bold;">struct</span> <span style="color: #00cd00;">foo</span> {
    <span style="color: #00cd00;">int</span> <span style="color: #cdcd00;">a</span>;
    <span style="color: #00cdcd; font-weight: bold;">struct</span> <span style="color: #00cd00;">foo</span> *<span style="color: #cdcd00;">b</span>[100];
};
</pre>
</div>

<p>
будет иметь вот такой FFI тип:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(struct foo
  (a int)
  (b (array (* (struct foo)) 100)))
</pre>
</div>

<p>
Типы могут быть поименованными или нет. Со структурой (struct) и объединением
(union) название - это часть спецификации типа. Это позволяет определять типы
рекурсивно, например так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(struct foo (a (* (struct foo))))
</pre>
</div>

<p>
Анонимные структуры или объединения задаются, с использованием на месте имени
значения <code>nil</code>. Макрос <code>with-alien</code> определяет local scope, который "захватывает"
любые именованные определения типов. Другие типы не имеют неотьемлимого имени, но
могут получить аббревиатуры имен, используя макрос <code>define-alien-type</code>.
</p>
</div>
</li>

<li><a id="sec-5-4-3-2"></a>Внешние типы и типы лиспа<br  /><div class="outline-text-5" id="text-5-4-3-2">
<p>
Внешние типы образуют подсистему лисп-типов. Alien type specifier обеспечивает
способ использовать любой внешний тип как lisp type specifier. Например:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(typep foo '(alien (* int)))
</pre>
</div>

<p>
может быть использован чтобы определить <code>foo</code> как указатель на внешний тип
int. Alien type specifiers могут быть использованы в тех же случаях, в каких
используются обычные спецификаторы типов лиспа, например <code>string</code>. Alien type
declarations точно также подвергаются <code>precise type checking</code> как и другие
декларации.
</p>

<p>
Следует обратить внимание, что type identifiers, используемые в foreign type
system перекрывают родные Lisp type specifiers в некоторых случаях. К примеру,
type specifier "(alien single-float)" идентичен "single-float", потому что foreign
floats автоматически конвертируются в lisp floats. Когда <code>type-of</code> вызывается на
alien value, которое автоматически не конвертируется в lisp value, он возвращает
alien type specifier
</p>
</div>
</li>

<li><a id="sec-5-4-3-3"></a>Спецификаторы внешних типов<br  /><div class="outline-text-5" id="text-5-4-3-3">
<p>
Все foreign type names экспортируются из пакета sb-alien. Некоторые foreign type
names также являются символоми пакета common-lisp, в этом случае они
реэкспортируются из пакета sb-alien, поэтому можно легально ссылаться, к примеру,
на sb-alien:single-float.
</p>

<p>
Вот основные foreign type specifiers:
</p>

<ul class="org-ul">
<li><code>(* foo)</code> определяет указатель на объект типа foo. Указатель типа foo обозначает
указатель на что-то, похожий на "void *" в ANSI C. Нулевой внешний указатель
может быть обнаружен с помощью функции sb-alien:null-alien
</li>
<li><code>(array foo &amp;rest dimensions)</code> определяет массив заданной размерности, хранящий
элементы типа foo. В отличии от С "(* foo)" и "(array foo)" считаеются разными
типами, когда делается type checking. Если желательна эквивалентность указателей
и типов array можно явно приводить их используя sb-alien:cast.  Массивы доступны
при использовании sb-alien:deref, которому передаются размерности в качестве
дополнительных аргументов. Элементы массива храняться по столбцам (как в С), так
что первое измерение определяет только размер блока в памяти, а не расположение
в высших измерениях. Массив, у которого первое измерение - переменное, может
быть специфицирован с использованием <code>nil</code> в качестве первого измерения. Массивы
фиксированного размера могут быть аллоцированы как массив элементов, структура
слотов или sb-alien:with-alien переменные. Динамические массивы могут быть
аллоцированы с использованием sb-alien:make-alien.
</li>
<li><code>(sb-alien:struct name &amp;rest fields)</code> определяет стуктуру с указанными именем и
полями. Поля аллоцируются по тем же смещениям, что и в используемом
имплементацией лиспа С-компилятором. С использованием опционального ключевого
аргумента :alignment можно специфицировать выравнивание для каждого поля. Если
name равно <code>nil</code> структура является анонимной.  Если именованный foreign struct
specifier передается в <code>define-alien-type</code> или <code>with-alien</code>, то они определяют
соответственно новый глобальный или локальный foreign structure type. Если поля
не указаны, то поля берутся из текущего (локального или глобального) определения
alien structure type по имени.
</li>
<li><code>(sb-alien:union name &amp;rest fields)</code> похож на sb-alien:struct но определяет
тип-объединение. Все поля аллоцируются по одному смещению и размер типа
объединения является размером самого большого его поля. Программист определят
какое поле в данный момент активно из контекста.
</li>
<li><code>(sb-alien:enum name &amp;rest specs)</code> определяет тип-перечисление, который является
отображением целочисленных значений в символы. Если имя <code>nil</code> то тип является
анонимным. Каждый элемент <code>specs</code> представляет собой лисп-символ или список
(символ значение). Значение является целым числом. Если значение не задано, по
умолчанию используется значение на один больше, чем предыдущее значение (или
ноль, если это первый элемент)
</li>
<li><code>(sb-alien:signed &amp;optional bits)</code> определяет целое со знаком указанной
точности. Верхний предел этого целого определяется размером машинного
слова. Если bits не задан используется максимальное значение.
</li>
<li><code>(integer &amp;optional bits)</code> это эквивалент соответствующему type specifier
определенному с использованием <code>sb-alien:signed</code> вместо <code>integer</code>.
</li>
<li><code>(sb-alien:unsigned &amp;optional bits)</code> соответствует type specifier, определенному
с использованием <code>sb-alien:signed</code>, исключая переменные, которые рассматриваются
как <code>unsigned integer</code>
</li>
<li><code>(boolean &amp;optional bits)</code> похож на тип-перечисление, но отображает лисповые
<code>nil</code> и <code>t</code> в сишные <code>0</code> и <code>1</code> соответственно. Опцинальный аргумент <code>bits</code>
определяет количество бит для хранения значения истинности.
</li>
<li><code>single-float</code> определяет числа с плавающей точкой IEEE-формате одинарной
точности
</li>
<li><code>double-float</code> определяет числа с плавающей точкой IEEE-формате двойной
точности
</li>
<li><code>(function result-type &amp;rest arg-types)</code> определяет внешнюю фукнцию, которая
принимает аргументы, специфицированные в arg-types и возвращает результат типа
result-type. Обратите внимание, что это только в контексте, когда foreign
function type непосредственно указан в аргументе <code>sb-alien:alien-funcall</code>. Во
всех других конекстах foreign functions представляются в виде типа-указателя на
внешнюю функцию (* (function &#x2026;))
</li>
<li><code>sb-alien:system-area-pointer</code> определяет указатель на область, которая
представлена в lisp как <code>system-area-pointer object</code>.
</li>
<li><code>sb-alien:void</code> используется в типе функции для декларации, что никакого
полезного значения не возвраается. Испрользуется в <code>alien-funcall</code> для вызова
void foreign function, которые не возвращают значения.
</li>
<li><p>
<code>(sb-alien:c-string &amp;key external-format element-type not-null)</code> похож на <code>(*
       char)</code>, но интерпретируется как null-terminated string, и автоматически
конвертируется в Lisp string при доступе; Или если указать в С NULL или 0, тогда
доступ к нему дает в лиспе nil если только не not-null = true, тогда
сигнализируется <code>type-error</code>.
Внешнее преобразование формата происходит автоматически, когда lisp-строки
передаются во внешний код, или когда внешние строки передаются в лисп-код. Если
спецификатор типа имеет явный external-format, то внешний формат используется. В
ином случае используется default external format, который определен в SBCL при
старте по текущим установка локали. Например, когда вызывается внешняя
подпрограмма, лисп-string передается как аргумент, конвертированный в ebcdic
octet representation.
</p>
<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00cdcd; font-weight: bold;">define-alien-routine</span> test int (str (c-string <span style="color: #0000ee; font-weight: bold;">:external-format</span> <span style="color: #0000ee; font-weight: bold;">:ebcdic-us</span>)))
</pre>
</div>
<p>
Лисп-строки типа <code>base-string</code> сохраняются с удалением нуль-терминатора,
копирования (либо осуществляемого пользователем или имплементацией) не требуется
при передаче их внешнему коду, в предположении, что external-format и
element-type c-строк совместимы с внутренним представлением строки.
Для SBCL, собранного с поддержкой unicode это подразумевает
external-format = :ascii и element-type = base-char.
Без Unicode поддержики external-format может быть :iso-8859-1, и element-type
может быть character. Если the external-format или element-type несовместимы,
или строки представляют собой (simple-array character (*)), тогда данные
копируются по требованию имплементации.
Присвоение лисп-строки в c-string, structure field сохраненяет переменную,
содержащую строку в память, на которую указывает переменная. Когда внешний
объект типа (* char) присваивается с c-string, тогда c-string указатель тоже
присваиватся. Это позволяет инициализировать c-string pointers. К примеру:
</p>
<div class="org-src-container">

<pre class="src src-lisp">(cl:in-package <span style="color: #00cd00;">"CL-USER"</span>) <span style="color: #cd0000;">; </span><span style="color: #cd0000;">which USEs package "SB-ALIEN"</span>

(<span style="color: #00cdcd; font-weight: bold;">define-alien-type</span> nil (struct foo (str c-string)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">make-foo</span> (str)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((my-foo (make-alien (struct foo))))
    (setf (slot my-foo 'str) (make-alien char (length str))
          (slot my-foo 'str) str)
    my-foo))
</pre>
</div>
<p>
Сохранение лисп-значения <code>nil</code> в c-string записывает значение C NULL в эту переменную.
</p>
</li>
<li>sb-alien также экспортирует переводы этих типов C в foreign type
specifiers:
<ul class="org-ul">
<li>char
</li>
<li>short
</li>
<li>int
</li>
<li>long
</li>
<li>unsigned-char
</li>
<li>unsigned-short
</li>
<li>unsigned-int
</li>
<li>unsigned-long
</li>
<li>float
</li>
<li>double
</li>
<li>size-t
</li>
<li>off-t.
</li>
</ul>
</li>
</ul>
</div>
</li>

<li><a id="sec-5-4-3-4"></a>Вызов lisp-функций из ECL<br  /><div class="outline-text-5" id="text-5-4-3-4">
<p>
Коллбэки в си должны быть специфицированы для ECL, с использованием функций,
которе оборачивают <code>cl_object=’ в си-типы, и обратно. Все коллбэки должны быть
     формой =cl_object function([cl_object ...])</code>. Они регистрируются внутри ECL с
помощью <code>cl_def_c_function</code>, которой нужно передать несколько аргументов. В
примере кода это завернуто в макрос.
</p>

<p>
If packages are to be used the lisp call to export the functions would be best
added to the macro.
</p>

<p>
Этот пример включает в себя маленький REPL, чтобы это опробовать. В настоящее
время ошибки не сообщаются.
</p>

<p>
Также можно подсмотреть в этом проекте:
<a href="https://github.com/rjmacready/pico-gmengine">https://github.com/rjmacready/pico-gmengine</a>
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #cd0000;">/*</span>
<span style="color: #cd0000;">    Example of a C program embedding ECL with callbacks to C functions.</span>
<span style="color: #cd0000;">    Compiled via: gcc ecldemo.c -lecl</span>
<span style="color: #cd0000;">*/</span>
<span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">&lt;stdio.h&gt;</span>
<span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">&lt;stdlib.h&gt;</span>
<span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">"ecl/ecl.h"</span>

<span style="color: #0000ee; font-weight: bold;">#define</span> <span style="color: #0000ee; font-weight: bold;">DEFUN</span>(<span style="color: #cdcd00;">name</span>,<span style="color: #cdcd00;">fun</span>,<span style="color: #cdcd00;">args</span>) \
    cl_def_c_function(c_string_to_object(name), \
        (<span style="color: #00cd00;">cl_objectfn_fixed</span>)fun, \
                      args)

<span style="color: #00cd00;">cl_object</span> <span style="color: #0000ee; font-weight: bold;">foo</span>() {
    <span style="color: #00cdcd; font-weight: bold;">return</span> ecl_make_integer(42);
}

<span style="color: #00cd00;">cl_object</span> <span style="color: #0000ee; font-weight: bold;">bar</span>(<span style="color: #00cd00;">cl_object</span> <span style="color: #cdcd00;">a</span>, <span style="color: #00cd00;">cl_object</span> <span style="color: #cdcd00;">b</span>) {
    <span style="color: #00cd00;">int</span> <span style="color: #cdcd00;">aval</span> = fix(a);
    <span style="color: #00cd00;">int</span> <span style="color: #cdcd00;">bval</span> = fix(b);
    <span style="color: #00cdcd; font-weight: bold;">return</span> ecl_make_integer(aval + bval);
}

<span style="color: #cd0000;">/*</span>
<span style="color: #cd0000;">    Assumes the string is a valid call.</span>
<span style="color: #cd0000;">*/</span>
<span style="color: #00cd00;">cl_object</span> <span style="color: #0000ee; font-weight: bold;">ecl_call</span>(<span style="color: #00cd00;">char</span> *<span style="color: #cdcd00;">call</span>) {
    <span style="color: #00cdcd; font-weight: bold;">return</span> cl_safe_eval(c_string_to_object(call), Cnil, Cnil);
}

<span style="color: #00cd00;">void</span> <span style="color: #0000ee; font-weight: bold;">init</span>() {
    cl_boot(1, (<span style="color: #00cd00;">char</span> **)&amp;<span style="color: #00cd00;">""</span>);

    atexit(cl_shutdown);

<span style="color: #cd0000;">/*</span>
<span style="color: #cd0000;">    Uncomment these lines to place your code into a separate package,</span>
<span style="color: #cd0000;">    They may then be called like (my-code:foo)</span>
<span style="color: #cd0000;">*/</span>
<span style="color: #cd0000;">//  </span><span style="color: #cd0000;">ecl_call("(make-package :my-code)");</span>
<span style="color: #cd0000;">//  </span><span style="color: #cd0000;">ecl_call("(in-package my-code)");</span>

    DEFUN(<span style="color: #00cd00;">"foo"</span>, foo, 0);
    DEFUN(<span style="color: #00cd00;">"bar"</span>, bar, 2);

<span style="color: #cd0000;">//  </span><span style="color: #cd0000;">ecl_call("(export foo)");</span>
<span style="color: #cd0000;">//  </span><span style="color: #cd0000;">ecl_call("(export bar)");</span>
<span style="color: #cd0000;">//  </span><span style="color: #cd0000;">ecl_call("(in-package common-lisp-user)");</span>
}

<span style="color: #00cd00;">int</span> <span style="color: #0000ee; font-weight: bold;">main</span>() {
    init();
    <span style="color: #00cd00;">cl_object</span> <span style="color: #cdcd00;">exit_obj</span> = c_string_to_object(<span style="color: #00cd00;">":EXIT"</span>);
    <span style="color: #00cd00;">cl_object</span> <span style="color: #cdcd00;">result</span> = Cnil;

    <span style="color: #00cdcd; font-weight: bold;">while</span> (cl_equal(exit_obj, result) == Cnil) {
        printf(<span style="color: #00cd00;">"\n&gt; "</span>);
        <span style="color: #00cd00;">cl_object</span> <span style="color: #cdcd00;">form</span> = ecl_call(<span style="color: #00cd00;">"(read)"</span>);
        result = cl_safe_eval(form, Cnil, Cnil);
        cl_print(1, result);
    }
    putchar(<span style="color: #00cd00;">'\n'</span>);

    <span style="color: #00cdcd; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
Официальный ман по ECL FFI доступен тут:
<a href="https://common-lisp.net/project/ecl/manual/ch28s02.html">https://common-lisp.net/project/ecl/manual/ch28s02.html</a>
</p>

<p>
Официальная вики: <a href="https://gitlab.com/embeddable-common-lisp/ecl/wikis/home">https://gitlab.com/embeddable-common-lisp/ecl/wikis/home</a>
</p>

<p>
Но я бы все же предпочел поставить вместо стандартно поставляемого на ббб ECL
более совершенный и документированный SBCL из исходников. Последняя доступная
версия должна ставиться из исходников, полученных на оффсайте:
<a href="http://sbcl.org/platform-table.html">http://sbcl.org/platform-table.html</a>
</p>

<p>
Хотя с точки зрения программирования архитектур менее навороченных, чем ббб на
языке лисп, изучение ECL кажется оправданным.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-4-4" class="outline-4">
<h4 id="sec-5-4-4"><span class="section-number-4">5.4.4</span> Архитектура бизнес-логики</h4>
<div class="outline-text-4" id="text-5-4-4">
<p>
[VRFY:aav] [VRFY:bvl] Хочу такого же описания но для нижнего уровня
</p>

<p>
Бизнес-логика с точки зрения реализации представляет собой по сути большой
конечный автомат. Конечный автомат - это такая абстракция для моделирования
поведения (дискретных) устройств. Во-избежание путаницы имеет смысл остановиться
на этом поподробнее, можно считать это обоснованием архитектуры:
</p>

<p>
Итак, конечный автомат - это:
</p>
<ul class="org-ul">
<li>Множество состояний (S - States, состояния)
</li>
<li>Множество входных воздействий (I - In "входной алфавит")
</li>
<li>Множество выходных воздействий (O - Out, "выходной алфавит")
</li>
<li>Функция переходов (T - Transition, переходы), определенная как отображение, в
котором каждой паре {текущее состояние : входное воздействие} сопоставлено одно
из <code>состояний</code>, в которое из текущего состояния возможен переход.
</li>
<li>Функция выходов (E - Effect, воздействие), определенная как отображение, в
котором каждой паре {текущее состояние : входное воздействие} сопоставлено одно из
<code>выходных воздействий</code>.
</li>
<li>Начальное состояние (s-нулевое)
</li>
<li>Множество конечных состояний
</li>
</ul>

<p>
У нас есть два возможных варианта реализации:
</p>
<ul class="org-ul">
<li>автомат Мура - конечный автомат, выходное значение в котором зависит
лишь от текущего состояния автомата
</li>
<li>автомат Мили - конечный автомат, выходное значение в котором зависит от
текущего состояния и входного воздействия.
</li>
</ul>

<p>
Второй вариант более сложный, но обеспечивает большую гибкость, будем
придерживаться его.
</p>

<p>
Конечный автомат может быть детерминированным (ДКА) и недетерминированным
(НКА). Недетерминированные автоматы гораздо сложнее в отладке, но их графы
переходов могут быть записаны компактнее. Поскольку эти классы автоматов
эквивалентны, мы будем использовать только ДКА, упрощая себе отладку.
</p>

<p>
Этот формализм очень удобен при моделировании <code>поведения</code> устройств потому что для
каждого автомата можно определить ориентированный граф переходов, а потом потыкать
в него пальцами - и увидеть на нем все выходные воздействия, отладить и даже
прогнать кейс, получив путь в графе переходов. А немного напрягшись, можно
автоматически (написав программу) получить множество всех возможных путей - а это
на минуточку обещает нам автоматизированное написание тестов.
</p>

<p>
Есть, правда один нюанс - моделируемое устройство должно работать в
т.н. дискретном времени, т.е. прерывать функцию переходов и функцию выходов
нельзя. Сразу же напрашивается идея ставить любые прерывания в очередь и
обрабатывать их как <code>входные воздействия</code>.
</p>

<p>
Конечные автоматы удобны (для моделирования поведения) тем, что:
</p>
<ul class="org-ul">
<li>Наглядно моделируют поведение (сюрприз!)
</li>
<li>Формально определяют логику работы устройства
</li>
<li>Поддерживают декомпозицию (абстрагирование)
</li>
<li>Подерживают композицию (объединение)
</li>
<li>Поддерживают комбинацию (применение), путем связывание выходных воздействий
одного автомата с входными другого и создания сети взаимодейтсвующих конечных
автоматов.
</li>
<li>Поддерживают метапрограммирование (автоматы можно более или менее
автоматизированно создавать из шаблонов и настроек)
</li>
<li>Поддерживают динамическое программирование (один автомат может
создавать/изменять другой в рантайме)
</li>
<li><p>
Позволяют автоматическую оптимизацию. Например, автоматы доказательно изоморфны,
если их графы изоморфны, т.е.:
</p>
<ul class="org-ul">
<li>для их состояний, входных и выходных воздействий можно построить
взаимно-однозначное отображение
</li>
<li>для их функций переходов и выходов можно построить изоморфизмы
</li>
</ul>
<p>
Соответственно можно выполнять объединение, (де)композицию, комбинирование,
частичное применение и другие операции над группой автоматов, контролируя
истинность этих условий и получить более оптимальный по каким-либо критериям
(скорость, память) целевой набор автоматов, чем исходный. Методы генетического
программирования позволяют также отбирать наиболее оптимальные наборы автоматов
среди более или менее случайных модификаций. Более формально см. "Морфизмы и
конечные подстановки. Белоусов А.И, Ткачев С.Б. Дискретная математика"
</p>
</li>
<li>Упрощают отладку, легко находить "висящие связи" и несоответствия.
</li>
<li>Позволяют автоматизировать создание тестов.
</li>
</ul>

<p>
Собственно, бизнес-логика и проектируется как сеть конечных автоматов. Этот
автомат собирается в соответствии с установленным оборудованием и настройками,
записанными в базе данных. При изменении настроек может происходить
переконфигурация без потери текущего состояния.
</p>

<p>
Каждый конечный автомат снабжен очередью входящих сообщений, из которой он в
нужных состояниях забирает сообщения, влияющие на поведение в этом
состоянии. Некоторые сообщения могут приводить к переконфигурации.
</p>
</div>
</div>

<div id="outline-container-sec-5-4-5" class="outline-4">
<h4 id="sec-5-4-5"><span class="section-number-4">5.4.5</span> Архитектура классов нижнего уровня</h4>
<div class="outline-text-4" id="text-5-4-5">
<p>
Нижний уровень управляет следующими типами устройств:
</p>
<ul class="org-ul">
<li>Display
</li>
<li>Sensor panel
</li>
<li>Printer
</li>
<li>PosTerminal
</li>
<li>Schlagbaum
</li>
<li>Hardware buttons
</li>
</ul>

<p>
В основе реализации нижнего уровня находится менеджер устройств и транзакций.
Он содержит указатели на имплементации каждого конкретного устройства и его
индивидуальной очереди транзакций. По отношению к устройствам менеджер позволяет
динамически создавать и удалять набор устройств для реализации возможности гибкой
смены конфигурации в рантайме. Подключениями к физическим устройствам через
коммуникационное оборудование управляет сам объект конкретного устройства.
</p>

<p>
Асинхронный обмен сообщениями между клиентом и устройством основан на принципах
Bulk Synchronous Parallelism (BSP) и реализован на пуле потоков, исполняющего
задачи из собственной очереди с приоритетами.
</p>

<p>
Источником задач являются внешние и внутренние клиенты нижнего уровня, сами устройства
и менеджер транзакций. Клиенты и устройства ставят задачи только для менеджера
транзакций, соблюдая таки образом строгую очередность исполнения команд.
</p>

<p>
Возможны два сценария работы: <code>транзакция</code> и <code>событие</code>
В первом сценарии инициатором обмена является клиент нижнего уровня.
Во втором сценарии инициатором обмена является устройство: физическое или его
представление - неважно.
</p>

<p>
Клиент нижнего уровня это ПО, которое может быть внешним или внутренним
по отношению к этому уровню.
Список текущих клиентов:
клиент, подключающийся через http. Механизм идентификации отсутствует.
встроенный пингер
инициализатор устройства, встроенный в каждый класс конкретного устройства
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-5-1"></a>Создание представлений устройств<br  /></li>

<li><a id="sec-5-4-5-2"></a>Удаление представлений устройств<br  /></li>

<li><a id="sec-5-4-5-3"></a>Обработка транзакций<br  /><div class="outline-text-5" id="text-5-4-5-3">
<p>
Уровень <code>бизнес-логики</code> посылает сообщение <code>нижнему уровню</code> о том, что необходимо
совершить операцию, например, отобразить на дисплее сообщение:
</p>

<pre class="example">
{
  "id" : 12345,
  "device" : "display",
  "command" : "show",
  "parameters": { "id_msg" : 456 }
}
</pre>

<p>
[COMMENT:pyub] Откуда мы берем айдишник сообщения?
</p>

<p>
[COMMENT:aav] id сообщения выдает бизнес-логика по собственным правилам
</p>

<p>
<code>Нижний уровень</code> принимает сообщение и осуществляет диспетчеризацию, отправляя
сообщение классу конкретного дисплея, например <code>DisplayWinstar1602A</code>.
</p>

<p>
<code>Менеджер устройств и транзакций</code> также может осуществить преобразование сообщения,
например, перевести его на другой язык, если это необходимо.
</p>

<p>
<code>Конкретный дисплей</code> осуществляет вывод на устройство путем отправки битов через
GPIO или по шине. При необходимости конкретный дисплей может переформатировать
сообщение чтобы обеспечить его красивый вывод на этот тип дисплея - код, который
за это отвечает, может находиться в методе класса, обслуживающего конкретный
дисплей.
</p>

<p>
Аналогичным образом обслуживаются и другие устройства.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-5-3-1"></a>Порядок обработки транзакции<br  /><div class="outline-text-6" id="text-5-4-5-3-1">
<p>
Функция httpserver::cb<sub>HttpServer</sub> парсит JSON документ установленного формата и
вызвает менеджер транзакций, чтобы поставить задачу устройству (SetCommandTo::Device).
В случае ошибок парсинга JSON, будет поставлена задача клиенту (SetCommandTo::Client).
</p>

<p>
Задача для устройства попадает в очередь задач устройства, как структура
CDeviceManager::DeviceCtl::Task.
Если задача в очереди одна, то она сразу ставится в очередь задач тредпула.
В один момент времени для одного устройства в тредпуле может обрабатываться или
ожидать обработки только одна задача.
</p>

<p>
Задача для устройства или клиента это функция CDeviceManager::sendCommand, которая
передает устройству команду и параметры. Для конкретного устройства команда и ее
параметры определяются индивидуально.
</p>

<p>
Вызов обработки команды проходит по цепочке
CAbstractDevice::sendCommand =&gt; CBaseDevice::sendCommand =&gt; CBaseCommCtl::send
Эти функции в базовых классах чисто виртуальные и должны быть переопределены
в дочерних классах устройств.
CAbstractDevice::sendCommand - делает преобразования данных, общие для всех устройств этого класса,
проксирует вызов на конкретное устройство.
CBaseDevice::sendCommand - преобразует команду в сериализованный поток данных
с поддержкой протокола обмена устройства, вызывает коммуникационные устройства,
которых может быть несколько
CBaseCommCtl::send - записывает подготовленный поток данных в комм. устройство.
</p>

<p>
Ответ от устройства принимается коллбэк функцией комм. устройства, которая
является единой для всех комм. устройств одного типа.
Она проксирует вызов на функцию приема данных конкретного устройства CBaseDevice::receive
Вызов обработки входящих данных проходит по цепочке
&lt;CConcreteCommDevice&gt;::cb<sub>receiveData</sub> =&gt; CBaseDevice::performEvent =&gt; SetCommandTo::Client,
CBaseDevice::receive - чисто виртуальная функция, которая должна быть переопределена в
классе устройства. Эта функция парсит данные и составляет из них строку данных для
дальнейшей отправки клиенту вместе с флагом транзакции.
SetCommandTo::Client - ставит задачу в очередь клиента, вызвавшего транзакцию. Если
задача в очереди клиента одна, то она сразу ставится в очередь задач тредпула.
Задача для этой команды удаляется из очереди задач устройства, с которого пришел ответ.
Если в его очереди, есть еще задачи, то следующая задача для устройства ставится в очередь задач тредпула.
</p>

<p>
Задачи из очереди клиента исполняются полностью аналогично очереди задач на устройства.
Любой клиент для системы является также устройством.
Когда от клиента приходит вызов аналога функции cb<sub>receiveData</sub> и определяется позитивный
ответ, то вызывается SetCommandTo::Manager. При его вызове не ставится задач другим
устройствам, только удаляется транзакция из очереди клиента.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-4-5-4"></a>Обработка событий<br  /><div class="outline-text-5" id="text-5-4-5-4">
<p>
<code>Нижний уровень</code> может обнаружить на устройстве неожиданную ситуацию, например
замятие бумаги в принтере. В таком случае нижний уровень должен обработать эту
ситуацию, послав сообщение бизнес-логике:
</p>

<pre class="example">
{
  id : 12345,
  device : "printer",
  error : "papier pizdetz",
  text : "Термопринтер неисправен. Замятие бумаги"
}
</pre>

<p>
После чего может взвести флаг неисправности и в дальнейшем на командные сообщения
синхронно отвечать "502 Internal Error" с сопутствующей страничкой об ошибке.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-5-4-1"></a>Порядок обработки события<br  /><div class="outline-text-6" id="text-5-4-5-4-1">
<p>
Событие всегда изначально принимается коллбэк функцией комм. устройства.
Событие проксируется на функцию приема данных конкретного устройства CBaseDevice::performEvent
Вызов обработки входящих данных проходит по цепочке
</p>

<p>
Вызов обработки входящих данных проходит по цепочке
&lt;CConcreteCommDevice&gt;::cb<sub>receiveData</sub> =&gt; CBaseDevice::performEvent =&gt; SetCommandTo::Client,
CBaseDevice::performEvent - чисто виртуальная функция, которая может быть переопределена в
классе устройства. Эта функция парсит данные и составляет из них строку данных для
дальнейшей отправки клиенту вместе с флагом события.
Флаг события, в отличие от флага транзакции, запрещает менеджеру транзакций проверять
очередь команд устройства и отправлять на него следующую задачу.
SetCommandTo::Client - ставит задачу в очереди всех клиентов. Если задача в очереди какого-то
клиента одна, то она сразу ставится в очередь задач тредпула.
</p>

<p>
Задачи из очереди клиента исполняются полностью аналогично очереди задач на устройства, как
это описано в обработке транзакции.
Любой клиент для системы является также устройством.
Когда от клиента приходит вызов аналога функции cb<sub>receiveData</sub> и определяется позитивный
ответ, то вызывается SetCommandTo::Manager. При его вызове не ставится задач другим
устройствам, только удаляется транзакция из очереди клиента.
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-4-5-5"></a>Интеграция кода нового абстрактного устройства<br  /><div class="outline-text-5" id="text-5-4-5-5">
<p>
Абстрактное устройство является фабрикой и прокси-классом для конкретных устройств.
Класс абстрактного устройства должен:
наследоваться от CAbstractDevice
переопределять функцию CAbstractDevice::sendCommand - прокси для команды на
конкретное устройство
определять функцию createDevice - фабрика для создания конкретного устройства
содержать static const std::string s<sub>abstractName</sub> - префикс имени набора
абстрактных устройств
с одним интерфейсом, например для:
"shlagbaum<sub>in</sub>" &amp; "shalgbaum<sub>out</sub>" - эта строка = "shlagbaum"
"logic<sub>http</sub>" &amp; "logic<sub>pinger</sub>" - эта строка = "logic"
</p>

<p>
Абстрактное устройство без привязанного к нему конкретного лишено смысла.
</p>

<p>
Интеграция с кодом производится в CDeviceFactory::deviceFactory, фабрике
абстрактных устройств.
</p>

<p>
! Место для интеграции абстрактного устройства в код помечено как // INTEGRATE
ABSTRACT SECTION: &lt;comment&gt;
</p>
</div>
</li>

<li><a id="sec-5-4-5-6"></a>Интеграция кода нового конкретного устройства<br  /><div class="outline-text-5" id="text-5-4-5-6">
<p>
Конкретное устройство является реализацией полного взаимодействия между
абстрактным интерфейсом и сериализованными данными для конкретной модели
устройства.
</p>

<p>
Класс конкретного устройства должен:
</p>
<ul class="org-ul">
<li>наследоваться от CBaseDevice
</li>
<li>переопределять чисто виртуальные функции sendCommand, performEvent,
connectToCommCtl
</li>
<li>функции performEvent и connectCommCtl имеют реализации по умолчанию, которые
рекомендуется использовать.
</li>
<li>содержать static const std::string s<sub>concreteName</sub> - имя конкретного устройства,
по которому к нему в БД будет назначаться вся коммуникация.
</li>
</ul>

<p>
Инициализация статических переменных имен для всех устройств производится в файле
NameInstances.cpp
</p>

<p>
! Место для интеграции помечено как // INTEGRATE DEVICE SECTION: &lt;comment&gt;
</p>
</div>
</li>

<li><a id="sec-5-4-5-7"></a>Интеграция кода нового вида коммуникационных устройств<br  /><div class="outline-text-5" id="text-5-4-5-7">
<p>
Класс коммуникационного устройства поддерживает все коммуникационные устройства
этого типа в системе. Не допускает захвата одного комм. устройства разными
конкретными устройствами и сигнализирует об таких попытках.
</p>

<p>
Для выполнения этих требований, класс реализован как multitone где для
каждого комм. устройства инстанцируется только один объект класса и
ведется список занятых устройств.
</p>

<p>
Класс должен: наследоваться от CBaseCommCtl, переопределять чисто виртуальные
функции receive, send, setSettings
</p>

<p>
в функции setSettings самостоятельно определять настройки каждого комм. устройства
из БД.
</p>

<p>
в функции send проксировать сериализованные данные из класса конкретного
устройства в комм. устройство
</p>

<p>
в функции receive проксировать принятые данные от комм. устройства на конкретное
устройство.
</p>

<p>
в функции takeCommDevice - производить захват комм. устройства и возвращать инстанс
на класс управления им.
в функции freeCommDevice - освобождать устройство.
</p>

<p>
в функциях startNotifier и stopNotifier - запускать и останавливать тред
получения событий от устройства.
! Добавить вызов функции startNotifier в конструкторе CDeviceManager
! Добавить вызов функции stopNotifier в деструктор менеджера устройств
</p>

<p>
Все места для внедрения в коде помечены как // INTEGRATE COMMDEVICE SECTION:
&lt;comment&gt;
</p>
</div>
</li>

<li><a id="sec-5-4-5-8"></a>Абстрактный базовый класс CBaseDevice<br  /><div class="outline-text-5" id="text-5-4-5-8">
<p>
Является базовым классом для классов устройств.
Реализует паттерн Strategy для конкретных классов от базовых CBaseCodec
и CBaseCommCtl.
</p>

<p>
Реализует композицию для подключения уровня SettingsLayer для доступа
классов устройств к своим настройкам.
Предоставляет интерфейс классам конкретных устройств.
</p>

<div class="org-src-container">

<pre class="src src-header_cpp">#include &lt;boost/noncopyable.hpp&gt;
#include &lt;boost/thread/thread.hpp&gt;
#include &lt;boost/thread/mutex.hpp&gt;
#include &lt;boost/smart_ptr.hpp&gt;

using namespace boost;

#include &lt;CBaseCodec.h&gt;
#include &lt;CBaseCommCtl.h&gt;
#include &lt;Settings.h&gt;
#include &lt;CPinCtl.h&gt;
#include &lt;CSerialPortCtl.h&gt;
#include &lt;SetCommandTo.h&gt;

class CBaseDevice: private noncopyable
{

public:
    const std::string c_name;

    CBaseDevice(const std::string&amp; deviceName);
    virtual ~CBaseDevice();
    CBaseDevice(const CBaseDevice&amp; theCBaseDevice);

    virtual void sendCommand(const std::string command, const std::string pars)=0;
    virtual bool connectToCommCtl()=0;

    const std::vector&lt; shared_ptr&lt;CBaseCommCtl&gt; &gt;&amp; getCommCtl();

    void performEvent(std::vector&lt;uint8_t&gt;&amp; rcvData);

protected:

    std::vector&lt; shared_ptr&lt;CBaseCommCtl&gt; &gt; m_commCtl;

    void addCommDevice(shared_ptr&lt;CBaseCommCtl&gt; commCtl);

    virtual void disconnectFromCommCtl();

    /*** Templates ***/

    template&lt;class T&gt;
    shared_ptr&lt;CBaseCommCtl&gt; takeCommDevice(const std::string&amp; commName)
    {

        if ( commName.find(T::s_name) != std::string::npos)
        {
            std::cout &lt;&lt; "CBaseDevice::takeCommDevice: Take communication device: " &lt;&lt; commName &lt;&lt; std::endl;

            return T::takeCommCtl(this, commName);
        }

        return nullptr;
    }

};


#endif // !defined(EA_AAF6E551_FF21_4908_B83B_A548A70782BC__INCLUDED_)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-source_cpp">#include "CBaseDevice.h"


CBaseDevice::CBaseDevice(const std::string&amp; str):
    c_name(str)
{

}



CBaseDevice::~CBaseDevice(){

}


const std::vector&lt; shared_ptr&lt;CBaseCommCtl&gt; &gt;&amp; CBaseDevice::getCommCtl(){

    return m_commCtl;
}


void CBaseDevice::performEvent(std::vector&lt;uint8_t&gt;&amp; rcvData)
{
    std::cout &lt;&lt; "CBaseDevice::performEvent: performs Event from device: " &lt;&lt; c_name &lt;&lt; ": ";
    for (auto v: rcvData) std::cout &lt;&lt; v &lt;&lt; " ";
    std::cout &lt;&lt; std::endl;

    // Вызвать установку задачи для клиента по имени абстрактного девайса
    std::string answer;
    for(uint8_t v: rcvData)
        answer += v;

    setCommandTo::Client( setCommandTo::Transaction, c_name, "answer: ", answer);
}


void CBaseDevice::performTransaction(std::vector&lt;uint8_t&gt;&amp; rcvData)
{
std::cout &lt;&lt; "CBaseDevice::performTransaction: performs Transaction from device: " &lt;&lt; c_name &lt;&lt; ": ";
for (auto v: rcvData) std::cout &lt;&lt; v &lt;&lt; " ";
std::cout &lt;&lt; std::endl;

// Вызвать установку задачи для клиента по имени абстрактного девайса
char* beginData = (char*) &amp;rcvData[0];
char* endData = (char*) &amp;rcvData[rcvData.size()-1];
std::string answer(beginData, endData);

setCommandTo::Client( setCommandTo::Transaction, c_name, "answer: ", answer);
}



void CBaseDevice::addCommDevice(shared_ptr&lt;CBaseCommCtl&gt; commCtl)
{
    if (commCtl != nullptr)
    {
        m_commCtl.push_back(commCtl);

        std::cout &lt;&lt; "CBaseDevice::addCommDevice: " &lt;&lt; commCtl-&gt;m_commName &lt;&lt; " was added to " &lt;&lt; c_name &lt;&lt; std::endl;
    }
}


bool CBaseDevice::connectToCommCtl()
{

    std::vector&lt;std::string&gt; commNames = settings::getCommNamesByDevice(c_name);

    if (commNames.size() == 0)
        return false;

    for (auto comm: commNames)
    {
        std::cout &lt;&lt; "CBaseDevice::connectToCommCtl: " &lt;&lt; c_name &lt;&lt; " connected to " &lt;&lt; comm &lt;&lt; std::endl;

        addCommDevice( takeCommDevice&lt;CPinCtl&gt;(comm) );
        addCommDevice( takeCommDevice&lt;CSerialPortCtl&gt;(comm) );

    }

    return m_commCtl.size() == commNames.size();
}


void CBaseDevice::disconnectFromCommCtl()
{

    for (auto comm: m_commCtl)
    {
        CPinCtl::freeCommCtl(this, comm-&gt;m_commName);
        CSerialPortCtl::freeCommCtl(this, comm-&gt;m_commName);
    }
}
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-5-9"></a>Класс абстрактного устройства CAbstractDevice<br  /><div class="outline-text-5" id="text-5-4-5-9">
<p>
[TODO:aav] Преобразовать код из
</p>

<p>
<a href="src/presentationLayer/Device Model/Presentation Layer/TestDevices.h">src/presentationLayer/Device Model/Presentation Layer/TestDevices.h</a>
</p>

<ul class="org-ul">
<li>Shlagbaum
</li>
<li>Printer
</li>
<li>PresentSensor
</li>
<li>PassSensor
</li>
<li>Display
</li>
<li>KKM
</li>
</ul>

<div class="org-src-container">

<pre class="src src-cpp" id="AbstractDevice"></pre>
</div>
</div>
</li>

<li><a id="sec-5-4-5-10"></a>Класс конкретного устройства<br  /><div class="outline-text-5" id="text-5-4-5-10">
<p>
Реализует функционал коммуникации с устройством, периодического опроса и
формирования сигналов состояния.
</p>

<p>
например CBarrierReleDown это устройство управления реле для опускания шлагбаума.
Протокол для пина отсутствует.
Пин управляет физическим импульсом опускания шлагбаума.
</p>

<p>
В нижележащих разделах будет код для каждого конкретного устройства.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-5-10-1"></a><span class="todo START">START</span> Shlagbaum<br  /></li>
<li><a id="sec-5-4-5-10-2"></a><span class="todo START">START</span> Printer<br  /></li>
<li><a id="sec-5-4-5-10-3"></a><span class="todo START">START</span> PresentSensor<br  /></li>
<li><a id="sec-5-4-5-10-4"></a><span class="todo START">START</span> PassSensor<br  /></li>
<li><a id="sec-5-4-5-10-5"></a><span class="todo START">START</span> Display<br  /></li>
<li><a id="sec-5-4-5-10-6"></a><span class="todo START">START</span> KKM<br  /></li></ol>
</li></ol>
</div>

<div id="outline-container-sec-5-4-6" class="outline-4">
<h4 id="sec-5-4-6"><span class="section-number-4">5.4.6</span> Нотификация при изменении настроек</h4>
<div class="outline-text-4" id="text-5-4-6">
<p>
При изменении настроек (которое возможно только оператором из веб-интерфейса)
соответствующие куски кода должны быть оповещены сообщениями.
</p>

<p>
Это можно делать как из веб-интерфейса (посылая сообщения в контроллере формы) так
и из PostgreSQL (используя триггеры - функция базы данных, срабатывающая на
определённое событие).
</p>

<p>
Как мне кажется, лучше по возможности выносить это на уровень, где происходит
действие. Поближе к актору - актор, в данном случае, - это пользователь,
изменяющий настройки). Так лучше, потому что смотреть внутрь триггеров - лишний
шаг в отладке. Да и формализовать будет проще, поскольку код будет размещен как
раз там, где изменяются настройки.
</p>

<p>
[COMMENT:pyub] Если развернёшь про вынесение в web-интерфейс, то будет хорошо. Я
не очень понял в чём разница между обработкой этого там и у тебя в основной
БЛ.
</p>

<p>
[COMMENT:gmm] Дык я развернул на абзац выше: контроллер формы в веб-интерфейсе
посылает сообщение, которое обрабатывает бизнес-логика. Не знаю как это более
понятно развернуть.. Попробовал более короткими предложениями
</p>

<p>
Категорически не следует предпринимать попытки кэширования настроек, т.к. это
ведет к сложным проблемам поддержания коггерентности кэша.
</p>

<p>
При выполнении действий, зависящих от настроек, код должен явно запросить базу
настроек и в зависимости от текущих установок выполнить необходимое действие.
</p>

<p>
Это кстати отчасти уменьшит трафик нотификаций об изменении настроек и
сопутствующую отладку.
</p>
</div>
</div>

<div id="outline-container-sec-5-4-7" class="outline-4">
<h4 id="sec-5-4-7"><span class="section-number-4">5.4.7</span> Драйвера уровня ядра</h4>
<div class="outline-text-4" id="text-5-4-7">
<p>
Драйвера конкретных устройств, устанавливаемые, как модули ядра. Большинство
модулей уже имеется в ядре Linux, как-то GPIO, коммуникациционный стек, etc.
</p>

<p>
Драйверы могут понадобиться для редких дисплеев, некоторых RTC и иной периферии.
</p>

<p>
Пока таких нет (т.к. все работает стандартными средствами).
</p>
</div>
</div>

<div id="outline-container-sec-5-4-8" class="outline-4">
<h4 id="sec-5-4-8"><span class="section-number-4">5.4.8</span> Требования к функционалу <code>HardwarePresentationLayer</code></h4>
<div class="outline-text-4" id="text-5-4-8">
</div><ol class="org-ol"><li><a id="sec-5-4-8-1"></a>Получение данных и формирование событий<br  /><div class="outline-text-5" id="text-5-4-8-1">
<p>
[TODO:aav] Перечислить варианты датчиков и написать сюда те функции, которые преобразуют
сигналы от реальных устройств в события, и потом (при необходимости) отправляют
сообщения.
</p>

<div class="org-src-container">

<pre class="src src-cpp" id="Xyu"><span style="color: #00cdcd; font-weight: bold;">class</span> <span style="color: #00cd00;">Xyu</span> : <span style="color: #00cdcd; font-weight: bold;">public</span> <span style="color: #00cd00;">CDevice</span> {
}
</pre>
</div>

<div class="org-src-container">

<pre class="src src-cpp" id="Xyu-:filename-file.cpp">&lt;&lt;Xyu&gt;&gt;
&lt;&lt;Xuy2&gt;&gt;
</pre>
</div>
</div>
</li>

<li><a id="sec-5-4-8-2"></a>Асинхронная работа с оборудованием по вызовам от <code>BusinessLogicLayer</code><br  /><div class="outline-text-5" id="text-5-4-8-2">
<p>
Все сообщения принимаются асинхронно уровнем представления устройств
<code>нижнего уровня</code> и диспетчеризируются к методам класса конкретных устройств.
</p>

<p>
Все сигналы и сообщения от устройств диспетчеризируются на нижнем уровне и (при
необходимости) отправляются бизнес-логике.
</p>

<p>
Все <code>опрашиваемые устройства</code> проверяются с заданным таймаутом. В случае сбоя
происходит событие, которое приводит к посылке сообщения, если не удалось решить
проблему на нижнем уровне.
</p>
</div>
</li>

<li><a id="sec-5-4-8-3"></a>Cписок конкретного оборудования, которое должно поддерживаться&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-5" id="text-5-4-8-3">
<p>
В списке абстрактного оборудования (на данный момент он только абстрактный) будут
вложенями даны ссылки на конкретное оборудование: <a href="doc.html#*%d0%9f%d0%b5%d1%80%d0%b8%d1%84%d0%b5%d1%80%d0%b8%d0%b9%d0%bd%d0%be%d0%b5%20%d0%be%d0%b1%d0%be%d1%80%d1%83%d0%b4%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5">периферийное оборудование</a> (в
doc.org)
</p>

<p>
[TODO:aav] Поправить ссылки
</p>

<p>
Полное раскрытие списка оборудования, сенсоров и кнопок:
<a href="doc.html#*%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D0%B8%20%D0%BA%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D1%83">Подключение периферии к контроллеру</a>
В графе "Тип устройства" описан абстрактный тип, в графе
"Предполагаемая модель" конкретная модель, в графе "Интерфейс подключения" -
собственно интерфейс.
</p>

<p>
[COMMENT:pyub] Наверное раздел требует верификации.
</p>

<p>
[TODO:bvl] До описания протоколов обмена данными с периферийными
устройствами мы пока не дошли. Это задача.
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-4-8-3-1"></a><span class="todo TODO">TODO</span> Протокол обмена с картоприемником&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-4-8-3-1">
<p>
Структуры данных, ссылка.
</p>
</div>
</li>

<li><a id="sec-5-4-8-3-2"></a><span class="todo TODO">TODO</span> Управление и контроль шлагбаума&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-4-8-3-2">
<p>
Команды и события, ссылка.
</p>
</div>
</li>

<li><a id="sec-5-4-8-3-3"></a><span class="todo TODO">TODO</span> Управление и контроль термопринтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-4-8-3-3">
<p>
Структуры данных, ссылка.
</p>
</div>
</li>

<li><a id="sec-5-4-8-3-4"></a><span class="todo TODO">TODO</span> Список используемых датчиков&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-4-8-3-4">
<p>
Уровни логических сигналов для состояний.  <a href="doc.html#*%D0%92%D0%B2%D0%BE%D0%B4%D1%8B%20%D1%81%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2%20%D1%81%20%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%BE%D0%B2">Вводы сигналов с датчиков</a>
</p>
</div>
</li>

<li><a id="sec-5-4-8-3-5"></a><span class="todo TODO">TODO</span> Список кнопок&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-4-8-3-5">
<p>
Уровни логических сигналов для состояний.
</p>

<p>
См. раздел <a href="doc.html#*%D0%92%D0%B2%D0%BE%D0%B4%D1%8B%20%D1%81%20%D0%BA%D0%BD%D0%BE%D0%BF%D0%BE%D0%BA">Вводы с кнопок</a>
</p>
</div>
</li></ol>
</li>

<li><a id="sec-5-4-8-4"></a>Преобразование данных между конкретным и абстрактным представлениями<br  /><div class="outline-text-5" id="text-5-4-8-4">
<p>
[COMMENT:pyub] Правильно ли я понимаю, что абстрактное представление это, например,
"сигнал датчика арбитража", а конкретное представление - это "12В с реле <code>R7</code> стойки
выигравшей арбитраж на сенсорный ввод <code>S4</code> стойки проигравшей арбитраж"?
</p>

<p>
[COMMENT:aav] Да.
</p>

<p>
[COMMENT:gmm] Тут мы будем писать какие события есть у какого устройства.
</p>

<p>
Список оборудования (на данный момент абстрактный): <a href="doc.html#*%d0%9f%d0%b5%d1%80%d0%b8%d1%84%d0%b5%d1%80%d0%b8%d0%b9%d0%bd%d0%be%d0%b5%20%d0%be%d0%b1%d0%be%d1%80%d1%83%d0%b4%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5">периферийное оборудование</a> (в
doc.org) Полное раскрытие списка с сенсорами и кнопками:
<a href="doc.html#*%D0%9F%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D0%B8%20%D0%BA%20%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D1%83">Подключение периферии к контроллеру</a> (в doc.org)
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-4-9" class="outline-4">
<h4 id="sec-5-4-9"><span class="section-number-4">5.4.9</span> Требования к реализации <code>HardwarePresentationLayer</code></h4>
<div class="outline-text-4" id="text-5-4-9">
</div><ol class="org-ol"><li><a id="sec-5-4-9-1"></a>Стандарт доступа к ресурсам ядра<br  /><div class="outline-text-5" id="text-5-4-9-1">
<p>
При разработке <code>HWPresentationLayer</code> на языке С++ необходимо использовать единый
стандарт доступа к ресурсам ядра с помощью определенного стандартного
фреймворка. Использование других возможностей ОС и других фреймворков по умолчанию
запрещено, опционально оговаривается отдельно.
</p>

<p>
Выбор стандарта и фреймворка исходя из требований полной модульности и
кроссплатформенности среди *nix-совместимых ОС.
</p>

<p>
Выбор проводился между:
</p>

<p>
<code>POSIX</code> + <code>STL only</code> - всем известны, долго писать, плодить лишние уровни
архитектуры) - неэффективно
</p>

<p>
<code>STL</code> + <code>boost</code> (boost на старте требует некоторого уровня входа, можно быстро и
легко создавать многопоточный безопасный код, может полностью заменить POSIX, код
получается полностью кроссплатформенный, код долго собирается) - эффективно
</p>

<p>
<code>QT</code> (требует отдельных навыков разработки, не удовлетворяет требованиям полной
модульности) - не подходит для этой задачи
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-5-4-10" class="outline-4">
<h4 id="sec-5-4-10"><span class="section-number-4">5.4.10</span> Работа с дисплеями и другими конкретными устройствами</h4>
<div class="outline-text-4" id="text-5-4-10">
<p>
[COMMENT:pyub] Не уверен, что это должно быть здесь. Перенесите куда считаете
нужным сами.
</p>

<p>
[VRFY:gmm] [VRFY:bvl] Проверьте всё, что я написал. Дополните.
</p>

<p>
Есть несколько типов дисплеев (см. <a href="#sec-5-3-1-1">Абстрактные типы устройств (обмен данными)</a>) с
разными вариантами отображения выводимой на них информации, зависимости от:
</p>
<ul class="org-ul">
<li>типа дисплея
</li>
<li>языковых настроек.
</li>
</ul>

<p>
[TODO:pyub] Описать настройки языков для дисплеев и для интерфейсов. Помнить, что
они должны меняться без перезагрузки и так далее.
</p>

<p>
Бизнес-логика не знает какой у нас тип дисплея, но знает текущую языковую настройку
и текущее состояние. При изменении состояния она отсылает нижнему уровню сообщение
о том, что необходимо вывести на дисплей в виде сообщения, содержащего строку.
</p>

<p>
Нижний уровень знает какой тип дисплея подключен и знает на какой тип дисплея в
каком формате выводить сообщения, что он и делает, получив сообщение от
бизнес-логики.
</p>

<p>
На данный момент предполагается, что все сообщения будут жёстко забиты в код
нижнего уровня для упрощения отладки. В последствии, когда мы отладим решение и
список выводимых сообщений будет сформирован и устаканен, мы сможем автоматически
сделать их выгрузку в PostgreSQL и забирать уже оттуда, а языковые пакеты делать
подключаемыми со стороны библиотеками.
</p>

<p>
Предполагается, что в том месте, где на <code>нижнем уровне</code> будет разбираться сообщение дисплею
будет простой код вида:
</p>

<div class="org-src-container">

<pre class="src src-cpp"><span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">&lt;stdio.h&gt;</span>
<span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">&lt;postgresql/libpq-fe.h&gt;</span>
<span style="color: #0000ee; font-weight: bold;">#include</span> <span style="color: #00cd00;">&lt;string&gt;</span>

<span style="color: #00cd00;">PGconn</span>          *<span style="color: #cdcd00;">conn</span>;
<span style="color: #00cd00;">PGresult</span>        *<span style="color: #cdcd00;">res</span>;
<span style="color: #00cd00;">int</span>             <span style="color: #cdcd00;">rec_count</span>;
<span style="color: #00cd00;">int</span>             <span style="color: #cdcd00;">row</span>;
<span style="color: #00cd00;">int</span>             <span style="color: #cdcd00;">col</span>;

<span style="color: #00cdcd; font-weight: bold;">class</span> <span style="color: #00cd00;">CDisplay</span> : <span style="color: #00cd00;">CBaseDevice</span> {
<span style="color: #00cdcd; font-weight: bold;">public</span>:

    <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1050;&#1086;&#1085;&#1089;&#1090;&#1088;&#1091;&#1082;&#1090;&#1086;&#1088; */</span>
    <span style="color: #0000ee; font-weight: bold;">CDisplay</span>() {
        CBaseDevice();
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1042;&#1089;&#1103; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1072;&#1103; &#1080;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103; */</span>
    };

    <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1084;&#1077;&#1085;&#1080; &#1082;&#1083;&#1072;&#1089;&#1089;&#1072; &#1090;&#1077;&#1082;&#1091;&#1097;&#1077;&#1075;&#1086; &#1072;&#1082;&#1090;&#1080;&#1074;&#1085;&#1086;&#1075;&#1086; &#1076;&#1080;&#1089;&#1087;&#1083;&#1077;&#1103; */</span>
    <span style="color: #00cd00;">string</span> <span style="color: #0000ee; font-weight: bold;">getCurrentDisplay</span>() {
        res = PQexec(conn, <span style="color: #00cd00;">"SELECT classname FROM displays WHERE active=1 LIMIT 1"</span>);
        <span style="color: #00cdcd; font-weight: bold;">if</span> (PQresultStatus(res) != PGRES_TUPLES_OK) {
            <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1052;&#1099; &#1085;&#1077; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1083;&#1080; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; - &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080; */</span>
        }
        <span style="color: #00cdcd; font-weight: bold;">return</span> PQgetvalue(res, row, col);
    }
    <span style="color: #00cd00;">string</span> <span style="color: #0000ee; font-weight: bold;">receiveMsg</span>(<span style="color: #00cd00;">string</span> <span style="color: #cdcd00;">in</span>) {
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; &#1086;&#1095;&#1077;&#1088;&#1077;&#1076;&#1080; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1081; */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">... */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&lt;&lt;POINTCUT&gt;&gt;: &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084; &#1074;&#1089;&#1077; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1099;&#1077; &#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">... */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1059;&#1079;&#1085;&#1072;&#1077;&#1084;, &#1082;&#1072;&#1082;&#1086;&#1081; &#1076;&#1080;&#1089;&#1087;&#1083;&#1077;&#1081; &#1072;&#1082;&#1090;&#1080;&#1074;&#1085;&#1099;&#1081; */</span>
        <span style="color: #00cd00;">string</span> <span style="color: #cdcd00;">displayClassName</span> = getCurrentDisplay();
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1053;&#1072;&#1093;&#1086;&#1076;&#1080;&#1084; &#1089;&#1086;&#1086;&#1090;&#1074;&#1077;&#1090;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1080;&#1081;  &#1101;&#1090;&#1086;&#1084;&#1091; &#1076;&#1080;&#1089;&#1087;&#1083;&#1077;&#1102; &#1082;&#1083;&#1072;&#1089;&#1089; &#1080; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; &#1091; &#1085;&#1077;&#1075;&#1086; &#1084;&#1077;&#1090;&#1086;&#1076; show() */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">... */</span>
        <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1074;&#1089;&#1077; &#1087;&#1088;&#1086;&#1096;&#1083;&#1086; &#1091;&#1089;&#1087;&#1077;&#1096;&#1085;&#1086;, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; 200 &#1054;&#1050; */</span>
        <span style="color: #00cdcd; font-weight: bold;">return</span> <span style="color: #00cd00;">"200 OK"</span>;
    }
};

<span style="color: #00cd00;">int</span> <span style="color: #0000ee; font-weight: bold;">main</span>() {
    <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082;  &#1041;&#1044; */</span>
    conn = PQconnectdb(<span style="color: #00cd00;">"dbname=aspp host=localhost user=lowlevel password=supersecret"</span>);
    <span style="color: #00cdcd; font-weight: bold;">if</span> (PQstatus(conn) == CONNECTION_BAD) {
        puts(<span style="color: #00cd00;">"&#1053;&#1077; &#1091;&#1076;&#1072;&#1077;&#1090;&#1089;&#1103; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1080;&#1090;&#1100;&#1089;&#1103; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;"</span>);
        exit(0);
    }
    <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1069;&#1084;&#1091;&#1083;&#1103;&#1094;&#1080;&#1103; &#1087;&#1086;&#1089;&#1099;&#1083;&#1082;&#1080; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1103; */</span>
    <span style="color: #00cd00;">CDisplay</span> <span style="color: #cdcd00;">display</span> = CDisplay();
    <span style="color: #00cdcd; font-weight: bold;">if</span> (<span style="color: #00cd00;">"200 OK"</span> != dispay.receiveMsg(<span style="color: #00cd00;">"&#1055;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072; &#1087;&#1088;&#1086;&#1077;&#1079;&#1078;&#1072;&#1081;&#1090;&#1077;"</span>)) {
        error();
    }
    <span style="color: #cd0000;">/* </span><span style="color: #cd0000;">&#1060;&#1080;&#1085;&#1072;&#1083;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103;*/</span>
    PQclear(res);
    PQfinish(conn);
    <span style="color: #00cdcd; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
В этом случае, когда возникнет необходимость оптимизации, мы можем
автоматизированно распарсить точку среза (pointcut) и преобразовать находящийся в
ней код. В качестве примера представим, что в точке среза есть switch, который
переводит сообщения на испанский:
</p>

<div class="org-src-container">

<pre class="src src-cpp"><span style="color: #00cd00;">string</span> <span style="color: #cdcd00;">result</span>;

<span style="color: #00cdcd; font-weight: bold;">if</span> (SPANISH == getCurrentLanguage()) {
    <span style="color: #00cdcd; font-weight: bold;">switch</span> (in) {
    <span style="color: #00cdcd; font-weight: bold;">case</span> <span style="color: #00cd00;">"&#1055;&#1086;&#1078;&#1072;&#1083;&#1091;&#1081;&#1089;&#1090;&#1072; &#1087;&#1088;&#1086;&#1077;&#1079;&#1078;&#1072;&#1081;&#1090;&#1077;"</span>:
        result = <span style="color: #00cd00;">"Por favor, venga"</span>;
        <span style="color: #00cdcd; font-weight: bold;">break</span>;
    <span style="color: #00cdcd; font-weight: bold;">case</span> (<span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1077;&#1079;&#1076; &#1079;&#1072;&#1082;&#1088;&#1099;&#1090;"</span>):
        result <span style="color: #00cd00;">"Prohibido el paso"</span>;
        <span style="color: #00cdcd; font-weight: bold;">break</span>;
    <span style="color: #00cdcd; font-weight: bold;">default</span>:
        error();
        <span style="color: #00cdcd; font-weight: bold;">break</span>;
    }
}
</pre>
</div>

<p>
[COMMENT:gmm] Да, я помню, что обычный С++ недостаточно выразительный, чтобы иметь
CASE of STRING. Но допустим, что мы извратились как-то вроде этого:
<a href="https://habrahabr.ru/post/166201/">https://habrahabr.ru/post/166201/</a> - просто ради того чтобы проиллюстрировать
концепцию.
</p>

<p>
Мы можем перед компиляцией в автоматическом режиме вынести перевод в базу данных и
заменить этот код на обращение к ней. Этот подход особенно полезен в случае, если
точки среза будут во всех методах <code>show()</code> конкретных дисплейных классов.
</p>

<p>
Таким образом на этапе разработки мы избегаем преждевременной оптимизации и
упрощаем отладку, не теряя в гибкости на продакшене.
</p>

<p>
Данное решение является оптимизацией программной части и будет реализовано, когда
на это будет время.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> <span class="todo TODO">TODO</span> Алгоритм запуска программного обеспечения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h3>
<div class="outline-text-3" id="text-5-5">
<p>
Асинхронный запуск под контролем раннера: рабочая среда + нижний уровень +
бизнес-логика + UI
</p>

<ul class="org-ul">
<li>Включается питание, загружается ОС.
</li>
<li>Запускается скрипт-супервизор, который контролирует наличие и независание
запущенных процессов: нижний уровень, бизнес-логика, веб-морда, nginx и других,
если будут.
</li>
<li>Каждое наше приложение - это клиент какого-либо сервера или сам сервер и сразу
после старта оно должно установить клиентские взаимосвязи: на сегодня бизнес-логика
должна установить соединение с нижним уровнем и веб-морда тоже должна установить
соединение с нижним уровнем. Приложение может начинать работу с устройствами
нижнего уровня только после получения информации о наличии, исправности и списке
текущих ошибок всех устройств.
</li>
<li>Нижний уровень сразу после старта, считает настройки устройств из базы и создаст в
памяти систему объектов, которая и будет являться уровнем представления устройств
для уровня бизнес-логики.
</li>
<li>Нижний уровень проводит инициализацию и пинг устройств. Выставляет статусы и
отправляет события о состоянии устройств бизнес-логике.
</li>
<li>После выдачи сообщения о состоянии устройств, нижний уровень перейдет в статус
"Work-ready". Других статусов для нижнего уровня пока не видно.
</li>
<li><p>
В случае, если были ошибки на устройствах, то для каждого неправильно работающего
устройства нижний уровень выдаст отдельное сообщение о статусе ошибки. То же
самое произойдет и в процессе работы в любой момент, если устройство перестало
отвечать на пинги, если устройство не отвечает (или неправильно отвечает) на
команды, если устройство само выдало событие об ошибках.
</p>
</li>

<li>Бизнес-логика анализирует наличие и состояния устройств, по результатам анализа
может проводить дополнительное тестирование, и выбирает алгоритм работы.
</li>
<li>Переход в состояние, соответствующее выбранному алгоритму: Stand-by, Ready, Lock,
etc.
</li>
</ul>

<p>
Рестарт приложения в процессе работы должен выполняться аналогично старту.
</p>

<p>
Обработка ошибок при обмене между приложениями: В любой момент может оказаться,
что приложение, которому надо отправить данные, не отвечает.
</p>

<p>
[TODO:gmm] [TODO:bvl] [TODO:aav] В этом случае поведение каждого конкретного
приложения должно быть описано отдельно.
</p>

<p>
[COMMENT:pyub] Необходимо описать здесь, но реализация может быть отложена на после
плотника.
</p>

<p>
В результате запуска бизнес-логика оказывается в <a href="#sec-4-6-1">состояние запуска (<code>poweron</code>)</a>.
</p>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> <span class="todo TODO">TODO</span> Рабочая среда&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h3>
<div class="outline-text-3" id="text-5-6">
<p>
<code>Рабочая среда</code> - это установленное в память контроллера и сконфигурированное под
нужды нашего проекта программное обеспечение сторонних разработчиков.
</p>

<p>
Вся рабочая среда запакована в единый архив и легко разворачивается (в будущем) из
него на управляющую плату контроллера.
</p>

<p>
[VRFY:bvl] [VRFY:gmm] Я плохо сформулировал определение, прошу помочь с этим.
</p>

<p>
[COMMENT:gmm] Это обычно называется "окружение" или "рабочее окружение",
"environment". Нам вообще надо отделить развертывание (деплой) от инициализации
(запуск). Кроме того, чтобы избежать проблем с обновлениями сторонних компонентов,
нам необходимо поддерживать все пакеты в стабильных версиях. Короче, нужен девопс.
</p>

<p>
[COMMENT:avv] [COMMENT:bvl] Остановились на "Рабочем окружении". Потом переделаем
ссылки и переименуем раздел
</p>

<p>
Ниже описана конфигурация рабочей среды. Все порты приложений и сервисов расписаны
в iptables.
</p>
</div>

<div id="outline-container-sec-5-6-1" class="outline-4">
<h4 id="sec-5-6-1"><span class="section-number-4">5.6.1</span> <span class="done DONE">DONE</span> Операционная система&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-1">
<p>
На данный момент в качестве ОС выбрана BeagleBoardDebian - Debian 7.4 "Wheezy" для
архитектуры ARMhf, который идёт в стандартной поставке.
</p>

<p>
Почитать о других вариантах ОС для BBB  можно здесь:
<a href="http://elinux.org/BeagleBone_Operating_Systems">http://elinux.org/BeagleBone_Operating_Systems</a>
</p>
</div>
</div>

<div id="outline-container-sec-5-6-2" class="outline-4">
<h4 id="sec-5-6-2"><span class="section-number-4">5.6.2</span> <span class="done DONE">DONE</span> Инициализация операционной системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-2">
<p>
В качестве демона инициализации ОС используется <code>systemd</code>.
</p>

<p>
Ссылки на толковые страницы:
<a href="http://vladimir-stupin.blogspot.ru/2013/02/systemd-1.html">http://vladimir-stupin.blogspot.ru/2013/02/systemd-1.html</a>
<a href="https://wiki.archlinux.org/index.php/Systemd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)">https://wiki.archlinux.org/index.php/Systemd_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)</a>
<a href="http://mybeagleboneblackfindings.blogspot.ru/2013/10/running-script-on-beaglebone-black-boot.html">http://mybeagleboneblackfindings.blogspot.ru/2013/10/running-script-on-beaglebone-black-boot.html</a>
<a href="https://habrahabr.ru/company/centosadmin/blog/255845/">https://habrahabr.ru/company/centosadmin/blog/255845/</a>
<a href="http://www2.kangran.su/~nnz/pub/s4a/s4a_latest.pdf">http://www2.kangran.su/~nnz/pub/s4a/s4a_latest.pdf</a>
</p>

<p>
Не смотря на то, что основой инициализации работает systemd, всё равно проходит инициализация
в том числе и "по старой схеме", через sysvinit, который работает с привычным нам /etc/init.d.
Важно помнить об этом, потому что ненужный нам <code>apache2</code> например живет именно там.
С ходу сносим /etc/init.d/apache. Из дистрибутива выкорчуем позже.
<code>Cloud9</code> отключается изящнее:
</p>

<div class="org-src-container">

<pre class="src src-sh">systemctl disable cloud9.socket
</pre>
</div>

<p>
Установка nginx уже описана выше.
Прописываем в автозапуск. Создаем файл /lib/systemd/system/nginx.service, пишем в него:
</p>

<div class="org-src-container">

<pre class="src src-conf">[<span style="color: #00cd00;">Unit</span>]
<span style="color: #cdcd00;">Description</span>=The NGINX HTTP and reverse proxy server
<span style="color: #cdcd00;">After</span>=syslog.target network.target remote-fs.target nss-lookup.target

[<span style="color: #00cd00;">Service</span>]
<span style="color: #cdcd00;">Type</span>=forking
<span style="color: #cdcd00;">PIDFile</span>=/usr/local/nginx/logs/nginx.pid
<span style="color: #cdcd00;">ExecStartPre</span>=/usr/local/nginx/sbin/nginx -t
<span style="color: #cdcd00;">ExecStart</span>=/usr/local/nginx/sbin/nginx
<span style="color: #cdcd00;">ExecReload</span>=/bin/kill -s HUP $MAINPID
<span style="color: #cdcd00;">ExecStop</span>=/bin/kill -s QUIT $MAINPID
<span style="color: #cdcd00;">PrivateTmp</span>=true

[<span style="color: #00cd00;">Install</span>]
<span style="color: #cdcd00;">WantedBy</span>=multi-user.target
</pre>
</div>

<p>
Сохраняем. Даем команду
</p>

<div class="org-src-container">

<pre class="src src-sh">systemctl enable nginx.service
</pre>
</div>

<p>
При необходимости, можем сразу и запустить:
</p>

<div class="org-src-container">

<pre class="src src-sh">systemctl start nginx.service
</pre>
</div>

<p>
В любом случае после перезагрузки nginx стартует и дает полюбоваться на свою success-страничку.
<i>обратите внимание, что настройка автостарта - это не все настройки nginx!!!</i>
</p>

<p>
<code>Systemd</code> позволяет следить за состоянием сервисов и может их <code>автоматически перезапускать</code>
(отслеживается по pid). Информации по работе с зомбями для systemd практически нет.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-3" class="outline-4">
<h4 id="sec-5-6-3"><span class="section-number-4">5.6.3</span> <span class="todo START">START</span> Конфигурация SSH сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-3">
<p>
[TODO:bvl] Описать нюансы конфигурации SSH-сервера.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-4" class="outline-4">
<h4 id="sec-5-6-4"><span class="section-number-4">5.6.4</span> <span class="done DONE">DONE</span> Установка и запуск nginx&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-4">
<p>
По умолчанию на ВВВ крутится apache2. Готовых .deb пакетов nginx для архитектуры
ARM нет, надо собирать из исходников. Исходники лежат здесь:
<a href="http://hg.nginx.org/nginx/shortlog/stable-1.8">http://hg.nginx.org/nginx/shortlog/stable-1.8</a> (последние на сегодня), потом можно
поискать следующую стабильную версию.
</p>

<p>
Скачиваем <a href="http://hg.nginx.org/nginx/archive/stable-1.8.tar.gz">http://hg.nginx.org/nginx/archive/stable-1.8.tar.gz</a>, загружаем на ВВВ
через scp (на нашей машине в консоли, в папке где лежит архив):
</p>

<div class="org-src-container">

<pre class="src src-sh">scp stable-1.8.tar.gz root@10.0.10.114:/root/build
</pre>
</div>

<p>
(если папки /root/build нет, её можно создать "mkdir /root/build" из консоли ВВВ)
</p>

<p>
Дальше распаковываем архив:
</p>
<div class="org-src-container">

<pre class="src src-sh">tar -xzf stable-1.8.tar.gz
</pre>
</div>

<p>
Переходим в папку nginx:
</p>
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #0000ee; font-weight: bold;">cd</span> nginx-stable-1.8
</pre>
</div>

<p>
Файл конфигурации лежит не там, где нужно. Перетаскиваем, запускаем:
</p>
<div class="org-src-container">

<pre class="src src-sh">cp auto/configure .
./configure
</pre>
</div>

<p>
Сконфигурировалось, собираем командой "make", устанавливаем "make install"
Nginx не прописывает себя в системные пути, вручную его можно запустить
</p>
<div class="org-src-container">

<pre class="src src-sh">/usr/local/nginx/sbin/nginx
</pre>
</div>

<p>
&#x2026;но пока крутится apache2, мы с конфигурацией по умолчанию этого не сделаем.
</p>
<div class="org-src-container">

<pre class="src src-sh">vi /usr/local/nginx/conf/nginx.conf
</pre>
</div>
<p>
в строке 37 выставляем "listen 8081". Когда "загасим" apache2 это значение можно вернуть в исходное.
</p>

<p>
Снова запускаем nginx, открываем приветствие nginx по адресу <a href="http://10.0.10.114:8081/">http://10.0.10.114:8081/</a>
Вуаля.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-5" class="outline-4">
<h4 id="sec-5-6-5"><span class="section-number-4">5.6.5</span> <span class="todo START">START</span> Установка и запуск PostgreSQL&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-5-6-5">
<p>
[TODO:gmm] Описать что к чему, развернуть PostgreSQL на BBB и расписать как это
повторить, какие конфиги задать и так далее.
</p>

<p>
[VRFY:pyub] [VRFY:bvl] [TODO:aav] Проверьте работает ли, чтобы можно было закрыть
тудушку
</p>

<p>
[19:21:02] rigidus: Так я осилил постгресс, но очень много хитрых шагов, среди
которых половина ненужных. Сделаю перерыв на обед и постараюсь описать. Просьба
завтра протестить на каком-нибудь биглбоне.
</p>

<p>
Ниже идет лог мытарств, может пригодится, если я буду спать пока Унримах пробует
развернуть у себя
</p>

<pre class="example">
root@bbb# apt-get install postgresql postgresql-common postgresql-client

[19:25:56] rigidus: Потом заходишь cd /usr/share/postgresql/9.1
[19:26:52] rigidus: Там есть конфиги *.samle - их надо скопировать в такие же но без
".sample", после чего отредактировать:
uncomment in /etc/postgresql/&lt;version&gt;/mainpostgresql.conf (/usr/share/postgresql/&lt;version&gt;/main/postgresql.conf):

# listen_addresses = 'localhost'

опционально выставить минимальные параметры по памяти, но может это не надо

/etc/postgresql/&lt;version&gt;/main/pg_hba.conf (/usr/share/postgresql/&lt;version&gt;/main/pg_hba.conf):
local   all         postgres                          md5

Потом попытаться запустить /usr/lib/postgresql/9.1/bin/postgresql
Если не сработает - в этой же папке лежит initdb - его надо
натравить на домашний каталог постргесса (я говорил, что все это надо делать под
постгрессом?)

/usr/lib/postgresql/9.1/bin/initdb -D /var/lib/postgresql/9.1/work

root@bbb# pg_createcluster

root@bbb# /etc/init.d/postgresql restart

error: "root" execution of the PostgreSQL server is not permitted.
The server must be started under an unprivileged user ID to prevent
possible system security compromise.  See the documentation for
more information on how to properly start the server.

root@bbb su postgres

postgres@beaglebone:/usr/share/postgresql$ /etc/init.d/postgresql start

[19:27:10] rigidus: Потом
[19:27:15] rigidus: Это в них же
[19:28:21] rigidus:

[19:29:45] rigidus: После чего финально

/usr/lib/postgresql/9.1/bin/postgres -D /var/lib/postgresql/9.1/work/

или как ты там назвал папку

[19:29:55] rigidus: Если все это сработает - мы в шоколаде и можно писать док
[19:36:24] rigidus: Если не прокатило - то можно создать пользователя с группой,
заовнить на него конфиги
</pre>
</div>
</div>

<div id="outline-container-sec-5-6-6" class="outline-4">
<h4 id="sec-5-6-6"><span class="section-number-4">5.6.6</span> <span class="done DONE">DONE</span> Установка и запуск Boost&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-6">
<p>
<code>Boost</code> - библиотеки расширения С++, значительно упрощающие работу.
</p>

<p>
По идее, вся установка заключается в запуске команды
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get install libboost-all-dev
</pre>
</div>

<p>
&#x2026;но при этом может возникнуть ошибка, выражающася в простыне строчек типа
</p>
<pre class="example">
insserv: Starting led_aging.sh depends on rmnologin and therefore on system facility `$all' which can not be true!
</pre>
<p>
с результатом ошибки установки. Чтобы это поправить, мы приводим файл /etc/init.d/led<sub>aging.sh</sub>
к следующему виду:
</p>

<div class="org-src-container">

<pre class="src src-conf"><span style="color: #cd0000;">#</span><span style="color: #cd0000;">!/bin/sh</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">tary, 16:46 2013-4-22</span>

<span style="color: #cd0000;">### </span><span style="color: #cd0000;">BEGIN INIT INFO</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Provides:          led_aging script</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Required-Start:    $remote_fs $syslog</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Required-Stop:     $remote_fs $syslog</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Default-Start:     2 3 4 5</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Default-Stop:      0 1 6</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Short-Description: Start led_agigng daemon at boot time</span>
<span style="color: #cd0000;"># </span><span style="color: #cd0000;">Description:       Enable service provided by led_aging daemon.</span>
<span style="color: #cd0000;">### </span><span style="color: #cd0000;">END INIT INFO</span>

<span style="color: #cdcd00;">x</span>=$(/bin/ps -ef | /bin/grep <span style="color: #00cd00;">"[l]ed_acc"</span>)
if [ ! -n <span style="color: #00cd00;">"$x"</span> -a -x /usr/bin/led_acc ]; then
        /usr/bin/led_acc &amp;
fi
</pre>
</div>

<p>
Повторяем:
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get install libboost-all-dev
</pre>
</div>

<p>
Boost установлен в <i>usr/include/boost</i> .
Можно пересобирать исходники с использованием Буста прямо на ВВВ.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-7" class="outline-4">
<h4 id="sec-5-6-7"><span class="section-number-4">5.6.7</span> <span class="done DONE">DONE</span> Установка и запуск git-core&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-5-6-7">
<p>
Для того, чтобы обновлять код во время тестирования и в продакшене мы можем
использовать GIT. Это достаточно гибко и просто в эксплуатации. В том числе, мы
можем отслеживать в гите конфигурационные файлы и логи сообщений - это поможет при
отладке.
</p>

<p>
Развертывние GIT на BBB выполняется просто:
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get install git-core
<span style="color: #0000ee; font-weight: bold;">cd</span> ~/repo
git clone git@github.com:rigidus/asp.git
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-8" class="outline-4">
<h4 id="sec-5-6-8"><span class="section-number-4">5.6.8</span> Установка Closure Common Lisp на bbb</h4>
<div class="outline-text-4" id="text-5-6-8">
<p>
Скачиваем (с оффсайта) и распаковываем ccl-1.11-linuxarm.tar.gz
<a href="http://ccl.clozure.com/download.html">http://ccl.clozure.com/download.html</a>
</p>

<p>
Установка и возможные проблемы описаны в документации:
<a href="http://ccl.clozure.com/docs/ccl.html#installing-and-running-clozure-cl">http://ccl.clozure.com/docs/ccl.html#installing-and-running-clozure-cl</a>
</p>

<p>
Заходим в папку, в которую распаковался архив, вызываем armcl и выполняем
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ccl:rebuild-ccl <span style="color: #0000ee; font-weight: bold;">:full</span> t)
</pre>
</div>

<p>
После того как ребилд прошел, выходим, набирая "(quit)" и переходим в папку
<code>ccl/lisp-kernel/linuxarm</code>. Там делаем:
</p>

<div class="org-src-container">

<pre class="src src-sh">make clean
make
</pre>
</div>

<p>
Иногда перед этим нужно поставить макропроцессор m4
</p>

<p>
Снова запускаем <code>armcl</code> и выполгяем компиляцию:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ccl:compile-ccl t)
</pre>
</div>

<p>
Выходим, загружаемся снова и загружаем нулевой уровень:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ccl:xload-level-0)
</pre>
</div>

<p>
Снова выходим и загружаем полученный образ
</p>

<div class="org-src-container">

<pre class="src src-sh">armcl -image-name x86-boot64.image --no-init
</pre>
</div>

<p>
Теперь можно его сохранить в окончательный файл
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ccl:save-application <span style="color: #00cd00;">"new.image"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-9" class="outline-4">
<h4 id="sec-5-6-9"><span class="section-number-4">5.6.9</span> Установка org-mode</h4>
<div class="outline-text-4" id="text-5-6-9">
<p>
Заключается в том, чтобы склонировать правильный org-mode
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #0000ee; font-weight: bold;">cd</span> ~/repo/
https://github.com/rigidus/org-mode.git
</pre>
</div>

<p>
Зайти в его каталог, сделать:
</p>

<div class="org-src-container">

<pre class="src src-sh">make autoloads
</pre>
</div>

<p>
и прописать его в ~/.emacs.d/init.el
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">OrgMode</span>
(add-to-list 'load-path <span style="color: #00cd00;">"/root/repo/org-mode/lisp"</span>)
(<span style="color: #00cdcd; font-weight: bold;">require</span> '<span style="color: #cd00cd;">org-install</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-10" class="outline-4">
<h4 id="sec-5-6-10"><span class="section-number-4">5.6.10</span> Установка Slime</h4>
<div class="outline-text-4" id="text-5-6-10">
<p>
Необходимо скачать версию 2.8 с оффсайта, выполнить операции оп установке и
прописать в init.el:
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">CCL</span>
(setq inferior-lisp-program <span style="color: #00cd00;">"/root/build/ccl/armcl"</span>)
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">SLIME</span>
(add-to-list 'load-path <span style="color: #00cd00;">"/root/build/slime-2.8"</span>)
(<span style="color: #00cdcd; font-weight: bold;">require</span> '<span style="color: #cd00cd;">slime</span>)
(slime-setup '(slime-fancy))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-6-11" class="outline-4">
<h4 id="sec-5-6-11"><span class="section-number-4">5.6.11</span> Установка Quicklisp</h4>
<div class="outline-text-4" id="text-5-6-11">
<div class="org-src-container">

<pre class="src src-sh">ccl/armcl --load quicklisp.lisp
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp">(quicklisp-quickstart:install)
</pre>
</div>

<p>
В <code>~/ccl-init.lisp</code> прописать:
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #cd0000;">;;; </span><span style="color: #cd0000;">The following lines added by ql:add-to-init-file:</span>
#-quicklisp
(<span style="color: #00cdcd; font-weight: bold;">let</span> ((quicklisp-init (merge-pathnames <span style="color: #00cd00;">"quicklisp/setup.lisp"</span>
                                       (user-homedir-pathname))))
  (<span style="color: #00cdcd; font-weight: bold;">when</span> (probe-file quicklisp-init)
    (load quicklisp-init)))


#+quicklisp
(mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
            (pushnew x ql:*local-project-directories*))
        (list
         #P<span style="color: #00cd00;">"~/repo/asp/"</span>
         ))
</pre>
</div>

<p>
Чтобы все работало правильно сделать:
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get purge common-lisp-controller
mv /usr/share/common-lisp /usr/share/common-lisp-2
</pre>
</div>

<p>
И установить локаль ru<sub>RU.UTF</sub>-8:
<a href="http://debianworld.ru/articles/nastrojka-rusifikaciya-konsoli-v-ubuntu-debian/">http://debianworld.ru/articles/nastrojka-rusifikaciya-konsoli-v-ubuntu-debian/</a>
</p>

<div class="org-src-container">

<pre class="src src-sh">dpkg-reconfigure locales
</pre>
</div>

<p>
И закомментировать все в файле <code>/etc/emacs/site-start.d/50slime.el</code> чтобы
запускался нужный swank
</p>
</div>
</div>

<div id="outline-container-sec-5-6-12" class="outline-4">
<h4 id="sec-5-6-12"><span class="section-number-4">5.6.12</span> <span class="todo START">START</span> Установка и запуск SMTP-сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-5-6-12">
<p>
Почтовый сервер необходим для того, чтобы контроллер мог отправлять на почту
администратору уведомления об ошибках, отчёты и так далее.
</p>

<p>
[TODO:gmm] Подобрать лёгкий почтовый сервер или SMTP сервер-only, развернуть
его на BBB и расписать как это повторить, какие конфиги задать и так далее.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-13" class="outline-4">
<h4 id="sec-5-6-13"><span class="section-number-4">5.6.13</span> <span class="todo START">START</span> Установка и запуск FTP-сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-5-6-13">
<p>
FTP-сервер необходим для того, чтобы можно было просто заливать прошивки по
удалёнке и высасывать их из репозиториев.
</p>

<p>
[TODO:gmm] Подобрать лёгкий ftp-сервер, развернуть
его на BBB и расписать как это повторить, какие конфиги задать и так далее.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-14" class="outline-4">
<h4 id="sec-5-6-14"><span class="section-number-4">5.6.14</span> <span class="todo START">START</span> Конфигурация iptables&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-14">
<p>
[TODO:bvl] Сконфигурировать фаервол, выдать всем сущностям среды разработки порты,
перечислить порты здесь.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Порты iptables</caption>

<colgroup>
<col  class="right" />

<col  class="left" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="right">Порт</th>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">Приложение</th>
<th scope="col" class="left">Доступ</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">TCP</td>
<td class="right">80</td>
<td class="left">http</td>
<td class="left">aspp<sub>web</sub></td>
<td class="left">ethernet</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">TCP</td>
<td class="right">443</td>
<td class="left">https</td>
<td class="left">aspp<sub>web</sub></td>
<td class="left">ethernet</td>
</tr>

<tr>
<td class="right">3</td>
<td class="left">TCP</td>
<td class="right">22</td>
<td class="left">ssh</td>
<td class="left">open<sub>ssh</sub> (?)</td>
<td class="left">ethernet</td>
</tr>

<tr>
<td class="right">4</td>
<td class="left">TCP</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">aspp<sub>bl</sub></td>
<td class="left">localhost</td>
</tr>

<tr>
<td class="right">5</td>
<td class="left">TCP</td>
<td class="right">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">aspp<sub>hw</sub></td>
<td class="left">localhost</td>
</tr>

<tr>
<td class="right">6</td>
<td class="left">TCP</td>
<td class="right">25</td>
<td class="left">smtp</td>
<td class="left">&#xa0;</td>
<td class="left">ethernet</td>
</tr>

<tr>
<td class="right">7</td>
<td class="left">TCP</td>
<td class="right">21</td>
<td class="left">ftp</td>
<td class="left">&#xa0;</td>
<td class="left">ethernet</td>
</tr>
</tbody>
</table>

<p>
[COMMENT:pyub] Вероятно есть ещё некий порт для коннекта агрегирующего сервера?
Важно понимать, что пользователь в web-морде может поменять все настройки портов -
это важное требование меня как сетевого администратора.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-15" class="outline-4">
<h4 id="sec-5-6-15"><span class="section-number-4">5.6.15</span> <span class="todo TODO">TODO</span> Конфигурация супервизора&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-15">
<p>
[TODO:bvl] Супервизор и логика его работы. Супервизор перезапускает неотвечающие
сервисы. Лучше запускать с нижнего уровня, чтобы бизнес-логика уже имела возможность
опрашивать оборудование.
</p>
</div>
</div>

<div id="outline-container-sec-5-6-16" class="outline-4">
<h4 id="sec-5-6-16"><span class="section-number-4">5.6.16</span> <span class="todo START">START</span> Конфигурация средства бэкапирования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-16">
<p>
[TODO:bvl] После того как мы всё собрали надо всё завернуть в архив и настроить
средство бэкапирования, реализовав то, что мы опять же должны описать здесь:
<a href="#sec-5-12">Резервирование системы</a>
</p>
</div>
</div>

<div id="outline-container-sec-5-6-17" class="outline-4">
<h4 id="sec-5-6-17"><span class="section-number-4">5.6.17</span> <span class="todo TODO">TODO</span> Установка и конфигурация отдельных периферийных средств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-6-17">
</div><ol class="org-ol"><li><a id="sec-5-6-17-1"></a><span class="todo TODO">TODO</span> Принтеры<br  /><ol class="org-ol"><li><a id="sec-5-6-17-1-1"></a>CUSTOM VKP-80II<br  /><ol class="org-ol"><li><a id="sec-5-6-17-1-1-1"></a><span class="done DONE">DONE</span> Работа через CUPS (USB)<br  /><div class="outline-text-7" id="text-5-6-17-1-1-1">
<p>
Драйверы для принтера под Linux можно найти у нас в хранилище или скачать здесь:
<a href="http://www.custom.biz/industrial-and-kiosk/solutions-for-self-service-kiosks/kiosk-printers/vkp80ii-sx">http://www.custom.biz/industrial-and-kiosk/solutions-for-self-service-kiosks/kiosk-printers/vkp80ii-sx</a>
</p>

<p>
Нужный файл - 1635-vkp80<sub>cupsdrv</sub>-1.05.tgz, внутри - VKP80<sub>CUPSDrv</sub><sub>armv7l</sub>-1.05,
где исполнимый файл "setup" бодро раскидывает остальные файлы по системе CUPS.
</p>

<p>
Перед этим, конечно же, нужно поставить CUPS:
</p>
<pre class="example">
apt-get install cups
</pre>
<p>
Проверить работоспособность этой подсистемы можно, зайдя на контроллер через веб-браузер
по порту 631. Прямо "с места" это не работает, доступ по умолчанию закрыт в настройках.
</p>

<p>
Лезем в файл <code>/etc/cups/cupsd.conf</code>, комментируем строчки "Listen", приводим к такому виду:
</p>
<pre class="example">
# Listen localhost:631
# Listen /var/run/cups/cups.sock
Port 631
</pre>
<p>
Далее по тексту выставляем DefaultAuthType None, и во всех &lt;Location &#x2026;&gt; выставляем
Allow from all
выставляем AuthType Default и закрываем комментом "# Require user &#x2026;" вообще по всему телу документа.
После этого должно успешно появиться приветствие системы CUPS на <a href="http://10.0.10.114:631/">http://10.0.10.114:631/</a> (подставить
актуальный адрес ВВВ).
</p>

<p>
После этого всего подмыкаем принтер к USB, производим установку распакованного драйвера запуском ./setup,
на панели администрирования в вебстранице CUPS добавляем принтер. Принтер устанавливается, мы можем
печатать текст через <code>echo "text" &gt; /dev/usb/lp0</code>, но при попытке печати картинки или pdf мы получаем
"rastertoVKP80 failed". Косяк здедсь в том, что тот самый rastertoVKP80 собран как исполняемый модуль
под архитектуру armel, а у нас архитектура armhf. По счастью, они совместимы - нам нужно только набросать
необходимых библиотек.
</p>

<p>
       Каких библиотек не хватает будет видно по команде <code>ldd /usr/lib/cups/filter/rastertovkp80</code> ровно до тех пор,
       пока все библиотеки не будут найдены и установлены. Полный список выглядит так:
libavahi-client3<sub>0.6.31</sub>-5<sub>armel.deb</sub>
libavahi-common3<sub>0.6.31</sub>-5<sub>armel.deb</sub>
libc6<sub>2.19</sub>-18+deb8u2<sub>armel.deb</sub>
libcomerr2<sub>1.42.12</sub>-1.1<sub>armel.deb</sub>
libcups2<sub>2.1.2</sub>-2+b1<sub>armel.deb</sub>
libcupsimage2<sub>2.1.2</sub>-2+b1<sub>armel.deb</sub>
libdbus-1-3<sub>1.8.20</sub>-0+deb8u1<sub>armel.deb</sub>
libffi6<sub>3.1</sub>-2+b2<sub>armel.deb</sub>
libgmp10<sub>6.0.0</sub>+dfsg-6<sub>armel.deb</sub>
libgnutls30<sub>3.4.8</sub>-2<sub>armel.deb</sub>
libgssapi-krb5-2<sub>1.12.1</sub>+dfsg-19+deb8u2<sub>armel.deb</sub>
libhogweed4<sub>3.1.1</sub>-4<sub>armel.deb</sub>
libidn11<sub>1.29</sub>-1+b2<sub>armel.deb</sub>
libk5crypto3<sub>1.12.1</sub>+dfsg-19+deb8u2<sub>armel.deb</sub>
libkeyutils1<sub>1.5.9</sub>-5+b1<sub>armel.deb</sub>
libkrb5-3<sub>1.12.1</sub>+dfsg-19+deb8u2<sub>armel.deb</sub>
libkrb5support0<sub>1.12.1</sub>+dfsg-19+deb8u2<sub>armel.deb</sub>
libnettle6<sub>3.1.1</sub>-4<sub>armel.deb</sub>
libp11-2<sub>0.2.8</sub>-5<sub>armel.deb</sub>
libp11-kit0<sub>0.20.7</sub>-1<sub>armel.deb</sub>
libtasn1-6<sub>4.2</sub>-3+deb8u1<sub>armel.deb</sub>
zlib1g<sub>1.2.8.dfsg</sub>-2+b1<sub>armel.deb</sub>
       но я уже собрал из них архив, который можно просто распаковать в корень: lib<sub>armel.tgz</sub>
       После распаковки надо обязательно проверить, что ссылка <code>/lib/ld-linux.so.3</code> указывает
       на /lib/ld-linux-armhf.so.3
</p>

<p>
Теперь мы можем печатать картинки и .pdf. Для полного счастья нужно научиться печатать html. В этом нам
поможет пакет wkhtmltopdf. Делаем <code>apt-get install wkhtmltopdf</code>. Для работы ему нужен Xserver. Сначала
проверяем работу, набросав какой-нибудь простенький html
</p>
<pre class="example">
/usr/local/bin/wkhtmltopdf ~/test.html test.pdf
</pre>
<p>
Если мы получаем "Cannot connect to X server" - <code>apt-get install xvfb</code>. Далее сам запуск заворачивается
в строку
</p>
<pre class="example">
xvfb-run -a -s "-screen 0 640x480x16" wkhtmltopdf "$@"
</pre>
<p>
сохраняется в /usr/local/bin/wkhtmltopdf.sh, выставляем права на исполнение.
Запуск на преобразование файла идет примерно так:
</p>
<pre class="example">
wkhtmltopdf.sh -s A7 test_check.html test_check2.pdf
</pre>
<p>
после чего запускаем на печать:
</p>
<pre class="example">
lp test_check2.pdf
</pre>

<p>
Если принтер по умолчанию не выбран, это можно сделать, узнав точное имя установленных принтеров в системе:
</p>
<pre class="example">
lpstat -p -d
</pre>
<p>
и вогнав результат в <code>lpoptions -d CUSTOM_Engineering_VKP80</code>.
</p>

<p>
Что важно: из-за неких мифических косяков ядра ВВВ, отвалившееся устройство USB не подхватывается обратно. Поэтому
пока рассчитываем "тепличные условия", при которых питание не сбрасывается в случайные моменты времени в случайном порядке.
</p>
</div>
</li>

<li><a id="sec-5-6-17-1-1-2"></a><span class="todo TODO">TODO</span> Работа через CUPS (RS232)<br  /></li>
<li><a id="sec-5-6-17-1-1-3"></a><span class="todo WAIT">WAIT</span> Работа через собственный драйвер<br  /></li></ol>
</li></ol>
</li>

<li><a id="sec-5-6-17-2"></a><span class="todo TODO">TODO</span> Дисплеи<br  /><ol class="org-ol"><li><a id="sec-5-6-17-2-1"></a><span class="todo TODO">TODO</span> Winstar 16x2 и другие на чипе HD44780&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span><br  /><div class="outline-text-6" id="text-5-6-17-2-1">
<p>
Для работы с подобными дисплеями мы пользуемся прекрасным драйвером с гитхаба
<a href="https://github.com/hsm5xw/Linux-Device-Driver-for-Character-LCD-Kernel-Level">https://github.com/hsm5xw/Linux-Device-Driver-for-Character-LCD-Kernel-Level</a>
Как идёт с ним работа - прекрасно видно на видео
<a href="https://www.youtube.com/watch?v=icP9ckrTLKc">https://www.youtube.com/watch?v=icP9ckrTLKc</a>
Этот модуль реализует в системе символьное устройство /dev/klcd, которое принимает
в себя простые и понятные команды, отрабатывая вывод на подключенный известным способом
дисплей.
</p>

<p>
Чтобы у нас заработала "вся фигня", нужно проделать два шага:
</p>
</div>

<ol class="org-ol"><li><a id="sec-5-6-17-2-1-1"></a>Маленький шаг: правильно собрать klcd.ko<br  /><div class="outline-text-7" id="text-5-6-17-2-1-1">
<p>
git clone <a href="https://github.com/hsm5xw/Linux-Device-Driver-for-Character-LCD-Kernel-Level">https://github.com/hsm5xw/Linux-Device-Driver-for-Character-LCD-Kernel-Level</a>
(делаем это не на ВВВ, а на хост-машине под Linux, см. следующий большой шаг)
Дальше лезем в исходник klcd.h и меняем константы в разделах LCD Pin Configuration и
LCD Constants, руководствуясь таблицами Дерека Моллоя (см. devices/BBB<sub>itself</sub>).
</p>

<p>
Далее открываем Makefile и поправляем ссылки в переменных KDIR и CROSS<sub>COMPILE</sub>. Я
менять ничего не стал, просто создал в /root символьные ссылки на нужные мне адреса
в системе. KDIR должен указывать на место расположения исходника Linux в нужной
конфигурации (3.8.13-bone47), с актуальным файлом Module.symvers. Как его получить:
</p>
</div>
</li>

<li><a id="sec-5-6-17-2-1-2"></a>Большой шаг: собираем ядро Linux в нашей частной конфигурации 3.8.13-bone47<br  /><div class="outline-text-7" id="text-5-6-17-2-1-2">
<p>
Смотри "Сборка Linux в нашей частной конфигурации 3.8.13-bone47" в разделе
"Подготовка среды разработки".
</p>
</div>
</li>

<li><a id="sec-5-6-17-2-1-3"></a>Конечный шаг - собираем, проверяем.<br  /><div class="outline-text-7" id="text-5-6-17-2-1-3">
<p>
В каталоге <code>code/klcd</code> делаем <code>make</code>. KDIR можно перенаправить на появившийся в предыдущем
шаге <code>bb-kernel/dl/gcc-linaro-arm-linux-gnueabihf-4.9-2014.09_linux</code>, должно сработать.
</p>

<p>
Идем в <code>code/klcd/ioctl_testDir</code>, там делаем <code>gcc driver.c -o ioctl_test</code>. Копируем получившиеся
klcd.ko и ioctl<sub>test</sub> на ВВВ.
</p>

<p>
Загружаем модуль ядра: <code>insmod klcd.ko</code>, проверяем через <code>lsmod</code>. Если klcd не появился в списке,
ошибка может быть видна в <code>dmesg</code>. Также можно увидеть появившийся /dev/klcd - это успех.
Отправляем команды на экран через ioctl<sub>test</sub>, список команд можно увидеть во второй части видео
или из исходника driver.c.
</p>
</div>
</li>

<li><a id="sec-5-6-17-2-1-4"></a><span class="todo TODO">TODO</span> Интеграция в код ASPP.<br  /><div class="outline-text-7" id="text-5-6-17-2-1-4">
<p>
Для каждого дисплея может быть (и будет) свой драйвер - свои ножки, свои параметры длины
строки и т. д. Kernel Object должен выбираться и загружаться нашим софтом исходя из настроек
при старте.
</p>
</div>
</li></ol>
</li></ol>
</li>

<li><a id="sec-5-6-17-3"></a><span class="todo TODO">TODO</span> Сканеры штрихкодов<br  /></li></ol>
</div>
</div>
<div id="outline-container-sec-5-7" class="outline-3">
<h3 id="sec-5-7"><span class="section-number-3">5.7</span> Подготовка среды разработки ПО контроллера</h3>
<div class="outline-text-3" id="text-5-7">
</div><div id="outline-container-sec-5-7-1" class="outline-4">
<h4 id="sec-5-7-1"><span class="section-number-4">5.7.1</span> Сборка ядра Linux в нашей частной конфигурации 3.8.13-bone47</h4>
<div class="outline-text-4" id="text-5-7-1">
<p>
   [VRFY:bvl] Стоит наверно перенести это в <a href="#sec-5-6-6">Установка и
запуск Boost</a> ?
</p>

<p>
   Смотри "Сборка Linux в нашей частной конфигурации 3.8.13-bone47" в разделе
"Сборка"
   git clone <a href="https://github.com/RobertCNelson/bb-kernel.git">https://github.com/RobertCNelson/bb-kernel.git</a>
   git checkout 3.8.13-bone47
   Это скрипты, которые собирают ядро нужной версии за нас. Перед запуском скрипты
   потребуют некоторой правки:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="version.sh"><span style="color: #cd0000;">#</span><span style="color: #cd0000;">toolchain="gcc_linaro_gnueabi_4_6"</span>
<span style="color: #cd0000;">#</span><span style="color: #cd0000;">toolchain="gcc_linaro_gnueabihf_4_7"</span>
<span style="color: #cd0000;">#</span><span style="color: #cd0000;">toolchain="gcc_linaro_gnueabihf_4_8"</span>
<span style="color: #cdcd00;">toolchain</span>=<span style="color: #00cd00;">"gcc_linaro_gnueabihf_4_9"</span>
</pre>
</div>

<p>
По образцу gcc<sub>linaro</sub><sub>gnueabihf</sub><sub>4</sub><sub>8</sub>) добавляем:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="scripts/gcc.sh">     gcc_linaro_gnueabihf_4_9)

<span style="color: #cd0000;">#</span><span style="color: #cd0000;">http://releases.linaro.org/14.09/components/toolchain/binaries/gcc-linaro-arm-linux-gnueabihf-4.9-2014.09_linux.tar.xz</span>
     <span style="color: #cdcd00;">gcc_version</span>=<span style="color: #00cd00;">"4.9"</span>
     <span style="color: #cdcd00;">release</span>=<span style="color: #00cd00;">"2014.09"</span>
     <span style="color: #cdcd00;">toolchain_name</span>=<span style="color: #00cd00;">"gcc-linaro-arm-linux-gnueabihf"</span>
     <span style="color: #cdcd00;">site</span>=<span style="color: #00cd00;">"https://releases.linaro.org"</span>
     <span style="color: #cdcd00;">version</span>=<span style="color: #00cd00;">"14.09/components/toolchain/binaries"</span>
     <span style="color: #cdcd00;">directory</span>=<span style="color: #00cd00;">"${toolchain_name}-${gcc_version}-${release}_linux"</span>
     <span style="color: #cdcd00;">filename</span>=<span style="color: #00cd00;">"${directory}.tar.xz"</span>
     <span style="color: #cdcd00;">datestamp</span>=<span style="color: #00cd00;">"${release}-${toolchain_name}"</span>
     <span style="color: #cdcd00;">binary</span>=<span style="color: #00cd00;">"bin/arm-linux-gnueabihf-"</span>
     ;;
</pre>
</div>

<p>
Скрещиваем пальцы на удачу, запускаем <code>sudo build_kernel.sh</code>. Что происходит:
</p>
<ul class="org-ul">
<li>Определяется хост-система
</li>
<li>Скачивается указанный выше хост-компилятор. 4.8 потом выдает ошибки, нужен 4.9
</li>
<li>Скачивается километр исходников Linux из git.kernel.org. Это не лезет в ВВВ,
</li>
</ul>
<p>
даже
     не пытайтесь.
</p>
<ul class="org-ul">
<li>Патчатся исходники ядра в соответствии с меткой 3.8.13-bone47.
</li>
<li>Вылезает окно дополнительной конфигурации. Делаем <code>Exit</code>.
</li>
<li>По команде "СОБЕРИСЬ, ТРЯПКА" - собирается полное ведро исходников Linux с
</li>
</ul>
<p>
заголовками.
</p>
<ul class="org-ul">
<li>Отрабатывают какие-то дополнительные скрипты, собирающие dtbs.
</li>
</ul>

<p>
   У нас получается свежий каталог bb-kernel/KERNEL, в котором индикатором готовности
выступает
   файл Module.symvers. На каталог стараемся не дышать - он нам еще не раз пригодится
именно
   в этом виде.
</p>
</div>
</div>

<div id="outline-container-sec-5-7-2" class="outline-4">
<h4 id="sec-5-7-2"><span class="section-number-4">5.7.2</span> Установка cmake</h4>
<div class="outline-text-4" id="text-5-7-2">
<p>
Cmake нам понадобится, чтобы собрать Boost
apt-get install cmake, собственно
</p>
</div>
</div>

<div id="outline-container-sec-5-7-3" class="outline-4">
<h4 id="sec-5-7-3"><span class="section-number-4">5.7.3</span> Установка Boost</h4>
<div class="outline-text-4" id="text-5-7-3">
<p>
Boost мы берем отсюда: <a href="http://www.boost.org/users/history/version_1_57_0.html">http://www.boost.org/users/history/version_1_57_0.html</a>
Укачиваем с SourceForge, распаковываем, смотрим на каталог.
</p>

<p>
Собираем, устанавливаем:
$ sudo ./buutstrap.sh
$ sudo ./b2 install
</p>

<p>
Это должно канать для сборки и тестирования на хост-машине.
</p>

<p>
Настраиваем кросс-компиляцию. Мануал:
<a href="http://www.boost.org/build/doc/html/bbv2/tasks/crosscompile.html">http://www.boost.org/build/doc/html/bbv2/tasks/crosscompile.html</a> Находим файл
./tools/build/example/user-config.jam, тащим его к себе в "~", добавляем строчку
</p>

<pre class="example">
using gcc : arm : arm-linux-gnueabihf-g++ ;
</pre>

<p>
Пересобираем с параметром:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo ./b2 <span style="color: #cdcd00;">toolset</span>=gcc-arm
</pre>
</div>

<p>
На ВВВ у нас тоже должен быть установлен и собран Boost, иначе не взлетим. Процесс
тот же (кроме настройки кросс-компиляции).
</p>
</div>
</div>

<div id="outline-container-sec-5-7-4" class="outline-4">
<h4 id="sec-5-7-4"><span class="section-number-4">5.7.4</span> Установка cppunit</h4>
<div class="outline-text-4" id="text-5-7-4">
<p>
Это набор инструментов автотестирования. Его тоже тащим с SourceForge:
<a href="https://sourceforge.net/projects/cppunit/">https://sourceforge.net/projects/cppunit/</a>
</p>

<p>
Сборка производится в директории cppunit.
В процессе сборки может произойти ошибка линковки с библиотекой libdl.so, чтобы ее
исправить надо в файле configure в строке 21585 дописать -ldl
Полный вид строки после исправления: LIBS="$LIBS -lm -ldl"
</p>

<p>
Сборка для x86<sub>64</sub>
</p>

<div class="org-src-container">

<pre class="src src-sh">./configure
make
sudo make install
</pre>
</div>

<p>
Сборка для arm-linux-gnueabihf
</p>

<div class="org-src-container">

<pre class="src src-sh">     ./configure <span style="color: #cdcd00;">CC</span>=/usr/local/arm-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc
<span style="color: #cdcd00;">CXX</span>=/usr/local/arm-linux-gnueabihf/bin/arm-linux-gnueabihf-g++ --build=arm
--exec-prefix=/usr/local/arm-linux-gnueabihf --prefix=/usr/local/arm-linux-gnueabihf
--host=amd64
     make
     sudo make install
</pre>
</div>

<p>
Пути cppunit для ARM:
</p>
<pre class="example">
include: /usr/local/arm-linux-gnueabihf/include/
lib: /usr/local/arm-linux-gnueabihf/lib/
</pre>

<p>
Обычно на этом всё.
</p>
</div>
</div>

<div id="outline-container-sec-5-7-5" class="outline-4">
<h4 id="sec-5-7-5"><span class="section-number-4">5.7.5</span> Установка rapidjson</h4>
<div class="outline-text-4" id="text-5-7-5">
<p>
Его тащим с гитхаба:
$ git clone <a href="https://github.com/miloyip/rapidjson.git">https://github.com/miloyip/rapidjson.git</a>
</p>

<p>
После чего производим настройку, сборку и установку:
</p>

<div class="org-src-container">

<pre class="src src-sh">cmake .
sudo make
sudo make install
</pre>
</div>

<p>
   make собирает только примеры использования, поэтому необязателен
   make install устанавливает исходники в <i>usr/local/include/rapidjson</i>.
   Для нашей сборки на ARM нужно скопировать их в
<i>usr/local/arm-linux-gnueabihf/rapidjson</i>.
</p>

<p>
   На последнем шаге мне не хватило каталога ./include/rapidjson в существующем
./include. Создал ручками,
   прокатило, установилось.
</p>
</div>
</div>

<div id="outline-container-sec-5-7-6" class="outline-4">
<h4 id="sec-5-7-6"><span class="section-number-4">5.7.6</span> Единая конфигурация Eclipse&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-5-7-6">
<p>
[TODO:aav] Надо бы по возможности проработать непротиворечивую конфигурацию, чтобы
.cproject был единым.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-8" class="outline-3">
<h3 id="sec-5-8"><span class="section-number-3">5.8</span> <span class="todo TODO">TODO</span> Работа с библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h3>
<div class="outline-text-3" id="text-5-8">
</div><div id="outline-container-sec-5-8-1" class="outline-4">
<h4 id="sec-5-8-1"><span class="section-number-4">5.8.1</span> <span class="todo TODO">TODO</span> Работа со статическими библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-5-8-1">
<p>
[TODO:bvl] [TODO:aav] Наверное, в этом разделе нужно расписать, какие библиотеки мы
планируем использовать сейчас.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Реализуемый функционал</th>
<th scope="col" class="left">библиотека</th>
<th scope="col" class="left">сервисная утилита</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">LowLevel Core</td>
<td class="left">Boost-1.54</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Поддержка json</td>
<td class="left">RapidJSON</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Поддержка SQL</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Термопринтер VKP-80</td>
<td class="left">CUPS+libs</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Экран знакосинтезирующий, 2 строки</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Экран знакосинтезирующий, 4 строки</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Экран ЖК монохром</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Экран цветной графический</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Сканер</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Считыватель EM-Marine</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">Считыватель Mifare+</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-5-8-2" class="outline-4">
<h4 id="sec-5-8-2"><span class="section-number-4">5.8.2</span> <span class="todo WAIT">WAIT</span> Работа динамическими с библиотеками&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h4>
<div class="outline-text-4" id="text-5-8-2">
<p>
[TODO:bvl:aav] Определится с какими либами мы работаем - статическими или
динамическими. Интерес постановщика задач в том, чтобы мы могли легко заменять
библиотеки, касающиеся того или иного конкретного оборудования.
</p>

<p>
[COMMENT:pyub] Я расписал зачем нам нужны динамические библиотеки в данном разделе:
<a href="#sec-5-1-7">Требования к гибкой реализации подключения периферии</a>
</p>

<p>
[COMMENT:aav]
На слое представления динамические библиотеки требуются для устройств и протоколов,
классы коммуникационных устройств будут использоваться всегда и к тому же настолько
малы, что не их не имеет смысла выносить в отдельные файловые сущности вообще.
Таким образом у нас будет 2 типа интерфейса к библиотекам: для устройства и для
кодека протокола. До первого релиза версии АПИ к либам будут меняться очень часто,
что при динамическом связывании потребует частой замены дополнительных файлов на
устройствах и отслеживания их совместимости по API. Кроме того для динамических либ
требуется загрузчик линковщик, который можно всегда дописать позже без проблем.
Таким образом в начале разработки предлагается использовать только статику.
К тому моменту, когда число устройств (то есть либ) станет значительным и, что важнее,
устоится API, то их все можно будет пересобрать в динамику и добавить 2 типа загрузчика
под 2 указанных API.
Кратко: до первого полного релиза и какое-то время после -  статика.
после того, как число устройств станет значительным - динамика.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-9" class="outline-3">
<h3 id="sec-5-9"><span class="section-number-3">5.9</span> <span class="todo WAIT">WAIT</span> Драйвера перифериных устройств&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h3>
<div class="outline-text-3" id="text-5-9">
<p>
[COMMENT:pyub] [TODO:bvl] Что должно быть в этом разделе? Для кого? Чем отличается
от тех разделов, которые ниже и выше?
</p>

<p>
[COMMENT:bvl] - Это про дрова и модули ядра периферии, если они потребуются
</p>
</div>
</div>

<div id="outline-container-sec-5-10" class="outline-3">
<h3 id="sec-5-10"><span class="section-number-3">5.10</span> <span class="todo TODO">TODO</span> Протоколы периферии&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h3>
<div class="outline-text-3" id="text-5-10">
<p>
[TODO:bvl:aav] Что тут предполагается писать?
</p>

<p>
Перекликается с этим:
<a href="#sec-5-3-1-3">Периферийные устройства контроллера и протоколы связи</a>
</p>
</div>
</div>

<div id="outline-container-sec-5-11" class="outline-3">
<h3 id="sec-5-11"><span class="section-number-3">5.11</span> <span class="todo TODO">TODO</span> Описание блока настроек портов подключения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span>&#xa0;<span class="aav">aav</span></span></h3>
<div class="outline-text-3" id="text-5-11">
<p>
[TODO:bvl] [TODO:aav] Подумать как это расписать. Должны быть зависимости настроек
от типов оборудования и понимание, что мы можем перенастроить с правами <code>root</code>, а
что нет. Мне не нравится термин "порт подключени". Т.е. я понимаю, что тут речь об
устройствах, которое общаются данными, а не сигналами, но надо что-то более
конкретное.
</p>

<p>
[COMMENT:aav] - Тройка uart-protocol-device хранится в базе и управляет всем этим.
</p>

<p>
Перезначение COM-портов, скорости и т.п.
</p>
</div>
</div>

<div id="outline-container-sec-5-12" class="outline-3">
<h3 id="sec-5-12"><span class="section-number-3">5.12</span> <span class="todo TODO">TODO</span> Резервирование системы&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h3>
<div class="outline-text-3" id="text-5-12">
<p>
Унификация процесса <code>восстановления после грандфакапа</code> и <code>развертывания системы</code>.
</p>

<p>
[COMMENT:pyub] Также мы обсуждали вопрос бэкапа при обновлении системы и отката при
неудаче.
</p>
</div>
</div>

<div id="outline-container-sec-5-13" class="outline-3">
<h3 id="sec-5-13"><span class="section-number-3">5.13</span> <span class="todo TODO">TODO</span> Web-интерфейс для настройки контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-5-13">
<p>
[TODO:pyub] Верифицировать.
</p>

<p>
Микроконтроллер должен иметь собственный Web-сервер для возможности доступа к его
настройкам через локальную сеть по IP адресу и наличия функции перепрошивки и
обновления программного обеспечения контроллера без физического доступа к нему.
</p>

<p>
Через UI контроллера должна быть реализована настройка доступа пользователей к интерфейсу.
См. распределение <i>роли пользователей системы</i> (<code>root</code> и <code>admin</code> применимо для контроллера).
</p>

<p>
Через UI контроллера должны быть реализованы настройки бизнес-логики контроллера:
</p>
<ul class="org-ul">
<li><i>Настройки администратора из web-интерфейса контроллера</i>
</li>
<li><i>Тестирование и диагностика из web-интерфейса контроллера</i>
</li>
<li><i>Настройки тарификации из web-интерфейса контроллера</i>
</li>
<li>Настройка функционирования торгового оборудовния из web-интерфейса контроллерачы
</li>
</ul>

<p>
Через UI контроллера должны быть реализованы настройки <code>идентификации стойки</code> (контроллера):
</p>
<ul class="org-ul">
<li>установка номера стойки в системе
</li>
<li>установка стевого имени, которым стойка представляется в LAN
</li>
<li>установка значений секторов для стойки - из какого в какой проезжает машина (0 - вне парковки)
</li>
</ul>

<p>
Через UI контроллера для пользователя <code>root</code> должно быть реализовано:
</p>
<ul class="org-ul">
<li>возможность установки, обновления, подключения и отключения библиотек для работы с периферийным оборудованием
</li>
<li>возможность установки, обновлеия, подключения и откючения бибилиотек для работы с дополнительными программными модулями
</li>
<li>настройка удалённого доступа по SSH и удалённого обновления из репозиториев (только для <code>root</code>)
</li>
<li>доступ к SSH через web-интерфейс при закрытом SSH порте
</li>
</ul>

<p>
Через UI контроллера администратор должен получать информацию о аппаратной и программной частях:
</p>
<ul class="org-ul">
<li>уникальный ID или s/n самой платы микрокомпьютера
</li>
<li>версию ядра системы (не ОС, а нашего программного продукта)
</li>
<li>список установленных библиотек, их версий и статуса
</li>
<li>доступ к истории событий контроллера
</li>
</ul>

<p>
Через UI контроллера должны быть реализованы сетевые настройки:
</p>
<ul class="org-ul">
<li>возможность настройки IP адреса, маски, шлюза для дсотупа в LAN
</li>
<li>настройка портов по которым контроллер общается с сервером
</li>
<li>настройка порта на котором находится web-интерфейс
</li>
<li>WAIT включение / отключение широковещательной рассылки (или другой системы,
направленной на автономную работу стоек без сервера)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-14" class="outline-3">
<h3 id="sec-5-14"><span class="section-number-3">5.14</span> Настройка и развертывание ПО контроллера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h3>
<div class="outline-text-3" id="text-5-14">
</div><div id="outline-container-sec-5-14-1" class="outline-4">
<h4 id="sec-5-14-1"><span class="section-number-4">5.14.1</span> <span class="done DONE">DONE</span> Подключение к BBB по ssh&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-14-1">
<p>
Для начала работы с ВВВ нужен только кабель miniUSB - по нему плата и питается, и
коммуницирует. Драйвера скачиваются с
<a href="http://beagleboard.org/static/Drivers/Windows/BONE_D64.exe">http://beagleboard.org/static/Drivers/Windows/BONE_D64.exe</a>, после установки -
подключаем плату к USB. В устройствах появляются Serial port (у меня СОМ3) и новое
сетевое подключение (Linux USB Ethernet/RNDIS Gadget). Для доступа потребуется
PuTTY, либо другая утилита консольного доступа.
</p>

<p>
Для доступа через СОМ-порт: устанавливаем соединение через PuTTY, выбрав нужный СОМ,
выставив скорость 115200, опционально - отключив flow control. Попадаем в консоль,
вводим в качестве логина "root" (без кавычек), пароля не требуется. Вуаля, мы в
консоли.
</p>

<p>
Для доступа по ssh: конфигурируем сетевое подключение, вводим статический адрес
192.168.7.1, маска 255.255.255.0. Теперь мы можем постучаться в ВВВ по ssh, по
адресу 192.168.7.2 (login=root), либо открыть в браузере страничку
<a href="http://192.168.7.2/">http://192.168.7.2/</a>, где крутится справочная страничка на apache2.
</p>

<p>
Для доступа через общий роутер: нужен патч-корд и роутер, умеющий раздавать адреса
по dhcp. Подключаем, перезагружаем ВВВ кнопкой "reset" или командой консоли reboot,
находим присвоенный ВВВ адрес - в логах роутера или в консоли по команде "ifconfig
eth0", далее - возможен доступ по ssh или через браузер. На настоящий момент адрес
10.0.10.114.
</p>

<p>
На порту 3000 (<a href="http://10.0.10.114:3000/">http://10.0.10.114:3000/</a>) развернута IDE Cloud9 с массой интересных
возможностей, есть с чем поиграться.
</p>
</div>
</div>

<div id="outline-container-sec-5-14-2" class="outline-4">
<h4 id="sec-5-14-2"><span class="section-number-4">5.14.2</span> <span class="done DONE">DONE</span> Бэкап при подготовке к работам&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-14-2">
<p>
Во избежание невосстановимого факапа, я скопировал в /root/etc.old /etc целиком.
Вмешиваясь в другие каталоги с настройками я предполагаю поступать так же.
</p>
</div>
</div>

<div id="outline-container-sec-5-14-3" class="outline-4">
<h4 id="sec-5-14-3"><span class="section-number-4">5.14.3</span> <span class="todo TODO">TODO</span> Развертывание рабочей среды из архива&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-14-3">
<p>
[TODO:bvl] Необходимо всю сконфигурированную рабочую среду свести в единый архив или
образ для того, чтобы на всех управляющих платах можно было просто и быстро
развернуть её.
</p>

<p>
[COMMENT:gmm] Нам понадобится поддерживать набор пакетов (source deb например),
чтобы деплой не стал геморроем при изменении отдельных версий чужого ПО. После
пилотника.
</p>

<p>
Всё, что входит в рабочую среду описано в разделе: <a href="#sec-5-6">Рабочая среда</a>
</p>
</div>
</div>

<div id="outline-container-sec-5-14-4" class="outline-4">
<h4 id="sec-5-14-4"><span class="section-number-4">5.14.4</span> <span class="done DONE">DONE</span> Компиляция и запуск HelloWorld&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bvl">bvl</span></span></h4>
<div class="outline-text-4" id="text-5-14-4">
<p>
Простые сишные файлы компилируются по "gcc example.c -o example" и запускаются
"./example"
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5-15" class="outline-3">
<h3 id="sec-5-15"><span class="section-number-3">5.15</span> <span class="todo WAIT">WAIT</span> Оптимизация решения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></h3>
<div class="outline-text-3" id="text-5-15">
<p>
[TODO:pyub] Описать всё, что мы напридумывали про оптимизацию.
</p>
</div>

<div id="outline-container-sec-5-15-1" class="outline-4">
<h4 id="sec-5-15-1"><span class="section-number-4">5.15.1</span> <span class="todo WAIT">WAIT</span> Оптимизация аппаратной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="bda">bda</span>&#xa0;<span class="ske">ske</span></span></h4>
<div class="outline-text-4" id="text-5-15-1">
<p>
[COMMENT:pyub] Важно уменьшение стоимости, уменьшение занимаемой площади и высвобождение дополнительных ног.
[TODO:bda] Разобраться со списком.
</p>

<p>
Возможные шаги
</p>
<ul class="org-ul">
<li>Уменьшить размер ПЗУ на BBB с 4 Гб -&gt; 1 Гб
</li>
<li>Убрать microHDMI
</li>
<li>Заменить USB A на otg (miniUSB)
</li>
<li>Разобраться с разводкой USB: нам нужен один USB (otg) на управляющей плате и вывод двух USB (host) на платы расширения, где могут стоять хабы
</li>
<li>Проработать аппаратную возможность (кнопку) инициирующую загрузку оболваненной платы управления с microSD
</li>
<li>Удлинить гребенку контактов для вывода доп. ног USB
</li>
<li>WAIT Замена на платах расширения I2C конвертеров на ПЛИС
</li>
<li>Все компоненты должны соотвествовать требованиям к конечному изделию [TODO:pyub] Вставить ссылку на требования.
</li>
<li>RTC должно быть на управляющей плате
</li>
<li>Пробивание уменьшения цены за сроки поставки
</li>
<li>Выход на большие партии у непосредственно производителей. Например, <a href="http://www.element14.com/community/search.jspa?q=BeagleBonE+Black">http://www.element14.com/community/search.jspa?q=BeagleBonE+Black</a>
</li>
<li>Есть интересная модификация BBB: <a href="http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/">http://www.mentorel.ru/promyshlennyj-modul-na-zamenu-beaglebone-black/</a>
</li>
<li>Можно ли что-то ещё вытащить из процессора на ноги платы управления
</li>
</ul>

<p>
Важно, чтобы с точки зрения нашего закона наша плата и BBB имели существенные отличия и были просто функциональными аналогами.
По сути мы должны на даташить процессора, а даташит BBB использовать как образцец.
</p>

<p>
По компонентной базе на плате управления можно попробовать:
</p>
<ul class="org-ul">
<li>танталовые конденсаторы <a href="http://www.giricond.ru/">http://www.giricond.ru/</a>
</li>
<li>вместо батарейки RTC можно попробовать ставить ионистор, но удержим мы время только до 2х суток, устроит ли это нас?
проверили тему, но вариант не очень
</li>
<li>предлагается использовать маленькую батарейку CR1025
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-15-2" class="outline-4">
<h4 id="sec-5-15-2"><span class="section-number-4">5.15.2</span> <span class="todo WAIT">WAIT</span> Оптимизация программной части&#xa0;&#xa0;&#xa0;<span class="tag"><span class="all">all</span></span></h4>
<div class="outline-text-4" id="text-5-15-2">
<p>
Возможные шаги:
</p>
<ul class="org-ul">
<li>Обмен через TCP/IP -&gt; FFI
</li>
<li>Статические библиотеки -&gt; Ядро + динамические библиотеки
</li>
<li>Подключение языковых пакетов вместо использования сообщений на дисплеи,
прописанных жёстко в коде
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-5-16" class="outline-3">
<h3 id="sec-5-16"><span class="section-number-3">5.16</span> HOWTO Подключение подтяжек pull-up для GPIO</h3>
<div class="outline-text-3" id="text-5-16">
<p>
Обнаружилось, что на ряде пинов GPIO по умолчанию не включена
подтяжка на + питания. Из-за этого не работало все, как было
задумано, то есть при замыкании с землей, так как  это
подключение является помехоустойчивым.
</p>

<p>
С помощью интерфейса GPIO подтяжками управлять нельзя.
Для этого и для многого другого существует система Device Tree Overlays
<a href="http://www.valvers.com/embedded-linux/beaglebone-black/step04-gpio/">http://www.valvers.com/embedded-linux/beaglebone-black/step04-gpio/</a>
</p>

<p>
  Как подцепить пуллапы на GPIO44 и GPIO45, user-button и car-detector для шлагбаума
в демо
</p>

<p>
cat /sys/kernel/debug/pinctrl/44e10800.pinmux/pins | grep "834"
ответ на эту команду будет содержать код 0х27 (главное 4 бит в нуле это выключенный
пулл-ап)
cat /sys/kernel/debug/pinctrl/44e10800.pinmux/pins | grep "830"
и здесь тоже
</p>

<p>
Наша задача их включить, то есть задать код 0х37.
Делаем это так.
</p>

<ol class="org-ol">
<li>Создать файл с именем VALVERS-IO-00A0.dts (имя обязательно такое)
</li>
</ol>
<p>
Содержимое файла
</p>
<pre class="example">
/dts-v1/;
/plugin/;

/ {
    compatible = "ti,beaglebone", "ti,beaglebone-black";

    part-number = "VALVERS-IO";

    fragment@0 {
        target = &lt;&amp;am33xx_pinmux&gt;;
        __overlay__ {
            valversled: pinmux_valversled {
                pinctrl-single,pins1 = &lt;
                            0x034 0x37
                              &gt;;
                pinctrl-single,pins2 = &lt;
                            0x030 0x37
                              &gt;;
            };
        };
    };

    fragment@1 {
        target = &lt;&amp;ocp&gt;;
        __overlay__ {
            valversled_helper {
                compatible = "bone-pinmux-helper";
                pinctrl-names = "default";
                pinctrl-0 = &lt;&amp;valversled&gt;;
                status = "okay";
            };
        };
    };
};
</pre>

<ol class="org-ol">
<li>Это компиляция
</li>
</ol>
<p>
dtc -O dtb -o VALVERS-IO-00A0.dtbo -b O -@ VALVERS-IO-00A0.dts
</p>

<ol class="org-ol">
<li>Это копирование в бинарные исходники, отсюда идет инсталляция
</li>
</ol>
<p>
cp VALVERS-IO-00A0.dtbo <i>lib/firmware</i>
</p>

<ol class="org-ol">
<li>Это инсталляция.
</li>
</ol>
<p>
echo VALVERS-IO &gt; /sys/devices/bone<sub>capemgr.9</sub>/slots
</p>

<ol class="org-ol">
<li>Это проверка успеха инсталляции
</li>
</ol>
<p>
cat /sys/devices/bone<sub>capemgr.9</sub>/slots
здесь должен появиться ответ
 0: 54:PF&#x2014;
 1: 55:PF&#x2014;
 2: 56:PF&#x2014;
 3: 57:PF&#x2014;
 4: ff:P-O-L Bone-LT-eMMC-2G,00A0,Texas Instrument,BB-BONE-EMMC-2G
 5: ff:P-O-L Bone-Black-HDMI,00A0,Texas Instrument,BB-BONELT-HDMI
11: ff:P-O-L Override Board Name,00A0,Override Manuf,VALVERS-IO
12: ff:P-O-L Override Board Name,00A0,Override Manuf,VALVERS-IO
</p>

<p>
2 строчки вида Override Board Name, значит наш файл встал.
</p>

<ol class="org-ol">
<li>Проверяем факт включения пуллапов
</li>
</ol>
<p>
cat /sys/kernel/debug/pinctrl/44e10800.pinmux/pins | grep "834"
ответ на эту команду теперь будет содержать код 0х37
cat /sys/kernel/debug/pinctrl/44e10800.pinmux/pins | grep "830"
и здесь тоже
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Серверная часть&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span>&#xa0;<span class="pyub">pyub</span></span></h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> <span class="todo TODO">TODO</span> Общие положения&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-6-1">
<p>
Серверную часть необходимо полностью переписать в соответствии со
следующими критериями:
</p>

<ul class="org-ul">
<li>Необходимо отойти от связки php+apache, сервер должен иметь
автономное ядро (бэкэнд, сервер приложений) которое возможно будет
развернуть на платформах ОС семейств Windows или Linux. Выбор
оптимальных средств (языка программирования) с помощью которых
будет реализована данная задача на данный момент является
приоритетной задачей.
</li>

<li>В качестве СУБД предлагается использовать PostgreSQL.
</li>

<li>Все требуемые администратору системы и конечному пользователю
интерфейсы и средства должны быть реализованы в кроссплатформенном
браузерном варианте. Т.е. система должна быть реализована по
принципу "одного окна" (или точнее "всё на одной вкладке
браузера"). В дальнейшем возможно создание клиентских приложений на
замену браузерной реализации, но данная задача не является
приоритетной.
</li>

<li>Сервер должен иметь модульную структуру как по функционалу, так и
по доступным конечным пользователям интерфейсам управления и
администрирования (фёронтэнду). Модули должны подключаться к серверу
в процессе изначальной установки, либо легко подключаться
после. Необходимо предусмотреть возможность инсталляции модулей как
с носителя, так и из сетевого репозитория.
</li>

<li>Ядро сервера и модули должны иметь встроенные средства
защиты. Предполагается использование программного ключа.
Подробнее: <a href="#sec-7-1">Программная лицензионная защита комплекса</a>
</li>

<li>При создании сервера необходимо разработать APIи техническую
документацию для возможности дальнейшей интеграции нашего ПО с
системами СКУД, 1С и т.д.
</li>

<li>Необходима возможность объединения серверов в кластеры,
т.е. несколько локальных серверов на отдельных парковках должны
иметь возможность обмениваться информацией с центральным сервером в
центре управления. Центральный сервер же должен иметь приоритет над
локальными, имея возможность управлять СКД во всём кластере,
тарифами и т.д.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> <span class="todo TODO">TODO</span> Основной функционал сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-6-2">
<p>
В базовом варианте сервер должен иметь собственно ядро, БД и два
основных модуля (интерфейса) - администратора системы и парковщика.
</p>

<p>
Администратор системы должен иметь следующие возможности:
</p>

<ul class="org-ul">
<li>Получать информацию обо всех стойках и терминалах, находящихся в
локальной сети по факту настройки стоек на работу с данным сервером.
</li>

<li>Изменение IP-адресов, ключей шифрования, номеров стоек, управления
секторами, временем, информацией, выводимой на дисплей стоек и
печатаемой на чеках, подключения и удалённого программного
отключения периферийного оборудования на них (торговое
оборудование, светофоры, табло), гибкой настройки логики работы
сенсоров (фотоэлементов, магнитных петель).
</li>

<li>Получение информации агрегируемую сервером со стоек - события
въездов, выездов, оплаты, ошибки и т.п., которая должна писать в лог
и быть доступна для выгрузке по дате в отчёт в формате *.xls.
</li>

<li>Доступ к средствам тестирования работоспособности стоек (аналог
текущего ParkingTest).
</li>

<li>Управление пользователями системы, создание логинов и паролей,
распределение прав доступа к интерфейсам из-под учётных записей и
групп пользователей системы (в том числе и для самого себя).
</li>
</ul>

<p>
Оператор парковки должен иметь следующие возможности:
</p>

<ul class="org-ul">
<li>Открытие и закрытие шлагбаумов, подключённых к стойкам, находящимся
в локальной сети.
</li>

<li>Управление количеством свободных мест на парковке.
</li>

<li>Мониторинг информации, приходящей со стоек (лога) в режиме
реального времени.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> <span class="todo WAIT">WAIT</span> База данных&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> <span class="todo TODO">TODO</span> Web-интерфейс сервера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-6-4">
<p>
Сервер выступает в системе аггрегатором данных и хранилищем общих настроек для всех
стоек и терминалов оплаты систем.
</p>

<p>
Через него можно конфигурировать все стойки, уже подключённые к нему и видимые им:
вместо подключения к каждой стойке отдельно через UI или SSH можно выбрать
устройство в <code>списке стоек</code> на сервере и получить дсотуп к её настройкам из общего
интерфейса.
</p>

<p>
Также в разделе <code>список стоек</code> можно увидеть время последней связи со стойкам и
короткий отчёт об их статусах работы.
</p>

<p>
Роли и права доступа к UI сервера описаны в разделе <i>Роли пользователей системы</i>.
</p>

<p>
В UI сервера частично дублируются настройки бизнес-логики, которые можно сделать на самих стойках
(например, простые настройки тарифов), но при этом настройки выставленные на
сервере автоматически рассылаются на все подключённые к нему стойки (если на них
включено автообновление) в соответствии с установленными параметрами. Например, на
сервере возможно создание тарифной сетки по секторам и тарифы рассылаются стойкам в
зависимотсти от того, к каким секторам они относятся.
</p>

<p>
Кроме каскадирования настроек, через UI сервера должны быть реализованы настройки
дполнительных модулей, требующие наличие единого хранилища данных.
См. <i>Дополнительные аппаратно-програмные модули</i>
</p>
</div>
</div>

<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> <span class="todo WAIT">WAIT</span> Агреггирующий сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
</div>
<div id="outline-container-sec-6-6" class="outline-3">
<h3 id="sec-6-6"><span class="section-number-3">6.6</span> <span class="todo TODO">TODO</span> Дополнительные аппаратно-програмные модули&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-6-6">
<p>
Мы хотим продавать решение разным людям за разные деньги. Обосновать это им можно
только предоставляя разные версии функционала.
</p>

<p>
Дополнительные модули должны подключаться к системе по запросу клиента в тех или
иных сочетаниях. При этом, каждый из этих установленных модулей подключается
администратором системы конкретному пользователю (группе пользователей). Это
позволяет сегментировать стоимость решения по цене.
</p>
</div>

<div id="outline-container-sec-6-6-1" class="outline-4">
<h4 id="sec-6-6-1"><span class="section-number-4">6.6.1</span> <span class="todo TODO">TODO</span> Модуль платной парковки&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-1">
<p>
Добавляет возможность работы с оплатой парковочного времени и управляет тарифами на
парковке.
</p>

<p>
В системы добавляется интерфейс администратор тарифов, с помощью которого можно
изменять почасовую стоимость пребывания на парковке, бесплатное время пребывания на
парковке, время бесплатного выезда с парковки после оплаты услуг и т.д.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-2" class="outline-4">
<h4 id="sec-6-6-2"><span class="section-number-4">6.6.2</span> <span class="todo TODO">TODO</span> Модуль СКУД&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-2">
<p>
Добавляет возможность работы с бесконтактными картами доступа в безусловном режиме
разрешения / запрета въезда.
</p>

<p>
В систему добавляется интерфейс администратора СКУД, который позволяет заводить в
систему карты доступа по их индивидуальному номеру, вводить информацию о владельцах
карт (ФИО, гос. номер транспортного средства и т.п.), распределять карты по
различным группам доступа.
</p>

<p>
Группы доступа могут иметь различные права по времени возможного въезда/выезда с
парковки, по посещению тех или иных секторов парковки, а также иметь численное
ограничение количества въездов (т.е. карт выдано в группе 10, но данной группе на
парковке принадлежит только 5 мест и одновременно на парковке / в секторе парковки
может находиться только 5 машин).
</p>

<p>
Карты доступа могут временно блокироваться, переноситься в архивные и окончательно
удаляться администратором. Если установлены другие модули, работающие с б/к
картами, администратор может изменять тип карт с одного на другой (абонемент,
дебетовая).
</p>

<p>
У оператора парковки при подключённом модуле СКУД в логе добавляются сообщения о
въездах и выездах по картам. Также добавляется интерфейс аудитора СКУД, который
позволяет пользователю с данными правами получить доступ к информации о картах
доступа, но не даёт возможности её изменять.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-3" class="outline-4">
<h4 id="sec-6-6-3"><span class="section-number-4">6.6.3</span> <span class="todo WAIT">WAIT</span> Модуль для работы с абонементами&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-3">
<p>
Добавляет возможность работы с бесконтактными картами в режиме оплаты услуг
парковки владельцем карты на заданный срок - т.е. оплата на фиксированную сумму
производится один раз в установленный срок.
</p>

<p>
В систему добавляется интерфейс администратора абонементных карт,позволяющий
заводить в систему абонементные карты по их индивидуальному номеру, вводить
информацию о владельцах карт (ФИО, гос. номер транспортного средства, номер
договора на предоставление услуг и т.п.), распределять карты по различным группам
доступа и тарифными группам.
</p>

<p>
Группы доступа используются те же, что и в модуле СКУД.
</p>

<p>
Абонементные карты могут временно блокироваться, переноситься в архивные и
окончательно удаляться администратором.
</p>

<p>
Если установлены другие модули, работающие с б/к картами, администратор может
изменять тип карт с одного на другой (СКУД, дебетовая).
</p>

<p>
В интерфейс администратора тарифов добавляется возможность работы с тарифными
группами, сроками и стоимостью оплаты для абонементов.
</p>

<p>
У оператора парковки, при подключённом модуле работы с абонементами, в логе
добавляются сообщения о въездах и выездах по картам и сроке действия карт.
</p>

<p>
Также добавляется интерфейс аудитора абонементных карт, который позволяет
пользователю с данными правами получить доступ к информации об абонементных картах
и сроках оплаты клиентом услуг, но не даёт возможности её изменять.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-4" class="outline-4">
<h4 id="sec-6-6-4"><span class="section-number-4">6.6.4</span> <span class="todo WAIT">WAIT</span> Модуль для работы по дебетовым картам&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-4">
<p>
Добавляет возможность работы с бесконтактными картами в режиме оплаты услуг
парковки владельцем карты по специальному тарифу - т.е. он кладёт деньги на карту
через кассу, сумма фиксируется в платёжной системе парковки и далее деньги
списываются с него исходя из времени пребывания на парковке при выездах, но по
особым тарифам.
</p>

<p>
В систему добавляется интерфейс администратора дебетовых карт,позволяющий заводить
в систему дебетовые карты по их индивидуальному номеру, вводить информацию о
владельцах карт (ФИО, гос. номер транспортного средства, номер договора на
предоставление услуг и т.п.), распределять карты по различным группам доступа и
тарифными группам.
</p>

<p>
Группы доступа используются те же, что и в модуле СКУД.
</p>

<p>
Дебетовые карты могут временно блокироваться, переноситься в архивные и
окончательно удаляться администратором.
</p>

<p>
Если установлены другие модули, работающие с б/к картами, администратор может
изменять тип карт с одного на другой (СКУД, абонементная).
</p>

<p>
В интерфейс администратора тарифов добавляется возможность работы с тарифными
группами и стоимостью времени пребывания на парковке для дебетовых карт.
</p>

<p>
У оператора парковки, при подключённом модуле работы с дебетовыми картами, в логе
добавляются сообщения о въездах и выездах по картам и списанных со счёта средствах.
</p>

<p>
Также добавляется интерфейс аудитора дебетовых карт, который позволяет пользователю
с данными правами получить доступ к информации о дебетовых картах, состоянии счёта
клиента и тарифном плане, но не даёт возможности ничего изменять.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-5" class="outline-4">
<h4 id="sec-6-6-5"><span class="section-number-4">6.6.5</span> <span class="todo WAIT">WAIT</span> Модуль акцептирования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-5">
<p>
Добавляет в систему возможность обнуления требующего оплаты билета со штриховым
кодом через интерфейсную оболочку.
</p>

<p>
В систему добавляется интерфейс акцептирования билета в котором пользователь может
ввести в специальное поле номер билета (или считать номер сканером штрих-кода) и
произвести либо безусловное акцептирование - сделать билет бесплатным для выезда
навсегда изменив информацию о нём на сервере и выездных стойках, либо
акцептирование на выезде- у клиента будет возможность покинуть парковку в течении
бесплатного времени после акцептирования, либо акцептирование по тарифу - данному
билету присваивается специальный тариф (используется список тарифов дебетового
режима) и стоимость пребывания на парковке пересчитывается исходя из него.
</p>

<p>
При акцептировании пользователь вводит комментарий, в котором пишется причина
акцептирования.
</p>

<p>
Вся информация о проведённых акцептированиях билетов (пользователь, номер билета,
время акцептирования, сумма акцептирования) пишется в лог и доступна для
ознакомления в интерфейсе аудитора акцептирования.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-6" class="outline-4">
<h4 id="sec-6-6-6"><span class="section-number-4">6.6.6</span> <span class="todo WAIT">WAIT</span> Модуль арендаторов&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-6">
<p>
Добавляет в систему возможность обнуления требующего оплаты билета со штриховым
кодом на кассах, стойках информации или через интерфейсную оболочку с помощью карты
арендатора с последующим списанием обнулённой суммы на счёт владельца карты.
</p>

<p>
В систему добавляется интерфейс администрирования арендаторов, в котором можно
создавать пользователей - "арендаторов" и привязывать их бесконтактным картам и
основным пользователям системы.
</p>

<p>
Каждому арендатору выдаётся своя бесконтактная карта, для которой в системе
администратором установлен режим акцептирования (режимы перечислены в описании
модуля акцептирования, для дебетового режима устанавливается тариф).
</p>

<p>
С помощью этой карты арендатор может акцептировать билет клиента, приложив сначала
билет, а затем карту к стойке информации, кассе или введя номер билета на ПК, а
затем приложив карту к считывателю на ПК. После этого клиент покидает парковку в
соответствии с правилами акцептирования, а акцептированная сумма переводится на
"овердрафтовый счёт" данного арендатора в системе.
</p>

<p>
Все данные по этому счёту отображаются в интерфейсе счета арендаторов. Через этот
интерфейс можно либо списать сумму, которую должен арендатор, либо распечатать
чек через фискальный регистратор, подключённый к ПК, либо выгрузить форму счёта на оплату в
банке.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-7" class="outline-4">
<h4 id="sec-6-6-7"><span class="section-number-4">6.6.7</span> <span class="todo TODO">TODO</span> Модуль кассира&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-7">
<p>
Добавляет в систему возможность оплаты услуг парковки через ручную кассу на базе ПК
к которому подключён фискальный регистратор и, опционально, денежный ящик и сканер штриховых кодов.
</p>

<p>
В систему добавляются интерфейсы кассир и кассир - парковщик. В интерфейсе кассира
пользователь может провести процедуру оплаты билета - вбить его номер (или считать
номер сканером штрих-кода), выбрать тариф оплаты, принять сумму к оплает и
распечатать выездной фискальный чек с суммой, рассчитанной системой исходя из
времени и тарифа.
</p>

<p>
При этом приём денег и выдача сдачи осуществляется непосредственно человеком.
</p>

<p>
Кассир-парковщик имеет интерфейс оплаты совмещённый с интерфейсом обычного
оператора парковки в котором есть возможность открытия и закрытия шлагбаума, доступ
к логу и т.п.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-8" class="outline-4">
<h4 id="sec-6-6-8"><span class="section-number-4">6.6.8</span> <span class="todo WAIT">WAIT</span> Модуль бухгалтера&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-8">
<p>
Добавляет в систему возможность получения финансовых отчётов по парковке и кассовым
аппаратам (нарастающий итог, оборот по кассам и т.п.), а также делает возможным
автоматическое снятие Z-отчётов, печать копий Z-отчётов, изъятие установленной
суммы из автоматической кассы и т.д.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-9" class="outline-4">
<h4 id="sec-6-6-9"><span class="section-number-4">6.6.9</span> <span class="todo WAIT">WAIT</span> Модуль фотофиксации&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-6-9">
<p>
Добавляет в систему фотографирования камерами по событию.
</p>

<p>
В интерфейсе администратора системы добавляется функция привязки камеры к
конкретной стойке и список событий, производимых со стойкой, по которым камера
должна производить фотографирование.
</p>

<p>
Во все логи, в том числе и у оператора парковки, к сообщениям о данных событиях
прикрепляются фотографии.
</p>

<p>
Также добавляются интерфейсы машины на парковке и аудиторфотофиксации в которых
можно посмотреть фотографии всех машин, которые приехали на парковку и находятся на
ней и, соответственно, приехали и уехали с парковки в установленный промежуток
времени.
</p>
</div>
</div>

<div id="outline-container-sec-6-6-10" class="outline-4">
<h4 id="sec-6-6-10"><span class="section-number-4">6.6.10</span> <span class="todo WAIT">WAIT</span> Модуль распознания номеров&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-6-11" class="outline-4">
<h4 id="sec-6-6-11"><span class="section-number-4">6.6.11</span> <span class="todo TODO">TODO</span> Модуль дуплексной IP связи&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="bvl">bvl</span>&#xa0;<span class="gmm">gmm</span></span></h4>
<div class="outline-text-4" id="text-6-6-11">
<p>
Интеграция с SIP сервером VoIP связи Asterisk
</p>

<p>
Работа аудио-оборудования со стороны контроллера пока описана здесь:
<a href="#sec-5-3-4">Аудио оборудование</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6-7" class="outline-3">
<h3 id="sec-6-7"><span class="section-number-3">6.7</span> <span class="todo WAIT">WAIT</span> Интеграция со сторонними решениями&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-6-7">
</div><div id="outline-container-sec-6-7-1" class="outline-4">
<h4 id="sec-6-7-1"><span class="section-number-4">6.7.1</span> <span class="todo WAIT">WAIT</span> Выгрузка данных в 1С&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-7-2" class="outline-4">
<h4 id="sec-6-7-2"><span class="section-number-4">6.7.2</span> <span class="todo WAIT">WAIT</span> Интеграция с 1С&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-7-3" class="outline-4">
<h4 id="sec-6-7-3"><span class="section-number-4">6.7.3</span> <span class="todo WAIT">WAIT</span> Интеграция со сторонним биллингом&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-7-3">
<p>
Интеграция с системами биллинга платёжных терминалов.
</p>
</div>
</div>

<div id="outline-container-sec-6-7-4" class="outline-4">
<h4 id="sec-6-7-4"><span class="section-number-4">6.7.4</span> <span class="todo WAIT">WAIT</span> Интеграция с NOW!&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-7-5" class="outline-4">
<h4 id="sec-6-7-5"><span class="section-number-4">6.7.5</span> <span class="todo WAIT">WAIT</span> Интеграция с SOLVO&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
</div>
<div id="outline-container-sec-6-7-6" class="outline-4">
<h4 id="sec-6-7-6"><span class="section-number-4">6.7.6</span> <span class="todo WAIT">WAIT</span> API для создания библиотек&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h4>
<div class="outline-text-4" id="text-6-7-6">
<p>
Ориентирование системы на написание библиотек периферии сторонними разработчиками
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Использование алгоритмов шифрования&#xa0;&#xa0;&#xa0;<span class="tag"><span class="gmm">gmm</span></span></h2>
<div class="outline-text-2" id="text-7">
<p>
[COMMENT:gmm] Для шифрования всех данных предлагается использовать общеавтоматое
шифрование вместе с ассимитричным распределением ключей
Общий принцип описан в документе: /asp/pdf/crypt-fsm.pdf
</p>

<p>
Следующий функционал АСПП использует уникальный ключ шифрования:
</p>
<ul class="org-ul">
<li>стойки устанавливают соединение друг с другом и сервера по Ethernet
</li>
<li>агрегирующий сервер подцепляет сервера нижнего уровня
</li>
<li>штрих-код начинает печататься не в открытом формате, а с использованием ключа
шифрования
</li>
<li>сканер штрихкодов считывает билет только при наличии идентичного ключа
</li>
<li>считыватели / программаторы Mifare+ использует код для работы с картами
</li>
<li>сервер узнаёт о том, какие на него возможно доустановить модули из репозитория
</li>
<li>сервер узнаёт о том, с каким комплектом стоек он должен общаться
</li>
<li>оператор-кассир может работать со своего ПК с системой
</li>
</ul>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Программная лицензионная защита комплекса&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span>&#xa0;<span class="gmm">gmm</span></span></h3>
<div class="outline-text-3" id="text-7-1">
<p>
[COMMENT:pyub] [TODO:gmm:aav:bda] Если кто-то из вас работал с чем-то подобным -
напишите об этом комментарий ниже. Нам бы крайне не хотелось использовать при
создании системы защиты какие-то платные решения (HASP, RuToken ключи или
криптозащиту через КриптоПро или аналоги), но при этом нужно максимально защититься
от возможности создания генератора ключей / сертификатов продвинутыми программистами
с целью обхода защиты.
</p>

<p>
Весь комплекс АСПП должен иметь гибкую систему управления лицензиями на оборудование
и программное обеспечение.
</p>

<p>
Конечный покупатель приобретает у производителя комплект оборудования с определённым
функционалом и программными возможностями: это и определённыйкомплект периферийного
оборудования на стойках, и определённые модули подключённые к серверу, и
фиксированное количество стоек, касс и ПК кассиров в системе. Проектируя систему
необходимо реализовать механизм, который будет ограничивать возможность покупателя
самостоятельно включать модули и функицонал, не предусмотренный поставкой.
</p>

<p>
Также система лицензирования должна нести в себе информацию об уникальности данного
комплекта: уникальные ключи шифрования штриховых кодов, RFID и сетевого траффика на
конкретной парковке.
</p>

<p>
Реализация такой лицензии предлагается путём создания текстового блока информации или
подписанного производителем сертификата, который загружается через web-интерфейс во все
рабочие узлы парковки (на контроллеры, на сервер, на ПК на котором работают с
кассой).
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Глоссарий</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Датчик</h3>
<div class="outline-text-3" id="text-8-1">
<p>
<code>Датчик</code> это внешнее периферийное устройство или его часть, предназначенное для
сбора данных и выработки на их основе <code>сигналов</code>.
</p>

<p>
Мы используем следующие виды датчиков:
</p>
</div>

<div id="outline-container-sec-8-1-1" class="outline-4">
<h4 id="sec-8-1-1"><span class="section-number-4">8.1.1</span> Датчик присутствия автомобиля</h4>
<div class="outline-text-4" id="text-8-1-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Датчик присутствия автомобиля</caption>

<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">выход</td>
<td class="left">сухой контакт</td>
</tr>
</tbody>
</table>

<p>
Устройство, отслеживающее наличие объекта, соответствующего по установленным
характеристикам автомобиля (петля индуктивности, датчик магнитного поля,
фотоэлемент безопасности)
</p>
</div>
</div>

<div id="outline-container-sec-8-1-2" class="outline-4">
<h4 id="sec-8-1-2"><span class="section-number-4">8.1.2</span> Датчик безопасности</h4>
<div class="outline-text-4" id="text-8-1-2">
<p>
Устройство, отслеживающее наличие любого объекта в зоне или на линии контроля
(фотоэлемент безопасности)
</p>
</div>
</div>

<div id="outline-container-sec-8-1-3" class="outline-4">
<h4 id="sec-8-1-3"><span class="section-number-4">8.1.3</span> Датчик контроля состояния стрелы шлагбаума</h4>
<div class="outline-text-4" id="text-8-1-3">
<p>
Часть конструкции автоматичекого шлагбаума, отслеживающая состояние
открытия/закрытия стрелы шлагбаума (концевики или релейная развязка)
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Сигнал</h3>
<div class="outline-text-3" id="text-8-2">
<p>
<code>Сигнал</code> - это то, что поступает на контроллер с периферийного датчика или что мы
шлем, чтобы включить лампочку, т.е. это замыкание реле и принимаемая на GPIO простая
логика (0 или 1) .
</p>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Событие</h3>
<div class="outline-text-3" id="text-8-3">
<p>
<code>Событие</code> - это то, что внезапно произошло и на что надо отреагировать (обработать
событие). Сигнал может спровоцировать возникновение события. События обрабатываются
синхронно. Как правило, обработка события приводит к посылке одного или нескольких
сообщений.
</p>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> Сообщение</h3>
<div class="outline-text-3" id="text-8-4">
<p>
<code>Сообщение</code> - это то, что контроллеры и некоторые периферийные устройства шлют друг
другу, серверу и пользователю. Сообщения обрабатываются асинхронно.
</p>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> Состояние</h3>
<div class="outline-text-3" id="text-8-5">
<p>
<code>Состояние</code> определяет реакции на сообщения - к примеру, когда пользователь нажимает
на кнопку стойки - реакция разная, в зависимости от того в каком состоянии находится
стойка. Переходы из одного состояния в другое производятся при обработке сообщений.
</p>
</div>
</div>

<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6"><span class="section-number-3">8.6</span> Процедура</h3>
<div class="outline-text-3" id="text-8-6">
<p>
<code>Процедура</code> - это последовательность взаимодействий элементов системы включая
пользователей и операторов для достижения результата (цели процедуры).
</p>
</div>
</div>

<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7"><span class="section-number-3">8.7</span> <span class="todo TODO">TODO</span> Стойка&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-7">
<p>
<code>Стойка</code> - это корпус устройства в который собирается вся периферия и контроллер.
</p>

<p>
Стойки бывают:
</p>
<ul class="org-ul">
<li><code>въезда</code> - стойки устанавлеваемые на въезде, характеризуются возможностью выдавать
билеты(или mifare карты), управлять шлагбаумом.
</li>
<li><code>выезда</code> - стойки устанавлеваемые на выезде, характеризуются возможностью
сканировать билеты(или принимать mifare карты), управлять шлагбаумом.
</li>
<li><code>проезда</code> - стойки устанавлеваемые на территори характеризуются возможностью сканировать
билеты (или mifare/em-marine карты), управлять шлагбаумом, регулировать работу зон
парковки.
</li>
<li><code>оплаты</code> - стойка с функционалом <code>кассы</code>, устанавливаемая на территори парковки, характеризуемая
возможностью сканировать билеты (или mifare/em-marine карты), принимать оплату и
печатать фискальный чек.
</li>
<li><code>оплаты совмещенная с въездом</code> - это стойка с функционалом <code>кассы</code>, устанавливаемая
на въезд на парковку, характеризуемая возможностью выдачи билетов (mifare карт),
приёма оплаты, печатати фискального чека и управления шлагбаумом.
</li>
<li><code>оплата совмещенная с выездом</code> - это стойка с функционалом <code>кассы</code>, устанавливаемая
на выезде с парковки, характеризуемая возможность сканирования билетов (приёма mifare карт),
приёма оплаты, печатати фискального чека и управления шлагбаумом.
</li>
<li><code>СКУД</code> - стойки устанавлеваемые на территори/въезде/выезде парковки,
характеризуются возможностью сканировать mifare/em-marine карты), управлять
шлагбаумом.
</li>
<li><code>информации</code> - стойки устанавливаемые на территори парковки, характеризуются
возможностью сканировать билеты (или mifare карты), выводить на дисплей данные по
ним и различные проводить операции со временем или внутренним счетом билета
(карты)
</li>
</ul>

<p>
У стойки есть:
</p>

<p>
[TODO:pyub] - Здесь надо перечислить все данные, которые мы храним по
стойке. Имеются ввиду данные связанные с местом проезда. Может быть этому не место в
глоссарии, но эти данные мне нужны сейчас чтобы построить модель стойки, если что -
перенести не проблема. Добавь их плиз в таблицу ниже:
</p>

<table id="checkpoint_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Данные стойки</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">никнейм стойки (номер)</td>
</tr>
</tbody>
</table>

<p>
s/n контроллера который мы загружаем
номер сектора
</p>
</div>
</div>

<div id="outline-container-sec-8-8" class="outline-3">
<h3 id="sec-8-8"><span class="section-number-3">8.8</span> Периферийные устройства</h3>
<div class="outline-text-3" id="text-8-8">
<p>
<code>Периферийные устройства</code> - это устройства подключаемые к контроллеру парковки,
получающие от него и отсылающие ему <code>сигналы</code> или <code>сообщения</code>.
</p>

<p>
Периферийные устройства бывают:
</p>
</div>

<div id="outline-container-sec-8-8-1" class="outline-4">
<h4 id="sec-8-8-1"><span class="section-number-4">8.8.1</span> Внутренние</h4>
<div class="outline-text-4" id="text-8-8-1">
<p>
<code>внутренние</code> - устройства подключаемые к контроллеру парковки, характеризуемые
расположением внутри стойки
</p>
</div>
</div>
<div id="outline-container-sec-8-8-2" class="outline-4">
<h4 id="sec-8-8-2"><span class="section-number-4">8.8.2</span> Внешние</h4>
<div class="outline-text-4" id="text-8-8-2">
<p>
<code>внешние</code> - устройства подключаемые к контроллеру парковки, характеризуемые
расположением вне стойки стойки
</p>
</div>
</div>
<div id="outline-container-sec-8-8-3" class="outline-4">
<h4 id="sec-8-8-3"><span class="section-number-4">8.8.3</span> Торговые</h4>
<div class="outline-text-4" id="text-8-8-3">
<p>
<code>торговые</code> - любое устройство, подключаемое к контроллеру парковки или ПК,
работающее с деньгами (монеты/купюры/банковские карты)
</p>
</div>
</div>
<div id="outline-container-sec-8-8-4" class="outline-4">
<h4 id="sec-8-8-4"><span class="section-number-4">8.8.4</span> Опрашиваемые</h4>
<div class="outline-text-4" id="text-8-8-4">
<p>
<code>опрашиваемые</code> - устройство, статус которого постоянно проверяется системой и при выходе
из строя которого так или иначе изменяется функционал и принцип работы системы
</p>
</div>
</div>
<div id="outline-container-sec-8-8-5" class="outline-4">
<h4 id="sec-8-8-5"><span class="section-number-4">8.8.5</span> Критичные</h4>
<div class="outline-text-4" id="text-8-8-5">
<p>
<code>критичное для работы</code> - частный случай опрашиваемого устройства, при выходе из строя
которого стойка автоматически уходит в состояние "Заблокирована"
</p>
</div>
</div>
</div>

<div id="outline-container-sec-8-9" class="outline-3">
<h3 id="sec-8-9"><span class="section-number-3">8.9</span> Касса</h3>
<div class="outline-text-3" id="text-8-9">
<p>
<code>Касса</code> (или <code>платежный терминал</code>) - это комплекс устройств (возможно - стойка)
обеспечивающих оплату пребывания посетителя на парковки и дополнительных услуг.
</p>

<ul class="org-ul">
<li><code>автоматическая касса</code> - это <code>стойка</code> устанавливаемая на территории парковки,
обепечиает полностью автоматизированный цикл оплаты пользователем услуг парковки.
</li>

<li><code>автоматическая каасса совмещенная с въездом</code> - это то же, что  <code>стойка оплаты совмещённая с въездом</code>.
</li>

<li><code>автоматическая касса совмещенная с выездом</code>  - это то же, что  <code>стойка оплаты совмещённая с выездом</code>.
</li>

<li><code>ручная касса</code> - это имеющее собственный корпус устроство под управлением
<code>контроллера</code> с встроенным в него сканером штрих-кодов (считыватель карт
em-marine/mifare), денежным ящиком и фискальным регистратором. Все операции
получения денег и выдачи сдачи производит оператор (кассир) без автоматизирующего
процесс торгового оборудования.
</li>

<li><code>касса на базе ПК</code> - это настольный персональный компьютер с подключенными к нему
настольными сканером штрих-кодов (считыватель карт em-marine/mifare), денежный
ящик и фискальный регистратор. Все операции получения денег и выдачи сдачи
производит оператор (кассир) без автоматизирующего процесс торгового оборудования.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-10" class="outline-3">
<h3 id="sec-8-10"><span class="section-number-3">8.10</span> Проездной документ</h3>
<div class="outline-text-3" id="text-8-10">
<p>
Это носитель информации, выдаваемый посетителю парковки, на котором находится (в
т.ч. шифруется) информация о времени и терминале въезда на парковку, а также данные,
необходимые для автономного функционированния парковки и реализации различных
механизмов монетизации.
</p>

<p>
Проездные билеты можно разделить типам (одноразовый/многоразовый), по материалам из
которых они сделаны, по категориям (вьездной/выездной), по статусам, связанным с
оплатой:
</p>

<p>
Типы:
</p>
<ul class="org-ul">
<li><code>одноразовый</code> - единоразово создаваемый и выдаваемый клиенту носитель информации,
который несёт на себе информацию о времени въезда и терминале въезда
</li>
<li><code>многоразовый</code> - многоразово используемый проездной документ, с помощью которого
посетитель паркови может посещать её не пользуясь одноразовыми въездными билетами=
</li>
</ul>

<p>
Материалы:
</p>
<ul class="org-ul">
<li><code>бумажный</code> - напечатанный на термобумаге или картоне, информация зашифрована в
штриховом коде
</li>
<li><code>пластиковый</code> - карта стандарта EM-Marine или Mifare, информация зашифрована на
чипе карты
</li>
</ul>

<p>
Категории:
</p>
<ul class="org-ul">
<li><code>въездной</code> - разновидность билета получаемого при въезде на парковку
</li>
<li><code>выездной</code> - разновидность билета получаемого (или перведенимого в данный статус из
въездного) при оплате парковки, как правило совмещён с фискальным чеком
</li>
</ul>

<p>
Статусы:
</p>
<ul class="org-ul">
<li><code>с бесплатным временем</code> - билет на котором еще не закончеллось бесплатное время
стоянки
</li>
<li><code>неоплаченный</code> - билет на котором закончелось бесплатное время и началось платное
время стоянки
</li>
<li><code>оплаченный</code> - билет по которому была произведена оплата
</li>
<li><code>использованный</code> - билет который уже использовали для выезда с парковки
</li>
<li><code>фискальный чек</code> - документ выдаваеммый кассой при проведении операции оплаты, может
быть сомещен с оплаченным билетом при использовании бумажных носителей
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-11" class="outline-3">
<h3 id="sec-8-11"><span class="section-number-3">8.11</span> Контроллер</h3>
<div class="outline-text-3" id="text-8-11">
<p>
Это устройство, контролирующее работу ряда периферийных элементов автоматизированной
парковки, регламентирующее работу стоек системы парковки и всех подключенных
периферийных устройств. Контроллер устанавливется в стойках.
</p>
</div>
</div>

<div id="outline-container-sec-8-12" class="outline-3">
<h3 id="sec-8-12"><span class="section-number-3">8.12</span> Системы навигациии</h3>
<div class="outline-text-3" id="text-8-12">
<p>
Контроллер, регламентирующий работу устройств, входящих в систему навигации и учёта
сводных мест с помощью УДПА (Ультразвуковой Датчик Присутствия Автомобиля)
</p>
</div>
</div>

<div id="outline-container-sec-8-13" class="outline-3">
<h3 id="sec-8-13"><span class="section-number-3">8.13</span> <span class="todo TODO">TODO</span> Сервер&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-13">
<p>
Сервера бывают:
</p>
<ul class="org-ul">
<li><code>парковочной системы</code>
</li>
<li><code>агрегирующий</code>
</li>
<li><code>сторонний</code>
</li>
<li><code>навигационной системы</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-14" class="outline-3">
<h3 id="sec-8-14"><span class="section-number-3">8.14</span> Время</h3>
<div class="outline-text-3" id="text-8-14">
<p>
Время - это промежуток времени установленный в ситеме (следовательно и внесенный на
носитель информации - билет)
</p>

<p>
Время бывает:
</p>
<ul class="org-ul">
<li><code>бесплатное</code> - промежуток в течении которого посетитель парковки может
беспрепятственно выехать по текущему носителю информации
</li>
<li><code>платное</code> - промежуток в течении которого начисляется оплата согласно тарифам
парковки
</li>
<li><code>оплаченное</code> - промежуток платного времени который оплатил посетитель
</li>
<li><code>на выезд</code> - промежуток бесплатного времени начисленный на носитель информации
после оплаты платного времени, начинаестся сразу после превода платного в
оплаченное время.
</li>
<li><code>акцептированное</code> - промежуток дополнительного бесплатного времени начисленный на
носитель информации, учитывается при расчете платного времени.
</li>
<li><code>сверх оплаченного</code> - промежуток платного времени начинающийся после окончания
времни на выезд.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-15" class="outline-3">
<h3 id="sec-8-15"><span class="section-number-3">8.15</span> Группы</h3>
<div class="outline-text-3" id="text-8-15">
<p>
Группы - это группа стоек и перифериного оборудования устанавлваемого в точке
проезда автомобиля или прохода посетителя.
</p>

<p>
Группы бывают:
</p>
<ul class="org-ul">
<li><code>въездная</code> - характеризуется установкой на въездах на территорию парковки
</li>
<li><code>выездная</code> - характеризуется установкой на выездах с территории парковки
</li>
<li><code>проездная</code> - характеризуется установкой на переездах  на территорию парковки
</li>
<li><code>реверсивная</code> - характеризуется установкой на реверсивных проездах (въезд и выезд по
одной полосе) может быть одновременно и проездной
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-16" class="outline-3">
<h3 id="sec-8-16"><span class="section-number-3">8.16</span> Парковка</h3>
<div class="outline-text-3" id="text-8-16">
<p>
<code>Территория парковки (парковка)</code> - комплекс инфраструктурных и дорожных объектов
являющаяся отдельной территорией и оснащаемым АСПП.
</p>

<p>
Территория парковки делится на сегменты согласно ряду признаков:
</p>
<ul class="org-ul">
<li><code>сектор</code> - физический сегмент парковки, применим в системе подсчета свободных мест
и/или ограничении типа проезжаемых автомабилий в данный сегмент.
</li>
<li><code>тарифные зоны</code> - логический сегмент парковки, применим при описании различных
тарифов в зависимости от фактического места и времени стоянки и/или проезда автомобиля.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-17" class="outline-3">
<h3 id="sec-8-17"><span class="section-number-3">8.17</span> <span class="todo TODO">TODO</span> Посетитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-17">
<p>
Посетитель - это водитель автомобиля посетившего парковку.
</p>

<ul class="org-ul">
<li><code>разовый</code> - водитель, однократно вопользовавшийся услугой парковки и использующий
одноразовые идентификатор. [TODO:pyub] - Ссылка на определение одноразового
идентификатора
</li>
<li><code>постоянный</code> - водитель многократно и неограниченно пользующийся услугой парковки
и использущий многоразовый идентификатор запрограммированный на определённый
тип предотсвляемых услуг
</li>
<li><code>с картой доступа</code>
</li>
<li><code>с абонементом</code> -водитель многократно и неогранниченно пользующийся услугой парковк
и использущий многоразовый носитель информации, и ежемесячно оплачивающий эти услуги
через АСПП внося на внутренний счет носителя.
</li>
<li><code>с картой предоплаты</code> -водитель многократно пользующийся услугой парковк и
использущий многоразовый носитель информации, оплачивающий фактической время
пребывания со внутреннего счета носителя информации, и пополняющий его через АСПП
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-18" class="outline-3">
<h3 id="sec-8-18"><span class="section-number-3">8.18</span> <span class="todo TODO">TODO</span> Деление парковкочных мест&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-18">
<ul class="org-ul">
<li><code>линия</code>
</li>
<li><code>объём</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-19" class="outline-3">
<h3 id="sec-8-19"><span class="section-number-3">8.19</span> <span class="todo TODO">TODO</span> Тариф&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-19">
<ul class="org-ul">
<li><code>типы проездов через шл</code>
</li>
<li><code>периферия стоек внешняя</code>
</li>
<li><code>внутренний счет</code>
</li>
<li><code>мифаре</code>
</li>
<li><code>емарине</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8-20" class="outline-3">
<h3 id="sec-8-20"><span class="section-number-3">8.20</span> <span class="todo TODO">TODO</span> Роли&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-8-21" class="outline-3">
<h3 id="sec-8-21"><span class="section-number-3">8.21</span> <span class="todo TODO">TODO</span> Внешний носитель&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-8-22" class="outline-3">
<h3 id="sec-8-22"><span class="section-number-3">8.22</span> <span class="todo TODO">TODO</span> УДПА&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-8-23" class="outline-3">
<h3 id="sec-8-23"><span class="section-number-3">8.23</span> <span class="todo TODO">TODO</span> Процесс&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-8-24" class="outline-3">
<h3 id="sec-8-24"><span class="section-number-3">8.24</span> <span class="todo TODO">TODO</span> Рампа&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-24">
<p>
Когда шлагбаум располагается после стойки и после-после стойки
</p>
</div>
</div>
<div id="outline-container-sec-8-25" class="outline-3">
<h3 id="sec-8-25"><span class="section-number-3">8.25</span> <span class="todo TODO">TODO</span> Шлюз&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
<div class="outline-text-3" id="text-8-25">
<p>
Когда шлагбаум располагается до стойки и после стойки
</p>
</div>
</div>
<div id="outline-container-sec-8-26" class="outline-3">
<h3 id="sec-8-26"><span class="section-number-3">8.26</span> <span class="todo TODO">TODO</span> Реверсивный проезд&#xa0;&#xa0;&#xa0;<span class="tag"><span class="pyub">pyub</span></span></h3>
</div>
<div id="outline-container-sec-8-27" class="outline-3">
<h3 id="sec-8-27"><span class="section-number-3">8.27</span> <span class="done DONE">DONE</span> Глоссарий архитектуры&#xa0;&#xa0;&#xa0;<span class="tag"><span class="man">man</span></span></h3>
<div class="outline-text-3" id="text-8-27">
<p>
[COMMENT:pyub] Это нужно мне для понимания. Не трогать.
</p>

<p>
<code>Layer</code> - слой, часть ПО, разрабатываемая единым образом и решающая набор
однотипных задач либо единую задачу в своих терминах, типах данных и со своим
набором методов коммуникации с остальными слоями.
</p>

<p>
Определение gmm: Слой - это набор компонентов на одном уровне абстракции, выделенный таким образом, что
интерфейсы взаимодействия между слоями строго определены (контрактом на
интерфейсы слоя) и минимизированы.
</p>

<p>
Делается все это для того, чтобы компоненты не взаимодействовали в режиме "все со
всеми", иначе так и запутаться можно, т.к. высокая связность.
</p>

<p>
<code>Компонент</code> - это иерархия взаимодействующих экземпляров классов, решающих одну
задачу. К примеру в винде IIS (web-server) - это компонент операционной
системы.
</p>

<p>
Классический пример слоя, состоящего из компонентов - это HAL (Hardware
Abstraction Layer) в System/38 - он содержит в себе несколько сотен компонентов,
например в нем присутствует компонент "компилятор", который генерирует
"абстрактный" машинный код и компонент "виртуальная машина", который этот код
исполняет. Все это надо чтобы при портировании на другую архитектуру переписать
только виртуальную машину, а не все сразу.
</p>

<p>
Нам такое не надо, у нас уже есть операционная система, по сравнению с которой мы -
глазурь на ром-бабе. Нам только нужно отделить бизнес-логику от обработкисобытий
устройств, чтобы они не перепутались и чтобы отлаживать было легче (и зоны
ответственности поделить, чтобы не лазать в код друг друга)
</p>

<p>
<code>BusinessLogic</code> - всё, что связано с логикой работы системы
</p>

<p>
<code>Hardware</code>, <code>HW</code> - всё, что связано с оборудованием
</p>

<p>
<code>Presentation</code> - представление конкретного оборудования в памяти в виде структур
данных и событий.
</p>

<p>
<code>Software</code> - всё, что связано с исполняемым ПО
</p>

<p>
<code>UI</code> (user interface) - всё, что связано с интерфейсом пользователя
</p>

<p>
<code>Component</code> - функциональный блок в составе архитектуры проекта, описывающий
решение отдельной задачи.
</p>

<p>
<code>BusinessLogicLayer</code> - это слой описания конкретных процессов для абстрактного
функционального оборудования.
</p>

<p>
<code>HardwarePresentationLayer</code> - это нижний слой архитектуры на котором конкретное
оборудование преобразуется в абстрактное представление для
</p>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Данные по первому поколению системы</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> <span class="done DONE">DONE</span> Старая версия сервера</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Доступ к текущей реализации сервера и БД для ознакомления:
<a href="http://31.28.10.26:8889/">http://31.28.10.26:8889/</a>
admin | 8812
<a href="http://31.28.10.26:8889/phpmyadmin/">http://31.28.10.26:8889/phpmyadmin/</a>
root | gThy77gG
</p>

<p>
[TODO:pyub] Изъять из общего доступа github?
</p>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Сущности</h2>
<div class="outline-text-2" id="text-10">
<p>
Соберем все сущности и автоматы в один файл <code>src/entityes.lisp</code>
</p>
</div>

<div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Функции для кодогенерации сущностей</h3>
<div class="outline-text-3" id="text-10-1">
<p>
Эти функции будут кодогенерировать сущности и автоматы из таблиц с наименованием и
типами полей внутри этого файла.
</p>

<p>
Чтобы емакс не запрашивал подтверждение на каждое исполнение кода, установим эту
настройку:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_org_confirm">(setq org-confirm-babel-evaluate nil)
</pre>
</div>

<p>
Начнем с генерации кода из таблицы полей:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_fields">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">gen-fields</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result))
    (push <span style="color: #00cd00;">"\n"</span> result)
    (push (format <span style="color: #00cd00;">"  (%s\n"</span> (butlast (car rows))) result)
    (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (push (format <span style="color: #00cd00;">"   %s\n"</span> (butlast x)) result))
            (butlast (cdr rows)))
    (push (format <span style="color: #00cd00;">"   %s)"</span> (butlast (car (last rows)))) result)
    (mapconcat 'identity (reverse result) <span style="color: #00cd00;">""</span>)))
</pre>
</div>

<p>
Теперь напишем код, который генерирует код для состояний конечного автомата:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_states">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">gen-states</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result)
        (hash (make-hash-table <span style="color: #0000ee; font-weight: bold;">:test</span> #'equal))
        (states))
    (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (elt rows nil)
      (puthash (cadr elt) nil hash)
      (puthash (cadr (cdr elt))  nil hash))
    (maphash (<span style="color: #00cdcd; font-weight: bold;">lambda</span> (k v)
               (push k states))
             hash)
    (push <span style="color: #00cd00;">"\n"</span> result)
    (push <span style="color: #00cd00;">"  ("</span> result)
    (<span style="color: #00cdcd; font-weight: bold;">dolist</span> (elt (butlast states))
      (push (format <span style="color: #00cd00;">":%s "</span> elt) result))
    (push (format <span style="color: #00cd00;">":%s)"</span> (car (last states))) result)
    (mapconcat 'identity (reverse result) <span style="color: #00cd00;">""</span>)))
</pre>
</div>

<p>
И добавим к этом генератор действий - т.е. переходов между состояниями:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_actions">(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">gen-actions</span> (rows)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((result))
    (push <span style="color: #00cd00;">"\n"</span> result)
    (<span style="color: #00cdcd; font-weight: bold;">let</span> ((x (car rows)))
      (push (format <span style="color: #00cd00;">"  ((:%s :%s :%s)"</span> (cadr x) (cadr (cdr x)) (car x)) result))
    (<span style="color: #00cdcd; font-weight: bold;">if</span> (equal 1 (length rows))
        (push <span style="color: #00cd00;">")"</span> result)
      (<span style="color: #00cdcd; font-weight: bold;">progn</span>
        (push <span style="color: #00cd00;">"\n"</span> result)
        (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                    (push (format <span style="color: #00cd00;">"   (:%s :%s :%s)\n"</span> (cadr x) (cadr (cdr x)) (car x)) result))
                (cdr (butlast rows)))
        (<span style="color: #00cdcd; font-weight: bold;">let</span> ((x (car (last rows))))
          (push (format <span style="color: #00cd00;">"   (:%s :%s :%s))"</span> (cadr x) (cadr (cdr x)) (car x)) result))))
    (mapconcat 'identity (reverse result) <span style="color: #00cd00;">""</span>)))
</pre>
</div>

<p>
Соберем все это в один файл, чтобы загружать перед кодогенерацией проекта:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>

&lt;&lt;gen_org_confirm&gt;&gt;

&lt;&lt;gen_fields&gt;&gt;

&lt;&lt;gen_states&gt;&gt;

&lt;&lt;gen_actions&gt;&gt;
</pre>
</div>

<p>
И загрузим его:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators">(load-file <span style="color: #00cd00;">"generators.el"</span>)
</pre>
</div>

<p>
Теперь у нас есть все необходимое, чтобы написать вызываемые при
tangle генераторы сущностей и автоматов:
</p>
</div>
</div>

<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> <span class="done DONE">DONE</span> События</h3>
<div class="outline-text-3" id="text-10-2">
<p>
События протоколируют все что происходит в системе. Каждое создание
сущности, каждое изменение состояния автомата регистрируется
здесь. Роботы используют эти события для своей работы. Также
информация о событиях попадает на главную страницу.
</p>

<p>
Событие является простой сущностью и не имеет состояния.
</p>

<table id="event_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Данные события</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">(or db-null varchar)</td>
<td class="left">имя события</td>
</tr>

<tr>
<td class="left">tag</td>
<td class="left">(or db-null varchar)</td>
<td class="left">тег события</td>
</tr>

<tr>
<td class="left">msg</td>
<td class="left">(or db-null varchar)</td>
<td class="left">сообщение или описание</td>
</tr>

<tr>
<td class="left">author-id</td>
<td class="left">(or db-null varchar)</td>
<td class="left">инициатор события</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время события</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код:
</p>
</div>
</div>

<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> <span class="done DONE">DONE</span> Роли (role)</h3>
<div class="outline-text-3" id="text-10-3">
<p>
Роли определяют набор сценариев, которые пользователь выполняет на
сайте. Функционал, который выполняют сценарии запрашивает
разрешение на выполнение действий, которое опирается на роль,
присвоенную пользователю. Пользователь может иметь только одну роль
или не иметь ее вовсе.
</p>

<p>
Роль является простой сущностью и не имеет состояния.
</p>

<table id="role_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Данные роли</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">(or db-null varchar)</td>
<td class="left">описание</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код и cоздадим необходимые роли:
</p>
</div>
</div>

<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> <span class="done DONE">DONE</span> Пользователи (user)</h3>
<div class="outline-text-3" id="text-10-4">
<p>
Для начала надо определиться, какие данные мы собираемся хранить о пользователях, и
какого типа будут эти данные. Типы данных задаем в формате <code>Postmodern</code> чтобы потом
сохранить данные в <code>PostgreSQL</code>
</p>

<table id="user_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Данные пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">никнейм пользователя</td>
</tr>

<tr>
<td class="left">password</td>
<td class="left">varchar</td>
<td class="left">пароль</td>
</tr>

<tr>
<td class="left">email</td>
<td class="left">varchar</td>
<td class="left">емейл</td>
</tr>

<tr>
<td class="left">firstname</td>
<td class="left">(or db-null varchar)</td>
<td class="left">имя</td>
</tr>

<tr>
<td class="left">lastname</td>
<td class="left">(or db-null varchar)</td>
<td class="left">фамилия</td>
</tr>

<tr>
<td class="left">phone</td>
<td class="left">(or db-null varchar)</td>
<td class="left">телефон</td>
</tr>

<tr>
<td class="left">mobilephone</td>
<td class="left">(or db-null varchar)</td>
<td class="left">мобильный телефон</td>
</tr>

<tr>
<td class="left">sex</td>
<td class="left">(or db-null varchar)</td>
<td class="left">пол</td>
</tr>

<tr>
<td class="left">birth-day</td>
<td class="left">(or db-null varchar)</td>
<td class="left">день рождения</td>
</tr>

<tr>
<td class="left">birth-month</td>
<td class="left">(or db-null varchar)</td>
<td class="left">месяц рождения</td>
</tr>

<tr>
<td class="left">birth-year</td>
<td class="left">(or db-null varchar)</td>
<td class="left">год рождения</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время регистрации</td>
</tr>

<tr>
<td class="left">ts-last</td>
<td class="left">bigint</td>
<td class="left">время последнего действия</td>
</tr>

<tr>
<td class="left">role-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор роли</td>
</tr>
</tbody>
</table>

<p>
В нашей системе пользователь может существовать (или не существовать) в одном из
нескольких состояний:
</p>
<ul class="org-ul">
<li>Когда пользователь еще не зарегистрирован на сайте мы можем считать его
незарегистрированным (<code>unregistred</code>)
</li>
<li>После регистрации он автоматически становится залогиненным (<code>logged</code>)
</li>
<li>Пользователь может покинуть сайт и перейти в состояние <code>unlogged</code>
</li>
<li>Пользователь может забыть свой пароль, тогда мы должны выслать ему ссылку для
восстановления пароля (<code>sended</code>)
</li>
<li>И наконец, после восстановления пароля пользователь вновь становится залогиненным
(<code>logged</code>)
</li>
</ul>

<p>
Все эти переходы и состояния сведем в единую таблицу:
</p>

<table id="user_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Состояния конечного автомата пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">registration</td>
<td class="left">unregistred</td>
<td class="left">logged</td>
</tr>

<tr>
<td class="left">unregistration</td>
<td class="left">logged</td>
<td class="left">unregistred</td>
</tr>

<tr>
<td class="left">enter</td>
<td class="left">unlogged</td>
<td class="left">logged</td>
</tr>

<tr>
<td class="left">leave</td>
<td class="left">logged</td>
<td class="left">unlogged</td>
</tr>

<tr>
<td class="left">forgot</td>
<td class="left">unlogged</td>
<td class="left">sended</td>
</tr>

<tr>
<td class="left">remember</td>
<td class="left">sended</td>
<td class="left">logged</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение пользователя как конечный автомат:
</p>


<div class="figure">
<p><img src="img/user-state.png" alt="user-state.png" />
</p>
</div>

<p>
Для того чтобы избежать дублирования ников и связанной с этим
ситуации, когда один пользователь выдает себя за другого, следует
определить констрейнт на уникальность поля <code>name</code> и <code>email</code>
</p>

<p>
Так как в системе все пользователи тесно связаны с ролями, следует
определить внешний ключ на таблицу ролей:
</p>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на
переходах из одного состояния в другое. Также установим ограничение
на колонку <code>name</code> чтобы избежать дублирования ников.
</p>
</div>
</div>

<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> <span class="done DONE">DONE</span> Группы (group, user2group)</h3>
<div class="outline-text-3" id="text-10-5">
<p>
Группы пользователей определяют набор операций, которые
пользователь может выполнять над объектами системы. В отличие от
ролей, один пользователь может входить в несколько групп или не
входить ни в одну из них.
</p>

<p>
Группа является простой сущностью и не имеет состояния.
</p>

<table id="group_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> Данные группы</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">имя группы</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">(or db-null varchar)</td>
<td class="left">описание группы</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время создания группы</td>
</tr>

<tr>
<td class="left">author-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор создателя группы</td>
</tr>
</tbody>
</table>

<p>
Сгенерируем код и создадим необходимые группы:
</p>

<p>
Теперь создадим таблицу связи, которая свяжет пользователей и группы:
</p>

<table id="user2group_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Данные таблицы связи пользователя и группы</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">user-id</td>
<td class="left">integer</td>
<td class="left">идентификатор пользователя</td>
</tr>

<tr>
<td class="left">group-id</td>
<td class="left">integer</td>
<td class="left">идентификатор группы</td>
</tr>
</tbody>
</table>

<p>
Чтобы пары в таблице связи удалялись при удалении связанных групп и
пользователей следует установить on-delete foreigh keys.
</p>

<p>
И сгенерируем код для нее:
</p>
</div>
</div>

<div id="outline-container-sec-10-6" class="outline-3">
<h3 id="sec-10-6"><span class="section-number-3">10.6</span> <span class="done DONE">DONE</span> Сообщения (msg)</h3>
<div class="outline-text-3" id="text-10-6">
<p>
О сообщениях мы знаем только от кого они посылаются, кому и собственно текст
сообщения. Его наверно не стоит ограничивать. По идее как посылающий, так и принимающий
может удалить сообщение (пометить как удаленное), для этого мы используем отдельные
флаги.
</p>

<table id="msg_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 15:</span> Данные сообщения</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">snd-id</td>
<td class="left">integer</td>
<td class="left">пользователь, который послал сообщение</td>
</tr>

<tr>
<td class="left">rcv-id</td>
<td class="left">integer</td>
<td class="left">пользователь, который получает сообщение</td>
</tr>

<tr>
<td class="left">msg</td>
<td class="left">varchar</td>
<td class="left">сообщение</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время создания</td>
</tr>

<tr>
<td class="left">ts-delivery</td>
<td class="left">bigint</td>
<td class="left">время доставки</td>
</tr>
</tbody>
</table>

<p>
Еще сообщение может быть доставлено или недоставлено.
</p>

<table id="msg_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 16:</span> Состояния конечного автомата сообщения</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">delivery</td>
<td class="left">undelivered</td>
<td class="left">delivered</td>
</tr>
</tbody>
</table>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на переходах
</p>
</div>
</div>

<div id="outline-container-sec-10-7" class="outline-3">
<h3 id="sec-10-7"><span class="section-number-3">10.7</span> <span class="done DONE">DONE</span> Задачи (task)</h3>
<div class="outline-text-3" id="text-10-7">
<table id="task_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 17:</span> Данные задачи</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название</td>
</tr>

<tr>
<td class="left">blockdata</td>
<td class="left">varchar</td>
<td class="left">суть задачи или данные</td>
</tr>

<tr>
<td class="left">owner-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор владельца</td>
</tr>

<tr>
<td class="left">exec-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор исполнителя</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время регистрации</td>
</tr>
</tbody>
</table>

<p>
В нашей системе задача может существовать  в одном из
нескольких состояний:
</p>
<ul class="org-ul">
<li>Создана, но еще ни разу не исполнялась (<code>new</code>).
</li>
<li>Исполняется в данный момент (<code>inaction</code>)
</li>
<li>Была исполнена но еще не завершена, возможно потребуется исполнять
еще раз или по расписанию (<code>standby</code>)
</li>
<li>Отменена (<code>cancelled</code>)
</li>
<li>Завершена (<code>terminated</code>)
</li>
</ul>

<p>
Все эти переходы и состояния сведем в единую таблицу:
</p>

<table id="task_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 18:</span> Состояния конечного автомата пользователя</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">starttask</td>
<td class="left">new</td>
<td class="left">inaction</td>
</tr>

<tr>
<td class="left">stoptask</td>
<td class="left">inaction</td>
<td class="left">standby</td>
</tr>

<tr>
<td class="left">restarttask</td>
<td class="left">standby</td>
<td class="left">inaction</td>
</tr>

<tr>
<td class="left">cancelnewtask</td>
<td class="left">new</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">cancelactiontask</td>
<td class="left">inaction</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">cancelstandbytask</td>
<td class="left">standby</td>
<td class="left">cancelled</td>
</tr>

<tr>
<td class="left">terminateactiontask</td>
<td class="left">inaction</td>
<td class="left">terminated</td>
</tr>

<tr>
<td class="left">terminatestandbytask</td>
<td class="left">standby</td>
<td class="left">terminated</td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение пользователя как конечный автомат:
</p>


<div class="figure">
<p><img src="img/task-state.png" alt="task-state.png" />
</p>
</div>

<p>
Для того чтобы избежать дублирования задач, следует определить
констрейнт на уникальность поля <code>name</code>
</p>

<p>
Так как в системе все пользователи тесно связаны с задачами,
следует определить внешний ключ на таблицу пользователей так, чтобы
при удалении пользователей-владельцев задач удалялись и их задачи.
</p>

<p>
Теперь сгенерируем код и определим функции, которые вызываются на
переходах из одного состояния в другое. Также установим ограничение
на колонку <code>name</code> чтобы избежать дублирования ников.
</p>
</div>
</div>

<div id="outline-container-sec-10-8" class="outline-3">
<h3 id="sec-10-8"><span class="section-number-3">10.8</span> <span class="done DONE">DONE</span> Очереди (que, quelt)</h3>
<div class="outline-text-3" id="text-10-8">
<p>
Очереди используются для фолловинга и прочей подписки на обновления.
</p>

<p>
Нам нужна некоторая инфраструктура чтобы абстрагироваться от операций управления
очередями, подписчиками и посылки сообщений. Потом ее можно будет изменить для поддержки
RabbitMQ, Mbus или ZMQ или даже использовать все их одновременно для разных целей.
</p>

<p>
Очередь является простой сущностью и не имеет состояния.
</p>

<table id="que_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 19:</span> Данные очереди</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">имя очереди</td>
</tr>
</tbody>
</table>

<p>
Нам понадобится сущность элемента очереди, назовем его <code>quelt</code>. Элемент очереди является
простой сущностью и не имеет состояния.
</p>

<table id="quelt_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 20:</span> Данные элемента очереди</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">que-id</td>
<td class="left">integer</td>
<td class="left">идентификатор очереди</td>
</tr>

<tr>
<td class="left">text</td>
<td class="left">varchar</td>
<td class="left">содержимое</td>
</tr>
</tbody>
</table>

<p>
Сгенерируем код и создадим необходимые очереди:
</p>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> Тесты</h2>
<div class="outline-text-2" id="text-11">
<div class="org-src-container">

<pre class="src src-lisp" id="asp_test"><span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; asp</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">asp-test</span> ()
  &lt;&lt;asp_test_contents&gt;&gt;
  (dbg <span style="color: #00cd00;">"passed: asp-test~%"</span>))
(asp-test)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="asp_test_contents">&lt;&lt;test_make_checkpoint&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Модули</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1"><span class="section-number-3">12.1</span> Cущности, автоматы и их тесты</h3>
<div class="outline-text-3" id="text-12-1">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_entity">(<span style="color: #0000ee; font-weight: bold;">:module</span> <span style="color: #00cd00;">"entity"</span>
         <span style="color: #0000ee; font-weight: bold;">:serial</span> t
         <span style="color: #0000ee; font-weight: bold;">:pathname</span> <span style="color: #00cd00;">"mod"</span>
         <span style="color: #0000ee; font-weight: bold;">:components</span> ((<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"entity"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2"><span class="section-number-3">12.2</span> Авторизация</h3>
<div class="outline-text-3" id="text-12-2">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_auth">(<span style="color: #0000ee; font-weight: bold;">:module</span> <span style="color: #00cd00;">"auth"</span>
         <span style="color: #0000ee; font-weight: bold;">:serial</span> t
         <span style="color: #0000ee; font-weight: bold;">:pathname</span> <span style="color: #00cd00;">"mod/auth"</span>
         <span style="color: #0000ee; font-weight: bold;">:components</span> ((<span style="color: #0000ee; font-weight: bold;">:static-file</span> <span style="color: #00cd00;">"auth-tpl.htm"</span>)
                      (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"auth"</span>)))
</pre>
</div>

<p>
Как пользователь, я хочу иметь возможность ввести логин и пароль чтобы получить доступ к
закрытому от неавторизованных пользователей функционалу.
</p>
</div>
</div>

<div id="outline-container-sec-12-3" class="outline-3">
<h3 id="sec-12-3"><span class="section-number-3">12.3</span> Очереди</h3>
<div class="outline-text-3" id="text-12-3">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_que">(<span style="color: #0000ee; font-weight: bold;">:module</span> <span style="color: #00cd00;">"que"</span>
         <span style="color: #0000ee; font-weight: bold;">:serial</span> t
         <span style="color: #0000ee; font-weight: bold;">:pathname</span> <span style="color: #00cd00;">"mod/que"</span>
         <span style="color: #0000ee; font-weight: bold;">:components</span> ((<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"que"</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-12-4" class="outline-3">
<h3 id="sec-12-4"><span class="section-number-3">12.4</span> Демонстрация</h3>
<div class="outline-text-3" id="text-12-4">
<p>
Опишем из чего состоит модуль, это описание станет частью asd-файла:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="mod_demo">(<span style="color: #0000ee; font-weight: bold;">:module</span> <span style="color: #00cd00;">"demo"</span>
         <span style="color: #0000ee; font-weight: bold;">:serial</span> t
         <span style="color: #0000ee; font-weight: bold;">:pathname</span> <span style="color: #00cd00;">"mod/demo"</span>
         <span style="color: #0000ee; font-weight: bold;">:components</span> ((<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"demo"</span>)))
</pre>
</div>

<p>
Как пользователь, я хочу иметь возможность ввести логин и пароль чтобы получить доступ к
закрытому от неавторизованных пользователей функционалу.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> Сборка</h2>
<div class="outline-text-2" id="text-13">
<p>
[TODO:bvl] Перенести в данный раздел всё, что касается сборки ядра и заголовков.
</p>
</div>

<div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> Утилиты</h3>
<div class="outline-text-3" id="text-13-1">
<div class="org-src-container">

<pre class="src src-lisp" id="utility_file">   <span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>
   <span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">util.lisp</span>

(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:asp</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1088;&#1077;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1080;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086;&#1083;&#1103; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1072; &#1074; plist</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">get-obj-data</span> (obj)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((class (find-class (type-of obj)))
        (result))
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> slot <span style="color: #0000ee; font-weight: bold;">:in</span> (closer-mop:class-direct-slots class) <span style="color: #0000ee; font-weight: bold;">:collect</span>
       (<span style="color: #00cdcd; font-weight: bold;">let</span> ((slot-name (closer-mop:slot-definition-name slot)))
         (<span style="color: #00cdcd; font-weight: bold;">when</span> (slot-boundp obj slot-name)
           (setf result
                 (append result (list (intern (symbol-name slot-name) <span style="color: #0000ee; font-weight: bold;">:keyword</span>)
                                      (funcall slot-name obj)))))))
    result))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">Assembly WHERE clause</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">make-clause-list</span> (glob-rel rel args)
  (append (list glob-rel)
          (<span style="color: #00cdcd; font-weight: bold;">loop</span>
             <span style="color: #0000ee; font-weight: bold;">:for</span> i
             <span style="color: #0000ee; font-weight: bold;">:in</span> args
             <span style="color: #0000ee; font-weight: bold;">:when</span> (and (symbolp i)
                        (getf args i)
                        (not (symbolp (getf args i))))
             <span style="color: #0000ee; font-weight: bold;">:collect</span> (list rel i (getf args i)))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1072;&#1082;&#1088;&#1086;&#1089;&#1099; &#1076;&#1083;&#1103; &#1082;&#1086;&#1088;&#1088;&#1077;&#1082;&#1090;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1074;&#1086;&#1076;&#1072; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">bprint</span> (var)
  `(subseq (<span style="color: #00cdcd; font-weight: bold;">with-output-to-string</span> (*standard-output*)  (pprint ,var)) 1))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">err</span> (var)
  `(<span style="color: #cd0000; font-weight: bold;">error</span> (format nil <span style="color: #00cd00;">"ERR:[~A]"</span> (bprint ,var))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1054;&#1090;&#1083;&#1072;&#1076;&#1086;&#1095;&#1085;&#1099;&#1081; &#1074;&#1099;&#1074;&#1086;&#1076;</span>
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*dbg-enable*</span> t)
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">*dbg-indent*</span> 1)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">dbgout</span> (out)
  (<span style="color: #00cdcd; font-weight: bold;">when</span> *dbg-enable*
    (format t (format nil <span style="color: #00cd00;">"~~%~~~AT~~A"</span> *dbg-indent*) out)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">dbg</span> (frmt <span style="color: #00cd00;">&amp;rest</span> params)
  `(dbgout (format nil ,frmt ,@params)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(macroexpand-1 '(dbg "~A~A~{~A~^,~}" "zzz" "34234" '(1 2 3 4)))</span>

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">anything-to-keyword</span> (item)
  (intern (string-upcase (format nil <span style="color: #00cd00;">"~a"</span> item)) <span style="color: #0000ee; font-weight: bold;">:keyword</span>))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">alist-to-plist</span> (alist)
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (not (equal (type-of alist) 'cons))
      alist
      <span style="color: #cd0000;">;;</span><span style="color: #cd0000;">else</span>
      (<span style="color: #00cdcd; font-weight: bold;">loop</span>
         <span style="color: #0000ee; font-weight: bold;">:for</span> (key . value)
         <span style="color: #0000ee; font-weight: bold;">:in</span> alist
         <span style="color: #0000ee; font-weight: bold;">:nconc</span> (list (anything-to-keyword key) value))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1042;&#1088;&#1072;&#1087;&#1087;&#1077;&#1088; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1103;&#1077;&#1090; &#1089;&#1077;&#1089;&#1080;&#1080;&#1103;&#1084;&#1080; &#1080; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090; &#1074;&#1089;&#1077; &#1074; &#1086;&#1089;&#1085;&#1086;&#1074;&#1085;&#1086;&#1081; (root-&#1086;&#1074;&#1099;&#1081;) &#1096;&#1072;&#1073;&#1083;&#1086;&#1085;</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1045;&#1089;&#1083;&#1080; &#1085;&#1077;&#1086;&#1073;&#1093;&#1086;&#1076;&#1080;&#1084;&#1086; &#1074;&#1099;&#1074;&#1077;&#1089;&#1090;&#1080; ajax-&#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1077;&#1090; &#1089;&#1087;&#1077;&#1094;&#1080;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1090;&#1080;&#1087; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080;</span>

(<span style="color: #00cdcd; font-weight: bold;">define-condition</span> <span style="color: #0000ee; font-weight: bold;">ajax</span> (<span style="color: #cd0000; font-weight: bold;">error</span>)
  ((output <span style="color: #0000ee; font-weight: bold;">:initarg</span> <span style="color: #0000ee; font-weight: bold;">:output</span> <span style="color: #0000ee; font-weight: bold;">:reader</span> output)))

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-wrapper</span> (<span style="color: #00cd00;">&amp;body</span> body)
  `(<span style="color: #00cdcd; font-weight: bold;">progn</span>
     (hunchentoot:start-session)
     (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((*current-user* (hunchentoot:session-value 'current-user))
            (retval))
       (<span style="color: #00cdcd; font-weight: bold;">declare</span> (special *current-user*))
       (<span style="color: #00cdcd; font-weight: bold;">handler-case</span>
           (<span style="color: #00cdcd; font-weight: bold;">let</span> ((output (<span style="color: #00cdcd; font-weight: bold;">with-output-to-string</span> (*standard-output*)
                           (setf retval ,@body))))
             (tpl:louis
              (list <span style="color: #0000ee; font-weight: bold;">:title</span> <span style="color: #00cd00;">""</span>
                    <span style="color: #0000ee; font-weight: bold;">:header</span> (tpl:header (list <span style="color: #0000ee; font-weight: bold;">:login</span> (head-login-block)
                                              <span style="color: #0000ee; font-weight: bold;">:search</span>
                                              (ps-html
                                              ((<span style="color: #0000ee; font-weight: bold;">:form</span> <span style="color: #0000ee; font-weight: bold;">:action</span> <span style="color: #00cd00;">"/hh/search"</span> <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #00cd00;">"get"</span> <span style="color: #0000ee; font-weight: bold;">:novalidate</span> <span style="color: #00cd00;">""</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"article-search"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"header-search"</span> <span style="color: #0000ee; font-weight: bold;">:id=</span><span style="color: #00cd00;">"article-search"</span>)
                                               ((<span style="color: #0000ee; font-weight: bold;">:fieldset</span>)
                                                ((<span style="color: #0000ee; font-weight: bold;">:legend</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"hidden"</span>) <span style="color: #00cd00;">"search"</span>)
                                                ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"input-container hide-label"</span>)
                                                 ((<span style="color: #0000ee; font-weight: bold;">:label</span> <span style="color: #0000ee; font-weight: bold;">:for</span> <span style="color: #00cd00;">"header-search-q"</span>) <span style="color: #00cd00;">"&#1055;&#1086;&#1080;&#1089;&#1082; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080; &#1092;&#1080;&#1088;&#1084;"</span>)
                                                 ((<span style="color: #0000ee; font-weight: bold;">:input</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"q"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"header-search-q"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"input-text form-element header-search__input"</span>
                                                          <span style="color: #0000ee; font-weight: bold;">:maxlength</span> <span style="color: #00cd00;">"50"</span> <span style="color: #0000ee; font-weight: bold;">:required</span> <span style="color: #00cd00;">"required"</span> <span style="color: #0000ee; font-weight: bold;">:autocomplete</span> <span style="color: #00cd00;">"off"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> (aif (get-parameter <span style="color: #00cd00;">"q"</span>) it <span style="color: #00cd00;">""</span>) <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"text"</span>)))
                                                ((<span style="color: #0000ee; font-weight: bold;">:button</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"submit"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button button--header-search"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">""</span>)
                                                 ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button__icon sprite"</span>) <span style="color: #00cd00;">"Search"</span>)))))))
                    <span style="color: #0000ee; font-weight: bold;">:content</span> retval
                    <span style="color: #0000ee; font-weight: bold;">:footer</span> (tpl:footer (list <span style="color: #0000ee; font-weight: bold;">:dbg</span> (format nil <span style="color: #00cd00;">"&lt;pre&gt;~A&lt;/pre&gt;"</span> output))))))
         (ajax (ajax) (output ajax))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1044;&#1083;&#1103; &#1090;&#1086;&#1075;&#1086; &#1095;&#1090;&#1086;&#1073;&#1099; &#1075;&#1077;&#1085;&#1077;&#1088;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1080; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1099; &#1092;&#1086;&#1088;&#1084;, &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1093;&#1077;&#1083;&#1087;&#1077;&#1088;&#1099;:</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun input (type &amp;key name value other)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%&lt;input type=\"~A\"~A~A~A/&gt;" type</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if name  (format nil " name=\"~A\"" name) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if value (format nil " value=\"~A\"" value) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if other (format nil " ~A" other) "")))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (input "text" :name "zzz" :value 111)</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (input "submit" :name "submit-btn" :value "send")</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro select ((name &amp;optional attrs) &amp;body options)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">`(format nil "~%&lt;select name=\"~A\"~A&gt;~{~%~A~}~%&lt;/select&gt;"</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">,name</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(aif ,attrs (format nil " ~A" it) "")</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(loop :for (name value selected) :in ,@options :collect</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">(format nil "&lt;option value=\"~A\"~A&gt;~A&lt;/option&gt;"</span>
<span style="color: #cd0000;">;;                       </span><span style="color: #cd0000;">value</span>
<span style="color: #cd0000;">;;                       </span><span style="color: #cd0000;">(if selected (format nil " ~A" selected) "")</span>
<span style="color: #cd0000;">;;                       </span><span style="color: #cd0000;">name))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun fld (name &amp;optional (value ""))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(input "text" :name name :value value))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun btn (name &amp;optional (value ""))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(input "button" :name name :value value))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun hid (name &amp;optional (value ""))</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(input "hidden" :name name :value value))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun submit (&amp;optional value)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(if value</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(input "submit" :value value)</span>
<span style="color: #cd0000;">;;       </span><span style="color: #cd0000;">(input "submit")))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun act-btn (act data title)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%~{~%~A~}"</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(list</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(hid "act"  act)</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(hid "data" data)</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">(submit title))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro row (title &amp;body body)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">`(format nil "~%&lt;tr&gt;~%&lt;td&gt;~A&lt;/td&gt;~%&lt;td&gt;~A~%&lt;/td&gt;~%&lt;/tr&gt;"</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">,title</span>
<span style="color: #cd0000;">;;            </span><span style="color: #cd0000;">,@body))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (row "thetitrle" (submit))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun td (dat)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%&lt;td&gt;~%~A~%&lt;/td&gt;" dat))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun tr (&amp;rest dat)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%&lt;tr&gt;~%~{~A~}~%&lt;/tr&gt;"</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">dat))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (tr "wfewf")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (tr "wfewf" 1111)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun frm (contents &amp;key name (method "POST") action)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%&lt;form method=\"~A\"~A~A&gt;~{~A~}~%&lt;/form&gt;"</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">method</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if name (format nil " name=\"~A\"" name) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if action (format nil " action=\"~A\"" action) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if (consp contents)</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">contents</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">(list contents))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (frm "form-content" :name "nnnnn")</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defun tbl (contents &amp;key name border)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~%&lt;table~A~A&gt;~{~A~}~%&lt;/table&gt;"</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if name (format nil " name=\"~A\"" name) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if border (format nil " border=\"~A\"" border) "")</span>
<span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(if (consp contents)</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">contents</span>
<span style="color: #cd0000;">;;               </span><span style="color: #cd0000;">(list contents))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (tbl (list "zzz") :name "table")</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; (frm (tbl (list (row "username" (fld "user")))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1072;&#1082;&#1088;&#1086;&#1089; &#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1090; &#1084;&#1072;&#1088;&#1096;&#1088;&#1091;&#1090; &#1080; &#1084;&#1072;&#1088;&#1096;&#1088;&#1091;&#1090;-&#1082;&#1086;&#1085;&#1090;&#1088;&#1086;&#1083;&#1083;&#1077;&#1088;, &#1090;&#1072;&#1082;&#1080;&#1084; &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1084;,</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1074;&#1103;&#1079;&#1072;&#1090;&#1100; &#1076;&#1077;&#1081;&#1089;&#1090;&#1074;&#1080;&#1103; &#1082;&#1086;&#1085;&#1090;&#1088;&#1086;&#1083;&#1083;&#1077;&#1088;&#1072; &#1080; &#1082;&#1085;&#1086;&#1087;&#1082;&#1080;</span>
(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">define-page</span> (name url (<span style="color: #00cd00;">&amp;body</span> body) <span style="color: #00cd00;">&amp;rest</span> rest)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((name-ctrl (intern (format nil <span style="color: #00cd00;">"~A-CTRL"</span> (symbol-name name)))))
    `(<span style="color: #00cdcd; font-weight: bold;">symbol-macrolet</span> (,@(<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> (act exp body) <span style="color: #0000ee; font-weight: bold;">:in</span> rest <span style="color: #0000ee; font-weight: bold;">:collect</span>
                            `(,(intern (format nil <span style="color: #00cd00;">"%~A%"</span> (symbol-name act))) ,exp)))
       (restas:define-route ,name (,url)
         (<span style="color: #00cdcd; font-weight: bold;">with-wrapper</span>
           ,body))
       (restas:define-route ,name-ctrl (,url <span style="color: #0000ee; font-weight: bold;">:method</span> <span style="color: #0000ee; font-weight: bold;">:post</span>)
         (<span style="color: #00cdcd; font-weight: bold;">with-wrapper</span>
           (<span style="color: #00cdcd; font-weight: bold;">let*</span> ((p (alist-to-plist (hunchentoot:post-parameters*))))
             (<span style="color: #00cdcd; font-weight: bold;">cond</span>
               ,@(append
                  (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> (act exp body) <span style="color: #0000ee; font-weight: bold;">:in</span> rest <span style="color: #0000ee; font-weight: bold;">:collect</span>
                     `((string= ,(symbol-name act) (getf p <span style="color: #0000ee; font-weight: bold;">:act</span>))
                       ,body))
                  `((t (format nil <span style="color: #00cd00;">"unk act : ~A"</span> (bprint p))))))))))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-collection</span> ((item collection) <span style="color: #00cd00;">&amp;body</span> body)
  `(<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> ,item <span style="color: #0000ee; font-weight: bold;">:in</span> ,collection <span style="color: #0000ee; font-weight: bold;">:collect</span>
      ,@body))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>

(<span style="color: #00cdcd; font-weight: bold;">defmacro</span> <span style="color: #0000ee; font-weight: bold;">with-element</span> ((item elt) <span style="color: #00cd00;">&amp;body</span> body)
  `(<span style="color: #00cdcd; font-weight: bold;">let</span> ((,item ,elt))
     (list
      ,@body)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">replace-all</span> (string part replacement <span style="color: #00cd00;">&amp;key</span> (test #'char=))
  <span style="color: #00cd00;">"Returns a new string in which all the occurences of the part</span>
<span style="color: #00cd00;">      is replaced with replacement."</span>
  (<span style="color: #00cdcd; font-weight: bold;">with-output-to-string</span> (out)
    (<span style="color: #00cdcd; font-weight: bold;">loop</span> with part-length = (length part)
       for old-pos = 0 then (+ pos part-length)
       for pos = (search part string
                         <span style="color: #0000ee; font-weight: bold;">:start2</span> old-pos
                         <span style="color: #0000ee; font-weight: bold;">:test</span> test)
       do (write-string string out
                        <span style="color: #0000ee; font-weight: bold;">:start</span> old-pos
                        <span style="color: #0000ee; font-weight: bold;">:end</span> (or pos (length string)))
       when pos do (write-string replacement out)
       while pos)))

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">explore-dir</span> (path)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((raw (directory path))
        (dirs)
        (files))
    (mapcar #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (x)
                (<span style="color: #00cdcd; font-weight: bold;">if</span> (cl-fad:directory-pathname-p x)
                    (push x dirs)
                    (push x files)))
            raw)
    (values dirs files raw)))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">clear-db</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">drop</span> (tbl-lst)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((tables tbl-lst))
    (<span style="color: #00cdcd; font-weight: bold;">flet</span> ((rmtbl (tblname)
             (<span style="color: #00cdcd; font-weight: bold;">when</span> (<span style="color: #00cdcd; font-weight: bold;">with-connection</span> *db-spec*
                     (query (<span style="color: #0000ee; font-weight: bold;">:select</span> 'table_name <span style="color: #0000ee; font-weight: bold;">:from</span> 'information_schema.tables <span style="color: #0000ee; font-weight: bold;">:where</span>
                                     (<span style="color: #0000ee; font-weight: bold;">:and</span> (<span style="color: #0000ee; font-weight: bold;">:=</span> 'table_schema <span style="color: #00cd00;">"public"</span>)
                                           (<span style="color: #0000ee; font-weight: bold;">:=</span> 'table_name tblname)))))
               (<span style="color: #00cdcd; font-weight: bold;">with-connection</span> *db-spec*
                 (query (<span style="color: #0000ee; font-weight: bold;">:drop-table</span> (intern (string-upcase tblname))))))))
      (<span style="color: #00cdcd; font-weight: bold;">loop</span> <span style="color: #0000ee; font-weight: bold;">:for</span> tblname <span style="color: #0000ee; font-weight: bold;">:in</span> tables <span style="color: #0000ee; font-weight: bold;">:collect</span>
         (rmtbl tblname)))))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">contains</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">contains</span> (string pattern)
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (search pattern string)
      t))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">empty</span>
(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">empty</span> (string)
  (<span style="color: #00cdcd; font-weight: bold;">if</span> (or (null string)
          (equal <span style="color: #00cd00;">""</span> string))
      t))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2"><span class="section-number-3">13.2</span> Глобальные определения</h3>
<div class="outline-text-3" id="text-13-2">
<p>
Создание базы данных проекта:
</p>

<pre class="example">
postgres=# CREATE USER asp_admin WITH PASSWORD 'qwe123';
CREATE ROLE
postgres=# CREATE DATABASE asp OWNER asp_admin;
CREATE DATABASE
postgres=# GRANT ALL privileges ON DATABASE asp TO asp_admin;
GRANT
</pre>

<div class="org-src-container">

<pre class="src src-lisp" id="globals"><span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:asp</span>)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">One thing we have to do is make sure that CL-WHO and Parenscript</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">use different string delimiters so that literal strings will</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">work as intended in JavaScript code inlined in HTML element properties.</span>
(setf *js-string-delimiter* #\")

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1073;&#1077;&#1079; &#1101;&#1090;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1080;&#1089;&#1093;&#1086;&#1076;&#1080;&#1090; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; &#1087;&#1088;&#1080; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080; &#1074; js</span>
(<span style="color: #00cdcd; font-weight: bold;">defparameter</span> <span style="color: #cdcd00;">PARENSCRIPT::SUPPRESS-VALUES</span> nil)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; PostgreSQL</span>
(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">*db-name*</span> <span style="color: #00cd00;">"asp"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">*db-user*</span> <span style="color: #00cd00;">"asp_admin"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">*db-pass*</span> <span style="color: #00cd00;">"qwe123"</span>)
(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">*db-serv*</span> <span style="color: #00cd00;">"localhost"</span>)

(<span style="color: #00cdcd; font-weight: bold;">defvar</span> <span style="color: #cdcd00;">*db-spec*</span> (list <span style="color: #00cd00;">"asp"</span> <span style="color: #00cd00;">"asp_admin"</span> <span style="color: #00cd00;">"qwe123"</span> <span style="color: #00cd00;">"localhost"</span>))

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; Mysql</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defvar *mysql-db-host* "bkn.ru")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defvar *mysql-db-database* "bkn_base")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defvar *mysql-db-user* "root")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defvar *mysql-db-password* "YGAhBawd1j~SANlw\"Y#l")</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defvar *mysql-db-port* 3306)</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">;; &#1052;&#1072;&#1082;&#1088;&#1086;&#1089; &#1076;&#1083;&#1103; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1103; &#1082; mysql</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro with-mysql-conn (spec &amp;body body)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">`(let ((*mysql-conn-pool* (apply #'cl-mysql:connect ',spec)))</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">(unwind-protect (progn</span>
<span style="color: #cd0000;">;;                        </span><span style="color: #cd0000;">(cl-mysql:query  "SET NAMES 'utf8'")</span>
<span style="color: #cd0000;">;;                        </span><span style="color: #cd0000;">,@body)</span>
<span style="color: #cd0000;">;;        </span><span style="color: #cd0000;">(cl-mysql:disconnect))))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro with-mysql (&amp;body body)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">`(with-mysql-conn (:host "bkn.ru" :database "bkn_base" :user "root" :password "YGAhBawd1j~SANlw\"Y#l" :port 3306)</span>
<span style="color: #cd0000;">;;      </span><span style="color: #cd0000;">,@body))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defparameter *mysql-conn-pool*</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(cl-mysql:connect :host "bkn.ru" :database "bkn_base" :user "root" :password "YGAhBawd1j~SANlw\"Y#l" :port 3306))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(cl-mysql:query  "SET NAMES 'utf8'")</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(defmacro with-mysql (&amp;body body)</span>
<span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">`(progn ,@body))</span>

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">clear db</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(drop '("resume"))</span>
<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(drop '("user" "role" "group" "user2group" "msg"</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">"que" "quelt" "bratan" "cmpx" "plex" "crps" "flat"</span>
<span style="color: #cd0000;">;;         </span><span style="color: #cd0000;">"city" "district" "metro" "deadline"))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3"><span class="section-number-3">13.3</span> Страницы</h3>
<div class="outline-text-3" id="text-13-3">
</div><div id="outline-container-sec-13-3-1" class="outline-4">
<h4 id="sec-13-3-1"><span class="section-number-4">13.3.1</span> Главная страница</h4>
<div class="outline-text-4" id="text-13-3-1">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:asp</span>)

(<span style="color: #00cdcd; font-weight: bold;">define-page</span> main <span style="color: #00cd00;">"/"</span>
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((breadcrumb (breadcrumb <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1080;&#1079;&#1084;&#1077;&#1085;&#1080;&#1085;&#1080;&#1103;"</span>))
        (user       (<span style="color: #00cdcd; font-weight: bold;">if</span> (null *current-user*) <span style="color: #00cd00;">"&#1040;&#1085;&#1086;&#1085;&#1080;&#1084;&#1085;&#1099;&#1081; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> (name (get-user *current-user*)))))
    (standard-page (<span style="color: #0000ee; font-weight: bold;">:breadcrumb</span> breadcrumb <span style="color: #0000ee; font-weight: bold;">:user</span> user <span style="color: #0000ee; font-weight: bold;">:menu</span> (menu) <span style="color: #0000ee; font-weight: bold;">:overlay</span> (reg-overlay))
      (content-box ()
        (heading (<span style="color: #00cd00;">"&#1063;&#1090;&#1086; &#1087;&#1088;&#1086;&#1080;&#1089;&#1093;&#1086;&#1076;&#1080;&#1090;?"</span>) <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1089;&#1086;&#1073;&#1099;&#1090;&#1080;&#1103;:"</span>))
      (content-box ()
        (show (sort (all-event) #'(<span style="color: #00cdcd; font-weight: bold;">lambda</span> (a b) (&gt; (id a) (id b))))))
      (ps-html ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))

(<span style="color: #00cdcd; font-weight: bold;">defmethod</span> <span style="color: #0000ee; font-weight: bold;">show</span> ((param event) <span style="color: #00cd00;">&amp;rest</span> actions <span style="color: #00cd00;">&amp;key</span> <span style="color: #00cd00;">&amp;allow-other-keys</span>)
  (<span style="color: #00cdcd; font-weight: bold;">let</span> ((time-record
         (<span style="color: #00cdcd; font-weight: bold;">multiple-value-bind</span> (second minute hour date month year day daylight-p zone)
             (decode-universal-time (ts-create param))
           (format nil <span style="color: #00cd00;">"~A:~A:~A ~A.~A.~A"</span>
                   hour minute second date month year))))

  (ps-html
   ((<span style="color: #0000ee; font-weight: bold;">:li</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"article-item article-item--list"</span> <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"height: inherit;;"</span>)
    ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"inner"</span>)
     ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"article-item__info"</span> <span style="color: #0000ee; font-weight: bold;">:style</span> <span style="color: #00cd00;">"width: 540px; height: inherit; float: inherit;"</span>)
      ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"article-item__main-info"</span>)
       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">((:a :class "article-item__title-link" :href (format nil "/group/~A" (id param)))</span>
       <span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">((:h3 :class "article-item__title") (name param))</span>
       <span style="color: #cd0000;">;;  </span><span style="color: #cd0000;">((:h4 :class "article-item__subtitle")))</span>
       ((<span style="color: #0000ee; font-weight: bold;">:p</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"article-item__description"</span>) (msg param)))
      time-record
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(if (null actions)</span>
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">""</span>
      <span style="color: #cd0000;">;;   </span><span style="color: #cd0000;">(format nil "~{~A~}"</span>
      <span style="color: #cd0000;">;;           </span><span style="color: #cd0000;">(loop :for action-key :in actions :by #'cddr :collect</span>
      <span style="color: #cd0000;">;;              </span><span style="color: #cd0000;">(funcall (getf actions action-key) param))))</span>
      ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"clear"</span>))))))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-13-4" class="outline-3">
<h3 id="sec-13-4"><span class="section-number-3">13.4</span> Каркас проекта</h3>
<div class="outline-text-3" id="text-13-4">
<p>
Для генерации "с чистого листа" необходимы функции генерации сущностей, они лежат в
файле <code>generators.el</code>
</p>

<p>
Чтобы их подключить - можно сделать M-x load-file generators.el в emacs-е.
</p>

<p>
Эти функции помещаются в <code>generators.el</code> при <code>tangle</code> и редактировать их можно в
соответствующем разделе этого файла. Для успешной генерации сущностей, они должны быть
загружены в emacs.
</p>

<p>
Файл <code>prepare</code> должен идти до файла <code>util</code> и остальных, так как в нем компилируются
шаблоны, от которых зависит <code>util</code>
</p>

<p>
Файл <code>globals</code> должен идти до файла <code>entity</code> так как в нем происходит подключение к базе
данных, которое используют тесты сущностей и автоматов.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem">     <span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>
     <span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">asp.asd</span>

(asdf:defsystem #<span style="color: #0000ee; font-weight: bold;">:asp</span>
  <span style="color: #0000ee; font-weight: bold;">:serial</span> t
  <span style="color: #0000ee; font-weight: bold;">:pathname</span> <span style="color: #00cd00;">"src"</span>
  <span style="color: #0000ee; font-weight: bold;">:depends-on</span> (#<span style="color: #0000ee; font-weight: bold;">:closer-mop</span>
               #<span style="color: #0000ee; font-weight: bold;">:postmodern</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-mysql</span>
               #<span style="color: #0000ee; font-weight: bold;">:anaphora</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-ppcre</span>
               #<span style="color: #0000ee; font-weight: bold;">:restas</span>
               #<span style="color: #0000ee; font-weight: bold;">:restas-directory-publisher</span>
               #<span style="color: #0000ee; font-weight: bold;">:closure-template</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-json</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-base64</span>
               #<span style="color: #0000ee; font-weight: bold;">:drakma</span>
               #<span style="color: #0000ee; font-weight: bold;">:split-sequence</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-html5-parser</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-who</span>
               #<span style="color: #0000ee; font-weight: bold;">:parenscript</span>
               #<span style="color: #0000ee; font-weight: bold;">:cl-fad</span>
               #<span style="color: #0000ee; font-weight: bold;">:optima</span>
               #<span style="color: #0000ee; font-weight: bold;">:fare-quasiquote-extras</span>
               #<span style="color: #0000ee; font-weight: bold;">:fare-quasiquote-optima</span>
               )
  <span style="color: #0000ee; font-weight: bold;">:description</span> <span style="color: #00cd00;">"asp"</span>
  <span style="color: #0000ee; font-weight: bold;">:author</span> <span style="color: #00cd00;">"Glukhov Mikhail"</span>
  <span style="color: #0000ee; font-weight: bold;">:version</span> <span style="color: #00cd00;">"0.0.3"</span>
  <span style="color: #0000ee; font-weight: bold;">:license</span> <span style="color: #00cd00;">"GNU AGPLv3"</span>
  <span style="color: #0000ee; font-weight: bold;">:components</span> ((<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"package"</span>)    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1092;&#1072;&#1081;&#1083; &#1087;&#1072;&#1082;&#1077;&#1090;&#1086;&#1074;</span>
               (<span style="color: #0000ee; font-weight: bold;">:static-file</span> <span style="color: #00cd00;">"templates.htm"</span>)
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"prepare"</span>)    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1087;&#1086;&#1076;&#1075;&#1086;&#1090;&#1086;&#1074;&#1082;&#1072; &#1082; &#1089;&#1090;&#1072;&#1088;&#1090;&#1091;</span>
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"util"</span>)       <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1072;&#1084;&#1080;</span>
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"globals"</span>)    <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1092;&#1072;&#1081;&#1083; &#1089; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1099;&#1084;&#1080; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1103;&#1084;&#1080;</span>
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"bricks"</span>)     <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1082;&#1086;&#1084;&#1087;&#1086;&#1085;&#1077;&#1085;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1103; &#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1086;&#1074;</span>
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081;, &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1086;&#1074; &#1080; &#1080;&#1093; &#1090;&#1077;&#1089;&#1090;&#1086;&#1074;</span>
               &lt;&lt;mod_entity&gt;&gt;
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"entityes"</span>)   <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1057;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1080; &#1080; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1099;</span>
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"start"</span>)      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1099;&#1081; &#1092;&#1072;&#1081;&#1083;</span>
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1072;&#1074;&#1090;&#1086;&#1088;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080; (&#1079;&#1072;&#1074;&#1080;&#1089;&#1080;&#1090; &#1086;&#1090; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1085;&#1086;&#1089;&#1090;&#1077;&#1081; &#1074; &#1089;&#1090;&#1072;&#1088;&#1090;&#1086;&#1074;&#1086;&#1084; &#1092;&#1072;&#1081;&#1083;&#1077;)</span>
               &lt;&lt;mod_auth&gt;&gt;
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1086;&#1095;&#1077;&#1088;&#1077;&#1076;&#1077;&#1081;</span>
               &lt;&lt;mod_que&gt;&gt;
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1081;</span>
               &lt;&lt;mod_msg&gt;&gt;
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(:file "events")     ;; &#1089;&#1086;&#1073;&#1099;&#1090;&#1080;&#1103; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;</span>
               (<span style="color: #0000ee; font-weight: bold;">:file</span> <span style="color: #00cd00;">"iface"</span>)      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1092;&#1072;&#1081;&#1083; &#1074;&#1077;&#1073;-&#1080;&#1085;&#1090;&#1077;&#1088;&#1092;&#1077;&#1081;&#1089;&#1072;</span>
               <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1052;&#1086;&#1076;&#1091;&#1083;&#1100; &#1076;&#1077;&#1084;&#1086;&#1085;&#1089;&#1090;&#1088;&#1072;&#1094;&#1080;&#1080;</span>
               &lt;&lt;mod_demo&gt;&gt;
               ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-5" class="outline-3">
<h3 id="sec-13-5"><span class="section-number-3">13.5</span> Пакеты</h3>
<div class="outline-text-3" id="text-13-5">
<p>
Соберем весь код в пакет:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="package"><span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">package.lisp</span>

(restas:define-module #<span style="color: #0000ee; font-weight: bold;">:asp</span>
  (<span style="color: #0000ee; font-weight: bold;">:use</span>  #<span style="color: #0000ee; font-weight: bold;">:cl</span> #<span style="color: #0000ee; font-weight: bold;">:closer-mop</span> #<span style="color: #0000ee; font-weight: bold;">:postmodern</span> #<span style="color: #0000ee; font-weight: bold;">:anaphora</span> #<span style="color: #0000ee; font-weight: bold;">:hunchentoot</span> #<span style="color: #0000ee; font-weight: bold;">:cl-who</span> #<span style="color: #0000ee; font-weight: bold;">:parenscript</span> #<span style="color: #0000ee; font-weight: bold;">:cl-fad</span> #<span style="color: #0000ee; font-weight: bold;">:optima</span>)
  (<span style="color: #0000ee; font-weight: bold;">:shadowing-import-from</span> #<span style="color: #0000ee; font-weight: bold;">:closer-mop</span>
                          #<span style="color: #0000ee; font-weight: bold;">:defclass</span>
                          #<span style="color: #0000ee; font-weight: bold;">:defmethod</span>
                          #<span style="color: #0000ee; font-weight: bold;">:standard-class</span>
                          #<span style="color: #0000ee; font-weight: bold;">:standard-method</span>
                          #<span style="color: #0000ee; font-weight: bold;">:ensure-generic-function</span>
                          #<span style="color: #0000ee; font-weight: bold;">:defgeneric</span>
                          #<span style="color: #0000ee; font-weight: bold;">:standard-generic-function</span>
                          #<span style="color: #0000ee; font-weight: bold;">:class-name</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-6" class="outline-3">
<h3 id="sec-13-6"><span class="section-number-3">13.6</span> Подготовка к старту</h3>
<div class="outline-text-3" id="text-13-6">
<p>
Подготовка включает в себя загрузку всех необходимых библиотек, компиляцию шаблонов, и,
возможно, инициализацию окружения.
</p>
</div>
</div>

<div id="outline-container-sec-13-7" class="outline-3">
<h3 id="sec-13-7"><span class="section-number-3">13.7</span> Блок логина в шапке на каждой странице</h3>
<div class="outline-text-3" id="text-13-7">
<div class="org-src-container">

<pre class="src src-lisp" id="auth_fn_contents">(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:asp</span>)

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">head-login-block</span> ()
  (<span style="color: #00cdcd; font-weight: bold;">if</span> *current-user*
      (ps-html
       ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"flyout-parent user-nav__item user-nav__item--my-louis"</span>)
        ((<span style="color: #0000ee; font-weight: bold;">:div</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"#"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button js__setFocus"</span> <span style="color: #0000ee; font-weight: bold;">:data-set-focus</span>
              <span style="color: #00cd00;">"email"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"mylouis-flyout-link"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button__text"</span>) <span style="color: #00cd00;">"&#1052;&#1086;&#1081; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button__icon sprite"</span>))))
        ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"user-nav__flyout flyout flyout--my-louis</span>
<span style="color: #00cd00;">  flyout--my-louis--login popup"</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"hover"</span>))
         ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"action-icon action-icon--close"</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"#"</span>) <span style="color: #00cd00;">"&#215;"</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"box"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"box--title"</span>) (format nil <span style="color: #00cd00;">"&#1055;&#1088;&#1080;&#1074;&#1077;&#1090;, ~A"</span> (name (get-user
                                                                      *current-user*))))
          ((<span style="color: #0000ee; font-weight: bold;">:p</span>) <span style="color: #00cd00;">"&#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1081; &#1074;&#1093;&#1086;&#1076;: &#1085;&#1077;&#1076;&#1072;&#1074;&#1085;&#1086;"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button button--link button--secondary"</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"/reg"</span>)
           <span style="color: #00cd00;">"&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;"</span>
           ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button__icon"</span>)))))))
      <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">else</span>
      (ps-html
       ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"flyout-parent user-nav__item user-nav__item--my-louis"</span>)
        ((<span style="color: #0000ee; font-weight: bold;">:div</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"#"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button js__setFocus"</span> <span style="color: #0000ee; font-weight: bold;">:data-set-focus</span>
              <span style="color: #00cd00;">"email"</span> <span style="color: #0000ee; font-weight: bold;">:id</span> <span style="color: #00cd00;">"mylouis-flyout-link"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button__text"</span>) <span style="color: #00cd00;">"&#1052;&#1086;&#1081; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"nav-button__icon sprite"</span>))))
        ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"user-nav__flyout flyout flyout--my-louis</span>
<span style="color: #00cd00;">  flyout--my-louis--login popup"</span>)
         ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"hover"</span>))
         ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"action-icon action-icon--close"</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"#"</span>) <span style="color: #00cd00;">"&#215;"</span>)
         (form (<span style="color: #00cd00;">"loginform"</span> nil <span style="color: #0000ee; font-weight: bold;">:action</span> <span style="color: #00cd00;">"/login"</span>)
           (fieldset <span style="color: #00cd00;">"&#1042;&#1093;&#1086;&#1076;:"</span>
             (input (<span style="color: #00cd00;">"email"</span> <span style="color: #00cd00;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1087;&#1086;&#1095;&#1090;&#1072;"</span> <span style="color: #0000ee; font-weight: bold;">:required</span> t <span style="color: #0000ee; font-weight: bold;">:type</span>
                             <span style="color: #00cd00;">"email"</span> <span style="color: #0000ee; font-weight: bold;">:maxlength</span> <span style="color: #00cd00;">"50"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"input-bg"</span>))
             (input (<span style="color: #00cd00;">"password"</span> <span style="color: #00cd00;">"&#1055;&#1072;&#1088;&#1086;&#1083;&#1100;"</span> <span style="color: #0000ee; font-weight: bold;">:required</span> t <span style="color: #0000ee; font-weight: bold;">:type</span>
                                <span style="color: #00cd00;">"password"</span> <span style="color: #0000ee; font-weight: bold;">:autocomplete</span> <span style="color: #00cd00;">"off"</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"input-bg"</span>))
             (ps-html ((<span style="color: #0000ee; font-weight: bold;">:input</span> <span style="color: #0000ee; font-weight: bold;">:type</span> <span style="color: #00cd00;">"hidden"</span> <span style="color: #0000ee; font-weight: bold;">:name</span> <span style="color: #00cd00;">"act"</span> <span style="color: #0000ee; font-weight: bold;">:value</span> <span style="color: #00cd00;">"LOGIN"</span>)))
             (submit <span style="color: #00cd00;">"&#1042;&#1086;&#1081;&#1090;&#1080;"</span>)
             (ps-html ((<span style="color: #0000ee; font-weight: bold;">:p</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"forgot-pw"</span>) <span style="color: #00cd00;">"&#1047;&#1072;&#1073;&#1099;&#1083;&#1080; "</span> ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:href</span>
                                                              <span style="color: #00cd00;">"/lostpassword"</span>) <span style="color: #00cd00;">"&#1087;&#1072;&#1088;&#1086;&#1083;&#1100;"</span>) <span style="color: #00cd00;">"?"</span>))))
         ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"box"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:div</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"box--title"</span>) <span style="color: #00cd00;">"&#1042;&#1087;&#1077;&#1088;&#1074;&#1099;&#1077; &#1079;&#1076;&#1077;&#1089;&#1100;?"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:p</span>) <span style="color: #00cd00;">"&#1047;&#1072;&#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1080;&#1088;&#1091;&#1081;&#1090;&#1077;&#1089;&#1100; &#1080; &#1086;&#1094;&#1077;&#1085;&#1080;&#1090;&#1077; &#1087;&#1088;&#1077;&#1080;&#1084;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1072;!"</span>)
          ((<span style="color: #0000ee; font-weight: bold;">:a</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button button--link button--secondary"</span> <span style="color: #0000ee; font-weight: bold;">:href</span> <span style="color: #00cd00;">"/reg"</span>)
           <span style="color: #00cd00;">"&#1047;&#1072;&#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100;&#1089;&#1103;"</span>
           ((<span style="color: #0000ee; font-weight: bold;">:span</span> <span style="color: #0000ee; font-weight: bold;">:class</span> <span style="color: #00cd00;">"button__icon"</span>)))))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-13-8" class="outline-3">
<h3 id="sec-13-8"><span class="section-number-3">13.8</span> Точка входа</h3>
<div class="outline-text-3" id="text-13-8">
<p>
Отсюда все начинается
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enter_point"><span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">&lt;&lt;copyright&gt;&gt;</span>
<span style="color: #cd0000;">;;;; </span><span style="color: #cd0000;">start.lisp</span>

(<span style="color: #00cdcd; font-weight: bold;">in-package</span> #<span style="color: #0000ee; font-weight: bold;">:asp</span>)

(<span style="color: #00cdcd; font-weight: bold;">defclass</span> <span style="color: #00cd00;">asp-render</span> () ())

(<span style="color: #00cdcd; font-weight: bold;">defun</span> <span style="color: #0000ee; font-weight: bold;">start-server</span> ()
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">start</span>
  (restas:start '#<span style="color: #0000ee; font-weight: bold;">:asp</span> <span style="color: #0000ee; font-weight: bold;">:port</span> 3999)
  (restas:debug-mode-on)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(restas:debugg-mode-off)</span>
  (setf hunchentoot:*catch-errors-p* t)
  <span style="color: #cd0000;">;; </span><span style="color: #cd0000;">(make-event :name "restart"</span>
  <span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">:tag "restart"</span>
  <span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">:msg (format nil "&#1057;&#1077;&#1088;&#1074;&#1077;&#1088; &#1087;&#1077;&#1088;&#1077;&#1079;&#1072;&#1087;&#1091;&#1097;&#1077;&#1085;")</span>
  <span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">:author-id 0</span>
  <span style="color: #cd0000;">;;             </span><span style="color: #cd0000;">:ts-create (get-universal-time))</span>
  )

(start-server)

<span style="color: #cd0000;">;; </span><span style="color: #cd0000;">&#1058;&#1077;&#1089;&#1090;&#1099;</span>
&lt;&lt;asp_test&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-13-9" class="outline-3">
<h3 id="sec-13-9"><span class="section-number-3">13.9</span> Copyright</h3>
<div class="outline-text-3" id="text-13-9">
<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2015 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> Оптимизация аппаратной части решения</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2016-03-27 Вс. 13:22</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
